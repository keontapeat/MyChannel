<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>MyChannel Pro - Next-Gen Video Platform</title>
    <meta name="title" content="MyChannel - The Future of Video">
    <meta name="description" content="Experience the next generation video platform. Watch, share, and discover amazing content from creators worldwide. Stories, videos, and live streaming - all in one place.">
    <meta name="keywords" content="video platform, streaming, content creators, videos, stories, MyChannel, social media, entertainment">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <meta name="author" content="MyChannel">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mychannel.live/">
    <meta property="og:title" content="MyChannel - The Future of Video">
    <meta property="og:description" content="Experience the next generation video platform. Watch, share, and discover amazing content from creators worldwide.">
    <meta property="og:image" content="https://mychannel.live/assets/MyChannel-og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="MyChannel">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://mychannel.live/">
    <meta property="twitter:title" content="MyChannel - The Future of Video">
    <meta property="twitter:description" content="Experience the next generation video platform. Watch, share, and discover amazing content from creators worldwide.">
    <meta property="twitter:image" content="https://mychannel.live/assets/MyChannel-og-image.png">
    <meta property="twitter:creator" content="@mychannel">
    <meta property="twitter:site" content="@mychannel">
    
    <!-- App Icons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Mobile App -->
    <meta name="theme-color" content="#ff4444">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MyChannel">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://apis.google.com https://www.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: blob:; media-src 'self' https: blob:; connect-src 'self' https: wss:; font-src 'self' data:; frame-src 'self' https://accounts.google.com https://*.google.com https://*.gstatic.com https://mychannel-ca26d.firebaseapp.com https://mychannel-ca26d.web.app; object-src 'none'; base-uri 'self';">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://mychannel.live/">
    
    <!-- Preconnect to External Domains -->
    <link rel="preconnect" href="https://images.unsplash.com">
    <link rel="preconnect" href="https://commondatastorage.googleapis.com">
    <link rel="preconnect" href="https://www.gstatic.com">
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "MyChannel",
      "description": "The future of video - watch, share, and discover amazing content from creators worldwide",
      "url": "https://mychannel.live",
      "applicationCategory": "MultimediaApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "1250"
      }
    }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* CSS Variables - Light Theme Only */
        :root {
            --primary: #FF4444;
            --accent: #00FFE1;
            --light: #ffffff;
            --gray: #888888;
            --light-gray: #f0f0f0;
            --dark: #212529;
            --darker: #6c757d;
            
            /* Main Theme Variables */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --card-bg: rgba(0, 0, 0, 0.05);
            --glass-bg: rgba(0, 0, 0, 0.1);
            --shadow: rgba(0, 0, 0, 0.1);
            --border: #dee2e6;
            --hover: #f8f9fa;
            
            /* Additional Variables */
            --success: #00FF88;
            --warning: #FFB800;
            --error: #FF4444;
            --gradient: linear-gradient(135deg, #FF4444 0%, #FF6B6B 100%);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        /* Dark Theme Variables - applied only when enabled in Settings */
        :root[data-theme="dark"] {
            --bg-primary: #0f0f0f;
            --bg-secondary: #161616;
            --text-primary: #f1f1f1;
            --text-secondary: #b3b3b3;
            --card-bg: rgba(255, 255, 255, 0.06);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --shadow: rgba(0, 0, 0, 0.6);
            --border: #222222;
            --hover: #1f1f1f;
        }

        /* Completely disable iOS Safari video overlays */
        video {
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            -khtml-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            outline: none !important;
            border: none !important;
        }
        
        .video-player-container {
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            user-select: none !important;
            overflow: hidden !important;
        }
        
        /* Block any iOS Safari video interaction overlays */
        video::-webkit-media-controls-overlay {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        /* Enhanced Animations */
        @keyframes heartFloat {
            0% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
            50% {
                transform: scale(1.5) translateY(-20px);
                opacity: 0.8;
            }
            100% {
                transform: scale(2) translateY(-40px);
                opacity: 0;
            }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-30px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        /* Enhanced Button Styles */
        .theme-toggle:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }

        .pip-btn, .speed-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            margin: 0 4px;
        }

        .pip-btn:hover, .speed-btn:hover {
            background: var(--hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        /* Enhanced Video Grid with Staggered Animation */
        .video-grid .video-item {
            animation: slideInUp 0.6s ease-out forwards;
            animation-delay: calc(var(--item-index, 0) * 0.1s);
        }

        /* Enhanced Story Items */
        .story-item {
            animation: slideInLeft 0.5s ease-out forwards;
            animation-delay: calc(var(--story-index, 0) * 0.1s);
        }

        .story-item:hover {
            animation: pulse 0.3s ease-in-out;
        }

        /* Enhanced Notifications */
        .notification {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: var(--glass-bg);
            border: 1px solid var(--border);
        }

        /* Splash (web version of iOS SplashView) */
        .splash-overlay { position: fixed; inset: 0; background: #fff; z-index: 100000; display: flex; align-items: center; justify-content: center; transition: opacity .4s ease, visibility .4s ease; }
        .splash-overlay.hidden { opacity: 0; visibility: hidden; }
        .splash-content { display:flex; flex-direction:column; align-items:center; gap:24px; }
        .splash-logo { width: 120px; height: 120px; object-fit: contain; opacity: 0; transform: scale(.8); transition: transform 1.2s cubic-bezier(.2,.8,.2,1), opacity .8s ease; }
        .splash-logo.show { opacity: 1; transform: scale(1); }
        .splash-progress { width: 200px; height: 3px; background: var(--border-color); border-radius: 2px; overflow: hidden; }
        .splash-progress-fill { width: 0%; height: 100%; background: var(--primary); transition: width .3s ease; }

        /* Full-Screen Flicks Viewer */
        .flicks-viewer {
            position: fixed;
            top: 64px; /* leave top app bar visible */
            left: 0; right: 0;
            bottom: calc(52px + env(safe-area-inset-bottom)); /* leave bottom nav visible */
            background: #000;
            z-index: 900; /* below bottom-nav (1000) but above content */
            display: none;
            flex-direction: column;
            touch-action: pan-y;
        }

        .flicks-viewer.active {
            display: flex;
        }

        .flicks-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
        }

        .flick-item {
            width: 100vw;
            height: 100vh;
            position: relative;
            scroll-snap-align: start;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flick-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        .flick-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(transparent 60%, rgba(0,0,0,0.4));
            pointer-events: none;
        }

        .flick-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 80px;
            color: white;
            pointer-events: auto;
        }

        .flick-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .flick-creator {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 12px;
        }

        .flick-actions {
            position: absolute;
            right: 20px;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }
        .flick-action {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .flick-action:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .flick-action.liked {
            background: #ff4444;
            color: white;
        }
        .flick-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .flick-progress {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255,255,255,0.3);
        }

        .flick-progress-fill {
            height: 100%;
            background: #ff4444;
            width: 0%;
            transition: width 0.1s linear;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: var(--transition);
            line-height: 1.6;
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 20001;
            padding-top: env(safe-area-inset-top);
            border-bottom: 0;
            box-shadow: none;
            transition: var(--transition);
        }

        /* Keep header light and text dark at all times */
        .header .logo { color: var(--text-primary); }
        .header:hover { background: rgba(255, 255, 255, 0.95); border-bottom-color: var(--border); }
        .header:hover .logo { color: var(--text-primary); }

        

        .header:hover {
            background: rgba(0, 0, 0, 0.98);
            border-bottom-color: var(--primary);
        }
        .header .logo { color: var(--text-primary); }
        .header:hover .logo { color: #fff; }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
        }

        /* Keep logo readable on hover when header turns dark */
        .header:hover .logo { color: #fff; }
        
        .logo img { width: 32px; height: 32px; border-radius: 6px; object-fit: contain; display: block; }
        
        .main-content { margin-top: 64px; padding: 20px 16px 70px; background: var(--bg-primary); }

        /* Video Detail: responsive layout + polished suggestions */
        .video-detail-info-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 900px) {
            .video-detail-info-grid { grid-template-columns: 2fr 1fr; align-items: start; }
            .suggestions-sidebar { position: sticky; top: calc(64px + env(safe-area-inset-top) + 12px); }
        }
        .suggestions-list { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .suggestion-card { display: flex; gap: 12px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; cursor: pointer; }
        .suggestion-card img.thumb { width: 168px; height: 94px; object-fit: cover; display: block; }
        .suggestion-meta { min-width: 0; padding: 10px 12px; display: flex; flex-direction: column; gap: 6px; }
        .suggestion-title { color: var(--text-primary); font-weight: 600; font-size: 14px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .suggestion-channel { color: var(--text-secondary); font-size: 12px; display: flex; align-items: center; gap: 8px; }
        .suggestion-channel img { width: 20px; height: 20px; border-radius: 50%; }
        .suggestion-views { color: var(--text-secondary); font-size: 12px; opacity: .8; }
        @media (max-width: 899px) {
            /* Mobile: show suggestions as one centered horizontal row */
            .suggestions-list { display: flex; gap: 12px; overflow-x: auto; padding: 8px 0; scroll-snap-type: x mandatory; justify-content: center; }
            .suggestion-card { flex: 0 0 78%; max-width: 420px; scroll-snap-align: center; flex-direction: column; }
            .suggestion-card img.thumb { width: 100%; height: 180px; }
            .suggestion-meta { padding: 10px 12px 12px; }
        }
        
        .stories-section {
            margin-bottom: 24px;
        }

        /* Minimal promo banner */
        .promo-banner { padding: 10px 12px; margin: 8px 0 12px 0; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.08); background:#fff; color:#111; border:1px solid rgba(0,0,0,0.06); }
        .promo-row { gap: 8px; }
        .promo-title { font-size: 16px; font-weight: 800; letter-spacing: .2px; margin: 0 0 2px 0; color:#111; text-shadow:none; }
        .promo-desc { font-size: 12px; opacity: 0.9; margin-top: 0; color:#333; }
        .promo-actions { gap: 10px; }
        .promo-close { top: 6px; right: 6px; width: 20px; height: 20px; font-size: 12px; }
        .promo-banner::after{ display:none; }

        
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #ff4444;
        }
        
        .stories-container {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
            scroll-snap-type: x mandatory;
            background: transparent;
        }
        
        .story-item {
            flex-shrink: 0;
            text-align: center;
            scroll-snap-align: start;
        }
        
        .story-ring {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff4444, #ff6b6b);
            padding: 3px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .story-ring:hover {
            transform: scale(1.05);
        }
        .story-ring img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #0f0f0f;
        }
        
        .add-story {
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-story-plus {
            color: white;
            font-size: 28px;
            font-weight: 300;
        }
        
        .active-story {
            background: linear-gradient(45deg, #ff4444, #ff6b6b);
        }
        
        .story-item span {
            font-size: 12px;
            color: #aaa;
            display: block;
            max-width: 64px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .video-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 480px) {
            .video-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (min-width: 900px) {
            .video-grid { grid-template-columns: repeat(3, 1fr); }
        }
        
        .video-card {
            background: #121212;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            border: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 6px 18px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
        }
        
        .video-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 28px rgba(0,0,0,0.35);
        }
        
        .video-thumbnail {
            position: relative;
            width: 100%;
            /* Prefer aspect-ratio where supported */
            aspect-ratio: 16/9;
            background: #272727;
        }
        /* Fallback for browsers ignoring aspect-ratio (iOS Safari quirks) */
        .video-thumbnail::before {
            content: '';
            display: block;
            padding-top: 56.25%; /* 16:9 */
        }
        .video-thumbnail img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        /* Trending-specific thumbnail overlay */
        .trend-card .video-thumbnail { border-radius: 16px; overflow: hidden; }
        .trend-card .video-thumbnail::after { content:''; position:absolute; inset:0; background: linear-gradient(to top, rgba(0,0,0,0.68) 0%, rgba(0,0,0,0.28) 35%, rgba(0,0,0,0) 60%); pointer-events:none; }
        .trend-meta { position:absolute; left:12px; right:12px; bottom:10px; color:#fff; text-shadow: 0 1px 2px rgba(0,0,0,.6); }
        .trend-title { font-size:16px; line-height:1.25; font-weight:800; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; margin:0; }
        .trend-stats { margin-top:4px; font-size:13px; opacity:.95; display:flex; align-items:center; gap:6px; }
        
        .video-duration {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.75);
            color: #fff;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            backdrop-filter: blur(4px);
        }
        
        .play-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            color: #000;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .video-card:hover .play-overlay {
            opacity: 1;
        }
        
        .video-info {
            padding: 10px 14px 10px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            border-top: 1px solid rgba(255,255,255,0.08);
        }
        .video-info.compact { display:block; padding: 10px 14px 10px; border-top: 1px solid rgba(255,255,255,0.08); }
        .video-text { flex: 1; min-width: 0; }
        .video-title { font-size: 16px; line-height: 1.3; margin: 0 0 2px; color: #f1f1f1; font-weight: 600; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .video-description { color: #cfcfcf; font-size: 13px; line-height: 1.45; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .video-subtext { color: #aeb0b3; font-size: 12.5px; line-height: 1.4; display:flex; align-items:center; gap: 6px; flex-wrap: wrap; }
        .video-stats { display:flex; align-items:center; gap: 8px; margin-top: 4px; color: #bfc3c7; font-weight: 500; }
        .video-stats .dot { opacity: .6; }
        .video-stats .year { opacity: 0.9; padding: 2px 10px; background: rgba(255,255,255,0.06); border-radius: 999px; }
        .video-stats .rating { display: inline-flex; align-items:center; gap: 6px; padding: 2px 8px; background: rgba(255,255,255,0.06); border-radius: 999px; }
        .video-stats .rating .star { color: #FFD166; }
        /* Subtle fade-in on scroll */
        .fade-in { opacity: 0; transform: translateY(6px); transition: opacity 300ms ease, transform 300ms ease; }
        .fade-in.visible { opacity: 1; transform: translateY(0); }

        @media (max-width: 480px) {
            /* Give more room for the text block under the thumbnail on mobile */
            .video-card .video-thumbnail { aspect-ratio: 16/8.4; }
            .video-card .video-thumbnail::before { padding-top: 52.5%; }
            .video-title { font-size: 15px; }
            .video-description { display: none; }
            .video-info { padding: 10px 12px 10px; }
        }
        
        .channel-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .video-details { background: rgba(0,0,0,0.85); padding:10px 12px; border-radius:12px; margin-top:8px; }
        .video-details h3 { color:#fff; font-size:16px; font-weight:700; margin:0 0 4px 0; }
        .video-meta { color:#ddd; font-size:12px; margin:0; }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 52px;
            background: var(--bg-primary);
            border-top: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 20000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 4px 8px;
            color: #aaa;
            text-decoration: none;
            transition: color 0.2s ease;
            cursor: pointer;
            flex: 1;
            max-width: 72px;
        }
        
        .nav-item.active {
            color: #fff;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 1px;
        }
        .nav-item small {
            font-size: 10px;
            font-weight: 400;
            letter-spacing: 0.2px;
        }
        @media (max-width: 768px) {
            .main-content {
                padding: 16px 12px 100px;
            }
            
            .header {
                padding: 0 16px;
                height: 56px;
            }
        }

        /* Pro create button */
        #create-tab {
            position: relative;
        }
        #create-tab .nav-icon {
            width: 56px; height: 40px; border-radius: 20px;
            background: linear-gradient(180deg, #00b4ff, #0077ff);
            color: #fff !important; font-weight: 800; font-size: 18px; line-height: 40px; text-align: center;
            box-shadow: 0 8px 24px rgba(0,119,255,0.35);
        }
        #create-tab small { font-weight: 700; }

        /* Enhanced Video Player Styles */
        .enhanced-video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-container:hover .enhanced-video-controls {
            opacity: 1;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            margin-bottom: 12px;
            cursor: pointer;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.1s ease;
        }

        .video-control-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .video-control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Floating Upload Button removed */

        /* Upload Modal */
        .upload-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 40000; display: none; }
        .upload-modal { position: fixed; inset: 0; display: none; z-index: 40001; align-items: center; justify-content: center; }
        .upload-card { width: min(720px, 94vw); max-height: 92vh; overflow: auto; background: var(--bg-primary); border-radius: 16px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .upload-header { display:flex; align-items:center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; background: var(--bg-primary); z-index: 1; }
        .upload-body { padding: 16px; }
        .upload-close { background: transparent; border: 0; color: var(--text-secondary); font-size: 22px; cursor: pointer; }
        .upload-zone { border: 2px dashed var(--border-color); border-radius: 12px; padding: 28px; text-align: center; margin-bottom: 16px; }
        .upload-input { display:none; }
        .upload-row { margin-bottom: 12px; }
        .upload-input-text, .upload-textarea, .upload-select { width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); }

            /* Enhanced Stories Section */
            .upload-select option {
                padding: 8px;
                background: var(--bg-primary);
                color: var(--text-primary);
            }
            
            /* Advanced Notifications Styles */
            .notifications-panel {
                position: fixed;
                top: 0;
                right: -400px;
                width: 400px;
                height: 100vh;
                background: var(--bg-primary);
                border-left: 1px solid var(--border);
                z-index: 10000;
                transition: right 0.3s ease;
                display: flex;
                flex-direction: column;
                box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            }
            .notifications-panel.active {
                right: 0;
            }
            .notifications-header {
                padding: 16px;
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: var(--bg-secondary);
            }
            .notification-badge {
                background: var(--error);
                color: #fff;
                border-radius: 50%;
                padding: 2px 6px;
                font-size: 10px;
                font-weight: 600;
                min-width: 16px;
                text-align: center;
            }
            .notifications-filters {
                display: flex;
                padding: 12px 16px;
                gap: 8px;
                border-bottom: 1px solid var(--border);
                overflow-x: auto;
            }
            .notification-filter {
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 16px;
                padding: 6px 12px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
                white-space: nowrap;
                color: var(--text-secondary);
            }
            .notification-filter.active {
                background: var(--primary);
                color: #fff;
                border-color: var(--primary);
            }
            .notifications-list {
                flex: 1;
                overflow-y: auto;
                padding: 8px 0;
            }
            .notification-item {
                padding: 12px 16px;
                border-bottom: 1px solid var(--border);
                cursor: pointer;
                transition: background 0.2s ease;
                position: relative;
            }
            .notification-item:hover {
                background: var(--bg-secondary);
            }
            .notification-item.unread {
                background: rgba(var(--primary-rgb), 0.05);
            }
            .notification-item.unread::before {
                content: '';
                position: absolute;
                left: 8px;
                top: 50%;
                transform: translateY(-50%);
                width: 4px;
                height: 4px;
                background: var(--primary);
                border-radius: 50%;
            }
            .notification-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: var(--bg-secondary);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                margin-right: 12px;
                flex-shrink: 0;
            }
            .notification-content {
                flex: 1;
            }
            .notification-text {
                font-size: 14px;
                color: var(--text-primary);
                margin-bottom: 4px;
                line-height: 1.3;
            }
            .notification-time {
                font-size: 11px;
                color: var(--text-secondary);
            }
            .notifications-empty {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100%;
            }
            .notifications-settings {
                border-top: 1px solid var(--border);
            }
            
            /* Notification Toast */
            .notification-toast {
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--bg-primary);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 12px 16px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                z-index: 10001;
                max-width: 300px;
                transform: translateX(400px);
                transition: transform 0.3s ease;
            }
            .notification-toast.show {
                transform: translateX(0);
            }
            .notification-toast-header {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 8px;
            }
            .notification-toast-title {
                font-weight: 600;
                font-size: 14px;
                color: var(--text-primary);
            }
            .notification-toast-body {
                font-size: 12px;
                color: var(--text-secondary);
                line-height: 1.3;
            }
            
            @media (max-width: 768px) {
                .notifications-panel {
                    width: 100vw;
                    right: -100vw;
                }
            }

        /* Stories Section */
        .stories-section {
            margin-bottom: 24px;
        }

        .story-item {
            position: relative;
            transition: var(--transition);
        }

        .story-item:hover {
            transform: scale(1.05);
        }

        /* Enhanced Buttons */
        .btn-enhanced {
            background: var(--gradient);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .btn-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 68, 68, 0.3);
        }

        /* Enhanced Notifications */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-primary);
            color: var(--light);
            padding: 16px 20px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary);
            box-shadow: var(--shadow);
            z-index: 10000;
            animation: slideInRight 0.3s ease;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .bottom-nav .nav-item { -webkit-tap-highlight-color: transparent; }
        .bottom-nav .nav-item:focus, .bottom-nav .nav-item:focus-visible { outline: none; }
        .bottom-nav .nav-item.active small { color: #fff; }
        .bottom-nav .nav-item.active .nav-icon { color: #fff; }

        /* Bottom nav focus/active fixes */
        .bottom-nav .nav-item { -webkit-tap-highlight-color: transparent; box-shadow: none !important; }
        .bottom-nav .nav-item:focus, .bottom-nav .nav-item:focus-visible { outline: none !important; box-shadow: none !important; }
        .bottom-nav .nav-item small { color: #aaa; }
        .bottom-nav .nav-item.active small, .bottom-nav .nav-item.active { color: #fff !important; }

        /* Ensure active tab text/icon visible on white bar */
        .bottom-nav .nav-item.active, .bottom-nav .nav-item.active small, .bottom-nav .nav-item.active .nav-icon { color: #111 !important; }
        .bottom-nav .nav-item.active { border-bottom: 2px solid var(--primary); }

        /* Promo Banner visual polish */
        .promo-banner { border: 1px solid rgba(255,255,255,0.2); }
        .promo-title { text-shadow: 0 1px 0 rgba(0,0,0,0.25); }
        .promo-btn { box-shadow: 0 6px 14px rgba(0,0,0,0.18); }
        /* Rounded, stylish video thumbnails */
        .video-grid .video-item { background: var(--card-bg); border: 1px solid var(--border); padding: 10px; border-radius: 14px; overflow: hidden; }
        .video-thumbnail { border-radius: 12px; overflow: hidden; position: relative; }
        .video-thumbnail::after { content: ''; position:absolute; inset:0; background: linear-gradient(to top, rgba(0,0,0,0.25), rgba(0,0,0,0)); pointer-events:none; }
        .video-thumbnail img { border-radius: 12px; display:block; width:100%; height:100%; object-fit:cover; }

        /* Promo Banner for guests */
        .promo-banner {
            display: block;
            background: linear-gradient(135deg, #ff4d4d, #ff7a7a);
            color: #fff;
            border-radius: 12px;
            padding: 10px 12px;
            margin: 8px 0 12px 0;
            box-shadow: 0 6px 16px rgba(255, 68, 68, 0.18);
        }
        .promo-banner.hidden { display: none !important; }
        .promo-banner.red { border: 1px solid rgba(255,255,255,0.2); }

        body .promo-banner { background:#fff !important; color:#111 !important; border:1px solid rgba(0,0,0,0.06) !important; box-shadow: 0 10px 24px rgba(0,0,0,0.08) !important; }
    </style>
    <!-- Performance: preconnect to critical origins -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://firebasestorage.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://storage.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://image.tmdb.org" crossorigin>
    <link rel="preconnect" href="https://api.themoviedb.org" crossorigin>
    <link rel="preconnect" href="https://ntv1.akamaized.net" crossorigin>
    <link rel="preconnect" href="https://dwamdstream102.akamaized.net" crossorigin>
    <!-- App identity for Safari/Spotlight tiles and rich results -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/MyChannel.imageset/MyChannelLaunch.PNG">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/MyChannel.imageset/MyChannelLaunch.PNG">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/MyChannel.imageset/MyChannelLaunch.PNG">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ff3b30">
    <meta name="application-name" content="MyChannel">
    <meta name="apple-mobile-web-app-title" content="MyChannel">
    <meta name="theme-color" content="#ff3b30">
    <link rel="canonical" href="https://mychannel.live/">
    <meta property="og:site_name" content="MyChannel">
    <meta property="og:title" content="MyChannel">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mychannel.live/">
    <meta property="og:image" content="https://mychannel.live/assets/MyChannel.imageset/MyChannelLaunch.PNG">
    <meta name="twitter:card" content="summary_large_image">
</head>
<body>
    <!-- Web SplashView -->
    <div id="webSplash" class="splash-overlay">
        <div class="splash-content">
            <img src="assets/MyChannel.imageset/MyChannelLaunch.PNG" alt="MyChannel" class="splash-logo" id="splashLogo">
            <div class="splash-progress"><div class="splash-progress-fill" id="splashFill"></div></div>
        </div>
    </div>
    <!-- Auth Modal -->
    <div id="authModal" style="display:none; position: fixed; inset:0; background: rgba(0,0,0,0.5); z-index: 20000; align-items:center; justify-content:center;">
        <div style="width: 92vw; max-width: 420px; background: #fff; border-radius: 16px; overflow:hidden; box-shadow: 0 18px 48px rgba(0,0,0,0.25);">
            <div style="padding: 16px 20px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
                <div id="authTitle" style="font-weight:700; font-size:18px;">Sign in</div>
                <button onclick="closeAuthModal()" style="border:none; background:none; font-size:20px; cursor:pointer;">√ó</button>
            </div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                <input id="authName" placeholder="Full name" style="display:none; padding:12px 14px; border-radius:10px; border:1px solid #e9ecef;">
                <input id="authEmail" placeholder="Email" type="email" style="padding:12px 14px; border-radius:10px; border:1px solid #e9ecef;">
                <div style="position:relative;">
                    <input id="authPassword" placeholder="Password" type="password" style="padding:12px 44px 12px 14px; border-radius:10px; border:1px solid #e9ecef; width:100%;">
                    <button id="togglePwd" type="button" onclick="togglePassword()" aria-label="Show password" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); border:none; background:none; cursor:pointer; font-size:13px; color:#6c757d;">Show</button>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">
                    <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#6c757d;">
                        <input id="rememberMe" type="checkbox"> Keep me signed in
                    </label>
                    <button type="button" onclick="startResetPassword()" style="background:none; border:none; color:#1a73e8; font-size:12px; cursor:pointer;">Forgot password?</button>
                </div>
                <button id="authSubmit" onclick="submitAuth()" style="margin-top:8px; padding:12px 16px; border:none; background:#ff4444; color:#fff; border-radius:10px; font-weight:600; cursor:pointer;">Continue</button>
                <div style="display:flex; align-items:center; gap:8px; margin:8px 0;">
                    <div style="height:1px; background:#e9ecef; flex:1;"></div>
                    <div style="font-size:12px; color:#6c757d;">or</div>
                    <div style="height:1px; background:#e9ecef; flex:1;"></div>
                </div>
                <button id="googleAuthBtn" onclick="signInWithGoogle()" style="padding:12px 16px; border:none; background:#1a73e8; color:#fff; border-radius:10px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>Continue with Google</span>
                </button>
                <button id="appleAuthBtn" onclick="signInWithApple()" style="padding:12px 16px; border:none; background:#000; color:#fff; border-radius:10px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>Continue with Apple</span>
                </button>
                <div id="authHelper" style="font-size:12px; color:#6c757d; text-align:center; margin-top:8px;"></div>
            </div>
        </div>
    </div>

    <!-- Full-Screen Flicks Viewer -->
    <div id="flicksViewer" class="flicks-viewer">
        <button id="flicksMuteBtn" onclick="toggleFlicksMute()" style="position:absolute; top:12px; right:12px; z-index:2; background:rgba(0,0,0,.5); color:#fff; border:0; border-radius:999px; width:36px; height:36px;">üîá</button>
        <div class="flicks-container" id="flicksContainer">
            <!-- Flick items will be injected here -->
        </div>
    </div>

    <!-- MyChannel Studio Modal -->
    <div id="studioModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.5); z-index:20000; align-items:center; justify-content:center;">
        <div style="width:96vw; max-width:720px; background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 18px 48px rgba(0,0,0,0.25);">
            <div style="padding:16px 20px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
                <div style="font-weight:700; font-size:18px;">MyChannel Studio</div>
                <button onclick="closeStudio()" style="border:none; background:none; font-size:20px; cursor:pointer;">√ó</button>
            </div>
            <div style="padding:20px; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:16px;">
                <div style="border:1px solid #eef2f4; border-radius:12px; padding:16px;">
                    <div style="font-size:12px; color:#6c757d;">Active users (est.)</div>
                    <div id="studioActiveUsers" style="font-size:28px; font-weight:700;">-</div>
                </div>
                <div style="border:1px solid #eef2f4; border-radius:12px; padding:16px;">
                    <div style="font-size:12px; color:#6c757d;">Stories (24h)</div>
                    <div id="studioStories" style="font-size:28px; font-weight:700;">-</div>
                </div>
                <div style="border:1px solid #eef2f4; border-radius:12px; padding:16px;">
                    <div style="font-size:12px; color:#6c757d;">Comments (24h)</div>
                    <div id="studioComments" style="font-size:28px; font-weight:700;">-</div>
                </div>
                <div style="border:1px solid #eef2f4; border-radius:12px; padding:16px;">
                    <div style="font-size:12px; color:#6c757d;">Likes (24h)</div>
                    <div id="studioLikes" style="font-size:28px; font-weight:700;">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profileSettingsModal" class="upload-modal-backdrop">
        <div class="upload-modal">
            <div class="upload-card" style="max-width:520px;">
                <div class="upload-header">
                    <h3 style="margin:0; font-weight:600; color:var(--text-primary);">‚öôÔ∏è Profile Settings</h3>
                    <button class="upload-close" onclick="closeProfileSettings()">&times;</button>
                </div>
                <div class="upload-body">
                    <div class="upload-row">
                        <h4 style="margin:0 0 12px 0; color:var(--text-primary);">Appearance</h4>
                        <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                            <span>Enable Dark Mode</span>
                            <input type="checkbox" id="psEnableDarkMode">
                        </label>
                    </div>
                    <div class="upload-row">
                        <h4 style="margin:0 0 12px 0; color:var(--text-primary);">Playback</h4>
                        <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                            <span>Autoplay previews in feeds</span>
                            <input type="checkbox" id="psAutoplayPreviews">
                        </label>
                    </div>
                    <div class="upload-row">
                        <button onclick="saveProfileSettings()" class="btn-enhanced" style="width:100%;">üíæ Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.5); z-index:20000; align-items:center; justify-content:center;">
        <div style="width:94vw; max-width:520px; background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 18px 48px rgba(0,0,0,0.25);">
            <div style="padding:16px 20px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
                <div style="font-weight:700; font-size:18px;">Edit Profile</div>
                <button onclick="closeEditProfile()" style="border:none; background:none; font-size:20px; cursor:pointer;">√ó</button>
            </div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                <input id="profileDisplayName" placeholder="Display name" style="padding:12px 14px; border-radius:10px; border:1px solid #e9ecef;">
                <textarea id="profileBio" placeholder="Bio" rows="3" style="padding:12px 14px; border-radius:10px; border:1px solid #e9ecef;"></textarea>
                <label style="font-size:14px; color:#6c757d;">Banner video (mp4)</label>
                <input id="profileBannerVideo" type="file" accept="video/*" />
                <label style="font-size:14px; color:#6c757d;">Avatar</label>
                <input id="profileAvatar" type="file" accept="image/*" />
                <button onclick="saveProfile()" style="margin-top:8px; padding:12px 16px; border:none; background:#ff4444; color:#fff; border-radius:10px; font-weight:600; cursor:pointer;">Save</button>
            </div>
        </div>
    </div>
    <!-- Skip to Content Link for Screen Readers -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <header class="header" role="banner">
        <a href="#" class="logo" aria-label="MyChannel Home">
            <img src="assets/MyChannel.imageset/MyChannelLaunch.PNG" alt="MyChannel Logo" onerror="this.style.display='none'">
            MyChannel
        </a>
        <div style="display: flex; align-items: center; gap: 16px; position: relative;">
            <span id="notifBell" style="position: relative; font-size: 24px; cursor: pointer;">üîî
                <span id="notifBadge" style="display:none; position:absolute; top:-2px; right:-4px; width:8px; height:8px; background:#ff4444; border-radius:50%;"></span>
            </span>
            <div id="notifMenu" style="display:none; position:absolute; top:44px; right:42px; width: 280px; background:#fff; border:1px solid #eee; border-radius:12px; box-shadow:0 12px 24px rgba(0,0,0,0.12); overflow:hidden;">
                <div style="padding:12px 14px; font-weight:600; border-bottom:1px solid #f0f0f0;">Notifications</div>
                <div id="notifList" style="max-height:320px; overflow:auto;"></div>
                <div style="padding:10px; text-align:center; font-size:12px; color:#6c757d; border-top:1px solid #f0f0f0;">You're up to date</div>
            </div>
            <button id="accountButton" style="width: 32px; height: 32px; border-radius: 50%; background: #ff4444; display: flex; align-items: center; justify-content: center; font-weight: 600; color:#fff; border:none; cursor:pointer;">K</button>
            <!-- Account Menu -->
            <div id="accountMenu" style="display:none; position:absolute; top:44px; right:0; width: 260px; background: #fff; border:1px solid #eee; border-radius: 12px; box-shadow: 0 12px 24px rgba(0,0,0,0.12); overflow:hidden;">
                <div style="padding:12px 16px; border-bottom:1px solid #f0f0f0;">
                    <div id="accountName" style="font-weight:600; color:#212529;">Guest</div>
                    <div id="accountEmail" style="font-size:12px; color:#6c757d;">Not signed in</div>
                </div>
                <div id="menuSignedOut">
                    <button onclick="openAuthModal('signin')" style="width:100%; padding:12px 16px; background:#fff; border:none; text-align:left; cursor:pointer;">Sign in</button>
                    <button onclick="openAuthModal('signup')" style="width:100%; padding:12px 16px; background:#fff; border:none; text-align:left; cursor:pointer;">Create account</button>
                </div>
                <div id="menuSignedIn" style="display:none;">
                    <button onclick="switchProfile()" style="width:100%; padding:12px 16px; background:#fff; border:none; text-align:left; cursor:pointer;">Switch profile</button>
                    <button onclick="signOutUser()" style="width:100%; padding:12px 16px; background:#fff; border:none; text-align:left; cursor:pointer; color:#c1121f;">Sign out</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tab Content -->
    <div id="home-content" class="tab-content active" role="tabpanel" aria-labelledby="home-tab">
        <main class="main-content" id="main-content" role="main">
            <section id="promoBanner" class="promo-banner" role="note" aria-live="polite">
                <div class="promo-row">
                    <div>
                        <div class="promo-title">Your Channel. Your Future.</div>
                        <div class="promo-desc">Join MyChannel to post stories and videos.</div>
                    </div>
                    <div class="promo-actions">
                        <button class="promo-btn" onclick="openAuthModal('signup')">Create account</button>
                        <button class="promo-btn secondary" onclick="openAuthModal('signin')">Sign in</button>
                        <button class="promo-close" id="promoCloseBtn" aria-label="Dismiss">√ó</button>
                    </div>
                </div>
            </section>
            <section class="stories-section">
                <h2 class="section-title">Stories</h2>
                <div class="stories-container">
                    <!-- Stories will be injected dynamically to avoid placeholder flicker -->
                </div>
            </section>

            <section id="featured-section" style="margin:12px 0 16px 0;">
                <h2 class="section-title">Featured</h2>
                <div id="heroCarousel" style="position:relative; border-radius:12px; overflow:hidden; background:#000;">
                    <!-- Slides will be injected dynamically -->
                </div>
                <div style="display:flex; align-items:center; justify-content:center; padding:8px 0;">
                    <div id="heroDots" style="display:flex; gap:6px;"></div>
                </div>
            </section>

            <!-- Trending Section (moved directly after Featured) -->
            <section id="trending-section" style="margin: 18px 0 8px 0;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                    <h2 class="section-title" style="margin:0;">Trending Now</h2>
                    <button onclick="openSeeAllTrending()" style="background:none; border:none; color:var(--primary); font-weight:600; cursor:pointer;">See all</button>
                </div>
                <div id="trendingRow" style="display:flex; gap:12px; overflow-x:auto; padding: 6px 2px 12px 2px; scroll-snap-type: x mandatory;"></div>
            </section>

            <!-- Trending See All Modal -->
            <div id="trendingSeeAll" class="upload-modal-backdrop">
                <div class="upload-modal" style="max-width:960px;">
                    <div class="upload-card" style="width:100%;">
                        <div class="upload-header" style="align-items:center; gap:8px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <button class="upload-close" onclick="closeSeeAllTrending()" aria-label="Close">&times;</button>
                                <h3 style="margin:0; font-weight:700; color:var(--text-primary);">Trending</h3>
                            </div>
                            <div id="trendingTimeTabs" style="display:flex; gap:8px; margin-left:auto;">
                                <button data-tf="today" class="btn-enhanced" style="padding:6px 10px;">Today</button>
                                <button data-tf="thisWeek" class="btn-enhanced" style="padding:6px 10px; background:var(--bg-secondary); color:var(--text-primary);">This Week</button>
                                <button data-tf="thisMonth" class="btn-enhanced" style="padding:6px 10px; background:var(--bg-secondary); color:var(--text-primary);">This Month</button>
                                <button data-tf="allTime" class="btn-enhanced" style="padding:6px 10px; background:var(--bg-secondary); color:var(--text-primary);">All Time</button>
                            </div>
                        </div>
                        <div class="upload-body">
                            <div id="trendingList" style="display:flex; flex-direction:column; gap:12px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categories Section -->
            <section id="categories-section" style="margin: 18px 0 8px 0;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                    <h2 class="section-title" style="margin:0;">Categories</h2>
                </div>
                <div id="categoriesChips" style="display:flex; gap:8px; overflow-x:auto; padding:4px 2px 10px 2px;"></div>
                <div id="categoriesRow" style="display:flex; gap:12px; overflow-x:auto; padding: 6px 2px 12px 2px; scroll-snap-type: x mandatory;"></div>
            </section>

            <!-- Live TV Section -->
            <section id="live-tv-section" style="margin: 18px 0 8px 0;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                    <h2 class="section-title" style="margin:0;">Live TV</h2>
                    <button onclick="openSeeAllLiveTV()" style="background:none; border:none; color:var(--primary); font-weight:600; cursor:pointer;">See all</button>
                </div>
                <div id="liveTVRow" style="display:flex; gap:12px; overflow-x:auto; padding: 6px 2px 12px 2px; scroll-snap-type: x mandatory;"></div>
            </section>

            <!-- Enhanced Free Movies with Provider Filters -->
            <section id="free-movies" style="margin: 18px 0 8px 0;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                    <h2 class="section-title" style="margin:0;">Movies</h2>
                    <button onclick="openSeeAllMovies()" style="background:none; border:none; color:var(--primary); font-weight:600; cursor:pointer;">See all</button>
                </div>
                <div id="freeMoviesRow" style="display:flex; gap:12px; overflow-x:auto; padding: 6px 2px 12px 2px; scroll-snap-type: x mandatory;"></div>
            </section>

            <!-- Trending Section (legacy, hidden to preserve layout without breaking IDs) -->
            <section id="trending-section-legacy" style="margin: 18px 0 8px 0; display:none;">
                <div style="display:flex; align-items:center; justify-content:flex-start; margin-bottom:12px;">
                    <h2 class="section-title" style="margin:0;">Trending</h2>
                </div>
                <div id="trendingRowLegacy" style="display:flex; gap:12px; overflow-x:auto; padding: 6px 2px 12px 2px; scroll-snap-type: x mandatory;"></div>
            </section>

            <!-- Top Showcase (grouped) -->
            <section id="top-showcase" style="margin: 28px 0 28px 0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 16px 0 24px 0;">
                <!-- Top Artists -->
                <section id="top-artists" style="margin: 0 0 16px 0;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                        <h2 class="section-title" style="margin:0;">Top Artists</h2>
                    </div>
                    <div id="topArtistsRow" style="display:flex; gap:12px; overflow-x:auto; padding: 6px 2px 12px 2px; scroll-snap-type: x mandatory;"></div>
                </section>

                <!-- Top Indie Filmmakers -->
                <section id="top-filmmakers" style="margin: 24px 0 16px 0;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                        <h2 class="section-title" style="margin:0;">Top Indie Filmmakers</h2>
                    </div>
                    <div id="topFilmmakersRow" style="display:flex; gap:12px; overflow-x:auto; padding: 6px 2px 12px 2px; scroll-snap-type: x mandatory;"></div>
                </section>

                <!-- Top MyChannels -->
                <section id="top-channels" style="margin: 24px 0 0 0;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                        <h2 class="section-title" style="margin:0;">Top MyChannels</h2>
                    </div>
                    <div id="topChannelsRow" style="display:flex; gap:12px; overflow-x:auto; padding: 6px 2px 12px 2px; scroll-snap-type: x mandatory;"></div>
                </section>
            </section>

            <section id="recommended" style="display:none;">
                <h2 class="section-title">Recommended for you</h2>
                <div class="video-grid" id="videoGrid">
                    <!-- Videos will be loaded dynamically -->
                </div>
            </section>
        </main>
        
        <!-- Live TV See All Modal (in-page, hidden until opened) -->
        <div id="liveTVSeeAll" class="upload-modal-backdrop">
            <div class="upload-modal" style="max-width:960px;">
                <div class="upload-card" style="width:100%;">
                    <div class="upload-header" style="align-items:center; gap:8px;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <button class="upload-close" onclick="closeSeeAllLiveTV()" aria-label="Close">&times;</button>
                            <h3 style="margin:0; font-weight:700; color:var(--text-primary);">Live TV</h3>
                            <div id="liveTVCount" style="font-size:12px; color:var(--text-secondary);"></div>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; margin-left:auto;">
                            <div id="liveTVViewToggle" style="display:flex; gap:6px;">
                                <button data-view="grid" title="Grid" class="btn-enhanced" style="padding:6px 8px;">‚ñ¶</button>
                                <button data-view="list" title="List" class="btn-enhanced" style="padding:6px 8px; background:var(--bg-secondary); color:var(--text-primary);">‚â°</button>
                            </div>
                            <input id="liveTVSearch" type="search" placeholder="Search channels..." class="upload-input-text" style="max-width:320px;">
                        </div>
                    </div>
                    <div class="upload-body">
                        <div id="liveTVTabs" style="display:flex; gap:8px; margin-bottom:12px;">
                            <button data-tab="all" class="btn-enhanced" style="padding:6px 10px;">All Channels</button>
                            <button data-tab="news" class="btn-enhanced" style="padding:6px 10px; background:var(--bg-secondary); color:var(--text-primary);">News</button>
                            <button data-tab="sports" class="btn-enhanced" style="padding:6px 10px; background:var(--bg-secondary); color:var(--text-primary);">Sports</button>
                            <button data-tab="entertainment" class="btn-enhanced" style="padding:6px 10px; background:var(--bg-secondary); color:var(--text-primary);">Entertainment</button>
                        </div>
                        <div id="liveTVGrid" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <nav class="bottom-nav" role="tablist" aria-label="Main navigation">
        <a href="#" class="nav-item active" onclick="showTab('home')" role="tab" aria-selected="true" aria-controls="home-content" id="home-tab" tabindex="0">
            <div class="nav-icon" aria-hidden="true">üè†</div>
            <small>Home</small>
            <span class="sr-only">Navigate to home page</span>
        </a>
        <a href="#" class="nav-item" onclick="showTab('flicks'); openFlicks(0); return false;" role="tab" aria-selected="false" aria-controls="flicks-content" id="flicks-tab" tabindex="-1">
            <div class="nav-icon" aria-hidden="true">üé¨</div>
            <small>Flicks</small>
            <span class="sr-only">Navigate to flicks page</span>
        </a>
        <a href="#" class="nav-item" onclick="openUploadModal(); return false;" role="button" aria-label="Create" id="create-tab" tabindex="0">
            <div class="nav-icon" aria-hidden="true">‚ûï</div>
            <small>Create</small>
            <span class="sr-only">Open upload</span>
        </a>
        <a href="#" class="nav-item" onclick="showTab('search')" role="tab" aria-selected="false" aria-controls="search-content" id="search-tab" tabindex="-1">
            <div class="nav-icon" aria-hidden="true">üîç</div>
            <small>Search</small>
            <span class="sr-only">Navigate to search page</span>
        </a>
        <a href="#" class="nav-item" onclick="showTab('profile')" role="tab" aria-selected="false" aria-controls="profile-content" id="profile-tab" tabindex="-1">
            <div class="nav-icon" aria-hidden="true">üë§</div>
            <small>Profile</small>
            <span class="sr-only">Navigate to profile page</span>
        </a>
    </nav>



    <div id="flicks-content" class="tab-content">
        <section style="padding: 20px 16px;">
            <h2 class="section-title">üé¨ Flicks</h2>
            <div id="flicksGrid" class="flicks-grid" style="display: grid; gap: 12px; grid-template-columns: repeat(3, 1fr);"></div>
            <div id="flicksEmpty" style="margin-top:8px; color: var(--text-secondary); font-size: 13px; padding: 12px; border: 1px dashed var(--border-color); border-radius: 8px;">No flicks yet.</div>
        </section>
    </div>

    <div id="search-content" class="tab-content">
        <section style="padding: 20px 16px;">
            <div class="search-bar" style="margin-bottom: 16px; position:sticky; top:56px; background: var(--bg-primary); z-index:5; padding-top:8px;">
                <div style="display:flex; gap:8px; align-items:center;">
                    <div style="flex:1; display:flex; align-items:center; gap:10px; background:#1a1a1a; border:1px solid #333; border-radius:12px; padding:10px 12px;">
                        <span style="color:#9aa0a6">üîç</span>
                        <input type="search" placeholder="Search videos, creators, and more..." style="flex:1; background:transparent; border:0; outline:none; color:#fff; font-size:16px;" oninput="performSearch(this.value)">
                        <button onclick="clearSearch()" style="display:none; background:transparent; border:0; color:#9aa0a6; font-size:16px;" id="searchClearBtn">‚úï</button>
                    </div>
                    <button onclick="toggleSearchFilters()" style="width:40px; height:40px; border-radius:999px; background:#1a1a1a; border:1px solid #333; color:#ff4444;">‚â°</button>
                </div>
            </div>
            
            <div id="search-results">
                <h3 style="color: #666; text-align: center; margin-top: 60px;">Search for videos, channels, and more</h3>
                
                <div class="search-suggestions" style="margin-top: 40px;">
                    <h4 style="color: #ff4444; margin-bottom: 16px;">Trending Searches</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('gaming')">gaming</span>
                        <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('music')">music</span>
                        <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('tutorial')">tutorial</span>
                        <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('comedy')">comedy</span>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <div id="profile-content" class="tab-content" aria-labelledby="profile-tab" role="tabpanel">
        <!-- Profile Header with Background -->
        <div class="profile-header" style="position: relative; height: 300px; background: #000; overflow: hidden;">
            <!-- Video Banner -->
            <video id="profileBannerVideoEl" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); min-width:100%; min-height:100%; object-fit:cover; opacity:0.6;" autoplay muted loop playsinline></video>
            
            <!-- Settings Icon -->
            <div id="profileSettingsBtn" style="position: absolute; top: 20px; right: 20px; color: white; font-size: 24px; cursor: pointer;" onclick="showSettings()" aria-label="Profile settings" title="Profile settings">‚öôÔ∏è</div>
            
            <!-- Profile Info -->
            <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; background: linear-gradient(transparent, rgba(0,0,0,0.7));">
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div id="profileAvatarEl" style="width: 64px; height: 64px; border-radius: 50%; background: #2a2a2a; border: 3px solid white; margin-right: 16px;"></div>
                    <div>
                        <h2 id="profileDisplayNameEl" style="color: white; margin: 0; font-size: 24px; font-weight: 600;">MyChannel User</h2>
                        <p id="profileHandleEl" style="color: #ccc; margin: 4px 0 0 0; font-size: 14px;">@user</p>
                        <p id="profileBioEl" style="color: #ccc; margin: 2px 0 0 0; font-size: 12px;">Welcome to MyChannel</p>
                    </div>
                </div>
                
                <!-- Stats -->
                <div style="display: flex; gap: 24px; margin-bottom: 16px;">
                    <div style="text-align: center;">
                        <div id="profileHeaderCountsSubs" style="color: white; font-size: 18px; font-weight: 600;">0</div>
                        <div style="color: #ccc; font-size: 11px;">Subscribers</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="profileHeaderCountsVids" style="color: white; font-size: 18px; font-weight: 600;">0</div>
                        <div style="color: #ccc; font-size: 11px;">Videos</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="profileHeaderCountsViews" style="color: white; font-size: 18px; font-weight: 600;">0</div>
                        <div style="color: #ccc; font-size: 11px;">Views</div>
                    </div>
                </div>
                
                <!-- Edit Profile Button -->
                <button id="editProfileBtn" onclick="openEditProfile()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: 500; width: 100%; backdrop-filter: blur(10px); cursor:pointer;">Edit Profile</button>
            </div>
        </div>
        
        <!-- Content Tabs -->
        <div class="profile-tabs" style="display:flex; background: var(--bg-primary); position:sticky; top:64px; z-index:20000; border-bottom:0;">
            <div class="profile-tab active" onclick="showProfileTab('videos')" style="flex:1; padding:12px 0; text-align:center; color:#ff4444; font-size:14px; font-weight:600; cursor:pointer; position:relative;">
                <span>üìπ Videos (<span id="profileVideosCount">0</span>)</span>
                <div style="position:absolute; left:16px; right:16px; bottom:0; height:3px; background:#ff4444; border-radius:1.5px;"></div>
            </div>
            <div class="profile-tab" onclick="showProfileTab('flicks')" style="flex:1; padding:12px 0; text-align:center; color:#666; font-size:14px; font-weight:600; cursor:pointer; position:relative;">üé¨ Flicks (0)</div>
            <div class="profile-tab" onclick="showProfileTab('playlists')" style="flex:1; padding:12px 0; text-align:center; color:#666; font-size:14px; font-weight:600; cursor:pointer; position:relative;">üìã Playlists (0)</div>
            <div class="profile-tab" onclick="showProfileTab('community')" style="flex:1; padding:12px 0; text-align:center; color:#666; font-size:14px; font-weight:600; cursor:pointer; position:relative;">üí¨ Community</div>
            <div class="profile-tab" onclick="showProfileTab('about')" style="flex:1; padding:12px 0; text-align:center; color:#666; font-size:14px; font-weight:600; cursor:pointer; position:relative;">‚ÑπÔ∏è About</div>
        </div>
        
        <!-- Tab Content Areas -->
        <div id="profile-videos-tab" class="profile-tab-content active" style="padding: 16px; background: var(--bg-primary);">
            <div id="profileVideosEmpty" style="display:none;"></div>
            <div id="profileVideosGrid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;"></div>
        </div>

        <div id="profile-flicks-tab" class="profile-tab-content" style="padding: 16px; background: var(--bg-primary); display: none;">
            <div id="profileFlicksGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;"></div>
        </div>

            <div id="profilePlaylistsEmpty" style="display:none;"></div>
        </div>

        <div id="profile-community-tab" class="profile-tab-content" style="padding: 16px; background: var(--bg-primary); display: none;">
            <div id="communityComposer" style="margin-bottom:12px; display:flex; gap:8px;">
                <input id="communityText" placeholder="Share an update..." style="flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:var(--bg-secondary); color:var(--text-primary);" />
                <button id="communityPostBtn" class="btn-enhanced">Post</button>
            </div>
            <div id="communityFeed" style="display:flex; flex-direction:column; gap:8px;"></div>
        </div>

        <div id="profile-about-tab" class="profile-tab-content" style="padding: 16px; background: var(--bg-primary); display: none;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                <div style="background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px;">
                    <div style="font-size:12px; color:#999;">Subscribers</div>
                    <div id="aboutSubs" style="font-weight:700; font-size:18px;">0</div>
                </div>
                <div style="background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px;">
                    <div style="font-size:12px; color:#999;">Videos</div>
                    <div id="aboutVids" style="font-weight:700; font-size:18px;">0</div>
                </div>
                <div style="background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px;">
                    <div style="font-size:12px; color:#999;">Total Views</div>
                    <div id="aboutViews" style="font-weight:700; font-size:18px;">0</div>
                </div>
                <div style="background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px;">
                    <div style="font-size:12px; color:#999;">Joined</div>
                    <div id="aboutJoined" style="font-weight:700; font-size:18px;">‚Äî</div>
                </div>
            </div>
        </div>
        
        <!-- Persistent History section (always visible) -->
        <div id="profile-history-persistent" style="display:none; padding:16px; background: var(--bg-primary);">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                <div style="font-weight:600;">History</div>
                <a href="#" style="font-size:12px; color:#666; text-decoration:none;">View all</a>
            </div>
            <div id="historyGrid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px;"></div>
        </div>
    </div>
    <!-- Story Viewer Modal -->
    <div id="storyViewer" class="story-viewer" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-primary); z-index: 10000;">
        <!-- Story Progress Bars -->
        <div class="story-progress" style="position: absolute; top: 20px; left: 20px; right: 20px; display: flex; gap: 4px; z-index: 10001;">
            <div class="progress-bar" style="flex: 1; height: 3px; background: rgba(255,255,255,0.3); border-radius: 2px;">
                <div class="progress-fill" style="height: 100%; background: white; border-radius: 2px; width: 0%; transition: width 0.1s linear;"></div>
            </div>
        </div>
        
        <!-- Story Header -->
        <div class="story-header" style="position: absolute; top: 40px; left: 20px; right: 20px; display: flex; align-items: center; justify-content: space-between; z-index: 10001;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <img id="storyUserAvatar" src="" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                <div>
                    <div id="storyUsername" style="color: white; font-size: 14px; font-weight: 500;"></div>
                    <div id="storyTime" style="color: #ccc; font-size: 12px;">2h ago</div>
                </div>
            </div>
            <div onclick="closeStoryViewer()" style="color: white; font-size: 28px; cursor: pointer; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.5)'" onmouseout="this.style.background='rgba(0,0,0,0.3)'" title="Close story">√ó</div>
        </div>
        
        <!-- Story Content -->
        <div class="story-content" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
            <img id="storyImage" src="" style="max-width: 100%; max-height: 100%; object-fit: contain;">
            <video id="storyVideo" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;" controls></video>
        </div>
        
        <!-- Navigation Areas -->
        <div class="story-nav-left" onclick="previousStory()" style="position: absolute; left: 0; top: 0; width: 30%; height: 100%; cursor: pointer; z-index: 10001;" title="Previous story"></div>
        <div class="story-nav-right" onclick="nextStory()" style="position: absolute; right: 0; top: 0; width: 30%; height: 100%; cursor: pointer; z-index: 10001;" title="Next story"></div>
        
        <!-- Navigation hint -->
        <div style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.6); font-size: 12px; z-index: 10001; text-align: center; pointer-events: none;">
            Press ESC to close ‚Ä¢ Click sides or use arrow keys to navigate
        </div>
        
        <!-- Story Comments List -->
        <div id="storyComments" style="position:absolute; left:20px; right:20px; bottom:88px; max-height:160px; overflow-y:auto; z-index:10001; display:flex; flex-direction:column; gap:8px;"></div>
        <!-- Story Actions -->
        <div class="story-actions" style="position: absolute; bottom: 20px; left: 20px; right: 20px; display: flex; gap: 12px; z-index: 10001;">
            <input id="storyCommentInput" type="text" placeholder="Reply to story..." style="flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 10px 16px; color: white; font-size: 14px;">
            <button id="storyLikeBtn" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 10px 14px; color:#fff; cursor:pointer;">Like</button>
            <button id="storySendBtn" style="background: #ff4444; border:none; border-radius: 20px; padding: 10px 14px; color:#fff; cursor:pointer;">Post</button>
        </div>
    </div>

    <!-- Add Story Modal -->
    <div id="addStoryModal" class="add-story-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; backdrop-filter: blur(10px);">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:min(540px,96vw); background:#0f0f0f; border:1px solid #222; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.6); overflow:hidden;">
            <!-- Header -->
            <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #222;">
                <div style="display:flex; align-items:center; gap:10px; color:#fff; font-weight:700;">
                    <div style="width:32px; height:32px; border-radius:8px; background:#1f1f1f; display:flex; align-items:center; justify-content:center;">üì∏</div>
                    Create story
                </div>
                <button onclick="closeAddStoryModal()" style="width:36px; height:36px; border-radius:8px; border:1px solid #333; background:#1a1a1a; color:#fff; cursor:pointer;">‚úï</button>
            </div>
            
            <!-- Preview -->
            <div id="storyPreviewWrap" style="position:relative; width:100%; aspect-ratio:9/16; background:#000;">
                <video id="storyCamera" autoplay playsinline muted style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000;"></video>
                <canvas id="storyCanvas" style="display:none; position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000;"></canvas>
                <div id="storyTextOverlay" contenteditable="true" spellcheck="false" style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); color:#fff; font-weight:800; font-size:32px; line-height:1.1; text-align:center; text-shadow:0 2px 12px rgba(0,0,0,.6); display:none;">Your text</div>
                <div id="storyStickerLayer" style="position:absolute; inset:0; pointer-events:none;"></div>
                </div>
            
            <!-- Tools -->
            <div style="padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-top:1px solid #111;">
                <div style="display:flex; gap:12px;">
                    <button class="btn-enhanced" onclick="storyFocusCamera()" title="Camera" style="background:#1f1f1f; border:1px solid #333; color:#fff; padding:8px 10px; border-radius:10px;">üì∑ Camera</button>
                    <button class="btn-enhanced" onclick="document.getElementById('storyGalleryInput').click();" title="Photo" style="background:#1f1f1f; border:1px solid #333; color:#fff; padding:8px 10px; border-radius:10px;">üñºÔ∏è Photo</button>
                    <button class="btn-enhanced" onclick="toggleStoryText()" title="Text" style="background:#1f1f1f; border:1px solid #333; color:#fff; padding:8px 10px; border-radius:10px;">üî§ Text</button>
                    <button class="btn-enhanced" onclick="addStorySticker('‚≠êÔ∏è')" title="Sticker" style="background:#1f1f1f; border:1px solid #333; color:#fff; padding:8px 10px; border-radius:10px;">‚ú® Sticker</button>
                </div>
                <div id="storyShutterWrap" style="display:flex; align-items:center; gap:10px;">
                    <button id="storyShutter" onclick="captureStoryPhoto()" title="Capture" style="width:56px; height:56px; border-radius:999px; background:#fff; border:4px solid #444; box-shadow:0 6px 16px rgba(0,0,0,.45);"></button>
                    <button id="storyPostBtn" onclick="shareCapturedStory()" style="display:none; background:#ff0000; color:#fff; border:0; border-radius:12px; padding:10px 14px; font-weight:800;">Share</button>
                </div>
            </div>
            
            <!-- Caption/Audience -->
            <div style="padding:12px 14px; display:flex; align-items:center; gap:10px; border-top:1px solid #222;">
                <button onclick="openStoryCaption()" style="background:#1f1f1f; border:1px solid #333; color:#fff; padding:8px 12px; border-radius:999px;">üí¨ Add caption</button>
                <div style="flex:1"></div>
                <button id="storyAudienceBtn" onclick="cycleStoryAudience()" style="background:#1f1f1f; border:1px solid #333; color:#fff; padding:8px 12px; border-radius:999px;">üåê Public</button>
        </div>
        </div>
        <input type="file" id="storyGalleryInput" accept="image/*,video/*" style="display:none;">
    </div>
    <!-- Video Detail View - iOS App Style -->
    <div id="videoDetailView" class="video-detail-view" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-primary); z-index: 30000; overflow-y: auto;">
        <!-- Video Player Container -->
        <div class="video-player-container" style="position: relative; width: 100%; aspect-ratio: 16/9; background: var(--bg-primary); max-height: 56.25vw;">
            <!-- Main Video Player -->
            <video id="detailVideoPlayer" style="width: 100%; height: 100%; object-fit: contain; background: var(--bg-primary); pointer-events: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;" autoplay playsinline webkit-playsinline x5-playsinline controls="false" controlsList="nodownload nofullscreen noremoteplayback noplaybackrate" disablePictureInPicture disableRemotePlayback>
                <source src="" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            
            <!-- iOS-Style Loading Spinner -->
            <div id="videoLoadingSpinner" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 10002;">
                <div style="width: 60px; height: 60px; border-radius: 50%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;">
                    <div style="width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
            </div>
            
            <!-- Sleek Video Controls Overlay -->
            <div id="videoControlsOverlay" class="video-controls-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10001; opacity: 1; transition: opacity 0.3s ease; pointer-events: none;">
                
                <!-- Top Controls Bar -->
                <div class="top-controls" style="position: absolute; top: 0; left: 0; right: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); padding: calc(20px + env(safe-area-inset-top)) 20px 20px; display: flex; align-items: center; justify-content: space-between; pointer-events: auto;">
                    <!-- Close Button -->
                    <div onclick="closeVideoDetail()" style="width: 40px; height: 40px; border-radius: 8px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </div>
                    
                    <!-- Video Title -->
                    <div style="flex: 1; margin: 0 16px; text-align: center;">
                        <div id="topBarVideoTitle" style="color: white; font-size: 15px; font-weight: 500; line-height: 1.2; background: rgba(0,0,0,0.4); padding: 6px 16px; border-radius: 8px; max-width: 280px; margin: 0 auto;"></div>
                    </div>
                    
                    <!-- Mini Player Button -->
                    <div onclick="minimizeToMiniPlayer()" style="width: 40px; height: 40px; border-radius: 8px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 4h4v4H6z"></path>
                            <path d="M14 4h4v4h-4z"></path>
                            <path d="M6 14h4v4H6z"></path>
                            <path d="M14 14h4v4h-4z"></path>
                        </svg>
                    </div>
                </div>
                
                <!-- Center Play/Pause Button -->
                <div class="center-controls" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; pointer-events: auto;">
                    <div id="centerPlayButton" onclick="togglePlayPause()" style="width: 80px; height: 80px; border-radius: 16px; background: rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s ease; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                        <svg id="centerPlayIcon" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="none">
                            <polygon points="8,5 19,12 8,19"></polygon>
                        </svg>
                    </div>
                </div>
                
                <!-- Bottom Controls Bar -->
                <div class="bottom-controls" style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 20px; pointer-events: auto;">
                    
                    <!-- Progress Bar -->
                    <div style="margin-bottom: 16px;">
                        <div class="progress-container" style="width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; position: relative; cursor: pointer;" onclick="seekToPosition(event)">
                            <div id="progressBar" style="height: 100%; background: #ff4444; border-radius: 2px; width: 0%; transition: width 0.1s linear;"></div>
                            <div id="progressHandle" style="position: absolute; top: 50%; right: 0; transform: translate(50%, -50%); width: 14px; height: 14px; background: #ff4444; border: 2px solid white; border-radius: 50%; opacity: 0; transition: opacity 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>
                        </div>
                    </div>
                    
                    <!-- Control Buttons Row -->
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <!-- Left Side - Time Display -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="currentTimeDisplay" style="color: white; font-size: 13px; font-weight: 500; font-family: 'SF Mono', Monaco, monospace;">0:00</span>
                            <span style="color: rgba(255,255,255,0.5); font-size: 13px;">/</span>
                            <span id="durationDisplay" style="color: rgba(255,255,255,0.7); font-size: 13px; font-family: 'SF Mono', Monaco, monospace;">0:00</span>
                        </div>
                        
                        <!-- Center - Playback Controls -->
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div onclick="seekBackward()" style="width: 36px; height: 36px; border-radius: 8px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'" title="Seek backward 10s">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="white" stroke="none">
                                    <polygon points="11,19 2,12 11,5"></polygon>
                                    <polygon points="22,19 13,12 22,5"></polygon>
                                </svg>
                            </div>
                            <div onclick="seekForward()" style="width: 36px; height: 36px; border-radius: 8px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'" title="Seek forward 10s">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="white" stroke="none">
                                    <polygon points="13,19 22,12 13,5"></polygon>
                                    <polygon points="2,19 11,12 2,5"></polygon>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Right Side - Settings -->
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div onclick="toggleMute()" style="width: 36px; height: 36px; border-radius: 8px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                                <svg id="volumeIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="11,5 6,9 2,9 2,15 6,15 11,19"></polygon>
                                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                </svg>
                            </div>
                            <div onclick="toggleFullscreen()" style="width: 36px; height: 36px; border-radius: 8px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="white" stroke="none">
                                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Removed intrusive tap areas - users can use the clean buttons instead -->
            </div>
        </div>
        <!-- Video Info -->
        <div class="video-detail-info" style="padding: 20px; background: var(--bg-primary);">
            <div class="video-detail-info-grid">
                <div>
            <h1 id="detailVideoTitle" style="color: var(--text-primary); font-size: 20px; font-weight: 600; margin: 0 0 12px 0; line-height: 1.3;"></h1>
            
            <!-- Stats and Actions -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div id="detailVideoStats" style="color: var(--text-secondary); font-size: 14px;"></div>
                <div style="display: flex; gap: 16px;">
                    <button onclick="likeVideo()" style="background: var(--card-bg); border: 1px solid var(--border); color: var(--text-primary); display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 20px; cursor: pointer; transition: var(--transition);" onmouseover="this.style.background='var(--hover)'" onmouseout="this.style.background='var(--card-bg)'">
                        üëç <span id="likeCount">1.2K</span>
                    </button>
                    <button onclick="shareVideo()" style="background: var(--card-bg); border: 1px solid var(--border); color: var(--text-primary); display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 20px; cursor: pointer; transition: var(--transition);" onmouseover="this.style.background='var(--hover)'" onmouseout="this.style.background='var(--card-bg)'">
                        üì§ Share
                    </button>
                </div>
            </div>
            
            <!-- Channel Info -->
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding: 16px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px;">
                <img id="detailChannelAvatar" src="" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
                <div style="flex: 1;">
                    <div id="detailChannelName" style="color: var(--text-primary); font-size: 16px; font-weight: 500; margin-bottom: 4px;"></div>
                    <div id="detailChannelSubs" style="color: var(--text-secondary); font-size: 12px;"></div>
                </div>
                <button onclick="subscribeChannel()" style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 500; cursor: pointer; transition: var(--transition);" onmouseover="this.style.background='#ff3333'" onmouseout="this.style.background='#ff4444'">Subscribe</button>
            </div>
            
            <!-- Description -->
            <div style="background: #1a1a1a; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                <div id="detailVideoDescription" style="color: #ccc; font-size: 14px; line-height: 1.6;"></div>
            </div>
            
            <div id="commentsSection" style="background: #111; border-radius: 12px; padding: 16px;">
                <h3 id="commentsHeader" style="color: white; margin: 0 0 16px 0; font-size: 16px;">Comments</h3>
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=40&h=40&fit=crop&crop=face" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                    <input id="commentInput" type="text" placeholder="Add a comment..." style="flex: 1; background: #222; border: 1px solid #333; border-radius: 20px; padding: 10px 16px; color: white;">
                    <button id="commentPostBtn" style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px;">Post</button>
                </div>
                <div id="commentsList"></div>
                </div>
                </div>
                <aside class="suggestions-sidebar">
                    <div id="suggestedContainer" style="display:none;">
                        <h3 style="color:white;margin:0 0 12px 0;font-size:16px;">Suggested</h3>
                        <div id="suggestedList" class="suggestions-list"></div>
                    </div>
                </aside>
            </div>
            <!-- Place comments above suggestions -->
            <!-- BEGIN_INLINE_MOVED
            try {
                const infoEl = document.querySelector('.video-detail-info');
                const commentsEl = document.getElementById('commentsSection');
                const suggEl = document.getElementById('suggestedContainer');
                if (infoEl && commentsEl) {
                    infoEl.appendChild(commentsEl);
                }
                if (suggEl) suggEl.style.display = 'block';
            } catch {}
            END_INLINE_MOVED -->
            <!-- BEGIN_INLINE_MOVED: comments and suggested logic
            window.__comments = window.__comments || {};
            const listEl = document.getElementById('commentsList');
            const headerEl = document.getElementById('commentsHeader');
            const postBtn = document.getElementById('commentPostBtn');
            const inputEl = document.getElementById('commentInput');
            if (!window.__comments[video.id]) {
                window.__comments[video.id] = [
                    { user: '@sarah_creates', text: 'This is amazing content! Keep it up! üî•', ago: '2 hours ago', avatar: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=40&h=40&fit=crop&crop=face' },
                    { user: '@mike_dev', text: 'Really helpful tutorial, thanks for sharing!', ago: '5 hours ago', avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=40&h=40&fit=crop&crop=face' }
                ];
            }
            function renderComments() {
                const arr = window.__comments[video.id] || [];
                if (headerEl) headerEl.textContent = `Comments ‚Ä¢ ${arr.length}`;
                if (listEl) {
                    listEl.innerHTML = arr.map(c => `
                        <div style=\"display:flex; gap:12px; margin-bottom:16px;\">
                            <img src=\"${c.avatar}\" style=\"width:32px; height:32px; border-radius:50%; object-fit:cover;\">
                        <div>
                                <div style=\"color:white; font-size:13px; font-weight:500;\">${c.user}</div>
                                <div style=\"color:#ccc; font-size:14px; margin:4px 0;\">${c.text}</div>
                                <div style=\"color:#666; font-size:12px;\">${c.ago}</div>
                        </div>
                        </div>`).join('');
                }
            }
            renderComments();
            if (postBtn && inputEl) {
                postBtn.onclick = () => {
                    const text = (inputEl.value || '').trim();
                    if (!text) return;
                    (window.__comments[video.id] || []).unshift({ user: '@you', text, ago: 'just now', avatar: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=40&h=40&fit=crop&crop=face' });
                    inputEl.value = '';
                    renderComments();
                };
            }

            // Render suggested videos
            try {
                const list = document.getElementById('suggestedList');
                if (list) {
                    list.innerHTML = '';
                    let pool = (window.videoLibrary || []).filter(v => v.id !== video.id);
                    if (!pool.length) {
                        try {
                            document.querySelectorAll('#videoGrid .video-item').forEach((card, i) => {
                                if (i < 8) {
                                    const img = card.querySelector('img');
                                    const title = card.querySelector('h3');
                                    pool.push({ id: 'home-' + i, title: (title && title.textContent) || 'Video', thumbnail: (img && img.src) || '', views: 0, channel: { name: 'Creator' } });
                                }
                            });
                        } catch {}
                    }
                    pool.slice(0, 12).forEach(v => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-card';
                        item.onclick = () => openVideoDetail(v);
                        const thumb = v.thumbnailUrl || v.thumb || v.thumbnail || v.poster || v.image || 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&h=400&fit=crop';
                        const channelName = (v.channel && v.channel.name) || v.creator || 'Creator';
                        const channelAvatar = (v.channel && v.channel.avatar) || 'https://i.pravatar.cc/200?u='+(channelName.replace(/\s+/g,'_'));
                        item.innerHTML = `
                            <img class="thumb" src="${thumb}" alt="${v.title||''}" loading="lazy" onerror="this.src='https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&h=400&fit=crop'">
                            <div class="suggestion-meta">
                                <div class="suggestion-title">${v.title || 'Untitled'}</div>
                                <div class="suggestion-channel"><img src="${channelAvatar}"><span data-channel="${channelName}">${channelName}</span></div>
                                <div class="suggestion-views">${(v.views||0)} views</div>
                            </div>`;
                        list.appendChild(item);
                    });
                    // Wire channel name/avatars inside suggestions
                    list.querySelectorAll('.suggestion-channel [data-channel]').forEach(el => {
                        el.onclick = (e) => {
                            e.stopPropagation();
                            const name = el.getAttribute('data-channel') || 'channel';
                            openChannelDetail({ name, subs: Math.floor(Math.random()*100000)+1000, avatar: `https://i.pravatar.cc/200?u=${encodeURIComponent(name)}` });
                        };
                    });
                }
            } catch {}
            END_INLINE_MOVED -->
        </div>
    </div>

    <!-- Mini Player (hidden by default) -->
    <div id="miniPlayer" style="display:none; position: fixed; right: 16px; bottom: 92px; width: 320px; max-width: 90vw; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 12px 30px rgba(0,0,0,0.35); z-index: 10050;">
        <video id="miniVideo" style="width: 100%; height: 100%; object-fit: contain; background: #000;" playsinline webkit-playsinline x5-playsinline></video>
        <!-- Mini controls -->
        <div style="position:absolute; left:0; right:0; bottom:0; padding:8px; display:flex; align-items:center; justify-content:space-between; background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);">
            <div style="display:flex; gap:8px;">
                <button id="miniPlayBtn" style="width:32px; height:32px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.1); color:#fff; display:flex; align-items:center; justify-content:center;">‚ñ∂</button>
                <div id="miniTime" style="color:#fff; font-size:12px; font-family: 'SF Mono', Monaco, monospace; opacity:0.9;">0:00 / 0:00</div>
            </div>
            <div style="display:flex; gap:8px;">
                <button id="miniExpandBtn" style="width:32px; height:32px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.1); color:#fff; display:flex; align-items:center; justify-content:center;">‚§¢</button>
                <button id="miniCloseBtn" style="width:32px; height:32px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.1); color:#fff; display:flex; align-items:center; justify-content:center;">√ó</button>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="cameraInput" accept="image/*,video/*" capture="environment" style="display: none;" onchange="handleStoryUpload(this)">
    <input type="file" id="galleryInput" accept="image/*,video/*" style="display: none;" onchange="handleStoryUpload(this)">
    
    <!-- Custom Modal -->
    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <div id="modalIcon" class="modal-icon">‚ÑπÔ∏è</div>
            <div id="modalTitle" class="modal-title">Information</div>
            <div id="modalMessage" class="modal-message">This is a custom modal message.</div>
            <button class="modal-button" onclick="closeCustomModal()">Got it!</button>
        </div>
    </div>
    
    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        .tab-content {
            display: none;
            min-height: calc(100vh - 112px);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .profile-item {
            padding: 16px;
            background: #1a1a1a;
            margin-bottom: 1px;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
        }
        
        .profile-item:hover {
            background: #2a2a2a;
        }
        
        .profile-item:first-child {
            border-radius: 12px 12px 0 0;
        }
        
        .profile-item:last-child {
            border-radius: 0 0 12px 12px;
        }
        
        /* Video Player Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .video-controls-overlay:hover .progress-container #progressHandle {
            opacity: 1 !important;
        }
        
        #centerPlayButton:hover {
            background: rgba(255,255,255,0.25) !important;
        }
        
        #centerPlayButton:active {
            background: rgba(255,255,255,0.2) !important;
        }
        
        /* COMPLETELY HIDE ALL NATIVE VIDEO CONTROLS */
        video {
            outline: none !important;
        }
        
        video::-webkit-media-controls {
            display: none !important;
            -webkit-appearance: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }
        
        video::-webkit-media-controls-panel {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-play-button {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-start-playback-button {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-timeline {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-current-time-display {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-time-remaining-display {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-mute-button {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-toggle-closed-captions-button {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-volume-slider {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-fullscreen-button {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-enclosure {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-overlay-play-button {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-overlay-enclosure {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        /* Firefox Controls */
        video::-moz-media-controls {
            display: none !important;
        }
        
        /* Microsoft Edge */
        video::-ms-media-controls {
            display: none !important;
        }
        
        /* Force hide any controls that might appear */
        #detailVideoPlayer {
            pointer-events: auto !important;
        }
        
        /* Accessibility Focus Indicators */
        /* Reduce default focus outline to avoid iOS teal glow on inputs */
        *:focus { outline: none; }
        input[type="search"]:focus, input[type="text"]:focus { outline: none !important; box-shadow: none !important; }
        
        button:focus,
        [onclick]:focus,
        .nav-item:focus,
        .story-item:focus {
            outline: 2px solid #ff4444;
            outline-offset: 2px;
        }
        
        /* Screen Reader Only Text */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Skip to Content Link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #ff4444;
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 100000;
            border-radius: 4px;
        }
        .skip-link:focus {
            top: 6px;
        }
        
        /* Custom Modal System */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1a1a;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        
        .modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: white;
        }
        
        .modal-message {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 24px;
            line-height: 1.5;
        }
        .modal-button {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .modal-button:hover {
            background: #ff3333;
        }
        #detailVideoPlayer::-webkit-media-controls,
        #detailVideoPlayer::-webkit-media-controls-panel,
        #detailVideoPlayer::-webkit-media-controls-play-button,
        #detailVideoPlayer::-webkit-media-controls-start-playback-button,
        #detailVideoPlayer::-webkit-media-controls-timeline,
        #detailVideoPlayer::-webkit-media-controls-current-time-display,
        #detailVideoPlayer::-webkit-media-controls-time-remaining-display,
        #detailVideoPlayer::-webkit-media-controls-mute-button,
        #detailVideoPlayer::-webkit-media-controls-toggle-closed-captions-button,
        #detailVideoPlayer::-webkit-media-controls-volume-slider,
        #detailVideoPlayer::-webkit-media-controls-fullscreen-button,
        #detailVideoPlayer::-webkit-media-controls-enclosure,
        #detailVideoPlayer::-webkit-media-controls-overlay-play-button,
        #detailVideoPlayer::-webkit-media-controls-overlay-enclosure {
            display: none !important;
            -webkit-appearance: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            width: 0 !important;
            height: 0 !important;
        }
    </style>

    <script>
        // Enhanced Movie Integration with Fallback Data - Load immediately
        document.addEventListener('DOMContentLoaded', async () => {
            // Load all home sections immediately (original behavior)
            try { loadFreeMovies(); } catch {}
            try { loadTrending(); } catch {}
            try { initCategories(); } catch {}
            try { loadLiveTV(); } catch {}
            try { loadTopArtists(); } catch {}
            try { loadTopFilmmakers(); } catch {}
            try { loadTopChannels(); } catch {}

            // Reveal fade-ins on first paint
            requestAnimationFrame(() => {
                document.querySelectorAll('.fade-in').forEach(el => el.classList.add('visible'));
            });
        });
    </script>
    <script>
        // Firebase configuration - LIVE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBXy89aYxkfImhy6LYiAP-84DoZHY87ITY",
            authDomain: "mychannel-ca26d.firebaseapp.com",
            projectId: "mychannel-ca26d",
            storageBucket: "mychannel-ca26d.appspot.com",
            messagingSenderId: "124515086975",
            appId: "1:124515086975:ios:f3683f5fb93c02d2c3454a"
        };
        
        let auth, db, storage;
        
        async function initFirebase() {
            try {
                if (window.firebase && window.firebase.apps && window.firebase.apps.length) {
                    auth = firebase.auth();
                    db = firebase.firestore();
                    storage = firebase.storage();
                    return;
                }
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                try { await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); } catch {}
                auth = firebase.auth();
                try { await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); } catch {}
                db = firebase.firestore();
                try { storage = firebase.app().storage('gs://mychannel-ca26d.appspot.com'); } catch { storage = firebase.storage(); }
                
                // Wait for Firebase to be ready
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Firebase initialized successfully
                try {
                    if (!window.__authListenerBound) {
                        auth.onAuthStateChanged((user) => {
                            logAuth('onAuthStateChanged user=' + (user ? (user.uid || 'yes') : 'null'));
                            // On first signed-in detection, force a fresh load (no guest cache)
                            if (user && !user.isAnonymous) {
                                try { clearStoriesCache(); } catch {}
                            }
                            loadUserStories();
                            if (user && !user.isAnonymous) {
                                __redirectInProgress = false;
                                try { closeAuthModal(); } catch {}
                                const menu = document.getElementById('accountMenu');
                                if (menu) { menu.style.display = 'none'; }
                                const promo = document.getElementById('promoBanner');
                                if (promo) { promo.classList.add('hidden'); }
                                // Apply avatar immediately on login
                                try { applyAvatarToUI(user.photoURL); refreshStoriesForAvatar(); } catch {}
                            }
                            try { refreshAccountMenu(); } catch {}
                        });
                        window.__authListenerBound = true;
                    }
                } catch {}
            } catch (e) {
                console.error('Firebase init failed:', e?.message || e);
                throw e;
            }
        }

        let __redirectInProgress = false;

        async function ensureAuth() {
            await initFirebase();
            try {
                // Do not auto sign-in anonymously to avoid interfering with OAuth redirects
                return auth.currentUser || null;
            } catch (e) {
                console.warn('ensureAuth error', e);
                return auth.currentUser || null;
            }
        }

        async function loadCommunityPosts() {
            try {
                await initFirebase();
                const u = auth && auth.currentUser;
                const feed = document.getElementById('communityFeed');
                const input = document.getElementById('communityText');
                const btn = document.getElementById('communityPostBtn');
                if (btn && !btn.__bound) {
                    btn.__bound = true;
                    btn.addEventListener('click', async () => {
                        if (!u || u.isAnonymous) { alert('Sign in to post.'); return; }
                        const text = (input && input.value || '').trim();
                        if (!text) return;
                        await db.collection('community').add({ ownerId: u.uid, text, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                        input.value='';
                        loadCommunityPosts();
                    });
                }
                if (!feed) return;
                feed.innerHTML = '';
                if (!u || u.isAnonymous) return;
                const qs = await db.collection('community').where('ownerId','==',u.uid).orderBy('createdAt','desc').limit(50).get();
                qs.docs.forEach(d => {
                    const c = d.data();
                    const row = document.createElement('div');
                    row.style.cssText = 'background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;';
                    const ts = c.createdAt && c.createdAt.seconds ? new Date(c.createdAt.seconds*1000).toLocaleString() : '';
                    row.innerHTML = `<div style=\"font-size:12px;color:#999;\">${ts}</div><div style=\"margin-top:4px;\">${c.text||''}</div>`;
                    feed.appendChild(row);
                });
            } catch (e) { console.error('loadCommunityPosts failed', e); }
        }

        async function loadAboutAndHistory() {
            try {
                await initFirebase();
                const u = auth && auth.currentUser; if (!u || u.isAnonymous) return;
                const userSnap = await db.collection('users').doc(u.uid).get();
                const d = userSnap.exists ? userSnap.data() : {};
                const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = String(val ?? 0); };
                setText('aboutSubs', d.subscribers || 0);
                setText('aboutVids', d.videos || 0);
                setText('aboutViews', d.views || 0);
                const joined = u.metadata && u.metadata.creationTime ? new Date(u.metadata.creationTime).toLocaleDateString() : '‚Äî';
                const jEl = document.getElementById('aboutJoined'); if (jEl) jEl.textContent = joined;
                // History moved to persistent section below profile tabs
                const grid = document.getElementById('historyGrid');
                if (grid) {
                    grid.innerHTML='';
                    const qs = await db.collection('history').where('ownerId','==',u.uid).orderBy('ts','desc').limit(9).get();
                    qs.docs.forEach(d => {
                        const h = d.data();
                        const cell = document.createElement('div');
                        cell.style.cssText='background:#1a1a1a;border-radius:8px;overflow:hidden;height:90px;';
                        cell.innerHTML = `<img src=\"${h.thumbnailUrl||'/api/placeholder/160/90'}\" style=\"width:100%;height:100%;object-fit:cover;\">`;
                        grid.appendChild(cell);
                    });
                }
            } catch (e) { console.error('loadAboutAndHistory failed', e); }
        }

        function isSignedInNonAnonymous() {
            try { return !!(auth && auth.currentUser && !auth.currentUser.isAnonymous); } catch { return false; }
        }
        
        function showTab(tabName) {
            // Always close Flicks overlay when switching tabs
            try {
                const viewer = document.getElementById('flicksViewer');
                if (viewer && viewer.classList.contains('active')) {
                    try { document.querySelectorAll('#flicksContainer video').forEach(v => { try { v.pause(); } catch {}; try { v.removeAttribute('src'); v.load(); } catch {}; }); } catch {}
                    viewer.classList.remove('active');
                    document.body.style.overflow = '';
                }
            } catch {}
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-content').classList.add('active');
            
            // Activate corresponding nav item
            event.target.closest('.nav-item').classList.add('active');

            // Toggle profile-only history section
            try {
                const hist = document.getElementById('profile-history-persistent');
                if (hist) hist.style.display = (tabName === 'profile') ? 'block' : 'none';
            } catch {}
        }

        // Account menu toggle
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('accountButton');
            const menu = document.getElementById('accountMenu');
            if (btn && menu) {
                btn.addEventListener('click', async () => {
                    await ensureAuth();
                    refreshAccountMenu();
                    menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
                });
                document.addEventListener('click', (e) => {
                    if (!menu.contains(e.target) && e.target !== btn) menu.style.display = 'none';
                });
            }
        });

        async function refreshAccountMenu() {
            await initFirebase();
            const user = auth.currentUser;
            const nameEl = document.getElementById('accountName');
            const emailEl = document.getElementById('accountEmail');
            const so = document.getElementById('menuSignedOut');
            const si = document.getElementById('menuSignedIn');
            if (user && !user.isAnonymous) {
                nameEl.textContent = user.displayName || 'MyChannel User';
                emailEl.textContent = user.email || '';
                so.style.display = 'none';
                si.style.display = 'block';
                // Update avatar initial
                const btn = document.getElementById('accountButton');
                btn.textContent = (user.displayName || user.email || 'U')[0].toUpperCase();
            } else {
                nameEl.textContent = 'Guest';
                emailEl.textContent = 'Not signed in';
                so.style.display = 'block';
                si.style.display = 'none';
                document.getElementById('accountButton').textContent = 'K';
            }
        }
        function openAuthModal(mode) {
            const modal = document.getElementById('authModal');
            const title = document.getElementById('authTitle');
            const name = document.getElementById('authName');
            const helper = document.getElementById('authHelper');
            modal.style.display = 'flex';
            if (mode === 'signup') {
                title.textContent = 'Create account';
                name.style.display = 'block';
                helper.innerHTML = 'We\'ll email a verification link.';
                modal.dataset.mode = 'signup';
            } else {
                title.textContent = 'Sign in';
                name.style.display = 'none';
                helper.textContent = '';
                modal.dataset.mode = 'signin';
            }
            const appleBtn = document.getElementById('appleAuthBtn');
            if (appleBtn) { appleBtn.style.display = 'flex'; }
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }
        async function submitAuth() {
            await initFirebase();
            const mode = document.getElementById('authModal').dataset.mode || 'signin';
            const name = document.getElementById('authName').value.trim();
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            try {
                if (mode === 'signup') {
                    const cred = await auth.createUserWithEmailAndPassword(email, password);
                    await cred.user.updateProfile({ displayName: name });
                    await cred.user.sendEmailVerification();
                    await db.collection('users').doc(cred.user.uid).set({
                        displayName: name,
                        email,
                        createdAt: new Date()
                    });
                    closeAuthModal();
                    refreshAccountMenu();
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                    closeAuthModal();
                    refreshAccountMenu();
                }
            } catch (e) {
                alert(e?.message || 'Authentication failed');
            }
        }

        async function signOutUser() {
            await initFirebase();
            await auth.signOut();
            refreshAccountMenu();
        }

        function switchProfile() {
            openAuthModal('signin');
        }

        async function startResetPassword() {
            try {
                await initFirebase();
                const emailInput = document.getElementById('authEmail');
                const email = (emailInput?.value || '').trim();
                if (!email) {
                    alert('Enter your email above first.');
                    emailInput?.focus();
                    return;
                }
                await auth.sendPasswordResetEmail(email);
                alert('Password reset link sent. Check your email.');
            } catch (e) {
                alert(e?.message || 'Could not send reset email');
            }
        }
        // Studio
        async function openStudio() {
            await initFirebase();
            document.getElementById('studioModal').style.display = 'flex';
            // Pull quick stats
            try {
                const now = new Date();
                const since = new Date(now.getTime() - 24*60*60*1000);
                const stories24 = await db.collection('stories').where('createdAt','>', since).get();
                document.getElementById('studioStories').textContent = stories24.size.toLocaleString();
                let commentsCount = 0; let likesCount = 0;
                // For each story, aggregate comments and likes sizes (lightweight for demo)
                const promises = stories24.docs.slice(0,50).map(async d => {
                    const c = await db.collection('stories').doc(d.id).collection('comments').where('createdAt','>', since).get();
                    commentsCount += c.size;
                    const likes = d.data().likes || [];
                    likesCount += Array.isArray(likes) ? likes.length : 0;
                });
                await Promise.all(promises);
                document.getElementById('studioComments').textContent = commentsCount.toLocaleString();
                document.getElementById('studioLikes').textContent = likesCount.toLocaleString();
                // Active users (approx): unique userIds in 24h stories + commenters
                const userSet = new Set(stories24.docs.map(d=>d.data().userId));
                document.getElementById('studioActiveUsers').textContent = userSet.size.toLocaleString();
            } catch (e) {
                console.warn('Studio stats error', e);
            }
        }
        function closeStudio(){ document.getElementById('studioModal').style.display='none'; }

        // Edit profile flows
        async function openEditProfile() {
            await ensureAuth();
            const modal = document.getElementById('editProfileModal');
            const user = auth.currentUser;
            document.getElementById('profileDisplayName').value = user?.displayName || '';
            // Load existing profile doc for bio/banner
            try {
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists) {
                    const d = doc.data();
                    document.getElementById('profileBio').value = d.bio || '';
                    if (d.bannerUrl) {
                        document.getElementById('profileBannerVideoEl').src = d.bannerUrl;
                    }
                    if (d.avatarUrl) {
                        document.getElementById('profileAvatarEl').style.background = `url('${d.avatarUrl}') center/cover`;
                        try { applyAvatarToUI(d.avatarUrl); refreshStoriesForAvatar(); } catch {}
                    } else {
                        document.getElementById('profileAvatarEl').style.background = '#2a2a2a';
                    }
                    if (d.displayName) {
                        document.getElementById('profileDisplayNameEl').textContent = d.displayName;
                        const handle = (auth.currentUser?.email || 'user').split('@')[0];
                        document.getElementById('profileHandleEl').textContent = '@' + handle;
                    }
                    if (d.bio) {
                        document.getElementById('profileBioEl').textContent = d.bio;
                    }
                }
            } catch {}
            modal.style.display = 'flex';
        }

        function closeEditProfile() {
            document.getElementById('editProfileModal').style.display = 'none';
        }

        // Gating Profile actions for guests
        async function gateProfileForAuth() {
            try {
                await initFirebase();
                const user = auth.currentUser;
                const isGuest = !user || user.isAnonymous;
                const editBtn = document.getElementById('editProfileBtn');
                const settingsBtn = document.getElementById('profileSettingsBtn');
                if (isGuest) {
                    if (editBtn) { editBtn.textContent = 'Create account to edit'; editBtn.onclick = () => openAuthModal('signup'); }
                    if (settingsBtn) { settingsBtn.style.display = 'none'; }
                }
            } catch {}
        }

        async function saveProfile() {
            await ensureAuth();
            const user = auth.currentUser;
            const name = document.getElementById('profileDisplayName').value.trim();
            const bio = document.getElementById('profileBio').value.trim();
            const bannerFile = document.getElementById('profileBannerVideo').files[0];
            const avatarFile = document.getElementById('profileAvatar').files[0];
            let bannerUrl, avatarUrl;
            try {
                if (name && name !== user.displayName) {
                    await user.updateProfile({ displayName: name });
                }
                if (bannerFile) {
                    const ref = storage.ref().child(`profiles/${user.uid}/banner_${Date.now()}`);
                    await ref.put(bannerFile);
                    bannerUrl = await ref.getDownloadURL();
                    document.getElementById('profileBannerVideoEl').src = bannerUrl;
                }
                if (avatarFile) {
                    const refA = storage.ref().child(`profiles/${user.uid}/avatar_${Date.now()}`);
                    await refA.put(avatarFile);
                    avatarUrl = await refA.getDownloadURL();
                }
                await db.collection('users').doc(user.uid).set({
                    displayName: name || user.displayName || '',
                    bio,
                    bannerUrl: bannerUrl || firebase.firestore.FieldValue.delete(),
                    avatarUrl: avatarUrl || firebase.firestore.FieldValue.delete(),
                    updatedAt: new Date()
                }, { merge: true });
                // Reflect immediately
                if (name) document.getElementById('profileDisplayNameEl').textContent = name;
                if (bio) document.getElementById('profileBioEl').textContent = bio;
                if (avatarUrl) document.getElementById('profileAvatarEl').style.background = `url('${avatarUrl}') center/cover`;
                closeEditProfile();
            } catch (e) {
                alert(e?.message || 'Failed to save profile');
            }
        }
        
        // Custom Modal System
        function showCustomModal(title, message, icon = '‚ÑπÔ∏è') {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalIcon').textContent = icon;
            document.getElementById('customModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeCustomModal() {
            document.getElementById('customModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.id === 'customModal') {
                closeCustomModal();
            }
        });
        
        function showSignIn() {
            showCustomModal('Coming Soon!', 'Sign In feature is being developed and will be available soon!', 'üöÄ');
        }
        
        function showSettings() { try { openProfileSettings(); } catch { try { openStudio(); } catch {} } }
        
        function showHistory() {
            // History UI is only on Profile tab now
            showProfileTab('about');
        }
        
        function showLiked() {
            showCustomModal('Liked Videos', 'Liked Videos collection is coming soon!', 'üëç');
        }
        
        function showSignOut() {
            showCustomModal('Sign Out', 'Sign Out functionality is being implemented!', 'üö™');
        }
        
        function toggleSearchFilters(){ alert('Filters coming soon'); }
        function clearSearch(){ const input=document.querySelector('#search-content input[type="search"]'); if(!input) return; input.value=''; performSearch(''); const b=document.getElementById('searchClearBtn'); if(b) b.style.display='none'; }
        async function performSearch(query) {
            const resultsDiv = document.getElementById('search-results');
            if (!query || !query.trim()) {
                resultsDiv.innerHTML = `
                    <h3 style="color: #666; text-align: center; margin-top: 60px;">Search for videos, channels, and more</h3>
                    <div class="search-suggestions" style="margin-top: 40px;">
                        <h4 style="color: #ff4444; margin-bottom: 16px;">Trending Searches</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('gaming')">gaming</span>
                            <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('music')">music</span>
                            <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('tutorial')">tutorial</span>
                            <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('comedy')">comedy</span>
                        </div>
                    </div>
                `;
                const b=document.getElementById('searchClearBtn'); if(b) b.style.display='none';
                return;
            }
            let items = [];
            try { items = (Array.isArray(window.videoLibrary) ? window.videoLibrary.slice(0,20) : []).map(v=>({ id:v.id||v.title, title:v.title, views:v.views||0, createdAt: Date.now()-Math.random()*1e9 })); } catch {}
            let ranked = items;
            try {
                const r = await fetch('/api/ai_rank', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ items, user: { id: (window.auth && auth.currentUser && auth.currentUser.uid) || 'guest' } }) });
                if (r.ok) { const d = await r.json(); ranked = d.items || items; }
            } catch {}
            resultsDiv.innerHTML = `
                <h3 style=\"color: #ff4444; margin-bottom: 16px;\">Search Results for \"${query}\"</h3>
                <div style=\"display:flex; flex-direction:column; gap:12px;\">
                    ${ranked.map(item=>`
                        <div class=\\"video-card\\" style=\\"padding:10px;\\">
                            <div class=\\"video-info compact\\">
                                <div class=\\"video-text\\">
                                    <h3 class=\\"video-title\\">${item.title}</h3>
                                    <div class=\\"video-subtext\\"><span class=\\"views\\">${item.views||'‚Äî'} views</span></div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
            const b=document.getElementById('searchClearBtn'); if(b) b.style.display='block';
        }
        
        function searchFor(term) {
            document.querySelector('#search-content input').value = term;
            performSearch(term);
        }
        
        function showProfileTab(tabName) {
            // Hide all profile tab contents
            document.querySelectorAll('.profile-tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.style.color = '#666';
                const underline = tab.querySelector('div[style*="height:3px"]');
                if (underline) underline.style.display = 'none';
            });
            
            // Show selected tab content
            document.getElementById('profile-' + tabName + '-tab').style.display = 'block';
            document.getElementById('profile-' + tabName + '-tab').classList.add('active');
            
            // Activate selected tab
            const tabs = Array.from(document.querySelectorAll('.profile-tab'));
            const order = ['videos','flicks','playlists','community','about'];
            const idx = order.indexOf(tabName);
            const el = tabs[idx];
            if (el) {
                el.style.color = '#ff4444';
                const underline = el.querySelector('div[style*="height:3px"]');
                if (underline) underline.style.display = 'block';
            }

            // Lazy-load data for tabs
            if (tabName === 'community') { try { loadCommunityPosts(); } catch {} }
            if (tabName === 'about') { try { loadAboutAndHistory(); } catch {} }
            if (tabName === 'flicks') {
                try { const flicksEmpty = document.getElementById('flicksEmpty'); if (flicksEmpty) flicksEmpty.style.display = 'none'; } catch {}
                // Do not auto-open Flicks feed to avoid hijacking movie clicks
            }

            // Only show history section on profile view
            try {
                const hist = document.getElementById('profile-history-persistent');
                if (hist) hist.style.display = 'block';
            } catch {}
        }
        
        // Story Data
        const stories = [
            {
                username: 'sarah',
                avatar: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=100&h=100&fit=crop&crop=face',
                content: [
                    { type: 'image', url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=600&h=800&fit=crop', time: '2h' },
                    { type: 'image', url: 'https://images.unsplash.com/photo-1519904981063-b0cf448d479e?w=600&h=800&fit=crop', time: '1h' }
                ]
            },
            {
                username: 'mike',
                avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&h=100&fit=crop&crop=face',
                content: [
                    { type: 'image', url: 'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=600&h=800&fit=crop', time: '3h' }
                ]
            },
            {
                username: 'alex',
                avatar: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100&h=100&fit=crop&crop=face',
                content: [
                    { type: 'image', url: 'https://images.unsplash.com/photo-1426604966848-d7adac402bff?w=600&h=800&fit=crop', time: '4h' },
                    { type: 'image', url: 'https://images.unsplash.com/photo-1464822759844-d150baec93c5?w=600&h=800&fit=crop', time: '3h' }
                ]
            },
            {
                username: 'emma',
                avatar: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=100&h=100&fit=crop&crop=face',
                content: [
                    { type: 'image', url: 'https://images.unsplash.com/photo-1611095973362-87fa4ac9b4e1?w=600&h=800&fit=crop', time: '5h' }
                ]
            }
        ];
        let currentStoryIndex = 0;
        let currentStoryItemIndex = 0;
        let storyProgressInterval;
        
        // Story Functions
        async function addStory(useCamera = false) {
            // Remove any prior hidden pickers to avoid iOS sheet reappearing
            document.querySelectorAll('#tempStoryPicker').forEach(el => el.remove());
            if (!isSignedInNonAnonymous()) {
                openAuthModal('signin');
                return;
            }
            // Create the input synchronously and click immediately to preserve user gesture on iOS
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*';
            input.multiple = true;
            input.id = 'tempStoryPicker';
            input.style.display = 'none';
            // Prefer camera when available
            if (useCamera) { try { input.setAttribute('capture', 'environment'); } catch {} }
            document.body.appendChild(input);
            input.onchange = async (e) => {
                const files = Array.from(e.target.files || []);
                if (!files.length) { input.remove(); return; }
                try { await ensureAuth(); } catch {}
                await uploadStoriesFromFiles(files);
                await loadUserStories();
                input.remove();
            };
            // Trigger picker immediately within the tap event
            try { input.click(); } catch {}
        }
        // Story modal lifecycle
        let storyStream = null;
        function stopStoryCamera(){ try { if (storyStream) { storyStream.getTracks().forEach(t=>t.stop()); storyStream = null; } const v=document.getElementById('storyCamera'); if (v) { v.srcObject=null; v.src=''; } } catch {} }
        async function initStoryCamera(){
            try {
                const v = document.getElementById('storyCamera');
                if (!v) return;
                stopStoryCamera();
                const constraints = { video: { facingMode: 'environment' }, audio: false };
                storyStream = await navigator.mediaDevices.getUserMedia(constraints);
                v.srcObject = storyStream;
                await v.play().catch(()=>{});
            } catch (e) { console.warn('camera unavailable', e); }
        }
        function closeAddStoryModal() {
            try {
                document.getElementById('addStoryModal').style.display='none';
                document.getElementById('storyPostBtn').style.display='none';
                const canvas = document.getElementById('storyCanvas'); if (canvas) canvas.style.display='none';
                stopStoryCamera();
            } catch {}
        }
        function openAddStoryModal() {
            try {
                document.getElementById('addStoryModal').style.display='block';
                // wire gallery input once
                const gi = document.getElementById('storyGalleryInput');
                if (gi && !gi.__wired) {
                    gi.addEventListener('change', async (e)=>{
                        const f = e.target.files && e.target.files[0];
                        if (!f) return;
                        const v = document.getElementById('storyCamera');
                        const c = document.getElementById('storyCanvas');
                        if (f.type.startsWith('video/')) {
                            stopStoryCamera();
                            v.srcObject = null;
                            v.src = URL.createObjectURL(f);
                            v.loop = true; v.muted = true; await v.play().catch(()=>{});
                            c.style.display='none';
                        } else {
                            // image -> draw to canvas
                            const img = new Image();
                            img.onload = ()=>{ try { c.width = img.width; c.height = img.height; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height); c.style.display='block'; } catch {} };
                            img.src = URL.createObjectURL(f);
                        }
                    });
                    gi.__wired = true;
                }
                initStoryCamera();
            } catch {}
        }
        async function openCamera() { await addStory(true); }
        async function openGallery() { await addStory(false); }
        // Pro Story modal JS
        function storyFocusCamera(){ try{ document.getElementById('storyTextOverlay').style.display='none'; document.getElementById('storyCanvas').style.display='none'; initStoryCamera(); }catch{} }
        function toggleStoryText(){ try{ const el=document.getElementById('storyTextOverlay'); el.style.display = (el.style.display==='none'||!el.style.display)?'block':'none'; el.focus(); }catch{} }
        function addStorySticker(txt){ try{ const layer=document.getElementById('storyStickerLayer'); const span=document.createElement('div'); span.textContent=txt; span.style.cssText='position:absolute; left:50%; top:60%; transform:translate(-50%,-50%); font-size:32px;'; layer.appendChild(span);}catch{} }
        function captureStoryPhoto(){
            try{
                const canvas=document.getElementById('storyCanvas');
                const video=document.getElementById('storyCamera');
                const textEl=document.getElementById('storyTextOverlay');
                const stickerLayer=document.getElementById('storyStickerLayer');
                const w=video.videoWidth||1080, h=video.videoHeight||1920; canvas.width=w; canvas.height=h;
                const ctx=canvas.getContext('2d');
                // draw frame
                if (video.srcObject || video.src) { ctx.drawImage(video,0,0,w,h); }
                // draw text overlay if visible
                if (textEl && textEl.style.display!=='none' && textEl.textContent.trim().length){
                    ctx.save();
                    ctx.fillStyle = '#ffffff';
                    ctx.shadowColor = 'rgba(0,0,0,0.6)'; ctx.shadowBlur = 12;
                    // scale font relative to video height
                    const fontPx = Math.round(0.04 * h);
                    ctx.font = `bold ${fontPx}px -apple-system, BlinkMacSystemFont, Segoe UI, Roboto`;
                    ctx.textAlign = 'center';
                    ctx.fillText(textEl.textContent.trim(), w/2, h/2);
                    ctx.restore();
                }
                // draw simple emoji stickers
                if (stickerLayer){
                    const rect = stickerLayer.getBoundingClientRect();
                    Array.from(stickerLayer.children).forEach((node)=>{
                        try{
                            const b = node.getBoundingClientRect();
                            const cx = (b.left - rect.left + b.width/2) / rect.width * w;
                            const cy = (b.top - rect.top + b.height/2) / rect.height * h;
                            ctx.save();
                            ctx.font = `${Math.round(0.05*h)}px AppleColorEmoji, Segoe UI Emoji`;
                            ctx.textAlign='center';
                            ctx.fillText(node.textContent||'', cx, cy);
                            ctx.restore();
                        }catch{}
                    });
                }
                canvas.style.display='block';
                document.getElementById('storyPostBtn').style.display='inline-block';
            }catch(e){ console.warn('capture failed', e); }
        }
        async function shareCapturedStory(){
            try{
                const canvas=document.getElementById('storyCanvas');
                if (!canvas || canvas.style.display==='none') { captureStoryPhoto(); }
                const blob = await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.92));
                if (!blob) return;
                const file = new File([blob], `story_${Date.now()}.jpg`, { type: 'image/jpeg' });
                try { await ensureAuth(); } catch {}
                await initFirebase();
                await uploadStoriesFromFiles([file]);
                closeAddStoryModal();
                try { pushNotification('Story posted','Your story is live for 24h.'); } catch {}
                try { await loadUserStories(); } catch {}
            } catch(e){ console.error('share story failed', e); }
        }
        function openStoryCaption(){ try{ const t=prompt('Add a caption'); /* persist later */ }catch{} }
        function cycleStoryAudience(){ try{ const btn=document.getElementById('storyAudienceBtn'); btn.textContent = btn.textContent.includes('Public') ? 'üë• Friends' : 'üåê Public'; }catch{} }
        
        async function handleStoryUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            try {
                // Show loading
                showStoryUploadProgress();
                
                // Initialize Firebase
                await initFirebase();
                
                // For demo purposes, create a local URL and mock save to database
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        updateStoryUploadProgress(50);
                        
                        // Create story data with local URL for demo
                        const storyData = {
                            userId: 'keonta',
                            username: 'Keonta Peat',
                            avatar: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop&crop=face',
                            mediaUrl: e.target.result, // Local data URL for demo
                            mediaType: file.type.startsWith('video/') ? 'video' : 'image',
                            timestamp: new Date(),
                            expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000),
                            views: 0,
                            likes: []
                        };
                        
                        updateStoryUploadProgress(75);
                        
                        // Add to local stories array for immediate viewing
                        let userStory = firebaseStories.find(s => s.userId === 'keonta');
                        if (!userStory) {
                            userStory = {
                                userId: 'keonta',
                                username: 'Keonta Peat',
                                avatar: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop&crop=face',
                                content: []
                            };
                            firebaseStories.unshift(userStory);
                        }
                        
                        userStory.content.unshift({
                            id: 'story_' + Date.now(),
                            type: storyData.mediaType,
                            url: storyData.mediaUrl,
                            time: 'now',
                            views: 0,
                            likes: []
                        });
                        
                        console.log('Story added to firebaseStories:', firebaseStories);
                        
                        updateStoryUploadProgress(100);
                        
                        // Update UI
                        updateStoriesUI();
                        
                        hideStoryUploadProgress();
                        showSuccessMessage('Story posted! üî•');
                        
                        // Reset input
                        input.value = '';
                        
                    } catch (error) {
                        console.error('Error processing story:', error);
                        hideStoryUploadProgress();
                        showCustomModal('Upload Error', 'Error uploading story. Please try again.', '‚ùå');
                    }
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('Error uploading story:', error);
                hideStoryUploadProgress();
                showCustomModal('Upload Error', 'Error uploading story. Please try again.', '‚ùå');
            }
        }
        // New: upload multiple files to Storage and create Firestore story
        async function uploadStoriesFromFiles(files) {
            await ensureAuth();
            await initFirebase();
            try {
                showStoryUploadProgress();
                const user = auth.currentUser;
                const uploads = [];
                let completed = 0;
                for (const f of files) {
                    const id = `${user.uid}_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
                    const ref = storage.ref().child(`stories/${user.uid}/${id}`);
                    await ref.put(f);
                    const url = await ref.getDownloadURL();
                    uploads.push({ type: f.type.startsWith('video') ? 'video' : 'image', url });
                    completed += 1;
                    updateStoryUploadProgress((completed/files.length)*80);
                }
                const now = new Date();
                const expiresAt = new Date(now.getTime()+24*60*60*1000);
                await db.collection('stories').add({
                    userId: user.uid,
                    username: user.displayName || 'You',
                    avatar: 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG',
                    items: uploads,
                    createdAt: now,
                    timestamp: now,
                    expiresAt,
                    views: 0,
                    likes: [],
                });
                updateStoryUploadProgress(100);
                hideStoryUploadProgress();
                await loadUserStories();
            } catch (e) {
                console.error('uploadStoriesFromFiles failed', e);
                hideStoryUploadProgress();
            }
        }
        
        function viewStory(username, storyIndex) {
            currentStoryIndex = storyIndex;
            currentStoryItemIndex = 0;
            
            const story = stories[storyIndex];
            if (!story) return;
            
            document.getElementById('storyViewer').style.display = 'block';
            document.getElementById('storyUsername').textContent = story.username;
            document.getElementById('storyUserAvatar').src = story.avatar;
            
            showStoryItem();
            startStoryProgress();
            attachStoryRealtime();
        }
        
        function showStoryItem() {
            const story = stories[currentStoryIndex];
            const item = story.content[currentStoryItemIndex];
            
            document.getElementById('storyTime').textContent = item.time + ' ago';
            
            const image = document.getElementById('storyImage');
            const video = document.getElementById('storyVideo');
            
            if (item.type === 'image') {
                image.src = item.url;
                image.style.display = 'block';
                video.style.display = 'none';
            } else if (item.type === 'video') {
                video.src = item.url;
                video.style.display = 'block';
                image.style.display = 'none';
            }
        }
        
        function startStoryProgress() {
            clearInterval(storyProgressInterval);
            const progressBar = document.querySelector('.progress-fill');
            let progress = 0;
            
            storyProgressInterval = setInterval(() => {
                progress += 0.5;
                progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    nextStory();
                }
            }, 30); // 6 seconds total (100 / 0.5 * 30ms)
        }
        
        function nextStory() {
            const story = stories[currentStoryIndex];
            
            if (currentStoryItemIndex < story.content.length - 1) {
                currentStoryItemIndex++;
                showStoryItem();
                startStoryProgress();
            } else if (currentStoryIndex < stories.length - 1) {
                currentStoryIndex++;
                currentStoryItemIndex = 0;
                viewStory(stories[currentStoryIndex].username, currentStoryIndex);
            } else {
                closeStoryViewer();
            }
        }
        
        function previousStory() {
            if (currentStoryItemIndex > 0) {
                currentStoryItemIndex--;
                showStoryItem();
                startStoryProgress();
            } else if (currentStoryIndex > 0) {
                currentStoryIndex--;
                const prevStory = stories[currentStoryIndex];
                currentStoryItemIndex = prevStory.content.length - 1;
                viewStory(prevStory.username, currentStoryIndex);
            }
        }
        
        function closeStoryViewer() {
            document.getElementById('storyViewer').style.display = 'none';
            clearInterval(storyProgressInterval);
            
            // Reset progress bar
            const progressBar = document.querySelector('.progress-fill');
            if (progressBar) {
                progressBar.style.width = '0%';
            }
            
            // Clear video if playing
            const video = document.getElementById('storyVideo');
            if (video) {
                video.pause();
                video.currentTime = 0;
            }
            
            showNotification('Story closed', 'info');
        }

        // Enhanced keyboard support for stories
        function initStoryKeyboardSupport() {
            document.addEventListener('keydown', (e) => {
                const storyViewer = document.getElementById('storyViewer');
                if (storyViewer.style.display === 'block') {
                    switch (e.key) {
                        case 'Escape':
                            e.preventDefault();
                            closeStoryViewer();
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            previousStory();
                            break;
                        case 'ArrowRight':
                        case ' ':
                            e.preventDefault();
                            nextStory();
                            break;
                    }
                }
            });
        }
        
        // Firebase Integration Functions
        let firebaseStories = [];
        const STORIES_CACHE_KEY = 'mc_stories_cache_v1';
        const STORIES_CACHE_TTL_MS = 15 * 60 * 1000; // 15 minutes

        function getCachedStories() {
            try {
                const raw = localStorage.getItem(STORIES_CACHE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                if (!parsed || !Array.isArray(parsed.data)) return null;
                if (Date.now() - (parsed.ts || 0) > STORIES_CACHE_TTL_MS) return null;
                return parsed.data;
            } catch (e) { return null; }
        }

        function setCachedStories(data) {
            try {
                localStorage.setItem(STORIES_CACHE_KEY, JSON.stringify({ ts: Date.now(), data }));
            } catch (e) { /* ignore quota/private mode errors */ }
        }

        function clearStoriesCache() {
            try { localStorage.removeItem(STORIES_CACHE_KEY); } catch (e) {}
        }

        function primeStoriesFromCache() {
            const cached = getCachedStories();
            if (cached && cached.length) {
                firebaseStories = cached;
                try { updateStoriesUI(); } catch (e) { console.log('prime cache render failed', e); }
            }
        }
        function buildMockStoriesFromAssets() {
            return [
                {
                    userId: 'luh_monti45',
                    username: 'luh_monti45',
                    avatar: 'assets/472855250_1416699136402148_2912796090052603733_n.imageset/472855250_1416699136402148_2912796090052603733_n.jpg',
                    content: [ { id: 'm1', type: 'image', url: 'assets/470923123_18158490016332148_6477017450217403765_n.imageset/470923123_18158490016332148_6477017450217403765_n.jpg', time: '2h' } ]
                },
                {
                    userId: 'geefrm2800',
                    username: 'geefrm2800',
                    avatar: 'assets/475835447_675201954830347_1756031358478369730_n.imageset/475835447_675201954830347_1756031358478369730_n.jpg',
                    content: [ { id: 'm2', type: 'image', url: 'assets/466399531_2282738375443632_7939875496433451873_n.imageset/466399531_2282738375443632_7939875496433451873_n.jpg', time: '3h' } ]
                },
                {
                    userId: 'reformedscumbag',
                    username: 'reformedscumbag',
                    avatar: 'assets/481160706_665641712649483_7487614386252000095_n.imageset/481160706_665641712649483_7487614386252000095_n.jpg',
                    content: [ { id: 'm3', type: 'image', url: 'assets/481384467_18341497597158210_3083149182286552212_n.imageset/481384467_18341497597158210_3083149182286552212_n.jpg', time: '4h' } ]
                },
                {
                    userId: 'rmc__mike',
                    username: 'rmc__mike',
                    avatar: 'assets/334320756_533260078924966_5316833915723430997_n.imageset/334320756_533260078924966_5316833915723430997_n.jpg',
                    content: [ { id: 'm4', type: 'image', url: 'assets/472392893_18252867850302322_7284995541774475779_n.imageset/472392893_18252867850302322_7284995541774475779_n.jpg', time: '5h' } ]
                },
                {
                    userId: 'bighornetpro',
                    username: 'bighornetpro',
                    avatar: 'assets/426685704_792648982704647_967197470146596162_n.imageset/426685704_792648982704647_967197470146596162_n.jpg',
                    content: [ { id: 'm5', type: 'image', url: 'assets/129075787_113795503889280_2510749229606017551_n.imageset/129075787_113795503889280_2510749229606017551_n.jpg', time: '6h' } ]
                },
                {
                    userId: '3200tre',
                    username: '3200tre',
                    avatar: 'assets/462248242_560040823136600_3556568014350287952_n.imageset/462248242_560040823136600_3556568014350287952_n.jpg',
                    content: [ { id: 'm6', type: 'image', url: 'assets/475362444_18498481846042375_7590792999184552048_n.imageset/475362444_18498481846042375_7590792999184552048_n.jpg', time: '7h' } ]
                },
                {
                    userId: 'freeemweemseeemleaveem',
                    username: 'freeemweemseeemleaveem',
                    avatar: 'assets/457371595_1235198240853217_1778504049849463165_n.imageset/457371595_1235198240853217_1778504049849463165_n.jpg',
                    content: [ { id: 'm7', type: 'image', url: 'assets/465660700_1797636381041731_4081532569943287856_n.imageset/465660700_1797636381041731_4081532569943287856_n.jpg', time: '8h' } ]
                },
                {
                    userId: 'scatzripky6',
                    username: 'scatzripky6',
                    avatar: 'assets/481403833_944554144430511_4402918744878259452_n.imageset/481403833_944554144430511_4402918744878259452_n.jpg',
                    content: [ { id: 'm8', type: 'image', url: 'assets/469432783_1093903885799534_1724252623959748153_n.imageset/469432783_1093903885799534_1724252623959748153_n.jpg', time: '9h' } ]
                }
            ];
        }
        async function loadUserStories() {
            try {
                if (!window.firebase || !window.firebase.apps.length) {
                    await initFirebase();
                }
                const isGuest = !(auth && auth.currentUser) || !!(auth && auth.currentUser && auth.currentUser.isAnonymous);
                const cached = getCachedStories();
                if (isGuest) {
                    // Guests: allow cached (or assets) immediately to avoid blank UI
                    if (Array.isArray(cached) && cached.length) {
                        firebaseStories = cached;
                        updateStoriesUI();
                    } else {
                        firebaseStories = buildMockStoriesFromAssets();
                        updateStoriesUI();
                        setCachedStories(firebaseStories);
                    }
                    return;
                }
                // Signed-in: never show guest cache first
                try { clearStoriesCache(); } catch {}
                
                const db = firebase.firestore();
                const now = new Date();
                
                // Get stories from last 24 hours
                const storiesSnapshot = await db.collection('stories')
                    .where('expiresAt', '>', now)
                    .orderBy('expiresAt')
                    .get();
                
                // Group stories by user
                const userStories = {};
                storiesSnapshot.forEach(doc => {
                    const story = { id: doc.id, ...doc.data() };
                    const userId = story.userId;
                    
                    if (!userStories[userId]) {
                        userStories[userId] = {
                            username: story.username,
                            avatar: story.avatar,
                            content: []
                        };
                    }
                    
                    const items = Array.isArray(story.items) && story.items.length ? story.items : [{ type:story.mediaType, url:story.mediaUrl }];
                    items.forEach((it, idx) => {
                    userStories[userId].content.push({
                            id: `${story.id}_${idx}`,
                            type: it.type,
                            url: it.url,
                            time: formatTimeAgo(story.createdAt?.toDate?.() || new Date()),
                        views: story.views || 0,
                        likes: story.likes || []
                        });
                    });
                });
                
                // Update global stories array; for signed-in sessions do NOT seed mocks
                const keys = Object.keys(userStories);
                firebaseStories = keys.length > 0
                    ? keys.map(userId => ({ userId, ...userStories[userId] }))
                    : [];
                
                // Update UI and cache for signed-in context
                updateStoriesUI();
                setCachedStories(firebaseStories);
                
            } catch (error) {
                console.error('Error loading stories:', error);
                // On error: guests see assets; signed-in sees empty
                if (!firebaseStories || !firebaseStories.length) {
                    if (isGuest) {
                        firebaseStories = buildMockStoriesFromAssets();
                    } else {
                        firebaseStories = [];
                    }
                    updateStoriesUI();
                }
            }
        }
        async function updateStoriesUI() {
            const storiesContainer = document.querySelector('.stories-container');
            if (!storiesContainer) {
                console.log('Stories container not found');
                return;
            }
            
            console.log('Updating stories UI with:', firebaseStories);
            
            // Clear all stories
            storiesContainer.innerHTML = '';
            
            // Add "Your Story" button - check if user has stories
            const currentUserId = (auth && auth.currentUser && auth.currentUser.uid) || '__guest__';
            const userHasStories = firebaseStories.find(s => s.userId === currentUserId);
            console.log('User has stories:', userHasStories);
            
            const addStoryElement = document.createElement('div');
            addStoryElement.className = 'story-item';
            const handleAddStoryTap = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (!isSignedInNonAnonymous()) {
                    openAuthModal('signin');
                    return false;
                }
                if (userHasStories && userHasStories.content.length > 0) {
                    const userIndex = firebaseStories.findIndex(s => s.userId === currentUserId);
                    viewStory('You', userIndex);
                } else {
                    openAddStoryModal();
                }
                return false;
            };
            addStoryElement.onclick = handleAddStoryTap;
            addStoryElement.addEventListener('touchend', handleAddStoryTap, { passive: false });
            
            if (userHasStories) {
                addStoryElement.innerHTML = `
                    <div class="story-ring active-story">
                        <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop&crop=face" alt="Your Story">
                    </div>
                    <span>Your Story</span>
                `;
            } else {
                addStoryElement.innerHTML = `
                    <div class="story-ring add-story">
                        <div class="add-story-plus">+</div>
                    </div>
                    <span>Your Story</span>
                `;
            }
            
            storiesContainer.appendChild(addStoryElement);

            // Ensure your story tile (if exists) shows avatar
            if (auth && auth.currentUser) {
                try {
                    const dbLocal = (typeof firebase !== 'undefined' && firebase.firestore) ? firebase.firestore() : null;
                    if (dbLocal) {
                        const doc = await dbLocal.collection('users').doc(auth.currentUser.uid).get();
                        const avatarUrl = doc.exists && doc.data().avatarUrl;
                        const imgEl = addStoryElement.querySelector('div.story-ring.active-story img');
                        if (avatarUrl && imgEl) {
                            imgEl.src = avatarUrl;
                        }
                    }
                } catch (e) { console.warn('avatar fetch skipped', e?.message); }
            }
            
            // Add other users' stories
            firebaseStories.filter(s => s.userId !== currentUserId).forEach((story, index) => {
                const storyElement = document.createElement('div');
                storyElement.className = 'story-item';
                const actualIndex = firebaseStories.findIndex(s => s.userId === story.userId);
                storyElement.onclick = () => viewStory(story.username, actualIndex);
                
                storyElement.innerHTML = `
                    <div class="story-ring active-story">
                        <img src="${story.avatar}" alt="Story">
                    </div>
                    <span>${story.username}</span>
                `;
                
                storiesContainer.appendChild(storyElement);
            });
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor(diffMs / (1000 * 60));
            
            if (diffHours > 0) return diffHours + 'h';
            if (diffMins > 0) return diffMins + 'm';
            return 'now';
        }
        
        // Updated viewStory to use Firebase stories
        function viewStory(username, storyIndex) {
            console.log('viewStory called:', username, storyIndex, firebaseStories);
            currentStoryIndex = storyIndex;
            currentStoryItemIndex = 0;
            
            const story = firebaseStories[storyIndex] || stories[storyIndex];
            console.log('Selected story:', story);
            
            if (!story || !story.content || story.content.length === 0) {
                console.log('No story content found');
                return;
            }
            
            document.getElementById('storyViewer').style.display = 'block';
            document.getElementById('storyUsername').textContent = story.username;
            document.getElementById('storyUserAvatar').src = story.avatar;
            
            showStoryItem();
            startStoryProgress();
        }
        
        function showStoryItem() {
            const story = firebaseStories[currentStoryIndex] || stories[currentStoryIndex];
            const item = story.content[currentStoryItemIndex];
            
            console.log('showStoryItem:', story, item);
            
            document.getElementById('storyTime').textContent = item.time + ' ago';
            
            const image = document.getElementById('storyImage');
            const video = document.getElementById('storyVideo');
            
            // Reset both elements
            image.style.display = 'none';
            video.style.display = 'none';
            image.src = '';
            video.src = '';
            
            if (item.type === 'image' || (item.type && item.type.startsWith('image/'))) {
                console.log('Showing image:', item.url);
                image.src = item.url;
                image.style.display = 'block';
                image.onload = () => console.log('Image loaded successfully');
                image.onerror = (e) => console.error('Image failed to load:', e);
            } else if (item.type === 'video' || (item.type && item.type.startsWith('video/'))) {
                console.log('Showing video:', item.url);
                video.src = item.url;
                video.style.display = 'block';
                video.onloadeddata = () => console.log('Video loaded successfully');
                video.onerror = (e) => console.error('Video failed to load:', e);
            }
        }
        // Realtime likes/comments for current story
        let commentsUnsub = null;
        async function attachStoryRealtime() {
            if (commentsUnsub) commentsUnsub();
            await initFirebase();
            const storyOwner = firebaseStories[currentStoryIndex];
            const item = storyOwner?.content?.[currentStoryItemIndex];
            if (!storyOwner || !item) return;
            const storyDoc = await db.collection('stories').where('userId','==',storyOwner.userId).limit(1).get();
            if (storyDoc.empty) return;
            const docId = storyDoc.docs[0].id;
            commentsUnsub = db.collection('stories').doc(docId).collection('comments')
                .orderBy('createdAt','desc').limit(25)
                .onSnapshot(snap => {
                    const list = document.getElementById('storyComments');
                    if (!list) return;
                    list.innerHTML='';
                    snap.forEach(d => {
                        const c = d.data();
                        const el = document.createElement('div');
                        el.style.cssText = 'display:flex; gap:8px; align-items:center; color:#fff;';
                        el.innerHTML = `<div style="width:24px;height:24px;border-radius:50%;background:rgba(255,255,255,0.2);"></div>
                                         <div style="font-size:13px;opacity:0.9;">${(c.userName||'User')}: ${c.text}</div>`;
                        list.appendChild(el);
                    });
                });
        }

        // Like + Comment actions
        document.addEventListener('click', async (e) => {
            if (e.target && e.target.id === 'storySendBtn') {
                const input = document.getElementById('storyCommentInput');
                const text = input.value.trim();
                if (!text) return;
                await ensureAuth(); await initFirebase();
                const storyOwner = firebaseStories[currentStoryIndex];
                const q = await db.collection('stories').where('userId','==',storyOwner.userId).limit(1).get();
                if (!q.empty) {
                    await db.collection('stories').doc(q.docs[0].id).collection('comments').add({
                        userId: auth.currentUser.uid,
                        userName: auth.currentUser.displayName || 'User',
                        text,
                        createdAt: new Date()
                    });
                }
                input.value='';
            }
            if (e.target && e.target.id === 'storyLikeBtn') {
                await ensureAuth(); await initFirebase();
                const storyOwner = firebaseStories[currentStoryIndex];
                const q = await db.collection('stories').where('userId','==',storyOwner.userId).limit(1).get();
                if (!q.empty) {
                    const ref = db.collection('stories').doc(q.docs[0].id);
                    await ref.update({ likes: firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid) });
                }
            }
        });
        // UI Helper Functions
        function showStoryUploadProgress() { /* overlay disabled for guest-gated flow */ }
        
        function updateStoryUploadProgress(progress) {
            const progressBar = document.getElementById('uploadProgress');
            const percentage = document.getElementById('uploadPercentage');
            if (progressBar) progressBar.style.width = progress + '%';
            if (percentage) percentage.textContent = Math.round(progress) + '%';
        }
        
        function hideStoryUploadProgress() {}
        
        function showSuccessMessage(message) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #1a1a1a; color: white; padding: 16px 24px; border-radius: 8px;
                z-index: 10003; font-size: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            modal.textContent = message;
            document.body.appendChild(modal);
            
            setTimeout(() => modal.remove(), 3000);
        }
        // Video Library - Free videos for new users
        const videoLibrary = [
            {
                id: 'vid1',
                title: 'Amazing Nature Documentary - Wildlife in 4K',
                description: 'Experience the beauty of nature with this stunning 4K wildlife documentary. From majestic mountains to serene oceans, discover the incredible diversity of our planet.',
                thumbnail: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                duration: '9:56',
                views: '2.1M',
                uploadTime: '3 days ago',
                channel: {
                    name: 'Nature Explorer',
                    avatar: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=100&h=100&fit=crop&crop=face',
                    subscribers: '1.2M'
                },
                likes: 45000
            },
            {
                id: 'vid2', 
                title: 'Epic Travel Vlog - Exploring Hidden Gems',
                description: 'Join me on an incredible journey to discover hidden gems around the world. From secret beaches to mountain villages, adventure awaits!',
                thumbnail: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4',
                duration: '12:34',
                views: '1.8M',
                uploadTime: '1 week ago',
                channel: {
                    name: 'Adventure Seeker',
                    avatar: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=100&h=100&fit=crop&crop=face',
                    subscribers: '850K'
                },
                likes: 38000
            },
            {
                id: 'vid3',
                title: 'Ultimate Cooking Masterclass - Professional Techniques',
                description: 'Learn professional cooking techniques from a master chef. Perfect your knife skills, master seasoning, and create restaurant-quality dishes at home.',
                thumbnail: 'https://images.unsplash.com/photo-1556909114-4f6e8407730d?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4',
                duration: '15:22',
                views: '3.2M',
                uploadTime: '5 days ago',
                channel: {
                    name: 'Chef Masters',
                    avatar: 'https://images.unsplash.com/photo-1556909114-4f6e8407730d?w=100&h=100&fit=crop&crop=face',
                    subscribers: '2.1M'
                },
                likes: 67000
            },
            {
                id: 'vid4',
                title: 'Tech Review - Latest Gadgets You Need to See',
                description: 'Comprehensive review of the latest tech gadgets hitting the market. Unboxing, testing, and honest opinions on what\'s worth your money.',
                thumbnail: 'https://images.unsplash.com/photo-1518717758536-85ae29035b6d?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerEscapes.mp4',
                duration: '8:45',
                views: '950K',
                uploadTime: '2 days ago',
                channel: {
                    name: 'Tech Insider',
                    avatar: 'https://images.unsplash.com/photo-1518717758536-85ae29035b6d?w=100&h=100&fit=crop&crop=face',
                    subscribers: '750K'
                },
                likes: 25000
            },
            {
                id: 'vid5',
                title: 'Fitness Transformation - 30 Day Challenge Results',
                description: 'See incredible transformation results from a 30-day fitness challenge. Workout routines, nutrition tips, and motivation to help you reach your goals.',
                thumbnail: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerFun.mp4',
                duration: '11:18',
                views: '1.4M',
                uploadTime: '1 day ago',
                channel: {
                    name: 'Fit Life',
                    avatar: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=100&h=100&fit=crop&crop=face',
                    subscribers: '920K'
                },
                likes: 34000
            },
            {
                id: 'vid6',
                title: 'Music Production Tutorial - Beat Making Basics',
                description: 'Learn the fundamentals of music production and beat making. From basic rhythm patterns to advanced mixing techniques.',
                thumbnail: 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4',
                duration: '14:07',
                views: '780K',
                uploadTime: '4 days ago',
                channel: {
                    name: 'Beat Makers',
                    avatar: 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=100&h=100&fit=crop&crop=face',
                    subscribers: '650K'
                },
                likes: 19000
            },
            {
                id: 'vid7',
                title: 'Sintel - Open Movie',
                description: 'Award-winning animated short film produced by the Blender Institute.',
                thumbnail: 'https://images.unsplash.com/photo-1529101091764-c3526daf38fe?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4',
                duration: '14:48',
                views: '5.4M',
                uploadTime: '2 weeks ago',
                channel: {
                    name: 'Blender Studio',
                    avatar: 'https://images.unsplash.com/photo-1511367461989-f85a21fda167?w=100&h=100&fit=crop&crop=face',
                    subscribers: '1.1M'
                },
                likes: 120000
            },
            {
                id: 'vid8',
                title: 'Tears of Steel - Sci-Fi Short',
                description: 'A high-quality sci-fi short with epic VFX and a dramatic storyline.',
                thumbnail: 'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4',
                duration: '12:14',
                views: '3.8M',
                uploadTime: '1 month ago',
                channel: {
                    name: 'Open Movies',
                    avatar: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=100&h=100&fit=crop&crop=face',
                    subscribers: '890K'
                },
                likes: 86000
            },
            {
                id: 'vid9',
                title: 'Offroad Drive - Subaru Outback',
                description: 'A cinematic drive through street and dirt to test the limits of the Outback.',
                thumbnail: 'https://images.unsplash.com/photo-1502877338535-766e1452684a?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/SubaruOutbackOnStreetAndDirt.mp4',
                duration: '2:12',
                views: '1.2M',
                uploadTime: '6 days ago',
                channel: {
                    name: 'Auto Motion',
                    avatar: 'https://images.unsplash.com/photo-1519340333755-5063a2421801?w=100&h=100&fit=crop&crop=face',
                    subscribers: '410K'
                },
                likes: 22000
            },
            {
                id: 'vid10',
                title: 'For Bigger Meltdowns - Comedy Short',
                description: 'A quick, funny short that shows what happens when things heat up.',
                thumbnail: 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerMeltdowns.mp4',
                duration: '1:00',
                views: '640K',
                uploadTime: '5 days ago',
                channel: {
                    name: 'Shorts Central',
                    avatar: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop&crop=face',
                    subscribers: '300K'
                },
                likes: 14000
            }
        ];
        
        // Load videos into the grid
        function loadVideos() {
            const videoGrid = document.getElementById('videoGrid');
            if (!videoGrid) return;
            videoGrid.innerHTML = '';
            videoLibrary.forEach(video => {
                const videoCard = document.createElement('div');
                videoCard.className = 'video-item';
                const thumb = video.thumbnailUrl || video.thumbnail || video.thumb || video.poster || video.image || 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&h=400&fit=crop';
                videoCard.innerHTML = `
                    <div class="video-thumbnail">
                        <img src="${thumb}" alt="${video.title}" loading="lazy" onerror="this.src='https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&h=400&fit=crop'">
                    </div>
                        <div class="video-details">
                            <h3>${video.title}</h3>
                        <p class="video-meta">${(video.views||0)} views ‚Ä¢ ${video.uploadTime}</p>
                    </div>
                `;
                videoCard.onclick = () => openVideoDetail(video);
                videoGrid.appendChild(videoCard);
            });
        }
        
        // Global video player state
        let currentVideo = null;
        let controlsTimeout = null;
        let isVideoPlaying = false;
        
        // Video Detail Functions
        function openVideoDetail(video) {
            // Opening video detail view
            currentVideo = video;
            
            // Set video data
            const videoPlayer = document.getElementById('detailVideoPlayer');
            document.getElementById('detailVideoTitle').textContent = video.title;
            document.getElementById('topBarVideoTitle').textContent = video.title;
            document.getElementById('detailVideoStats').textContent = `${video.views} views ‚Ä¢ ${video.uploadTime}`;
            document.getElementById('detailChannelAvatar').src = video.channel.avatar;
            document.getElementById('detailChannelName').textContent = video.channel.name;
            document.getElementById('detailChannelSubs').textContent = `${video.channel.subscribers} subscribers`;
            document.getElementById('detailVideoDescription').textContent = video.description;
            // Move comments section under info and wire comments logic
            try {
                const infoEl = document.querySelector('.video-detail-info');
                const primaryCol = document.querySelector('.video-detail-info-grid > div:first-child') || infoEl;
                const commentsEl = document.getElementById('commentsSection');
                const suggEl = document.getElementById('suggestedContainer');
                if (primaryCol && commentsEl && commentsEl.parentElement !== primaryCol) {
                    primaryCol.appendChild(commentsEl);
                }
                if (suggEl) suggEl.style.display = 'block';
            } catch (e) {}

            // Comments logic (previously inline)
            try {
                window.__comments = window.__comments || {};
                const listEl = document.getElementById('commentsList');
                const headerEl = document.getElementById('commentsHeader');
                const postBtn = document.getElementById('commentPostBtn');
                const inputEl = document.getElementById('commentInput');
                if (!window.__comments[video.id]) {
                    window.__comments[video.id] = [
                        { user: '@sarah_creates', text: 'This is amazing content! Keep it up! üî•', ago: '2 hours ago', avatar: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=40&h=40&fit=crop&crop=face' },
                        { user: '@mike_dev', text: 'Really helpful tutorial, thanks for sharing!', ago: '5 hours ago', avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=40&h=40&fit=crop&crop=face' }
                    ];
                }
                function renderComments() {
                    const arr = window.__comments[video.id] || [];
                    if (headerEl) headerEl.textContent = `Comments ‚Ä¢ ${arr.length}`;
                    if (listEl) {
                        listEl.innerHTML = arr.map(c => `
                            <div style=\"display:flex; gap:12px; margin-bottom:16px;\">
                                <img src=\"${c.avatar}\" data-channel=\"${(c.user||'').replace('@','')}\" style=\"width:32px; height:32px; border-radius:50%; object-fit:cover; cursor:pointer;\">
                                <div>
                                    <div style=\"color:white; font-size:13px; font-weight:500;\"><span data-channel=\"${(c.user||'').replace('@','')}\" style=\"cursor:pointer;\">${c.user}</span></div>
                                    <div style=\"color:#ccc; font-size:14px; margin:4px 0;\">${c.text}</div>
                                    <div style=\"color:#666; font-size:12px;\">${c.ago}</div>
                                </div>
                            </div>`).join('');
                        // Wire avatar/name click to channel sheet
                        listEl.querySelectorAll('[data-channel]').forEach(el => {
                            el.onclick = () => {
                                const name = el.getAttribute('data-channel') || 'channel';
                                openChannelDetail({ name, subs: Math.floor(Math.random()*100000)+1000, avatar: `https://i.pravatar.cc/200?u=${encodeURIComponent(name)}` });
                            };
                        });
                    }
                }
                renderComments();
                if (postBtn && inputEl) {
                    postBtn.onclick = () => {
                        const text = (inputEl.value || '').trim();
                        if (!text) return;
                        (window.__comments[video.id] || []).unshift({ user: '@you', text, ago: 'just now', avatar: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=40&h=40&fit=crop&crop=face' });
                        inputEl.value = '';
                        renderComments();
                    };
                }
            } catch (e) {}
            // Render suggested videos
            try {
                let container = document.getElementById('suggestedContainer');
                if (!container) {
                    const info = document.querySelector('.video-detail-info');
                    if (info) {
                        container = document.createElement('div');
                        container.id = 'suggestedContainer';
                        container.style.marginTop = '20px';
                        container.innerHTML = '<h3 style="color:white;margin:0 0 12px 0;font-size:16px;">Suggested videos</h3><div id="suggestedList" style="display:grid;grid-template-columns:1fr;gap:12px;"></div>';
                        info.insertBefore(container, info.querySelector('.comments-list') || null);
                    }
                }
                const list = document.getElementById('suggestedList');
                if (list) {
                    list.innerHTML = '';
                    let pool = (window.videoLibrary || []).filter(v => v.id !== video.id);
                    if (!pool.length) {
                        // Fallback: scrape current home grid thumbnails/titles
                        try {
                            document.querySelectorAll('#videoGrid .video-item').forEach((card, i) => {
                                if (i < 8) {
                                    const img = card.querySelector('img');
                                    const title = card.querySelector('h3');
                                    pool.push({
                                        id: 'home-' + i,
                                        title: (title && title.textContent) || 'Video',
                                        thumbnail: (img && img.src) || '',
                                        views: 0,
                                        channel: { name: 'Creator' }
                                    });
                                }
                            });
                        } catch {}
                    }
                    pool.slice(0, 8).forEach(v => {
                        const row = document.createElement('div');
                        row.style.cssText = 'display:flex; gap:12px; cursor:pointer;';
                        row.onclick = () => openVideoDetail(v);
                        const thumb = v.thumbnailUrl || v.thumb || v.thumbnail || v.poster || v.image || 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&h=400&fit=crop';
                        row.innerHTML = `
                            <img src="${thumb}" alt="${v.title||''}" loading="lazy" style="width:160px; height:90px; object-fit:cover; border-radius:8px;" onerror="this.src='https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&h=400&fit=crop'">
                            <div style=\"flex:1; min-width:0;\">
                                <div style=\"color:#fff; font-size:14px; font-weight:600; line-height:1.3;\">${v.title || 'Untitled'}</div>
                                <div style=\"color:#aaa; font-size:12px; margin-top:4px;\">${(v.channel && v.channel.name) || v.creator || 'Creator'}</div>
                                <div style=\"color:#666; font-size:12px; margin-top:2px;\">${v.views || 0} views</div>
                            </div>`;
                        list.appendChild(row);
                    });
                }
            } catch {}
            
            // Show loading spinner
            showVideoLoading();
            
            // Load video
            videoPlayer.src = video.videoUrl;
            videoPlayer.load();
            
            // Set up video event listeners
            setupVideoEventListeners();
            
            // Show the detail view
            document.getElementById('videoDetailView').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Show controls initially, then auto-hide
            showVideoControls();
            startControlsAutoHide();
        }
        function closeVideoDetail() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            videoPlayer.pause();
            videoPlayer.src = '';
            
            // Clear timeouts
            if (controlsTimeout) {
                clearTimeout(controlsTimeout);
                controlsTimeout = null;
            }
            
            document.getElementById('videoDetailView').style.display = 'none';
            document.body.style.overflow = 'auto';
            
            currentVideo = null;
            isVideoPlaying = false;
        }
        function setupVideoEventListeners() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            
            // AGGRESSIVELY remove all native controls
            videoPlayer.controls = false;
            videoPlayer.removeAttribute('controls');
            videoPlayer.setAttribute('controlsList', 'nodownload nofullscreen noremoteplayback noplaybackrate');
            videoPlayer.setAttribute('disablePictureInPicture', 'true');
            videoPlayer.setAttribute('disableRemotePlayback', 'true');
            videoPlayer.setAttribute('playsinline', 'true');
            videoPlayer.setAttribute('webkit-playsinline', 'true');
            videoPlayer.setAttribute('x5-playsinline', 'true');
            
            // Force hide controls continuously
            setInterval(() => {
                if (videoPlayer.controls) {
                    videoPlayer.controls = false;
                    videoPlayer.removeAttribute('controls');
                }
            }, 100);
            
            videoPlayer.onloadstart = () => {
                showVideoLoading();
                // Force remove controls again on load
                videoPlayer.controls = false;
                videoPlayer.removeAttribute('controls');
            };
            videoPlayer.oncanplay = () => {
                hideVideoLoading();
                // Force remove controls when ready
                videoPlayer.controls = false;
                videoPlayer.removeAttribute('controls');
            };
            videoPlayer.onplay = () => {
                isVideoPlaying = true;
                updatePlayButtons('pause');
                // Force remove controls on play
                videoPlayer.controls = false;
                videoPlayer.removeAttribute('controls');
            };
            videoPlayer.onpause = () => {
                isVideoPlaying = false;
                updatePlayButtons('play');
            };
            videoPlayer.ontimeupdate = () => updateProgress();
            videoPlayer.onloadedmetadata = () => {
                updateDuration();
                // Force remove controls when metadata loads
                videoPlayer.controls = false;
                videoPlayer.removeAttribute('controls');
            };
            videoPlayer.onerror = () => {
                hideVideoLoading();
                console.error('Video failed to load');
            };
            
            // Prevent context menu on video
            videoPlayer.oncontextmenu = (e) => {
                e.preventDefault();
                return false;
            };
            
            // Prevent double-click fullscreen
            videoPlayer.ondblclick = (e) => {
                e.preventDefault();
                return false;
            };
            
            // Block any attempt to show controls
            videoPlayer.addEventListener('controlschange', () => {
                videoPlayer.controls = false;
            });
        }
        function showVideoLoading() {
            document.getElementById('videoLoadingSpinner').style.display = 'block';
        }
        
        function hideVideoLoading() {
            document.getElementById('videoLoadingSpinner').style.display = 'none';
        }
        
        function togglePlayPause() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            
            if (videoPlayer.paused) {
                videoPlayer.play();
            } else {
                videoPlayer.pause();
            }
            
            // Show controls when interacting
            showVideoControls();
            startControlsAutoHide();
        }
        
        function updatePlayButtons(state) {
            const centerIcon = document.getElementById('centerPlayIcon');
            
            if (state === 'play') {
                // Play icon - properly centered
                centerIcon.innerHTML = '<polygon points="8,5 19,12 8,19" fill="white"></polygon>';
            } else {
                // Pause icon - perfectly centered with consistent spacing
                centerIcon.innerHTML = '<rect x="9" y="5" width="2.5" height="14" fill="white"></rect><rect x="12.5" y="5" width="2.5" height="14" fill="white"></rect>';
            }
        }
        
        function seekBackward() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 10);
            showVideoControls();
            startControlsAutoHide();
        }
        function seekForward() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 10);
            showVideoControls();
            startControlsAutoHide();
        }
        
        function seekToPosition(event) {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            const progressContainer = event.currentTarget;
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = clickX / rect.width;
            
            videoPlayer.currentTime = percentage * videoPlayer.duration;
            showVideoControls();
            startControlsAutoHide();
        }
        
        function updateProgress() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            const progressBar = document.getElementById('progressBar');
            const currentTimeDisplay = document.getElementById('currentTimeDisplay');
            
            if (videoPlayer.duration > 0) {
                const percentage = (videoPlayer.currentTime / videoPlayer.duration) * 100;
                progressBar.style.width = percentage + '%';
                currentTimeDisplay.textContent = formatVideoTime(videoPlayer.currentTime);
            }
        }
        
        function updateDuration() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            const durationDisplay = document.getElementById('durationDisplay');
            durationDisplay.textContent = formatVideoTime(videoPlayer.duration);
        }
        
        function formatVideoTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }
        
        function toggleMute() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            const volumeIcon = document.getElementById('volumeIcon');
            
            videoPlayer.muted = !videoPlayer.muted;
            
            if (videoPlayer.muted) {
                // Muted icon
                volumeIcon.innerHTML = '<polygon points="11,5 6,9 2,9 2,15 6,15 11,19"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line>';
            } else {
                // Volume icon
                volumeIcon.innerHTML = '<polygon points="11,5 6,9 2,9 2,15 6,15 11,19"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>';
            }
            
            showVideoControls();
            startControlsAutoHide();
        }
        
        function toggleFullscreen() {
            const videoDetailView = document.getElementById('videoDetailView');
            
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                videoDetailView.requestFullscreen();
            }
            
            showVideoControls();
            startControlsAutoHide();
        }
        
        // Mini Player state
        let miniPlayerActive = false;
        
        function minimizeToMiniPlayer() {
            const fullVideo = document.getElementById('detailVideoPlayer');
            const miniPlayer = document.getElementById('miniPlayer');
            const miniVideo = document.getElementById('miniVideo');

            // Show mini player
            miniPlayer.style.display = 'block';
            miniPlayerActive = true;

            // Mirror source and current time
            miniVideo.src = fullVideo.currentSrc || fullVideo.src;
            miniVideo.currentTime = fullVideo.currentTime;
            miniVideo.muted = fullVideo.muted;
            miniVideo.playbackRate = fullVideo.playbackRate;

            // Start playing in mini
            miniVideo.play().catch(() => {});

            // Close full view
            closeVideoDetail();

            // Wire controls
            wireMiniPlayerControls();
        }

        function restoreFromMiniPlayer() {
            const miniVideo = document.getElementById('miniVideo');
            const src = miniVideo.currentSrc || miniVideo.src;
            const time = miniVideo.currentTime;
            const muted = miniVideo.muted;
            const rate = miniVideo.playbackRate;

            // Reopen full player and continue playback
            openVideoDetail({
                title: document.getElementById('detailVideoTitle')?.textContent || 'Video',
                url: src,
                autoplay: true
            }, true);

            const fullVideo = document.getElementById('detailVideoPlayer');
            fullVideo.src = src;
            fullVideo.currentTime = time;
            fullVideo.muted = muted;
            fullVideo.playbackRate = rate;
            fullVideo.play().catch(() => {});

            // Hide mini
            destroyMiniPlayer();
        }

        function destroyMiniPlayer() {
            const miniPlayer = document.getElementById('miniPlayer');
            const miniVideo = document.getElementById('miniVideo');
            miniVideo.pause();
            miniVideo.removeAttribute('src');
            miniVideo.load();
            miniPlayer.style.display = 'none';
            miniPlayerActive = false;
        }

        function wireMiniPlayerControls() {
            const miniVideo = document.getElementById('miniVideo');
            const playBtn = document.getElementById('miniPlayBtn');
            const expandBtn = document.getElementById('miniExpandBtn');
            const closeBtn = document.getElementById('miniCloseBtn');
            const timeLabel = document.getElementById('miniTime');

            playBtn.onclick = () => {
                if (miniVideo.paused) {
                    miniVideo.play();
                    playBtn.textContent = '‚ùö‚ùö';
                } else {
                    miniVideo.pause();
                    playBtn.textContent = '‚ñ∂';
                }
            };

            expandBtn.onclick = restoreFromMiniPlayer;
            closeBtn.onclick = destroyMiniPlayer;

            miniVideo.ontimeupdate = () => {
                timeLabel.textContent = `${formatTime(miniVideo.currentTime)} / ${formatTime(miniVideo.duration || 0)}`;
            };

            // Make mini draggable
            makeMiniPlayerDraggable();
        }
        function makeMiniPlayerDraggable() {
            const el = document.getElementById('miniPlayer');
            let startX = 0, startY = 0, initialLeft = 0, initialTop = 0;

            const onTouchStart = (e) => {
                const t = e.touches[0];
                startX = t.clientX; startY = t.clientY;
                const rect = el.getBoundingClientRect();
                initialLeft = rect.left; initialTop = rect.top;
                document.addEventListener('touchmove', onTouchMove, { passive: false });
                document.addEventListener('touchend', onTouchEnd);
            };

            const onTouchMove = (e) => {
                e.preventDefault();
                const t = e.touches[0];
                const dx = t.clientX - startX;
                const dy = t.clientY - startY;
                el.style.left = initialLeft + dx + 'px';
                el.style.top = initialTop + dy + 'px';
                el.style.right = 'auto';
                el.style.bottom = 'auto';
            };

            const onTouchEnd = () => {
                document.removeEventListener('touchmove', onTouchMove);
                document.removeEventListener('touchend', onTouchEnd);
            };

            el.addEventListener('touchstart', onTouchStart);
        }
        
        function showVideoControls() {
            const overlay = document.getElementById('videoControlsOverlay');
            overlay.style.opacity = '1';
        }
        
        function hideVideoControls() {
            const overlay = document.getElementById('videoControlsOverlay');
            overlay.style.opacity = '0';
        }
        function startControlsAutoHide() {
            if (controlsTimeout) {
                clearTimeout(controlsTimeout);
            }
            
            controlsTimeout = setTimeout(() => {
                if (isVideoPlaying) {
                    hideVideoControls();
                }
            }, 4000); // Hide after 4 seconds like iOS
        }
        // Add click handler to show/hide controls
        document.addEventListener('DOMContentLoaded', function() {
            const videoDetailView = document.getElementById('videoDetailView');
            if (videoDetailView) {
                videoDetailView.addEventListener('click', function(e) {
                    // Only toggle controls if clicking on the video area, not buttons
                    if (e.target.closest('.video-controls-overlay') && !e.target.closest('[onclick]')) {
                        const overlay = document.getElementById('videoControlsOverlay');
                        if (overlay.style.opacity === '0') {
                            showVideoControls();
                            startControlsAutoHide();
                        } else {
                            hideVideoControls();
                        }
                    }
                });
            }
        });
        
        function likeVideo() {
            const likeBtn = document.querySelector('[onclick="likeVideo()"]');
            const currentLikes = parseInt(document.getElementById('likeCount').textContent.replace('K', '').replace('.', '')) * 1000;
            const newLikes = currentLikes + 1;
            document.getElementById('likeCount').textContent = formatNumber(newLikes);
            
            likeBtn.style.background = '#ff4444';
            likeBtn.innerHTML = '‚ù§Ô∏è <span id="likeCount">' + formatNumber(newLikes) + '</span>';
            
            showSuccessMessage('Liked! ‚ù§Ô∏è');
        }
        
        function shareVideo() {
            if (navigator.share) {
                navigator.share({
                    title: document.getElementById('detailVideoTitle').textContent,
                    url: window.location.href
                });
            } else {
                // Fallback
                navigator.clipboard.writeText(window.location.href);
                showSuccessMessage('Link copied to clipboard! üìã');
            }
        }
        
        function subscribeChannel() {
            const subBtn = document.querySelector('[onclick="subscribeChannel()"]');
            subBtn.textContent = 'Subscribed ‚úì';
            subBtn.style.background = '#333';
            showSuccessMessage('Subscribed! üîî');
        }
        
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
        
        // Enhanced Features and Utilities
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Enhanced Video Player Controls
        function createEnhancedVideoPlayer(videoElement) {
            const container = videoElement.parentElement;
            
            // Add enhanced controls overlay
            const controlsOverlay = document.createElement('div');
            controlsOverlay.className = 'enhanced-video-controls';
            controlsOverlay.innerHTML = `
                <div class="progress-bar" onclick="seekVideo(event, this)">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="video-controls-row">
                    <div class="video-controls-left">
                        <button class="video-control-btn play-pause-btn" onclick="togglePlayPause()">‚è∏Ô∏è</button>
                        <button class="video-control-btn" onclick="adjustVolume(-0.1)">üîâ</button>
                        <button class="video-control-btn" onclick="adjustVolume(0.1)">üîä</button>
                        <span class="time-display">0:00 / 0:00</span>
                    </div>
                    <div class="video-controls-right">
                        <button class="video-control-btn" onclick="toggleFullscreen()">‚õ∂</button>
                    </div>
                </div>
            `;
            
            container.appendChild(controlsOverlay);
            
            // Update progress bar
            videoElement.addEventListener('timeupdate', updateProgressBar);
            videoElement.addEventListener('loadedmetadata', updateTimeDisplay);
        }

        function updateProgressBar() {
            const video = document.getElementById('detailVideoPlayer');
            const progressFill = document.querySelector('.progress-fill');
            const timeDisplay = document.querySelector('.time-display');
            
            if (video && progressFill) {
                const progress = (video.currentTime / video.duration) * 100;
                progressFill.style.width = progress + '%';
                
                if (timeDisplay) {
                    const current = formatTime(video.currentTime);
                    const total = formatTime(video.duration);
                    timeDisplay.textContent = `${current} / ${total}`;
                }
            }
        }
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function seekVideo(event, progressBar) {
            const video = document.getElementById('detailVideoPlayer');
            const rect = progressBar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            video.currentTime = percent * video.duration;
        }

        function togglePlayPause() {
            const video = document.getElementById('detailVideoPlayer');
            const btn = document.querySelector('.play-pause-btn');
            
            if (video.paused) {
                video.play();
                btn.textContent = '‚è∏Ô∏è';
            } else {
                video.pause();
                btn.textContent = '‚ñ∂Ô∏è';
            }
        }

        function adjustVolume(change) {
            const video = document.getElementById('detailVideoPlayer');
            video.volume = Math.max(0, Math.min(1, video.volume + change));
            showNotification(`Volume: ${Math.round(video.volume * 100)}%`, 'info');
        }

        function toggleFullscreen() {
            const videoContainer = document.getElementById('videoDetailView');
            
            if (!document.fullscreenElement) {
                videoContainer.requestFullscreen().catch(err => {
                    showNotification('Fullscreen not supported', 'error');
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Enhanced Story Features
        function enhanceStoryExperience() {
            const stories = document.querySelectorAll('.story-item');
            stories.forEach(story => {
                story.addEventListener('click', function() {
                    const storyTitle = this.querySelector('.story-name')?.textContent || 'Story';
                    showNotification(`Opening ${storyTitle}...`, 'info');
                });
            });
        }

        // Advanced Performance Optimization
        function lazyLoadImages() {
            const images = document.querySelectorAll('img[data-src]');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        imageObserver.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px 0px', // Start loading 50px before image comes into view
                threshold: 0.1
            });

            images.forEach(img => imageObserver.observe(img));
        }

        // Virtual Scrolling for Video Grid (Performance Boost)
        class VirtualScrollManager {
            constructor(container, itemHeight = 200) {
                this.container = container;
                this.itemHeight = itemHeight;
                this.visibleItems = Math.ceil(window.innerHeight / itemHeight) + 2;
                this.scrollTop = 0;
                this.totalItems = 0;
                
                this.init();
            }
            
            init() {
                this.container.addEventListener('scroll', this.handleScroll.bind(this));
                window.addEventListener('resize', this.handleResize.bind(this));
            }
            
            handleScroll() {
                this.scrollTop = this.container.scrollTop;
                this.updateVisibleItems();
            }
            
            handleResize() {
                this.visibleItems = Math.ceil(window.innerHeight / this.itemHeight) + 2;
                this.updateVisibleItems();
            }
            
            updateVisibleItems() {
                const startIndex = Math.floor(this.scrollTop / this.itemHeight);
                const endIndex = Math.min(startIndex + this.visibleItems, this.totalItems);
                
                // This would integrate with your video loading logic
                this.renderVisibleItems(startIndex, endIndex);
            }
            
            renderVisibleItems(start, end) {
                // Implementation would depend on your video data structure
                console.log(`Rendering items ${start} to ${end}`);
            }
        }
        // Advanced Caching System
        class AdvancedCache {
            constructor(maxSize = 50) {
                this.cache = new Map();
                this.maxSize = maxSize;
            }
            
            set(key, value, ttl = 300000) { // 5 minutes default TTL
                if (this.cache.size >= this.maxSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                
                this.cache.set(key, {
                    value,
                    timestamp: Date.now(),
                    ttl
                });
            }
            
            get(key) {
                const item = this.cache.get(key);
                if (!item) return null;
                
                if (Date.now() - item.timestamp > item.ttl) {
                    this.cache.delete(key);
                    return null;
                }
                
                return item.value;
            }
            
            clear() {
                this.cache.clear();
            }
        }

        // Initialize advanced performance features
        const videoCache = new AdvancedCache(100);
        let virtualScroll = null;

        // Theme removed - using light theme only

        // Enhanced Video Player with Advanced Controls
        function enhanceVideoPlayer() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            if (!videoPlayer) return;

            // Add picture-in-picture support
            if (document.pictureInPictureEnabled) {
                const pipButton = document.createElement('button');
                pipButton.innerHTML = 'üì±';
                pipButton.className = 'pip-btn';
                pipButton.onclick = togglePictureInPicture;
                pipButton.title = 'Picture in Picture';
                
                const controlsContainer = videoPlayer.parentElement.querySelector('.video-controls');
                if (controlsContainer) {
                    controlsContainer.appendChild(pipButton);
                }
            }

            // Add playback speed control
            const speedButton = document.createElement('button');
            speedButton.innerHTML = '1x';
            speedButton.className = 'speed-btn';
            speedButton.onclick = cyclePlaybackSpeed;
            speedButton.title = 'Playback Speed';
            
            const controlsContainer = videoPlayer.parentElement.querySelector('.video-controls');
            if (controlsContainer) {
                controlsContainer.appendChild(speedButton);
            }
        }

        function togglePictureInPicture() {
            const video = document.getElementById('detailVideoPlayer');
            
            if (document.pictureInPictureElement) {
                document.exitPictureInPicture();
            } else {
                video.requestPictureInPicture().catch(err => {
                    showNotification('Picture-in-picture not available', 'error');
                });
            }
        }

        const playbackSpeeds = [0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2];
        let currentSpeedIndex = 3; // 1x

        function cyclePlaybackSpeed() {
            const video = document.getElementById('detailVideoPlayer');
            const speedBtn = document.querySelector('.speed-btn');
            
            currentSpeedIndex = (currentSpeedIndex + 1) % playbackSpeeds.length;
            const newSpeed = playbackSpeeds[currentSpeedIndex];
            
            video.playbackRate = newSpeed;
            speedBtn.innerHTML = `${newSpeed}x`;
            showNotification(`Speed: ${newSpeed}x`, 'info');
        }
        // Enhanced Mobile Gestures
        function initMobileGestures() {
            let touchStartX = 0;
            let touchStartY = 0;
            let touchStartTime = 0;

            document.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
            });

            document.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const touchEndTime = Date.now();
                
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const deltaTime = touchEndTime - touchStartTime;
                
                // Quick swipe detection
                if (deltaTime < 300 && Math.abs(deltaX) > 50) {
                    if (deltaX > 0) {
                        // Swipe right - go back or previous video
                        handleSwipeRight();
                    } else {
                        // Swipe left - next video or forward
                        handleSwipeLeft();
                    }
                }
                
                // Double tap like disabled (removed per design requirements)
            });
        }

        function handleSwipeRight() {}

        function handleSwipeLeft() {}

        // handleDoubleTap removed (no hearts / simplified UI)

        // Enhanced Accessibility Features
        function initAccessibilityFeatures() {
            // Keyboard navigation for video grid
            const videoItems = document.querySelectorAll('.video-item');
            videoItems.forEach((item, index) => {
                item.setAttribute('tabindex', '0');
                item.setAttribute('role', 'button');
                item.setAttribute('aria-label', `Video ${index + 1}`);
                
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        item.click();
                    }
                });
            });

            // Keyboard navigation for stories
            const storyItems = document.querySelectorAll('.story-item');
            storyItems.forEach((item, index) => {
                item.setAttribute('tabindex', '0');
                item.setAttribute('role', 'button');
                item.setAttribute('aria-label', `Story ${index + 1}`);
                
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        item.click();
                    }
                });
            });

            // Enhanced focus indicators
            const focusableElements = document.querySelectorAll('button, [tabindex="0"], a, input, select, textarea');
            focusableElements.forEach(element => {
                element.addEventListener('focus', () => {
                    element.style.outline = '2px solid var(--accent)';
                    element.style.outlineOffset = '2px';
                });
                
                element.addEventListener('blur', () => {
                    element.style.outline = '';
                    element.style.outlineOffset = '';
                });
            });

            // Skip links functionality
            const skipLink = document.querySelector('.skip-link');
            if (skipLink) {
                skipLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    const target = document.querySelector(skipLink.getAttribute('href'));
                    if (target) {
                        target.focus();
                        target.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            }

            // Announce theme changes to screen readers
            const themeButton = document.querySelector('.theme-toggle');
            if (themeButton) {
                themeButton.setAttribute('aria-live', 'polite');
                themeButton.setAttribute('aria-atomic', 'true');
            }
        }
        // Enhanced Keyboard Shortcuts
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Only handle shortcuts when not in input fields
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                switch (e.key) {
                    case 'k':
                    case 'K':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            const searchInput = document.querySelector('input[type="search"]');
                            if (searchInput) {
                                searchInput.focus();
                                showNotification('üîç Search activated', 'info');
                            }
                        }
                        break;
                    
                    // Theme toggle removed
                    
                    case ' ':
                        if (document.activeElement.classList.contains('video-item')) {
                            e.preventDefault();
                            document.activeElement.click();
                        }
                        break;
                    
                    case 'Escape':
                        // Close any open modals
                        const modal = document.querySelector('.modal.show');
                        if (modal) {
                            closeCustomModal();
                        }
                        break;
                    
                    case 'h':
                    case 'H':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            showKeyboardShortcuts();
                        }
                        break;
                }
            });
        }

        function showKeyboardShortcuts() {
            const shortcuts = [
                '‚åò/Ctrl + K: Focus search',
                '‚åò/Ctrl + H: Show shortcuts',
                'Space: Activate focused item',
                'Escape: Close modals',
                'Tab: Navigate elements'
            ];
            
            showCustomModal('‚å®Ô∏è Keyboard Shortcuts', shortcuts.join('<br>'));
        }

        // Reduced Motion Support
        function initReducedMotionSupport() {
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)');
            
            function handleReducedMotion() {
                if (prefersReducedMotion.matches) {
                    document.body.style.setProperty('--transition', 'none');
                    document.querySelectorAll('*').forEach(el => {
                        el.style.animationDuration = '0.01ms !important';
                        el.style.animationIterationCount = '1 !important';
                        el.style.transitionDuration = '0.01ms !important';
                    });
                    showNotification('üéØ Reduced motion enabled', 'info');
                } else {
                    document.body.style.setProperty('--transition', 'all 0.3s ease');
                }
            }
            
            prefersReducedMotion.addListener(handleReducedMotion);
            handleReducedMotion();
        }

        // Enhanced Search Functionality
        function initEnhancedSearch() {
            // Add search suggestions
            const searchSuggestions = [
                'üéµ Music Videos', 'üéÆ Gaming', 'üìö Education', 'üç≥ Cooking',
                'üí™ Fitness', 'üé® Art', 'üíª Tech', 'üé¨ Movies'
            ];
            
            // This would integrate with your existing search functionality
            console.log('Enhanced search initialized with suggestions:', searchSuggestions);
        }

        // Backend service endpoints (via API Gateway)
        const API_HOST = 'https://mychannel-gw-1l792fzz.uc.gateway.dev';
        const EVENTS_ENDPOINT = `${API_HOST}/v1/events`;
        const CONTENT_FEED_ENDPOINT = `${API_HOST}/v1/feed/home`;
        const UPLOAD_SIGNED_URL_ENDPOINT = `${API_HOST}/v1/uploads/signed-url`;

        // Enhanced Analytics Integration
        function trackUserEngagement(action, data = {}) {
            // Enhanced analytics tracking with more context
            const enhancedData = {
                ...data,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                screenResolution: `${screen.width}x${screen.height}`,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                theme: 'light',
                connectionType: navigator.connection?.effectiveType || 'unknown'
            };
            
            console.log('üìä User Engagement:', action, enhancedData);
            
            // Firebase Analytics integration
            if (typeof gtag !== 'undefined') {
                gtag('event', action, enhancedData);
            }
            
            // Store in local cache for offline analysis
            const analyticsCache = JSON.parse(localStorage.getItem('analytics_cache') || '[]');
            analyticsCache.push({ action, data: enhancedData });
            
            // Keep only last 100 events
            if (analyticsCache.length > 100) {
                analyticsCache.shift();
            }
            
            localStorage.setItem('analytics_cache', JSON.stringify(analyticsCache));

            // Send to backend events service (non-blocking)
            try {
                fetch(EVENTS_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, data: enhancedData }) ,
                    keepalive: true,
                    mode: 'cors'
                }).catch(()=>{});
            } catch {}
        }
        // Performance Monitoring
        function initPerformanceMonitoring() {
            // Monitor page load performance
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    if (perfData) {
                        trackUserEngagement('performance_metrics', {
                            loadTime: Math.round(perfData.loadEventEnd - perfData.fetchStart),
                            domContentLoaded: Math.round(perfData.domContentLoadedEventEnd - perfData.fetchStart),
                            firstPaint: Math.round(performance.getEntriesByName('first-paint')[0]?.startTime || 0),
                            firstContentfulPaint: Math.round(performance.getEntriesByName('first-contentful-paint')[0]?.startTime || 0)
                        });
                    }
                }, 1000);
            });

            // Monitor user interactions
            ['click', 'scroll', 'keydown'].forEach(eventType => {
                document.addEventListener(eventType, () => {
                    trackUserEngagement('user_interaction', { type: eventType });
                }, { once: true, passive: true });
            });

            // Monitor video engagement
            document.addEventListener('play', (e) => {
                if (e.target.tagName === 'VIDEO') {
                    trackUserEngagement('video_play', { videoId: e.target.id || 'unknown' });
                }
            });

            document.addEventListener('pause', (e) => {
                if (e.target.tagName === 'VIDEO') {
                    trackUserEngagement('video_pause', { 
                        videoId: e.target.id || 'unknown',
                        currentTime: e.target.currentTime,
                        duration: e.target.duration
                    });
                }
            });
        }

        // Load stories and videos when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Revert force-close overlays to avoid hiding required UI
            // Initialize performance monitoring
            initPerformanceMonitoring();
            
            // Prime stories from cache for instant UI
            try { primeStoriesFromCache(); } catch {}

            // Load videos immediately with a safeguard re-try
            loadVideos();
            setTimeout(() => {
                try {
                    const grid = document.getElementById('videoGrid');
                    if (grid && grid.children.length === 0) {
                        loadVideos();
                    }
                } catch (e) { /* no-op */ }
            }, 600);
            
            // Load stories after a short delay to let the page render
            setTimeout(loadUserStories, 1000);

            // Hero carousel disabled for production for now

            // Show promo for guests (hide if signed in or dismissed)
            try {
                const promo = document.getElementById('promoBanner');
                const closeBtn = document.getElementById('promoCloseBtn');
                let dismissedUntil = 0;
                try { dismissedUntil = parseInt(localStorage.getItem('mc_promo_dismissed_until')||'0', 10) || 0; } catch {}
                const now = Date.now();
                const notDismissed = now > dismissedUntil;
                let shownThisSession = false;
                try { shownThisSession = sessionStorage.getItem('mc_promo_shown') === '1'; } catch {}
                if (promo && notDismissed && !shownThisSession) {
                    promo.classList.remove('hidden');
                    try { sessionStorage.setItem('mc_promo_shown','1'); } catch {}
                }
                await initFirebase();
                const isSignedIn = auth && auth.currentUser && !auth.currentUser.isAnonymous;
                if (promo) {
                    if (!isSignedIn && notDismissed) {
                        promo.classList.remove('hidden');
                    }
                    if (closeBtn) closeBtn.onclick = () => {
                        promo.classList.add('hidden');
                        try { localStorage.setItem('mc_promo_dismissed_until', String(Date.now() + 7*24*60*60*1000)); } catch {}
                    };
                }
            } catch {
                // If anything failed, show promo as a last resort (guest default)
                const promo = document.getElementById('promoBanner');
                if (promo) promo.style.display = 'block';
            }
            // Initialize enhanced features
            setTimeout(() => {
                initEnhancedSearch();
                enhanceStoryExperience();
                lazyLoadImages();
                enhanceVideoPlayer();
                initMobileGestures();
                initAccessibilityFeatures();
                initKeyboardShortcuts();
                initReducedMotionSupport();
                initStoryKeyboardSupport();
                
                // Initialize virtual scrolling if container exists
                const videoGrid = document.getElementById('videoGrid');
                if (videoGrid) {
                    virtualScroll = new VirtualScrollManager(videoGrid);
                }
                
                // Add staggered animations to existing items
                document.querySelectorAll('.video-item').forEach((item, index) => {
                    item.style.setProperty('--item-index', index);
                });
                
                document.querySelectorAll('.story-item').forEach((item, index) => {
                    item.style.setProperty('--story-index', index);
                });
                
                // Welcome toast disabled for cleaner first impression
                
                // Track page load with enhanced metrics
                // Suppressed page_load analytics to avoid any overlays/console noise on first render
                gateProfileForAuth();
            }, 1500);
        });

        function initHeroCarousel() {
            const slides = Array.from(document.querySelectorAll('#heroCarousel .hero-slide'));
            const dots = Array.from(document.querySelectorAll('#heroDots .hero-dot'));
            if (slides.length === 0) return;
            let i = 0; let timer = null;
            const show = (idx) => {
                i = (idx + slides.length) % slides.length;
                slides.forEach((s, si) => s.classList.toggle('active', si === i));
                dots.forEach((d, di) => d.classList.toggle('active', di === i));
            };
            const play = () => { stop(); timer = setInterval(() => show(i + 1), 5000); };
            const stop = () => { if (timer) { clearInterval(timer); timer = null; } };
            // Swipe support
            let startX = 0; let deltaX = 0; const threshold = 30;
            const el = document.getElementById('heroCarousel');
            if (el) {
                el.addEventListener('touchstart', e => { startX = e.touches[0].clientX; deltaX = 0; }, {passive:true});
                el.addEventListener('touchmove', e => { deltaX = e.touches[0].clientX - startX; }, {passive:true});
                el.addEventListener('touchend', () => { if (Math.abs(deltaX) > threshold) { show(i + (deltaX < 0 ? 1 : -1)); play(); } });
            }
            // Click dots to navigate
            dots.forEach((d, di) => d.addEventListener('click', () => { show(di); play(); }));
            slides.forEach((s, si) => s.addEventListener('click', () => {
                try { if (Array.isArray(window.videoLibrary) && window.videoLibrary[si]) { openVideoDetail(window.videoLibrary[si]); } } catch (e) {}
            }));
            play();
        }

        function forceCloseOverlays() {}
        // OAuth sign-in with Google
        async function signInWithGoogle() {
            await initFirebase();
            try {
                __redirectInProgress = false;
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({ prompt: 'select_account' });
                await auth.signInWithPopup(provider);
                try { sessionStorage.removeItem('oauthRedirect'); } catch {}
                closeAuthModal();
                refreshAccountMenu();
                clearOverlays();
                startAuthWatchdog();
            } catch (e) {
                const msg = (e && e.code) ? e.code : (e && e.message) ? e.message : String(e);
                if (/popup/.test(msg)) {
                    alert('Please allow popups, then tap Continue with Google again. If you are inside another app\'s browser, tap the ‚Ä¢‚Ä¢‚Ä¢ menu and choose Open in Safari/Chrome.');
                } else {
                    alert('Google sign-in failed: ' + msg);
                }
            }
        }

        // OAuth sign-in with Apple
        async function signInWithApple() {
            if (!APPLE_SIGNIN_ENABLED) {
                alert('Sign in with Apple will be available soon.');
                return;
            }
            await initFirebase();
            try {
                const provider = new firebase.auth.OAuthProvider('apple.com');
                provider.addScope('email');
                provider.addScope('name');
                const isIOSSafari = /iP(hone|ad|od)/.test(navigator.userAgent) && /Safari/.test(navigator.userAgent) && !/CriOS|FxiOS/.test(navigator.userAgent);
                if (isIOSSafari) {
                    await auth.signInWithRedirect(provider);
                    return;
                }
                await auth.signInWithPopup(provider);
                closeAuthModal();
                refreshAccountMenu();
                clearOverlays();
            } catch (e) {
                alert(e?.message || 'Apple sign-in failed');
            }
        }
        // Handle redirect result (iOS Safari)
        window.addEventListener('load', async () => {
            try {
                await initFirebase();
                const result = await auth.getRedirectResult();
                logAuth('getRedirectResult user=' + (result && result.user ? (result.user.uid || 'yes') : 'null'));
                const hadRedirectFlag = (typeof sessionStorage !== 'undefined' && sessionStorage.getItem('oauthRedirect') === '1');
                try { sessionStorage.removeItem('oauthRedirect'); } catch {}
                if (result && result.user) {
                    __redirectInProgress = false;
                    try {
                        if (result.additionalUserInfo && result.additionalUserInfo.isNewUser) {
                            await db.collection('users').doc(result.user.uid).set({
                                displayName: result.user.displayName || 'MyChannel User',
                                email: result.user.email || '',
                                createdAt: new Date()
                            }, { merge: true });
                        }
                    } catch {}
                    closeAuthModal();
                    refreshAccountMenu();
                    clearOverlays();
                    try {
                        if (hadRedirectFlag) {
                            setTimeout(() => { window.location.replace('/'); }, 50);
                        }
                    } catch {}
                    startAuthWatchdog();
                }
            } catch { __redirectInProgress = false; }
        });

        const APPLE_SIGNIN_ENABLED = false;

        // Defensive: ensure no overlay is blocking taps after auth
        function clearOverlays() {
            try {
                const modal = document.getElementById('authModal');
                const backdrop = document.getElementById('uploadBackdrop');
                if (modal) modal.style.display = (auth && auth.currentUser && !auth.currentUser.isAnonymous) ? 'none' : modal.style.display;
                if (backdrop) backdrop.style.display = 'none';
                document.body.style.overflow = '';
                // Ensure all dynamic modals are removed (movie/details/etc.)
                document.querySelectorAll('.upload-modal-backdrop').forEach(el => {
                    // Keep persistent upload and live modals hidden but not removed if needed
                    if (!el.closest('#uploadModal') && !el.closest('#liveStreamModal')) {
                        el.remove();
                    }
                });
                // Make sure the home tab is visible
                const home = document.getElementById('home-content');
                if (home && !home.classList.contains('active')) {
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                    home.classList.add('active');
                }
            } catch {}
        }

        function isInAppBrowser() {
            try {
                const ua = navigator.userAgent || '';
                return /(FBAN|FBAV|Instagram|Line|Twitter|TikTok|MicroMessenger|Snapchat|Pinterest)/i.test(ua);
            } catch { return false; }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try { await initFirebase(); } catch {}
            try { refreshAccountMenu(); } catch {}
            // Splash animation
            try {
                const splash = document.getElementById('webSplash');
                const logo = document.getElementById('splashLogo');
                const fill = document.getElementById('splashFill');
                if (splash && logo && fill) {
                    requestAnimationFrame(() => logo.classList.add('show'));
                    const steps = [0.3, 0.6, 0.85, 1.0];
                    steps.forEach((p, i) => setTimeout(() => { fill.style.width = (p*100)+'%'; }, 500 + i*350));
                    setTimeout(() => { splash.classList.add('hidden'); }, 2200);
                }
            } catch {}
            // Build Featured carousel from Firestore or fallback
            try {
                await initFirebase();
                const wrap = document.getElementById('heroCarousel');
                const dotsWrap = document.getElementById('heroDots');
                if (wrap && dotsWrap) {
                    // Ensure carousel is a single horizontal swiper, not stacked
                    wrap.style.display = 'flex';
                    wrap.style.overflowX = 'auto';
                    wrap.style.scrollSnapType = 'x mandatory';
                    wrap.style.webkitOverflowScrolling = 'touch';
                    let items = [];
                    try {
                        const snap = await db.collection('featured').orderBy('order','asc').limit(5).get();
                        items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    } catch {}
                    if (items.length === 0) {
                        // Hard fallback to ensure autoplay demo (3 swipable videos)
                        items = [
                            { id: 'feat-demo-1', title: 'Big Buck Bunny', views: 5200, thumbnailUrl: 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=1200&h=675&fit=crop', videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4', channelName: 'MyChannel', channelAvatar: 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG' },
                            { id: 'feat-demo-2', title: 'Sintel', views: 7800, thumbnailUrl: 'https://images.unsplash.com/photo-1517817748491-7feac7c7d7bf?w=1200&h=675&fit=crop', videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4', channelName: 'MyChannel', channelAvatar: 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG' },
                            { id: 'feat-demo-3', title: 'Tears of Steel', views: 9100, thumbnailUrl: 'https://images.unsplash.com/photo-1504384308090-c894fdcc538d?w=1200&h=675&fit=crop', videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4', channelName: 'MyChannel', channelAvatar: 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG' }
                        ];
                    }
                    const fmt = (n) => { try { if (!n) return '0'; const abs=Math.abs(n); if (abs>=1e9) return (n/1e9).toFixed(1)+'B'; if (abs>=1e6) return (n/1e6).toFixed(1)+'M'; if (abs>=1e3) return (n/1e3).toFixed(1)+'K'; return String(n);} catch { return String(n||0);} };
                    wrap.innerHTML = items.map((it, i) => {
                        const viewsText = '';
                        const avatar = it.channelAvatar || (it.channel && it.channel.avatar) || 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG';
                        const channelName = it.channelName || (it.channel && it.channel.name) || '';
                        const title = it.title || 'Featured';
                        return `
                        <div class="hero-slide${i===0?' active':''}" style="position:relative; width:100%; height:250px; border-radius:16px; overflow:hidden; box-shadow:0 10px 28px rgba(0,0,0,.25); scroll-snap-align:center; flex: 0 0 100%;">
                            <video ${i===0?'autoplay':''} muted playsinline loop src="${it.videoUrl||''}" poster="${it.thumbnailUrl||''}" style="width:100%;height:100%;object-fit:cover;display:block;"></video>
                            <div style="position:absolute;inset:0;background:linear-gradient(180deg, rgba(0,0,0,0.20) 0%, rgba(0,0,0,0.00) 40%, rgba(0,0,0,0.55) 100%);"></div>
                            
                            <div style="position:absolute;left:12px;right:12px;bottom:12px;display:flex;align-items:flex-end;justify-content:space-between;gap:12px;">
                                <div style="color:#fff;max-width:70%;display:flex;flex-direction:column;gap:6px;">
                                    <div style="display:flex;align-items:center;gap:10px;">
                                        <img src="${avatar}" alt="${channelName}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.7);">
                                        <div style="font-weight:800;font-size:18px;line-height:1.2;text-shadow:0 2px 10px rgba(0,0,0,.6);">${title}</div>
                                    </div>
                                    <div style="opacity:.9;font-size:12px;">${channelName ? channelName + ' ‚Ä¢ ' : ''}${viewsText}</div>
                                </div>
                                <div style="display:flex;gap:8px;">
                                    <button data-idx="${i}" class="heroPlayBtn" style="border:0;background:#000000b3;color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;">Play</button>
                                    <button aria-label="Watch later" style="border:1px solid rgba(255,255,255,.35);background:#ffffff; color:#000; border-radius:12px; padding:10px 12px; font-weight:700;">+</button>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                    dotsWrap.innerHTML = items.map((_, i) => `<div class="hero-dot${i===0?' active':''}" style="width:8px;height:8px;border-radius:50%;background:${i===0?'#ff4444':'#ddd'};"></div>`).join('');
                    document.querySelectorAll('.heroPlayBtn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const idx = Number(e.currentTarget.getAttribute('data-idx'))||0;
                            const it = items[idx];
                            if (it && it.videoUrl) {
                                openVideoDetail({ id: it.id||('feat-'+idx), title: it.title||'', description: '', thumbnail: it.thumbnailUrl, videoUrl: it.videoUrl, duration: '', views: 0, uploadTime: '', channel: { name: it.channelName||'MyChannel', avatar: it.channelAvatar||'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG', subscribers: 0 } });
                            }
                        });
                    });
                    initHeroCarousel();
                }
            } catch (e) { console.warn('Featured carousel init failed', e); }
        });

        function logAuth(msg) {
            try {
                if (location.search.includes('authdebug=1')) {
                    let box = document.getElementById('authDebugBox');
                    if (!box) {
                        box = document.createElement('div');
                        box.id = 'authDebugBox';
                        box.style.cssText = 'position:fixed;bottom:8px;left:8px;right:8px;max-height:40vh;overflow:auto;background:rgba(0,0,0,.7);color:#0f0;padding:8px;border-radius:8px;font:12px/1.4 monospace;z-index:99999;';
                        document.body.appendChild(box);
                    }
                    const line = document.createElement('div');
                    line.textContent = new Date().toISOString() + ' ' + msg;
                    box.appendChild(line);
                }
            } catch {}
        }

        function startAuthWatchdog() {
            let tries = 0;
            const t = setInterval(() => {
                tries++;
                const u = (auth && auth.currentUser) || null;
                logAuth('watchdog tick user=' + (u ? (u.uid || 'yes') : 'null'));
                if (u && !u.isAnonymous) {
                    try { refreshAccountMenu(); closeAuthModal(); clearOverlays(); } catch {}
                    clearInterval(t);
                }
                if (tries > 10) clearInterval(t);
            }, 500);
        }

        function openUploadModal() {
            const wrapper = document.getElementById('uploadModal');
            if (wrapper) {
                wrapper.style.display = 'block';
                const inner = wrapper.querySelector('.upload-modal');
                if (inner) inner.style.display = 'flex';
                // Click outside card to close
                const onBackdrop = (e) => { if (e.target === wrapper) { closeUploadModal(); } };
                wrapper.addEventListener('click', onBackdrop);
                // ESC to close
                const onEsc = (e) => { if (e.key === 'Escape') { closeUploadModal(); document.removeEventListener('keydown', onEsc); } };
                document.addEventListener('keydown', onEsc);
            }
            document.body.style.overflow = 'hidden';
        }
        function closeUploadModal() {
            const wrapper = document.getElementById('uploadModal');
            if (wrapper) {
                const inner = wrapper.querySelector('.upload-modal');
                if (inner) inner.style.display = 'none';
                wrapper.style.display = 'none';
            }
            document.body.style.overflow = '';
        }
        document.addEventListener('DOMContentLoaded', () => {
            const closeBtn = document.getElementById('closeUpload');
            if (closeBtn) closeBtn.addEventListener('click', closeUploadModal);
            // Wire upload flow
            const fileInput = document.getElementById('videoFileInput');
            const publishBtn = document.getElementById('umPublish');
            const titleEl = document.getElementById('umTitle');
            const descEl = document.getElementById('umDesc');
            const catEl = document.getElementById('umCategory');
            const prog = document.getElementById('umProgress');
            const fill = document.getElementById('umFill');
            const pct = document.getElementById('umPct');
            const previewSection = document.getElementById('videoPreviewSection');
            const previewVideo = document.getElementById('videoPreview');
            const fileNameEl = document.getElementById('videoFileName');
            const fileInfoEl = document.getElementById('videoFileInfo');
            const zone = document.getElementById('uploadZone');
            if (zone && fileInput) {
                zone.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', () => {
                    const f = fileInput.files && fileInput.files[0];
                    if (previewSection) previewSection.style.display = f ? 'block' : 'none';
                    if (f && previewVideo) {
                        try { previewVideo.src = URL.createObjectURL(f); previewVideo.load(); } catch {}
                    }
                    if (fileNameEl) fileNameEl.textContent = f ? f.name : '';
                    if (fileInfoEl) fileInfoEl.textContent = f ? `${(f.size/1024/1024).toFixed(2)} MB ‚Ä¢ ${f.type}` : '';
                });
            }
            if (publishBtn) publishBtn.addEventListener('click', async () => {
                try {
                    await initFirebase();
                    const u = auth && auth.currentUser;
                    if (!u || u.isAnonymous) {
                        alert('Please sign in to upload.');
                        return;
                    }
                    const f = fileInput && fileInput.files && fileInput.files[0];
                    const title = (titleEl && titleEl.value || '').trim();
                    const description = (descEl && descEl.value || '').trim();
                    const category = (catEl && catEl.value) || '';
                    if (!f || !title) {
                        alert('Title and video file are required.');
                        return;
                    }
                    if (prog) prog.style.display = 'block';
                    if (fill) fill.style.width = '0%'; if (pct) pct.textContent = '0%';
                    const ref = storage.ref().child(`videos/${u.uid}/${Date.now()}_${f.name}`);
                    const task = ref.put(f, { contentType: f.type });
                    await new Promise((resolve, reject) => {
                        task.on('state_changed', (snap) => {
                            const p = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
                            if (fill) fill.style.width = p + '%'; if (pct) pct.textContent = p + '%';
                        }, reject, resolve);
                    });
                    const videoUrl = await ref.getDownloadURL();
                    // Optional: thumbnail extraction can be added later
                    const docRef = await db.collection('videos').add({
                        creatorId: u.uid,
                        ownerId: u.uid,
                        title,
                        description,
                        category,
                        videoUrl,
                        thumbnailUrl: '',
                        duration: '',
                        views: 0,
                        likes: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    // Increment user's video count
                    const userRef = db.collection('users').doc(u.uid);
                    await userRef.set({ videos: firebase.firestore.FieldValue.increment(1) }, { merge: true });
                    if (prog) prog.style.display = 'none';
                    closeUploadModal();
                    pushNotification('Upload Complete', 'Your video has been published.');
                    // Refresh profile header and videos
                    try { loadProfileHeader(); } catch {}
                    try { loadProfileVideos(); } catch {}
                } catch (e) {
                    console.error('Upload failed', e);
                    alert(e?.message || 'Upload failed');
                }
            });
            // Show FAB for signed-in users
            const fab = document.getElementById('openUploadFab');
            if (fab) {
                fab.addEventListener('click', openUploadModal);
                setTimeout(async () => {
                    try { await initFirebase(); if (auth.currentUser && !auth.currentUser.isAnonymous) fab.style.display = 'flex'; } catch {}
                }, 800);
            }
        });

        // Notifications
        const notifState = { items: [] };
        function pushNotification(title, body) {
            notifState.items.unshift({ id: Date.now(), title, body, ts: new Date() });
            renderNotifications();
        }
        function renderNotifications() {
            const list = document.getElementById('notifList');
            const badge = document.getElementById('notifBadge');
            if (!list || !badge) return;
            list.innerHTML = notifState.items.map(n => `
                <div style="padding:10px 12px; border-bottom:1px solid #f5f5f5;">
                    <div style="font-weight:600; font-size:13px;">${n.title}</div>
                    <div style="font-size:12px; color:#6c757d;">${n.body}</div>
                </div>`).join('');
            badge.style.display = notifState.items.length ? 'block' : 'none';
        }
        document.addEventListener('DOMContentLoaded', () => {
            const bell = document.getElementById('notifBell');
            const menu = document.getElementById('notifMenu');
            if (bell && menu) {
                bell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
                });
                document.addEventListener('click', () => { menu.style.display = 'none'; });
            }
        });

        // After auth sign-in, send welcome notification once per user/device
        async function maybeSendWelcomeNotification() {
            try {
                await initFirebase();
                const u = auth && auth.currentUser;
                if (!u || u.isAnonymous) return;
                const key = 'mc_welcome_notif_' + u.uid;
                const sent = localStorage.getItem(key) === '1';
                if (!sent) {
                    pushNotification('Welcome to MyChannel üéâ', 'Thanks for joining! Tap Create to upload your first video.');
                    localStorage.setItem(key, '1');
                }
            } catch {}
        }
        // Hook into auth listener
        (function(){
            const _orig = window.__authListenerBound;
            setTimeout(maybeSendWelcomeNotification, 1200);
        })();

        // Avatar helpers
        function applyAvatarToUI(avatarUrl) {
            try {
                if (!avatarUrl) return;
                const profileAvatarEl = document.getElementById('profileAvatarEl');
                if (profileAvatarEl) profileAvatarEl.style.background = `url('${avatarUrl}') center/cover`;
                const accountBtn = document.getElementById('accountButton');
                if (accountBtn) {
                    accountBtn.style.background = `url('${avatarUrl}') center/cover`;
                    accountBtn.textContent = '';
                }
            } catch {}
        }
        function refreshStoriesForAvatar() {
            try { if (typeof updateStoriesUI === 'function') updateStoriesUI(); } catch {}
        }

        async function loadProfileHeader() {
            try {
                await initFirebase();
                const u = auth && auth.currentUser;
                const subsEl = document.querySelector('#profileHeaderCountsSubs');
                const vidsEl = document.querySelector('#profileHeaderCountsVids');
                const viewsEl = document.querySelector('#profileHeaderCountsViews');
                const nameEl = document.getElementById('profileDisplayNameEl');
                const handleEl = document.getElementById('profileHandleEl');
                if (!u || u.isAnonymous) {
                    if (subsEl) subsEl.textContent = '0';
                    if (vidsEl) vidsEl.textContent = '0';
                    if (viewsEl) viewsEl.textContent = '0';
                    return;
                }
                handleEl.textContent = '@' + (u.email ? u.email.split('@')[0] : 'user');
                nameEl.textContent = u.displayName || 'MyChannel User';
                const snap = await db.collection('users').doc(u.uid).get();
                const d = snap.exists ? snap.data() : {};
                if (subsEl) subsEl.textContent = String(d.subscribers || 0);
                if (vidsEl) vidsEl.textContent = String(d.videos || 0);
                if (viewsEl) viewsEl.textContent = String(d.views || 0);
            } catch {}
        }
        document.addEventListener('DOMContentLoaded', loadProfileHeader);

        async function loadProfileVideos() {
            try {
                await initFirebase();
                const u = auth && auth.currentUser;
                const grid = document.getElementById('profileVideosGrid');
                const empty = document.getElementById('profileVideosEmpty');
                const countEl = document.getElementById('profileVideosCount');
                if (!grid || !empty) return;
                grid.innerHTML = '';
                if (!u || u.isAnonymous) {
                    empty.style.display = 'block';
                    if (countEl) countEl.textContent = '0';
                    return;
                }
                const qs = await db.collection('videos').where('ownerId','==', u.uid).orderBy('createdAt','desc').limit(50).get();
                const docs = qs.docs.map(d => ({ id: d.id, ...d.data() }));
                if (countEl) countEl.textContent = String(docs.length);
                if (!docs.length) {
                    empty.style.display = 'block';
                    return;
                }
                empty.style.display = 'none';
                docs.forEach(v => {
                    const card = document.createElement('div');
                    card.style.background = '#1a1a1a';
                    card.style.borderRadius = '8px';
                    card.style.overflow = 'hidden';
                    card.innerHTML = `
                        <div style="position: relative;">
                            <img src="${v.thumbnailUrl || '/api/placeholder/320/180'}" style="width: 100%; aspect-ratio: 16/9; object-fit: cover;">
                            <div style="position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.8); color: white; padding: 1px 4px; border-radius: 3px; font-size: 10px;">${v.duration || ''}</div>
                        </div>
                        <div style="padding: 8px;">
                            <h4 style="color: white; font-size: 12px; font-weight: 500; margin: 0; line-height: 1.2;">${v.title || 'Untitled'}</h4>
                            <p style="color: #666; font-size: 10px; margin: 2px 0 0 0;">${(v.views || 0)} views</p>
                        </div>`;
                    card.onclick = () => openVideoDetail({
                        id: v.id,
                        title: v.title || 'Untitled',
                        description: v.description || '',
                        thumbnail: v.thumbnailUrl,
                        videoUrl: v.videoUrl,
                        duration: v.duration || '',
                        views: v.views || 0,
                        uploadTime: v.createdAt ? new Date(v.createdAt.seconds*1000).toLocaleDateString() : '',
                        channel: { name: (auth.currentUser?.displayName || 'You'), avatar: auth.currentUser?.photoURL || 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG', subscribers: 0 }
                    });
                    grid.appendChild(card);
                });
            } catch (e) {
                console.error('loadProfileVideos failed', e);
            }
        }
        document.addEventListener('DOMContentLoaded', () => setTimeout(loadProfileVideos, 1200));

        // Force Flicks viewer for all users (until Firestore feed is wired)
        async function loadFlicksTab() {
            try { const empty = document.getElementById('flicksEmpty'); if (empty) empty.style.display = 'none'; } catch {}
            try { openFlicks(0); } catch (e) { console.error('openFlicks failed', e); }
        }
        async function fetchFollowedStories() {
            try {
                await initFirebase();
                const u = auth && auth.currentUser;
                if (!u || u.isAnonymous) return;
                const doc = await db.collection('users').doc(u.uid).get();
                const following = (doc.exists && Array.isArray(doc.data().following)) ? doc.data().following : [];
                // Filter firebaseStories by following list + own story
                const currentId = u.uid;
                firebaseStories = firebaseStories.filter(s => s.userId === currentId || following.includes(s.userId));
                updateStoriesUI();
            } catch {}
        }
        document.addEventListener('DOMContentLoaded', () => setTimeout(fetchFollowedStories, 1500));
    </script>
    <!-- Advanced Notifications Panel -->
    <div id="notificationsPanel" class="notifications-panel">
        <div class="notifications-header">
            <h3 style="margin:0; font-weight:600; color:var(--text-primary); display:flex; align-items:center; gap:8px;">
                üîî Notifications
                <span id="notificationCount" class="notification-badge">0</span>
            </h3>
            <div style="display:flex; gap:8px; align-items:center;">
                <button onclick="markAllNotificationsRead()" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:12px;">Mark all read</button>
                <button onclick="toggleNotificationsPanel()" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:18px;">&times;</button>
            </div>
        </div>
        
        <div class="notifications-filters">
            <button class="notification-filter active" data-filter="all">All</button>
            <button class="notification-filter" data-filter="likes">‚ù§Ô∏è Likes</button>
            <button class="notification-filter" data-filter="comments">üí¨ Comments</button>
            <button class="notification-filter" data-filter="follows">üë• Follows</button>
            <button class="notification-filter" data-filter="uploads">üìπ Uploads</button>
            <button class="notification-filter" data-filter="live">üî¥ Live</button>
        </div>
        
        <div id="notificationsList" class="notifications-list">
            <div class="notifications-empty">
                <div style="text-align:center; padding:40px 20px; color:var(--text-secondary);">
                    <div style="font-size:48px; margin-bottom:12px;">üîî</div>
                    <div style="font-size:16px; margin-bottom:8px;">No notifications yet</div>
                    <div style="font-size:12px;">We'll notify you when something happens!</div>
                </div>
            </div>
        </div>
        
        <div class="notifications-settings">
            <div style="padding:16px; border-top:1px solid var(--border); background:var(--bg-secondary);">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                    <span style="font-size:14px; font-weight:600; color:var(--text-primary);">Notification Settings</span>
                    <button onclick="openNotificationSettings()" style="background:var(--primary); color:#fff; border:none; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">‚öôÔ∏è Settings</button>
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:8px; font-size:11px;">
                    <label style="display:flex; align-items:center; gap:4px; color:var(--text-secondary);">
                        <input type="checkbox" id="pushNotifications" checked>
                        Push notifications
                    </label>
                    <label style="display:flex; align-items:center; gap:4px; color:var(--text-secondary);">
                        <input type="checkbox" id="emailNotifications" checked>
                        Email notifications
                    </label>
                </div>
            </div>
        </div>
    </div>
    <!-- Notification Settings Modal -->
    <div id="notificationSettingsModal" class="upload-modal-backdrop">
        <div class="upload-modal">
            <div class="upload-card">
                <div class="upload-header">
                    <h3 style="margin:0; font-weight:600; color:var(--text-primary);">üîî Notification Settings</h3>
                    <button class="upload-close" onclick="closeNotificationSettings()">&times;</button>
                </div>
                <div class="upload-body">
                    <div class="upload-row">
                        <h4 style="margin:0 0 12px 0; color:var(--text-primary);">Push Notifications</h4>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>New likes on your videos</span>
                                <input type="checkbox" class="notification-toggle" data-type="likes" checked>
                            </label>
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>New comments on your videos</span>
                                <input type="checkbox" class="notification-toggle" data-type="comments" checked>
                            </label>
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>New followers</span>
                                <input type="checkbox" class="notification-toggle" data-type="follows" checked>
                            </label>
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>Someone you follow goes live</span>
                                <input type="checkbox" class="notification-toggle" data-type="live" checked>
                            </label>
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>Someone you follow uploads</span>
                                <input type="checkbox" class="notification-toggle" data-type="uploads" checked>
                            </label>
                        </div>
                    </div>
                    
                    <div class="upload-row">
                        <h4 style="margin:0 0 12px 0; color:var(--text-primary);">Email Notifications</h4>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>Weekly activity summary</span>
                                <input type="checkbox" class="email-toggle" data-type="weekly" checked>
                            </label>
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>Monthly analytics report</span>
                                <input type="checkbox" class="email-toggle" data-type="monthly" checked>
                            </label>
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>Product updates and news</span>
                                <input type="checkbox" class="email-toggle" data-type="updates">
                            </label>
                        </div>
                    </div>
                    
                    <div class="upload-row">
                        <h4 style="margin:0 0 12px 0; color:var(--text-primary);">Quiet Hours</h4>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Start Time</label>
                                <input type="time" id="quietStart" value="22:00" class="upload-input-text">
                            </div>
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">End Time</label>
                                <input type="time" id="quietEnd" value="08:00" class="upload-input-text">
                            </div>
                        </div>
                        <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">No notifications will be sent during these hours</div>
                    </div>
                    
                    <div class="upload-row">
                        <h4 style="margin:0 0 12px 0; color:var(--text-primary);">Appearance</h4>
                        <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                            <span>Enable Dark Mode</span>
                            <input type="checkbox" id="enableDarkMode">
                        </label>
                        <div style="font-size:11px; color:var(--text-secondary);">Dark mode applies across the site and is saved to your device.</div>
                    </div>
                    
                    <div class="upload-row">
                        <button onclick="saveNotificationSettings()" class="btn-enhanced" style="width:100%;">üíæ Save Settings</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Streaming Modal -->
    <div id="liveStreamModal" class="upload-modal-backdrop">
        <div class="upload-modal">
            <div class="upload-card">
                <div class="upload-header">
                    <h3 style="margin:0; font-weight:600; color:var(--text-primary);">üî¥ Go Live</h3>
                    <button class="upload-close" onclick="closeLiveStreamModal()">&times;</button>
                </div>
                <div class="upload-body">
                    <!-- Stream Setup -->
                    <div id="streamSetup">
                        <div class="upload-row">
                            <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Stream Title *</label>
                            <input type="text" id="streamTitle" class="upload-input-text" placeholder="What's your stream about?" maxlength="100">
                            <div style="text-align:right; font-size:11px; color:var(--text-secondary); margin-top:2px;"><span id="streamTitleCount">0</span>/100</div>
                        </div>
                        
                        <div class="upload-row">
                            <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Description</label>
                            <textarea id="streamDesc" class="upload-textarea" rows="2" placeholder="Tell viewers what to expect" maxlength="300"></textarea>
                            <div style="text-align:right; font-size:11px; color:var(--text-secondary); margin-top:2px;"><span id="streamDescCount">0</span>/300</div>
                        </div>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;" class="upload-row">
                            <div>
                                <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Category</label>
                                <select id="streamCategory" class="upload-select">
                                    <option value="gaming">üéÆ Gaming</option>
                                    <option value="music">üéµ Music</option>
                                    <option value="talk">üí¨ Just Chatting</option>
                                    <option value="education">üìö Education</option>
                                    <option value="art">üé® Art & Creative</option>
                                    <option value="cooking">üë®‚Äçüç≥ Cooking</option>
                                    <option value="fitness">üí™ Fitness</option>
                                    <option value="tech">üíª Tech</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Quality</label>
                                <select id="streamQuality" class="upload-select">
                                    <option value="720p">HD 720p</option>
                                    <option value="1080p">Full HD 1080p</option>
                                    <option value="480p">SD 480p</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Camera Preview -->
                        <div class="upload-row">
                            <label style="display:block; font-weight:600; margin-bottom:8px; color:var(--text-primary);">Camera Preview</label>
                            <div style="position:relative; background:#000; border-radius:8px; overflow:hidden; aspect-ratio:16/9;">
                                <video id="cameraPreview" style="width:100%; height:100%; object-fit:cover;" muted autoplay playsinline></video>
                                <div id="cameraStatus" style="position:absolute; top:12px; left:12px; background:rgba(0,0,0,0.7); color:#fff; padding:4px 8px; border-radius:4px; font-size:12px;">üì∑ Camera Off</div>
                                <div style="position:absolute; bottom:12px; right:12px; display:flex; gap:8px;">
                                    <button id="toggleCamera" onclick="toggleCamera()" style="background:rgba(255,255,255,0.2); border:none; border-radius:50%; width:40px; height:40px; color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center;">üì∑</button>
                                    <button id="toggleMic" onclick="toggleMic()" style="background:rgba(255,255,255,0.2); border:none; border-radius:50%; width:40px; height:40px; color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center;">üé§</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stream Settings -->
                        <div class="upload-row">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                                <input type="checkbox" id="enableChat" checked>
                                <label for="enableChat" style="font-size:14px; color:var(--text-primary);">Enable live chat</label>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                                <input type="checkbox" id="recordStream" checked>
                                <label for="recordStream" style="font-size:14px; color:var(--text-primary);">Save stream recording</label>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <input type="checkbox" id="notifyFollowers" checked>
                                <label for="notifyFollowers" style="font-size:14px; color:var(--text-primary);">Notify followers</label>
                            </div>
                        </div>
                        
                        <!-- Stream Actions -->
                        <div class="upload-row">
                            <button id="startStreamBtn" class="btn-enhanced" style="width:100%; background:var(--error); font-size:16px; font-weight:600;">üî¥ Start Streaming</button>
                            <button id="streamSignIn" class="btn-enhanced" style="width:100%; margin-top:8px; display:none; background:#1a73e8;">Sign in with Google to Stream</button>
                        </div>
                    </div>
                    
                    <!-- Live Stream Interface -->
                    <div id="liveStreamInterface" style="display:none;">
                        <div style="text-align:center; margin-bottom:16px;">
                            <div style="display:inline-flex; align-items:center; gap:8px; background:var(--error); color:#fff; padding:8px 16px; border-radius:20px; font-weight:600;">
                                <div style="width:8px; height:8px; background:#fff; border-radius:50%; animation:pulse 2s infinite;"></div>
                                LIVE
                            </div>
                        </div>
                        
                        <!-- Stream Stats -->
                        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-bottom:16px;">
                            <div style="text-align:center; padding:12px; background:var(--bg-secondary); border-radius:8px;">
                                <div style="font-size:20px; font-weight:600; color:var(--text-primary);" id="viewerCount">0</div>
                                <div style="font-size:12px; color:var(--text-secondary);">Viewers</div>
                            </div>
                            <div style="text-align:center; padding:12px; background:var(--bg-secondary); border-radius:8px;">
                                <div style="font-size:20px; font-weight:600; color:var(--text-primary);" id="streamDuration">00:00</div>
                                <div style="font-size:12px; color:var(--text-secondary);">Duration</div>
                            </div>
                            <div style="text-align:center; padding:12px; background:var(--bg-secondary); border-radius:8px;">
                                <div style="font-size:20px; font-weight:600; color:var(--text-primary);" id="chatMessages">0</div>
                                <div style="font-size:12px; color:var(--text-secondary);">Messages</div>
                            </div>
                        </div>
                        
                        <!-- Live Chat Preview -->
                        <div style="background:var(--bg-secondary); border-radius:8px; padding:12px; margin-bottom:16px; height:120px; overflow-y:auto;" id="liveChatPreview">
                            <div style="font-size:12px; color:var(--text-secondary); text-align:center; padding:20px;">Live chat will appear here...</div>
                        </div>
                        
                        <!-- Stream Controls -->
                        <div style="display:flex; gap:8px;">
                            <button onclick="toggleStreamCamera()" class="btn-enhanced" style="flex:1; background:var(--bg-secondary); color:var(--text-primary); border:1px solid var(--border);">üì∑ Camera</button>
                            <button onclick="toggleStreamMic()" class="btn-enhanced" style="flex:1; background:var(--bg-secondary); color:var(--text-primary); border:1px solid var(--border);">üé§ Mic</button>
                            <button onclick="endStream()" class="btn-enhanced" style="flex:2; background:var(--error);">‚èπÔ∏è End Stream</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Upload Modal with Advanced Features -->
    <div id="uploadModal" class="upload-modal-backdrop">
        <div class="upload-modal">
            <div class="upload-card" style="width:min(960px,96vw); border:0; background:#0f0f0f; color:#fff;">
                <div class="upload-header" style="background:#0f0f0f; border-bottom:1px solid #222;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="width:36px; height:36px; border-radius:50%; background:#ff0000; display:flex; align-items:center; justify-content:center; font-weight:800;">‚ûï</div>
                        <h3 style="margin:0; font-weight:700; color:#fff; letter-spacing:.2px;">Upload videos</h3>
                </div>
                    <button class="upload-close" onclick="closeUploadModal()" style="background:#1f1f1f; border:1px solid #333; color:#fff; width:36px; height:36px; border-radius:8px;">&times;</button>
                </div>
                <div class="upload-body" style="background:#0f0f0f;">
                    <!-- Enhanced Upload Zone with Drag & Drop -->
                    <div id="uploadZone" class="upload-zone enhanced-upload-zone" onclick="document.getElementById('videoFileInput').click()" style="border:2px dashed #333; background:#111;">
                        <div id="uploadZoneContent" style="max-width:680px; margin:0 auto; text-align:center;">
                            <div style="font-size:64px; margin-bottom:12px;">üì§</div>
                            <div style="font-size:20px; font-weight:700; margin-bottom:6px;">Drag and drop video files to upload</div>
                            <div style="font-size:13px; color:#aaa; margin-bottom:14px;">Your videos will be private until you publish them.</div>
                            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                                <button class="btn-enhanced" style="background:#3ea6ff; color:#111; border:0; padding:10px 16px; font-weight:700;" onclick="document.getElementById('videoFileInput').click(); event.stopPropagation(); return false;">Select files</button>
                                <button class="btn-enhanced" style="background:#1f1f1f; border:1px solid #333; color:#fff; padding:10px 16px;" onclick="document.getElementById('videoFileInput').click(); event.stopPropagation(); return false;">Import from device</button>
                            </div>
                        </div>
                        <input type="file" id="videoFileInput" class="upload-input" accept="video/*" multiple>
                    </div>
                    
                    <!-- Video Preview Section -->
                    <div id="videoPreviewSection" style="display:none; margin-bottom:16px;">
                        <div style="background:var(--bg-secondary); border-radius:8px; padding:12px;">
                            <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                                <video id="videoPreview" style="width:80px; height:45px; border-radius:4px; object-fit:cover;" muted></video>
                                <div style="flex:1;">
                                    <div id="videoFileName" style="font-weight:600; font-size:14px; color:var(--text-primary);"></div>
                                    <div id="videoFileInfo" style="font-size:12px; color:var(--text-secondary);"></div>
                                </div>
                                <button onclick="removeVideoFile()" style="background:var(--error); color:#fff; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer; font-size:12px;">&times;</button>
                            </div>
                            <div id="videoAnalysis" style="font-size:11px; color:var(--text-secondary); display:flex; gap:12px; flex-wrap:wrap;"></div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Form Fields -->
                    <div class="upload-row">
                        <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Title *</label>
                        <input type="text" id="umTitle" class="upload-input-text" placeholder="Enter video title" maxlength="100">
                        <div style="text-align:right; font-size:11px; color:var(--text-secondary); margin-top:2px;"><span id="titleCount">0</span>/100</div>
                    </div>
                    
                    <div class="upload-row">
                        <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Description</label>
                        <textarea id="umDesc" class="upload-textarea" rows="3" placeholder="Tell viewers about your video" maxlength="500"></textarea>
                        <div style="text-align:right; font-size:11px; color:var(--text-secondary); margin-top:2px;"><span id="descCount">0</span>/500</div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;" class="upload-row">
                        <div>
                            <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Category</label>
                            <select id="umCategory" class="upload-select">
                                <option value="entertainment">üé≠ Entertainment</option>
                                <option value="music">üéµ Music</option>
                                <option value="gaming">üéÆ Gaming</option>
                                <option value="education">üìö Education</option>
                                <option value="news">üì∞ News</option>
                                <option value="sports">‚öΩ Sports</option>
                                <option value="tech">üíª Tech</option>
                                <option value="lifestyle">‚ú® Lifestyle</option>
                                <option value="comedy">üòÇ Comedy</option>
                                <option value="travel">‚úàÔ∏è Travel</option>
                            </select>
                        </div>
                        <div>
                            <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Visibility</label>
                            <select id="umVisibility" class="upload-select">
                                <option value="public">üåç Public</option>
                                <option value="unlisted">üîó Unlisted</option>
                                <option value="private">üîí Private</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Thumbnail Options -->
                    <div class="upload-row">
                        <label style="display:block; font-weight:600; margin-bottom:8px; color:var(--text-primary);">Thumbnail</label>
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(80px, 1fr)); gap:8px; margin-bottom:8px;" id="thumbnailOptions">
                            <!-- Auto-generated thumbnails will appear here -->
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="file" id="umThumb" accept="image/*" style="display:none;">
                            <button onclick="document.getElementById('umThumb').click()" style="flex:1; padding:8px 12px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary); cursor:pointer; font-size:12px;">üìÅ Upload Custom</button>
                            <button onclick="generateThumbnails()" style="flex:1; padding:8px 12px; background:var(--accent); border:none; border-radius:6px; color:#000; cursor:pointer; font-size:12px; font-weight:600;">‚ú® Auto Generate</button>
                        </div>
                    </div>
                    
                    <!-- Advanced Options -->
                    <div class="upload-row">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                            <input type="checkbox" id="enableComments" checked>
                            <label for="enableComments" style="font-size:14px; color:var(--text-primary);">Allow comments</label>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                            <input type="checkbox" id="enableLikes" checked>
                            <label for="enableLikes" style="font-size:14px; color:var(--text-primary);">Show like/dislike counts</label>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <input type="checkbox" id="enableNotifications" checked>
                            <label for="enableNotifications" style="font-size:14px; color:var(--text-primary);">Notify subscribers</label>
                        </div>
                    </div>
                    
                    <!-- Upload Actions -->
                    <div class="upload-row" style="position:sticky; bottom:0; background:#0f0f0f; padding-top:12px; border-top:1px solid #222;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <button id="umSaveDraft" class="btn-enhanced" style="background:#1f1f1f; border:1px solid #333; color:#fff; flex:0 0 auto;">Save draft</button>
                            <div style="flex:1"></div>
                            <button id="umPublish" class="btn-enhanced" style="background:#ff0000; border:0; color:#fff; font-weight:800; padding:10px 18px;">Publish</button>
                        </div>
                        <button id="umSignIn" class="btn-enhanced" style="width:100%; margin-top:10px; display:none; background:#3ea6ff; color:#111;">Sign in with Google to Upload</button>
                    </div>

                    <!-- Enhanced Progress Section -->
                    <div class="upload-progress" id="umProgress">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                            <div style="font-weight:600; color:var(--text-primary);">Uploading...</div>
                            <div style="font-size:12px; color:var(--text-secondary);">
                                <span id="uploadSpeed">0 MB/s</span> ‚Ä¢ <span id="timeRemaining">Calculating...</span>
                            </div>
                        </div>
                        <div class="upload-progress-bar">
                            <div class="upload-progress-fill" id="umFill"></div>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--text-secondary); margin-top:6px;">
                            <span id="uploadStatus">Preparing upload...</span>
                            <span id="umPct">0%</span>
                        </div>
                        <div id="uploadSteps" style="margin-top:12px; font-size:11px; color:var(--text-secondary);">
                            <div id="step1" style="margin-bottom:4px;">üìÅ File validation: <span style="color:var(--warning);">Pending</span></div>
                            <div id="step2" style="margin-bottom:4px;">üì§ Upload: <span style="color:var(--text-secondary);">Waiting</span></div>
                            <div id="step3" style="margin-bottom:4px;">üé¨ Processing: <span style="color:var(--text-secondary);">Waiting</span></div>
                            <div id="step4">‚úÖ Publishing: <span style="color:var(--text-secondary);">Waiting</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="site-footer" role="contentinfo" style="margin-top:64px; padding:32px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border); color: var(--text-secondary);">
        <div style="max-width:1200px; margin:0 auto; display:flex; flex-wrap:wrap; gap:16px; align-items:center; justify-content:space-between;">
            <div style="font-size:14px;">&copy; 2025 MyChannel. All rights reserved.</div>
            <nav aria-label="Footer" style="display:flex; gap:16px; font-size:14px; flex-wrap:wrap;">
                <a href="/privacy.html" style="color:var(--text-primary); text-decoration:none;">Privacy</a>
                <a href="/terms.html" style="color:var(--text-primary); text-decoration:none;">Terms</a>
                <a href="/contact.html" style="color:var(--text-primary); text-decoration:none;">Contact</a>
                <a href="/sitemap.xml" style="color:var(--text-primary); text-decoration:none;">Sitemap</a>
            </nav>
        </div>
    </footer>

    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js?v=107').catch(function(e){
                    console.error('SW registration failed', e);
                });
            });
        }
    </script>
    <script>
        // Flicks Viewer Implementation
        let currentFlickIndex = 0;
        let flicksData = [];
        let flicksSwipeStartX = 0;
        let flicksSwipeEndX = 0;

        // Sample flicks data - replace with real data from your backend
        const sampleFlicks = [
            {
                id: '1',
                title: 'Amazing Sunset Timelapse',
                creator: 'NatureFilms',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                likes: 1234,
                comments: 89,
                shares: 45
            },
            {
                id: '2', 
                title: 'City Life in 60 Seconds',
                creator: 'UrbanExplorer',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4',
                likes: 2156,
                comments: 134,
                shares: 78
            },
            {
                id: '3',
                title: 'Quick Recipe: Pasta Magic',
                creator: 'ChefMike',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4',
                likes: 3421,
                comments: 267,
                shares: 156
            }
        ];

        async function openFlicks(startIndex = 0) {
            try {
                const feed = await getFlicksFeed();
                flicksData = Array.isArray(feed) && feed.length ? feed : sampleFlicks;
            } catch { flicksData = sampleFlicks; }
            currentFlickIndex = startIndex;
            const viewer = document.getElementById('flicksViewer');
            viewer.classList.add('active');
            document.body.style.overflow = 'hidden';
            renderFlicksHorizontal();
            setupFlicksGesturesHorizontal();
            // Allow bottom nav taps while viewer is open
            try { document.querySelectorAll('.bottom-nav .nav-item').forEach(el => el.style.pointerEvents = 'auto'); } catch {}
        }

        async function getFlicksFeed() {
            try {
                await initFirebase();
                const snap = await db.collection('flicks').orderBy('createdAt', 'desc').limit(50).get();
                const arr = snap.docs.map(d => ({ id: d.id, ...(d.data()||{}) }));
                return arr.filter(x => x && x.videoUrl).map(x => ({ id: x.id, title: x.title||'', videoUrl: x.videoUrl }));
            } catch (e) { return []; }
        }

        function closeFlicks() {
            const viewer = document.getElementById('flicksViewer');
            try { document.querySelectorAll('#flicksContainer video').forEach(v => { try { v.pause(); } catch {}; try { v.removeAttribute('src'); v.load(); } catch {}; }); } catch {}
            viewer.classList.remove('active');
            document.body.style.overflow = '';
            // Re-enable tab interactions
            try { document.querySelectorAll('.bottom-nav .nav-item').forEach(el => el.style.pointerEvents = 'auto'); } catch {}
        }

        function renderFlicksHorizontal() {
            const wrap = document.getElementById('flicksContainer');
            if (!wrap) return;
            wrap.innerHTML = '';
            wrap.style.display = 'flex';
            wrap.style.overflowX = 'hidden';
            wrap.style.scrollSnapType = 'x mandatory';
            wrap.style.paddingBottom = '52px'; /* visually occupy area under navbar */
            flicksData.forEach((f, i) => {
                const pane = document.createElement('div');
                pane.style.cssText = 'position:relative; width:100vw; height:calc(100vh - 64px - 52px - env(safe-area-inset-bottom)); flex:0 0 100%; scroll-snap-align:center; background:#000; display:flex; align-items:center; justify-content:center;';
                pane.innerHTML = `<video src="${f.videoUrl}" playsinline loop style="width:100%; height:100%; object-fit:cover;"></video>`;
                wrap.appendChild(pane);
            });
            // Autoplay current
            requestAnimationFrame(() => {
                const v = wrap.querySelectorAll('video')[currentFlickIndex];
                if (v) v.play().catch(()=>{});
            });
        }

        function setupFlicksGesturesHorizontal() {
            const wrap = document.getElementById('flicksContainer');
            if (!wrap) return;
            const threshold = 40;
            let startX = 0; let deltaX = 0;
            wrap.addEventListener('touchstart', e => { startX = e.touches[0].clientX; deltaX = 0; }, {passive:true});
            wrap.addEventListener('touchmove', e => { deltaX = e.touches[0].clientX - startX; }, {passive:true});
            wrap.addEventListener('touchend', () => {
                if (Math.abs(deltaX) > threshold) {
                    currentFlickIndex = (currentFlickIndex + (deltaX < 0 ? 1 : -1) + flicksData.length) % flicksData.length;
                    wrap.scrollTo({ left: currentFlickIndex * wrap.clientWidth, behavior: 'smooth' });
                    wrap.querySelectorAll('video').forEach((v, i) => { if (i===currentFlickIndex) v.play().catch(()=>{}); else v.pause(); });
                }
            });
            // Allow taps to fall through to bottom nav by not intercepting
            wrap.style.pointerEvents = 'auto';
            document.getElementById('flicksViewer').style.pointerEvents = 'auto';
        }

        function toggleFlicksMute() {
            const btn = document.getElementById('flicksMuteBtn');
            const vids = document.querySelectorAll('#flicksContainer video');
            if (!vids.length) return;
            const nowMuted = !(vids[0].muted === false);
            vids.forEach(v => v.muted = !nowMuted);
            btn.textContent = nowMuted ? 'üîä' : 'üîá';
        }

        // Enhanced Movie Integration with Fallback Data
        const fallbackMovies = [
            {
                id: 1,
                title: "The Shawshank Redemption",
                overview: "Two imprisoned men bond over a number of years, finding solace and eventual redemption through acts of common decency.",
                poster: "https://image.tmdb.org/t/p/w780/q6y0Go1tsGEsmtFryDOJo3dEmqu.jpg",
                vote_average: 9.3,
                release_date: "1994-09-23"
            },
            {
                id: 2,
                title: "The Godfather",
                overview: "The aging patriarch of an organized crime dynasty transfers control of his clandestine empire to his reluctant son.",
                poster: "https://image.tmdb.org/t/p/w780/3bhkrj58Vtu7enYsRolD1fZdja1.jpg",
                vote_average: 9.2,
                release_date: "1972-03-14"
            },
            {
                id: 3,
                title: "The Dark Knight",
                overview: "When the menace known as the Joker wreaks havoc and chaos on the people of Gotham, Batman must accept one of the greatest psychological and physical tests.",
                poster: "https://image.tmdb.org/t/p/w780/qJ2tW6WMUDux911r6m7haRef0WH.jpg",
                vote_average: 9.0,
                release_date: "2008-07-18"
            },
            {
                id: 4,
                title: "Pulp Fiction",
                overview: "The lives of two mob hitmen, a boxer, a gangster and his wife, and a pair of diner bandits intertwine in four tales of violence and redemption.",
                poster: "https://image.tmdb.org/t/p/w780/d5iIlFn5s0ImszYzBPb8JPIfbXD.jpg",
                vote_average: 8.9,
                release_date: "1994-10-14"
            },
            {
                id: 5,
                title: "Forrest Gump",
                overview: "The presidencies of Kennedy and Johnson, the Vietnam War, the Watergate scandal and other historical events unfold from the perspective of an Alabama man.",
                poster: "https://image.tmdb.org/t/p/w780/arw2vcBveWOVZr6pxd9XTd1TdQa.jpg",
                vote_average: 8.8,
                release_date: "1994-06-23"
            },
            {
                id: 6,
                title: "Inception",
                overview: "A thief who steals corporate secrets through the use of dream-sharing technology is given the inverse task of planting an idea into the mind of a C.E.O.",
                poster: "https://image.tmdb.org/t/p/w780/9gk7adHYeDvHkCSEqAvQNLV5Uge.jpg",
                vote_average: 8.8,
                release_date: "2010-07-15"
            },
            {
                id: 7,
                title: "The Matrix",
                overview: "A computer programmer is led to fight an underground war against powerful computers who have constructed his entire reality with a system called the Matrix.",
                poster: "https://image.tmdb.org/t/p/w780/f89U3ADr1oiB1s9GkdPOEpXUk5H.jpg",
                vote_average: 8.7,
                release_date: "1999-03-30"
            },
            {
                id: 8,
                title: "Goodfellas",
                overview: "The story of Henry Hill and his life in the mob, covering his relationship with his wife Karen Hill and his mob partners.",
                poster: "https://image.tmdb.org/t/p/w780/aKuFiU82s5ISJpGZp7YkIr3kCUd.jpg",
                vote_average: 8.7,
                release_date: "1990-09-12"
            }
        ];
        
        async function loadFreeMovies(provider = 'tubi') {
            try { renderMovies(fallbackMovies); } catch {}
            try {
                const response = await fetch(CONTENT_FEED_ENDPOINT);
                if (!response.ok) throw new Error('API not available');
                const data = await response.json();
                renderMovies(Array.isArray(data.items) ? data.items : fallbackMovies);
            } catch (error) {
                try {
                    const TMDB_API_KEY = 'cc1d44a1b1c8a4f2a5890cad1660d0be';
                    const providerIds = { tubi: '73', pluto: '300', roku: '207', freevee: '613', plex: '538', crackle: '12' };
                    const params = new URLSearchParams({
                        api_key: TMDB_API_KEY,
                        language: 'en-US',
                        sort_by: 'popularity.desc',
                        include_adult: 'false',
                        include_video: 'false',
                        page: '1',
                        region: 'US',
                        with_watch_monetization_types: 'free|ads'
                    });
                    if (provider !== 'all' && providerIds[provider]) {
                        params.set('with_watch_providers', providerIds[provider]);
                    }
                    const r = await fetch(`https://api.themoviedb.org/3/discover/movie?${params.toString()}`);
                    if (!r.ok) throw new Error('TMDB fetch failed');
                    const tmdb = await r.json();
                    const base = 'https://image.tmdb.org/t/p/w780';
                    const items = (tmdb.results || []).slice(0, 24).map(m => ({
                        id: m.id,
                        title: m.title || m.name || 'Untitled',
                        overview: m.overview || '',
                        poster: base + (m.backdrop_path || m.poster_path || ''),
                        vote_average: m.vote_average || 0,
                        release_date: m.release_date || ''
                    }));
                    renderMovies(items);
                } catch (e) {
                console.log('Using fallback movie data');
                renderMovies(fallbackMovies);
            }
        }
        }
        function renderMovies(movies) {
            const container = document.getElementById('freeMoviesRow');
            if (!container) return;
            
            const fragment = document.createDocumentFragment();
            movies.forEach(movie => {
                const movieCard = document.createElement('div');
                movieCard.className = 'video-card trend-card fade-in';
                movieCard.style.cssText = 'width:320px; flex:0 0 320px; cursor:pointer; scroll-snap-align:start; position:relative;';
                movieCard.onclick = () => openMovieModal(movie.id, 'movie');
                
                movieCard.innerHTML = `
                    <div class=\"video-thumbnail\">
                        <img src=\"${(movie.poster && (movie.poster + (movie.poster.includes('?') ? '&' : '?') + 'v=105')) || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjI3MCIgdmlld0JveD0iMCAwIDE4MCAyNzAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMjcwIiBmaWxsPSIjMzMzIi8+Cjx0ZXh0IHg9XCI5MFwiIHk9XCIxMzVcIiBmaWxsPVwiIzc2NlwiIGZvbnQtZmFtaWx5PVwiQXJpYWxcIiBmb250LXNpemU9XCIxNFwiIHRleHQtYW5jaG9yPVwibWlkZGxlXCIgZG9taW5hbnQtYmFzZWxpbmU9XCJtaWRkbGVcIj5Nb3ZpZSBQb3N0ZXI8L3RleHQ+Cjwvc3ZnPgo='}\" alt=\"${movie.title}\" loading=\"lazy\" style=\"width:100%; height:100%; object-fit:cover;\" onerror=\"this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjI3MCIgdmlld0JveD0iMCAwIDE4MCAyNzAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMjcwIiBmaWxsPSIjMzMzIi8+Cjx0ZXh0IHg9XCI5MFwiIHk9XCIxMzVcIiBmaWxsPVwiIzc2NlwiIGZvbnQtZmFtaWx5PVwiQXJpYWxcIiBmb250LXNpemU9XCIxNFwiIHRleHQtYW5jaG9yPVwibWlkZGxlXCIgZG9taW5hbnQtYmFzZWxpbmU9XCJtaWRkbGVcIj5Nb3ZpZSBQb3N0ZXI8L3RleHQ+Cjwvc3ZnPgo='\">\n                        <div class=\"video-duration\">Movie</div>\n                        <button class=\"btn-enhanced\" style=\"position:absolute; bottom:8px; right:8px; padding:6px 10px; font-size:12px;\" onclick=\"event.stopPropagation(); playTrailer(${movie.id})\">Trailer</button>\n                    </div>\n                    <div class=\"video-info compact\">\n                        <div class=\"video-text\">\n                            <h3 class=\"video-title\">${movie.title}</h3>\n                            <div class=\"video-subtext\">\n                                <span class=\"rating\"><span class=\"star\">‚òÖ</span>${movie.vote_average.toFixed(1)}</span>\n                                <span class=\"dot\">‚Ä¢</span><span class=\"year\">${movie.release_date.split('-')[0] || 'N/A'}</span>\n                            </div>\n                        </div>\n                    </div>\n                `;
                fragment.appendChild(movieCard);
            });
            container.innerHTML = '';
            container.appendChild(fragment);
            // Ensure newly rendered cards fade in
            requestAnimationFrame(() => {
                container.querySelectorAll('.fade-in').forEach(el => el.classList.add('visible'));
            });
        }
        
        // Fallback trending data - sample user videos
        const fallbackTrending = [
            {
                id: 't1',
                title: 'Amazing Nature Documentary - Wildlife in 4K',
                description: 'Experience the beauty of nature with this stunning 4K wildlife documentary.',
                thumbnail: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                duration: '9:56',
                views: '2.1M views',
                uploadTime: '3 days ago',
                channel: { name: 'Nature Explorer', avatar: 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG', subscribers: '1.2M' }
            },
            {
                id: 't2',
                title: 'Epic Travel Vlog - Exploring Hidden Gems',
                description: 'Join me on an incredible journey to discover hidden gems around the world.',
                thumbnail: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4',
                duration: '12:34',
                views: '1.8M views',
                uploadTime: '1 week ago',
                channel: { name: 'Adventure Seeker', avatar: 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG', subscribers: '850K' }
            },
            {
                id: 't3',
                title: 'Sintel - Open Movie',
                description: 'Award-winning animated short film produced by the Blender Institute.',
                thumbnail: 'https://images.unsplash.com/photo-1529101091764-c3526daf38fe?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4',
                duration: '14:48',
                views: '5.4M views',
                uploadTime: '2 weeks ago',
                channel: { name: 'Blender Studio', avatar: 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG', subscribers: '1.1M' }
            },
            {
                id: 't4',
                title: 'Tears of Steel - Sci-Fi Short',
                description: 'A high-quality sci-fi short with epic VFX and a dramatic storyline.',
                thumbnail: 'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4',
                duration: '12:14',
                views: '3.8M views',
                uploadTime: '1 month ago',
                channel: { name: 'Open Movies', avatar: 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG', subscribers: '890K' }
            }
        ];
        
        async function loadTrending(mediaType = 'movie') {
            // Replace API-based trending with actual sample videos from the local library
            try {
                const samples = Array.isArray(window.videoLibrary) ? window.videoLibrary.slice(0, 12) : [];
                if (samples.length) {
                    renderTrendingMovies(samples);
                    return;
                }
            } catch {}
            // Fallback (very last resort)
            try { renderTrendingMovies(fallbackTrending); } catch {}
        }
        function renderTrendingMovies(movies) {
            const container = document.getElementById('trendingRow') || document.getElementById('trendingRowLegacy');
            if (!container) return;
            
            const fragment = document.createDocumentFragment();
            movies.forEach(movie => {
                const movieCard = document.createElement('div');
                movieCard.className = 'video-card fade-in';
                movieCard.style.cssText = 'width:320px; flex:0 0 320px; cursor:pointer; scroll-snap-align:start;';
                const thumb = movie.thumbnail || movie.thumbnailUrl || movie.thumb || movie.poster || movie.image || 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&h=400&fit=crop';
                const desc = (movie.description || movie.overview || '').toString();
                const rating = (typeof movie.vote_average === 'number') ? movie.vote_average.toFixed(1) : '';
                const year = (movie.release_date || '').split('-')[0] || '';
                const views = movie.views || '';
                const when = movie.uploadTime || '';
                
                movieCard.onclick = () => {
                    if (movie.videoUrl) {
                        openVideoDetail(movie);
                    } else if (movie.id) {
                        openMovieModal(movie.id, 'movie');
                    }
                };
                
                const stats = movie.videoUrl
                    ? `<div class=\"video-stats\">${views ? `<span class=\"views\">${views}</span>` : ''}${when ? ` <span class=\"dot\">‚Ä¢</span> <span class=\"time\">${when}</span>` : ''}</div>`
                    : ((rating || year) ? `<div class=\"video-stats\">${rating ? `<span class=\"rating\"><span class=\"star\">‚òÖ</span>${rating}</span>` : ''}${year ? `<span class=\"year\">${year}</span>` : ''}</div>` : '');
                
                movieCard.innerHTML = `
                    <div class="video-thumbnail">
                        <img src="${thumb}" alt="${movie.title}" loading="lazy" style="width:100%; height:100%; object-fit:cover;">
                        <div class="video-duration">Trending</div>
                    </div>
                    <div class="video-info compact">
                        <div class="video-text">
                            <h3 class="video-title">${movie.title}</h3>
                            <div class="video-subtext">
                                <span class="channel-name">${(movie.channel && movie.channel.name) || 'MyChannel'}</span>
                                ${views ? `<span class=\"dot\">‚Ä¢</span><span class=\"views\">${views}</span>` : ''}
                                ${when ? `<span class=\"dot\">‚Ä¢</span><span class=\"time\">${when}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                fragment.appendChild(movieCard);
            });
            container.innerHTML = '';
            container.appendChild(fragment);
            // Ensure newly rendered cards fade in
            requestAnimationFrame(() => {
                container.querySelectorAll('.fade-in').forEach(el => el.classList.add('visible'));
            });
        }
        
        // Categories: simple chips + demo items
        function initCategories() {
            const chips = [
                'All','Music','Gaming','Sports','News','Tech','Movies','Comedy','Live'
            ];
            const wrap = document.getElementById('categoriesChips');
            if (wrap) {
                wrap.innerHTML = chips.map((c,i)=>`<button class="trending-filter ${i===0?'active':''}" onclick="filterCategory('${c}')" style="padding:4px 12px; border-radius:20px; border:1px solid var(--border); background:${i===0?'var(--primary)':'transparent'}; color:${i===0?'#fff':'var(--text-primary)'}; font-size:12px; cursor:pointer;">${c}</button>`).join('');
            }
            renderCategories('All');
        }
        function filterCategory(c) { renderCategories(c); }
        function renderCategories(filter) {
            const row = document.getElementById('categoriesRow');
            if (!row) return;
            // Map sample library into categorized items
            const base = (Array.isArray(window.videoLibrary) ? window.videoLibrary : []).map(v => ({
                id: v.id,
                title: v.title,
                image: v.thumbnail || v.thumbnailUrl || v.thumb || v.poster || v.image,
                tag: (() => {
                    const t = v.title.toLowerCase();
                    if (t.includes('music') || t.includes('beat')) return 'Music';
                    if (t.includes('game') || t.includes('warzone')) return 'Gaming';
                    if (t.includes('news')) return 'News';
                    if (t.includes('tech') || t.includes('gadget')) return 'Tech';
                    if (t.includes('film') || t.includes('movie')) return 'Movies';
                    if (t.includes('comedy') || t.includes('fun')) return 'Comedy';
                    return 'Live';
                })(),
                video: v
            }));
            // If no library, use static demo
            const fallback = [
                { id:'cat1', title:'Warzone: 20 Kill Solo Win', image:'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=800', tag:'Gaming', video: null },
                { id:'cat2', title:'Top 10 Tips to Win Solo', image:'https://images.unsplash.com/photo-1511512578047-dfb367046420?w=800', tag:'Gaming', video: null },
                { id:'cat3', title:'Morning World News', image:'https://images.unsplash.com/photo-1453873531674-2151bcd01707?w=800', tag:'News', video: null },
                { id:'cat4', title:'New Phone Review', image:'https://images.unsplash.com/photo-1510552776732-01acc9a4c44e?w=800', tag:'Tech', video: null },
                { id:'cat5', title:'Pop Hits Mix', image:'https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=800', tag:'Music', video: null }
            ];
            const items = base.length ? base : fallback;
            const pool = filter==='All' ? items : items.filter(i=>i.tag===filter);
            row.innerHTML = pool.map(i=>`
                <div class="video-card fade-in" style="width:320px; flex:0 0 320px; cursor:pointer; scroll-snap-align:start;">
                    <div class="video-thumbnail">
                        <img src="${i.image}" alt="${i.title}" loading="lazy" style="width:100%; height:100%; object-fit:cover;">
                        <div class="video-duration">${i.tag}</div>
                    </div>
                    <div class="video-info compact">
                        <div class="video-text">
                            <h3 class="video-title">${i.title}</h3>
                            <div class="video-subtext">
                                <span class="channel-name">${(i.video && i.video.channel && i.video.channel.name) || 'MyChannel'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            // Click handlers for playable items
            Array.from(row.children).forEach((card, idx) => {
                const item = pool[idx];
                if (item && item.video && item.video.videoUrl) {
                    card.onclick = () => openVideoDetail(item.video);
                }
            });
            requestAnimationFrame(()=>{
                row.querySelectorAll('.fade-in').forEach(el=>el.classList.add('visible'));
            });
        }

        // Live TV with preview and resume
        const liveTVChannels = [
            // Public 24/7 HLS demo streams with poster thumbnails and MP4 preview loops
            { id:'live1', title:'NASA TV', thumb:'https://images-assets.nasa.gov/image/PIA12348/PIA12348~medium.jpg', url:'https://ntv1.akamaized.net/hls/live/2014075/NASA-NTV1-Public/master.m3u8', preview:'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4' },
            { id:'live2', title:'Bloomberg TV', thumb:'https://assets.bwbx.io/images/users/iqjWHBFdfxIU/iCwe8rFjKs6g/v1/1200x800.jpg', url:'https://www.bloomberg.com/media-manifest/streams/asia.m3u8', preview:'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4' },
            { id:'live3', title:'DW News', thumb:'https://static.dw.com/image/64219795_605.jpg', url:'https://dwamdstream102.akamaized.net/hls/live/2015530/dwstream102/index.m3u8', preview:'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4' }
        ];
        const livePreviewTimes = {};
        function loadLiveTV() {
            const row = document.getElementById('liveTVRow');
            if (!row) return;
            row.innerHTML = '';
            liveTVChannels.forEach(ch => {
                const card = document.createElement('div');
                card.className = 'video-card fade-in';
                card.style.cssText = 'width:320px; flex:0 0 320px; cursor:pointer; scroll-snap-align:start; position:relative;';
                card.innerHTML = `
                    <div class="video-thumbnail" style="position:relative;">
                        <video data-live-url="${ch.url}" src="${(ch.preview||ch.url)}" muted autoplay loop playsinline webkit-playsinline preload="auto" poster="${ch.thumb}" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover;"></video>
                        <div class="video-duration">LIVE</div>
                    </div>
                    <div class="video-info compact">
                        <div class="video-text">
                            <h3 class="video-title">${ch.title}</h3>
                            <div class="video-subtext"><span class="channel-name">Live</span></div>
                        </div>
                    </div>`;
                const vid = card.querySelector('video');
                // Autoplay preview silently if allowed by settings; resume time after metadata loads
                vid.addEventListener('loadedmetadata', ()=>{ try { vid.muted = true; if ((livePreviewTimes[ch.id]||0) > 0) { vid.currentTime = livePreviewTimes[ch.id]; } if (notificationSettings?.appearance?.autoplayPreviews !== false) { vid.play().catch(()=>{}); } } catch {} }, { once:true });
                vid.addEventListener('error', ()=>{ try { if (ch.preview && !vid.src.includes(ch.preview)) { vid.src = ch.preview; } } catch {} });
                // Track preview time regularly
                vid.ontimeupdate = () => { livePreviewTimes[ch.id] = vid.currentTime; };
                // Open full player and resume from preview time
                card.onclick = () => {
                    const resumeAt = livePreviewTimes[ch.id] || 0;
                    openVideoDetail({ id: ch.id, title: ch.title, videoUrl: (vid.getAttribute('data-live-url')||ch.url), views: 0, uploadTime: 'LIVE', channel: { name: 'Live', avatar: 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG', subscribers: 0 }, description: '' });
                    const full = document.getElementById('detailVideoPlayer');
                    const tryResume = () => { try { full.currentTime = resumeAt; } catch {} };
                    full.addEventListener('loadedmetadata', tryResume, { once:true });
                };
                row.appendChild(card);
            });
            // Ensure preview videos autoplay/pause when visible to avoid blocked autoplay
            try {
                const observer = new IntersectionObserver((entries)=>{
                    entries.forEach(e=>{
                        const v = e.target;
                        if (e.isIntersecting) {
                            try { if (notificationSettings?.appearance?.autoplayPreviews !== false) { v.play().catch(()=>{}); } } catch {}
                        } else {
                            try { v.pause(); } catch {}
                        }
                    });
                }, { root: row, threshold: 0.2 });
                row.querySelectorAll('video').forEach(v=>observer.observe(v));
            } catch {}
            requestAnimationFrame(()=>{
                row.querySelectorAll('.fade-in').forEach(el=>el.classList.add('visible'));
            });
        }
        async function openMovieModal(movieId, mediaType = 'movie') {
            try {
                let movie;
                try {
                    const response = await fetch(`/api/tmdb_details?id=${movieId}&media_type=${mediaType}`);
                    if (!response.ok) throw new Error('API not available');
                    movie = await response.json();
                } catch (error) {
                    try {
                        const TMDB_API_KEY = 'cc1d44a1b1c8a4f2a5890cad1660d0be';
                        const base = 'https://image.tmdb.org/t/p/w780';
                        const detailsR = await fetch(`https://api.themoviedb.org/3/${mediaType}/${movieId}?api_key=${TMDB_API_KEY}&language=en-US`);
                        const providersR = await fetch(`https://api.themoviedb.org/3/${mediaType}/${movieId}/watch/providers?api_key=${TMDB_API_KEY}`);
                        if (!detailsR.ok) throw new Error('TMDB details fetch failed');
                        const details = await detailsR.json();
                        const providers = await providersR.json().catch(()=>({}));
                        const us = (providers.results || {}).US || {};
                        movie = {
                            id: details.id,
                            title: details.title || details.name || 'Untitled',
                            overview: details.overview || '',
                            poster: base + (details.backdrop_path || details.poster_path || ''),
                            vote_average: details.vote_average || 0,
                            release_date: details.release_date || details.first_air_date || '',
                            runtime: details.runtime || (Array.isArray(details.episode_run_time) ? details.episode_run_time[0] : 0),
                            genres: (details.genres || []).map(g => g.name),
                            watch_providers: { free: (us.free || []).map(p => ({ provider_name: p.provider_name, logo_path: 'https://image.tmdb.org/t/p/w92' + (p.logo_path || ''), provider_id: p.provider_id })) }
                        };
                    } catch (e) {
                    const allMovies = [...fallbackMovies, ...fallbackTrending];
                    movie = allMovies.find(m => m.id === movieId) || {
                        id: movieId,
                        title: "Sample Movie",
                        overview: "This is a sample movie description. The actual movie data will be available once the API is connected.",
                        poster: "https://image.tmdb.org/t/p/w780/sample.jpg",
                        vote_average: 8.0,
                        release_date: "2023-01-01",
                        runtime: 120,
                        genres: ["Action", "Drama"],
                        watch_providers: { free: [] }
                    };
                    }
                }
                
                // Create modal with movie data
                const modal = createMovieModal(movie);
                document.body.appendChild(modal);
                
                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                
            } catch (error) {
                console.error('Error loading movie details:', error);
            }
        }
        
        // Fetch and play trailer for Movies
        async function playTrailer(movieId, mediaType = 'movie') {
            try {
                // Try Cloud Function first
                const r = await fetch(`/api/tmdb_details?id=${movieId}&media_type=${mediaType}`);
                let trailerUrl = null;
                if (r.ok) {
                    const details = await r.json();
                    const vids = (details.videos && details.videos.results) || [];
                    const best = vids.find(v => v.type === 'Trailer' && v.site === 'YouTube') || vids[0];
                    if (best && best.key) {
                        trailerUrl = `https://www.youtube.com/watch?v=${best.key}`;
                    }
                }
                if (!trailerUrl) {
                    // Fallback: direct TMDB videos endpoint
                    const TMDB_API_KEY = 'cc1d44a1b1c8a4f2a5890cad1660d0be';
                    const rv = await fetch(`https://api.themoviedb.org/3/${mediaType}/${movieId}/videos?api_key=${TMDB_API_KEY}&language=en-US`);
                    if (rv.ok) {
                        const data = await rv.json();
                        const vids = (data.results || []);
                        const best = vids.find(v => v.type === 'Trailer' && v.site === 'YouTube') || vids[0];
                        if (best && best.key) {
                            trailerUrl = `https://www.youtube.com/watch?v=${best.key}`;
                        }
                    }
                }
                if (!trailerUrl) {
                    // Final fallback demo trailer
                    trailerUrl = 'https://www.youtube.com/watch?v=dQw4w9WgXcQ';
                }
                openVideoDetail({
                    id: `trailer-${movieId}`,
                    title: 'Trailer',
                    videoUrl: trailerUrl.replace('watch?v=', 'embed/') + '?autoplay=1&mute=0',
                    views: 0,
                    uploadTime: '',
                    channel: { name: 'Trailer', avatar: 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG', subscribers: 0 },
                    description: ''
                });
            } catch (e) {
                console.warn('Failed to play trailer', e);
            }
        }
        
        function createMovieModal(movie) {
                const modal = document.createElement('div');
                modal.className = 'upload-modal-backdrop';
                modal.style.display = 'flex';
            const year = (movie.release_date||'').split('-')[0] || '';
            const runtime = movie.runtime ? `${movie.runtime} min` : '';
            const rating = (typeof movie.vote_average === 'number') ? movie.vote_average.toFixed(1) : (movie.vote_average||'');
            const poster = movie.poster || movie.thumb || '';
            const genres = (movie.genres||[]).join(', ');
            const overview = movie.overview || '';
                modal.innerHTML = `
                    <div class="upload-modal" style="display:flex;">
                    <div class="upload-card" style="max-width:920px; background:#000; color:#fff; overflow:hidden;">
                        <div style="position:relative; height:360px;">
                            <img src="${poster}" alt="${escapeHTML(movie.title)}" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter:brightness(0.8);" onerror="this.style.display='none'">
                            <div style="position:absolute; inset:0; background: linear-gradient(180deg, rgba(0,0,0,0.35) 0%, rgba(0,0,0,0.0) 40%, rgba(0,0,0,0.75) 100%);"></div>
                            <div style="position:absolute; left:16px; right:16px; bottom:16px; display:flex; gap:16px; align-items:flex-end;">
                                <div style="width:110px; height:165px; border-radius:16px; overflow:hidden; box-shadow:0 10px 24px rgba(0,0,0,.5); background:rgba(255,255,255,0.06); display:none;"></div>
                                <div style="flex:1;">
                                    <div style="font-size:24px; font-weight:800; line-height:1.2;">${escapeHTML(movie.title)}</div>
                                    <div style="margin-top:8px; display:flex; gap:8px; align-items:center; font-size:12px; color:rgba(255,255,255,0.85);">
                                        <span style="background:rgba(255,255,255,0.15); padding:4px 8px; border-radius:999px;">‚òÖ ${rating}</span>
                                        ${year?`<span style=\"background:rgba(255,255,255,0.15); padding:4px 8px; border-radius:999px;\">${year}</span>`:''}
                                        ${runtime?`<span style=\"background:rgba(255,255,255,0.15); padding:4px 8px; border-radius:999px;\">${runtime}</span>`:''}
                            </div>
                                            </div>
                                <button class="upload-close" onclick="this.closest('.upload-modal-backdrop').remove()" aria-label="Close">&times;</button>
                                            </div>
                                        </div>
                        <div class="upload-body" style="background:#000; color:#fff;">
                            <div style="display:flex; gap:12px; margin-bottom:16px;">
                                <button class="btn-enhanced" style="flex:1; background:#fff; color:#000; font-weight:800;" onclick="playTrailer('${movie.id}')">Play Now</button>
                                <button onclick="shareMovie('${escapeHTML(movie.title)}')" style="background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2); padding:10px 16px; border-radius:12px; cursor:pointer;">Share</button>
                            </div>
                            ${overview ? `
                                            <div style="margin-bottom:16px;">
                                <div style="font-weight:700; margin-bottom:8px;">Synopsis</div>
                                <div id="movieOverview" style="color:rgba(255,255,255,0.85); line-height:1.6; display:-webkit-box; -webkit-line-clamp:4; -webkit-box-orient:vertical; overflow:hidden;">${escapeHTML(overview)}</div>
                                ${overview.length>200?`<button id="overviewToggle" style="margin-top:6px; background:none; border:0; color:#ff4444; font-weight:700; cursor:pointer;">Show More</button>`:''}
                            </div>` : ''}
                            ${genres ? `<div style="margin-bottom:16px; display:flex; gap:8px; flex-wrap:wrap;">${(movie.genres||[]).map(g=>`<span style=\"background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); padding:6px 10px; border-radius:999px; font-size:12px;\">${escapeHTML(g)}</span>`).join('')}</div>`:''}
                                                        </div>
                                                </div>
                </div>`;
            // Overview toggle
            const btn = modal.querySelector('#overviewToggle');
            if (btn) {
                btn.addEventListener('click', ()=>{
                    const el = modal.querySelector('#movieOverview');
                    const expanded = btn.getAttribute('data-expanded')==='1';
                    if (expanded) { el.style.display='-webkit-box'; btn.textContent='Show More'; btn.setAttribute('data-expanded','0'); }
                    else { el.style.display='block'; btn.textContent='Show Less'; btn.setAttribute('data-expanded','1'); }
                });
            }
                return modal;
        }
        function shareMovie(title) {
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: `Check out ${title} on MyChannel`,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(`Check out ${title} on MyChannel: ${window.location.href}`);
                alert('Link copied to clipboard!');
            }
        }

        // See all handlers
        function openSeeAllTrending() {
            const modal = document.getElementById('trendingSeeAll');
            const list = document.getElementById('trendingList');
            if (!modal || !list) return;
            modal.style.display = 'block';
            const inner = modal.querySelector('.upload-modal');
            if (inner) inner.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            renderTrendingSeeAll('today');
            wireTrendingSeeAll();
            if (!modal.__wiredBackdrop) {
                modal.addEventListener('click', (e)=>{ const card = modal.querySelector('.upload-card'); if (card && !card.contains(e.target)) closeSeeAllTrending(); });
                window.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeSeeAllTrending(); });
                modal.__wiredBackdrop = true;
            }
        }
        function closeSeeAllTrending() {
            const modal = document.getElementById('trendingSeeAll');
            if (!modal) return;
            modal.style.display = 'none';
            const inner = modal.querySelector('.upload-modal');
            if (inner) inner.style.display = 'none';
            document.body.style.overflow = '';
        }
        function wireTrendingSeeAll() {
            const tabs = document.getElementById('trendingTimeTabs');
            if (tabs && !tabs.__wired) {
                tabs.addEventListener('click', (e)=>{
                    const btn = e.target.closest('button[data-tf]');
                    if (!btn) return;
                    tabs.querySelectorAll('button[data-tf]').forEach(b=>{ if (b===btn) { b.style.background='var(--primary)'; b.style.color='#fff'; } else { b.style.background='var(--bg-secondary)'; b.style.color='var(--text-primary)'; } });
                    renderTrendingSeeAll(btn.getAttribute('data-tf'));
                });
                tabs.__wired = true;
            }
        }
        function renderTrendingSeeAll(timeframe='today') {
            const list = document.getElementById('trendingList');
            if (!list) return;
            let items = [];
            try { items = Array.isArray(window.videoLibrary) ? window.videoLibrary.slice(0, 40) : []; } catch {}
            if (!items.length) { try { items = fallbackTrending; } catch {} }
            // Simulate timeframe sort/filter by shuffling and slicing
            items = items.map((it,i)=> ({...it, rank: i+1}));
            list.innerHTML = items.map((v,idx)=> trendingRowHTML(v, idx+1)).join('');
            list.querySelectorAll('[data-trend-id]').forEach(row=>{
                row.addEventListener('click', ()=>{
                    const id = row.getAttribute('data-trend-id');
                    const title = row.getAttribute('data-title')||'Video';
                    if (row.getAttribute('data-video-url')) {
                        openVideoDetail({ id, title, videoUrl: row.getAttribute('data-video-url'), views: 0, uploadTime: '', channel: { name: 'Trending', avatar: 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG', subscribers: 0 }, description: '' });
                    } else if (row.getAttribute('data-movie-id')) {
                        openMovieModal(row.getAttribute('data-movie-id'), 'movie');
                    }
                });
            });
        }
        function trendingRowHTML(v, rank) {
            const thumb = v.thumbnailUrl || v.thumbnail || v.thumb || v.poster || 'https://images.unsplash.com/photo-1517817748491-7feac7c7d7bf?w=600&h=400&fit=crop';
            const channel = (v.channelName || (v.channel && v.channel.name) || 'Creator');
            const views = formatCompactNumber(v.views || v.popularity || 0);
            const idAttrs = v.id ? `data-trend-id="${v.id}"` : '';
            const urlAttr = v.videoUrl ? `data-video-url="${v.videoUrl}"` : '';
            const movieAttr = v.id ? `data-movie-id="${v.id}"` : '';
            return `
                <div class="video-card" ${idAttrs} ${urlAttr} ${movieAttr} style="display:flex; align-items:center; gap:12px; padding:14px; border-radius:16px; cursor:pointer; background:#121212;">
                    <div style="flex:0 0 36px; display:flex; align-items:center; justify-content:center;">
                        <div style="width:30px; height:30px; border-radius:50%; background:${rank<=3?'#ffd54f':'var(--bg-secondary)'}; color:${rank<=3?'#111':'var(--text-secondary)'}; display:flex; align-items:center; justify-content:center; font-weight:800;">${rank}</div>
                    </div>
                    <div style="width:120px; height:68px; border-radius:12px; overflow:hidden; position:relative; flex:0 0 120px;">
                        <img src="${thumb}" alt="${escapeHTML(v.title||'Trending')}" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover;" />
                    </div>
                    <div style="flex:1; min-width:0;">
                        <div style="font-weight:800; color:#fff; line-height:1.25; margin-bottom:6px;">${escapeHTML(v.title||'Trending')}</div>
                        <div style="color:#ccc; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHTML(channel)} ‚Ä¢ ${views} views</div>
                    </div>
                </div>
            `;
        }
        function openSeeAllMovies() {
            try { if (typeof openMoviesList === 'function') return openMoviesList(); } catch {}
            alert('Movies - See all coming soon');
        }

        // Live TV See All - dataset and rendering
        const LIVE_PREVIEW_MP4 = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';
        const liveTVSeeAllChannels = [
            { id:'aljazeera', name:'Al Jazeera English', description:'Global news 24/7', logoURL:'https://upload.wikimedia.org/wikipedia/commons/8/8f/Aljazeera.svg', streamURL:'https://live-hls-web-aje.getaj.net/AJE/01.m3u8', preview: LIVE_PREVIEW_MP4, category:'news', viewerCount: 32000, quality:'1080p', isLive:true },
            { id:'dw', name:'DW English', description:'Germany‚Äôs international broadcaster', logoURL:'https://upload.wikimedia.org/wikipedia/commons/0/03/Deutsche_Welle_symbol_2012.svg', streamURL:'https://dwamdstream102.akamaized.net/hls/live/2015530/dwstream102/index.m3u8', preview: LIVE_PREVIEW_MP4, category:'news', viewerCount: 21000, quality:'720p', isLive:true },
            { id:'france24', name:'France 24 (English)', description:'International news channel', logoURL:'https://upload.wikimedia.org/wikipedia/commons/8/8a/France_24_Logo.svg', streamURL:'https://static.france24.com/live/F24_EN_HI_HLS/master_900.m3u8', preview: LIVE_PREVIEW_MP4, category:'news', viewerCount: 14500, quality:'720p', isLive:true },
            { id:'nhkworld', name:'NHK World Japan', description:'Japan‚Äôs international broadcaster', logoURL:'https://upload.wikimedia.org/wikipedia/commons/5/53/NHK_World-Japan_logo.svg', streamURL:'https://nhkwlive-xjp.akamaized.net/hls/live/2003458/nhkwlive-xjp-en/index_4M.m3u8', preview: LIVE_PREVIEW_MP4, category:'international', viewerCount: 9800, quality:'1080p', isLive:true },
            { id:'sportradar', name:'Fox Sports', description:'Sports highlights and analysis', logoURL:'https://upload.wikimedia.org/wikipedia/commons/5/5e/Fox_Sports_logo.svg', streamURL:'https://example.com/foxsports.m3u8', preview: LIVE_PREVIEW_MP4, category:'sports', viewerCount: 26500, quality:'1080p', isLive:true },
            { id:'espnnews', name:'ESPN News', description:'Sports news', logoURL:'https://upload.wikimedia.org/wikipedia/commons/2/2f/ESPN_wordmark.svg', streamURL:'https://example.com/espnnews.m3u8', preview: LIVE_PREVIEW_MP4, category:'sports', viewerCount: 23100, quality:'720p', isLive:true },
            { id:'mtv', name:'MTV Live', description:'Music and entertainment', logoURL:'https://upload.wikimedia.org/wikipedia/commons/7/7a/MTV_Logo_2010.svg', streamURL:'https://example.com/mtvlive.m3u8', preview: LIVE_PREVIEW_MP4, category:'entertainment', viewerCount: 18700, quality:'720p', isLive:true },
            { id:'nick', name:'Kids Zone', description:'Family and kids programming', logoURL:'https://upload.wikimedia.org/wikipedia/commons/1/1d/Nickelodeon_2009_logo.svg', streamURL:'https://example.com/kidszone.m3u8', preview: LIVE_PREVIEW_MP4, category:'kids', viewerCount: 12100, quality:'720p', isLive:true }
        ];

        function openSeeAllLiveTV() {
            const modal = document.getElementById('liveTVSeeAll');
            if (!modal) return alert('Live TV view unavailable');
            // Show modal explicitly (CSS uses display:none by default)
            modal.style.display = 'block';
            const inner = modal.querySelector('.upload-modal');
            if (inner) inner.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            // default tab from persisted state
            const state = getPersistedLiveTVState();
            const tab = state.tab || 'all';
            const query = state.query || '';
            const search = document.getElementById('liveTVSearch');
            if (search) search.value = query;
            // highlight active tab
            const tabs = document.getElementById('liveTVTabs');
            if (tabs) {
                const btn = tabs.querySelector(`button[data-tab="${tab}"]`) || tabs.querySelector('button[data-tab="all"]');
                if (btn) btn.click();
            }
            renderLiveTVSeeAll(tab, query);
            wireLiveTVSeeAll();
            // backdrop click to close (only if clicking outside card)
            if (!modal.__wiredBackdrop) {
                modal.addEventListener('click', (e)=>{
                    const card = modal.querySelector('.upload-card');
                    if (card && !card.contains(e.target)) closeSeeAllLiveTV();
                });
                window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeSeeAllLiveTV(); });
                modal.__wiredBackdrop = true;
            }
        }
        function closeSeeAllLiveTV() {
            const modal = document.getElementById('liveTVSeeAll');
            if (!modal) return;
            modal.style.display = 'none';
            const inner = modal.querySelector('.upload-modal');
            if (inner) inner.style.display = 'none';
            document.body.style.overflow = '';
        }

        function wireLiveTVSeeAll() {
            const tabs = document.getElementById('liveTVTabs');
            const search = document.getElementById('liveTVSearch');
            const toggle = document.getElementById('liveTVViewToggle');
            if (tabs && !tabs.__wired) {
                tabs.addEventListener('click', (e)=>{
                    const btn = e.target.closest('button[data-tab]');
                    if (!btn) return;
                    const tab = btn.getAttribute('data-tab');
                    // reset styles
                    tabs.querySelectorAll('button[data-tab]').forEach(b=>{
                        if (b === btn) {
                            b.style.background = 'var(--primary)';
                            b.style.color = '#fff';
                        } else {
                            b.style.background = 'var(--bg-secondary)';
                            b.style.color = 'var(--text-primary)';
                        }
                    });
                    persistLiveTVState({ tab });
                    renderLiveTVSeeAll(tab, (search && search.value) || '');
                });
                tabs.__wired = true;
            }
            if (search && !search.__wired) {
                const handler = ()=>{
                    const active = getPersistedLiveTVState().tab || 'all';
                    persistLiveTVState({ query: search.value });
                    renderLiveTVSeeAll(active, search.value);
                };
                search.addEventListener('input', handler);
                search.__wired = true;
            }
            if (toggle && !toggle.__wired) {
                toggle.addEventListener('click', (e)=>{
                    const btn = e.target.closest('button[data-view]');
                    if (!btn) return;
                    const view = btn.getAttribute('data-view');
                    toggle.querySelectorAll('button[data-view]').forEach(b=>{
                        if (b === btn) { b.style.background='var(--primary)'; b.style.color='#fff'; } else { b.style.background='var(--bg-secondary)'; b.style.color='var(--text-primary)'; }
                    });
                    persistLiveTVState({ view });
                    renderLiveTVSeeAll(getPersistedLiveTVState().tab||'all', (search && search.value)||'');
                });
                toggle.__wired = true;
            }
        }

        function renderLiveTVSeeAll(category = 'all', query = '') {
            const grid = document.getElementById('liveTVGrid');
            const countEl = document.getElementById('liveTVCount');
            if (!grid) return;
            let items = liveTVSeeAllChannels.slice();
            if (category && category !== 'all') items = items.filter(c => (c.category || 'news') === category);
            if (query) {
                const q = query.trim().toLowerCase();
                items = items.filter(c => (c.name||'').toLowerCase().includes(q) || (c.description||'').toLowerCase().includes(q) || (c.category||'').toLowerCase().includes(q));
            }
            // Simple health filter: drop any without streamURL or with placeholder example.com
            items = items.filter(c => c.streamURL && !/example\.com\//.test(c.streamURL));
            items.sort((a,b)=> (b.viewerCount||0) - (a.viewerCount||0));
            animateLiveCount(countEl, items.length);
            const state = getPersistedLiveTVState();
            const view = state.view || 'grid';
            if (view === 'list') {
                grid.style.display = 'block';
                grid.style.gridTemplateColumns = '';
                grid.innerHTML = items.map(c => liveTVRowHTML(c)).join('');
            } else {
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = 'repeat(auto-fill,minmax(160px,1fr))';
                grid.innerHTML = items.map(c => liveTVCardHTML(c)).join('');
            }
            // bind click handlers
            grid.querySelectorAll('[data-live-id]').forEach(card => {
                card.addEventListener('click', ()=>{
                    try {
                        openVideoDetail({ id: card.getAttribute('data-live-id'), title: card.getAttribute('data-name')||'Live', videoUrl: card.getAttribute('data-url')||'', views: Number(card.getAttribute('data-views')||0), uploadTime: 'LIVE', channel: { name: 'Live', avatar: 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG', subscribers: 0 }, description: card.getAttribute('data-desc')||'' });
                    } catch {}
                });
            });
        }

        function liveTVCardHTML(c) {
            const viewers = formatCompactNumber(c.viewerCount||0);
            const poster = c.logoURL || c.thumb || 'https://images.unsplash.com/photo-1517817748491-7feac7c7d7bf?w=600&h=400&fit=crop';
            const previewSrc = c.preview || LIVE_PREVIEW_MP4;
            return `
                <div class="video-card" data-live-id="${c.id}" data-url="${c.streamURL||''}" data-name="${escapeHTML(c.name||'Live')}" data-desc="${escapeHTML(c.description||'')}" data-views="${c.viewerCount||0}" style="cursor:pointer;">
                    <div class="video-thumbnail" style="position:relative;">
                        <video src="${previewSrc}" poster="${poster}" muted loop playsinline webkit-playsinline preload="auto" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000;"></video>
                        <div class="video-duration">LIVE</div>
                    </div>
                    <div class="video-info compact">
                        <div class="video-text">
                            <h3 class="video-title">${escapeHTML(c.name||'Live')}</h3>
                            <div class="video-subtext"><span class="channel-name">${viewers} watching ‚Ä¢ ${c.quality||''}</span></div>
                        </div>
                    </div>
                </div>
            `;
        }
        function liveTVRowHTML(c) {
            const viewers = formatCompactNumber(c.viewerCount||0);
            const poster = c.logoURL || c.thumb || 'https://images.unsplash.com/photo-1517817748491-7feac7c7d7bf?w=600&h=400&fit=crop';
            const previewSrc = c.preview || LIVE_PREVIEW_MP4;
            return `
                <div class="video-card" data-live-id="${c.id}" data-url="${c.streamURL||''}" data-name="${escapeHTML(c.name||'Live')}" data-desc="${escapeHTML(c.description||'')}" data-views="${c.viewerCount||0}" style="cursor:pointer; display:flex; gap:12px; align-items:center; padding:10px; border:1px solid var(--border-color); border-radius:12px; margin-bottom:10px;">
                    <div class="video-thumbnail" style="position:relative; flex:0 0 160px; height:90px; border-radius:12px; overflow:hidden;">
                        <video src="${previewSrc}" poster="${poster}" muted loop playsinline webkit-playsinline preload="auto" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000;"></video>
                        <div class="video-duration">LIVE</div>
                    </div>
                    <div class="video-info compact" style="flex:1;">
                        <div class="video-text">
                            <h3 class="video-title">${escapeHTML(c.name||'Live')}</h3>
                            <div class="video-subtext"><span class="channel-name">${viewers} watching ‚Ä¢ ${c.quality||''}</span></div>
                            <div class="video-subtext" style="color:var(--text-secondary); font-size:12px;">${escapeHTML(c.description||'')}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        function animateLiveCount(el, n){ if (!el) return; try { const start=Number(el.textContent?.match(/\d+/)?.[0]||0); const end=Number(n)||0; const dur=300; const t0=performance.now(); const step=(t)=>{ const k=Math.min(1,(t-t0)/dur); const v=Math.round(start+(end-start)*k); el.textContent=`${v} channels live`; if(k<1) requestAnimationFrame(step); }; requestAnimationFrame(step);} catch { el.textContent=`${n} channels live`; } }
        function persistLiveTVState(p){ try { const key='liveTVState'; const cur=getPersistedLiveTVState(); localStorage.setItem(key, JSON.stringify(Object.assign({}, cur, p))); } catch {} }
        function getPersistedLiveTVState(){ try { return JSON.parse(localStorage.getItem('liveTVState')||'{}'); } catch { return {}; } }

        function formatCompactNumber(n){ try { const abs=Math.abs(n); if (abs>=1e9) return (n/1e9).toFixed(1)+'B'; if (abs>=1e6) return (n/1e6).toFixed(1)+'M'; if (abs>=1e3) return (n/1e3).toFixed(1)+'K'; return String(n||0);} catch { return String(n||0);} }
        function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }

        // Render helper for artist, filmmaker, and channel chips
        function renderChipRow(targetId, items, chipRenderer, onClick) {
            const row = document.getElementById(targetId);
            if (!row) return;
            const fragment = document.createDocumentFragment();
            items.forEach((it, idx) => {
                const chip = chipRenderer(it, idx + 1);
                chip.style.cssText = 'flex:0 0 auto; width:100px; scroll-snap-align:start; margin-right:8px;';
                chip.setAttribute('role','button');
                chip.style.cursor = 'pointer';
                chip.style.userSelect = 'none';
                chip.addEventListener('click', () => { try { onClick && onClick(it); } catch(e) {} });
                fragment.appendChild(chip);
            });
            row.innerHTML = '';
            row.appendChild(fragment);
        }

        function createAvatarChip(avatarUrl, title, subtitle, rank) {
            const el = document.createElement('div');
            el.className = 'avatar-chip';
            el.style.cssText = 'flex:0 0 auto; width:100px; text-align:center;';
            el.innerHTML = `
                <div style="position:relative; width:64px; height:64px; margin:0 auto 6px;">
                    <img src="${avatarUrl}" alt="${title}" style="width:64px;height:64px;border-radius:50%;object-fit:cover;border:3px solid #ff4d4d; box-shadow:0 6px 14px rgba(0,0,0,.15);">
                    ${rank ? `<div style=\"position:absolute;top:-6px;left:-6px;background:#ff4d4d;color:#fff;border-radius:999px;padding:2px 6px;font-size:10px;font-weight:800;box-shadow:0 2px 6px rgba(0,0,0,.25);\">#${rank}</div>` : ''}
                </div>
                <div style="font-weight:700; color:var(--text-primary); font-size:13px; line-height:1.2; max-height:32px; overflow:hidden;">${title}</div>
                <div style="color:var(--text-secondary); font-size:11px; margin-top:2px;">${subtitle}</div>
            `;
            return el;
        }

        // Generate demo rows to mirror app layout (can be wired to Firestore later)
        function loadTopArtists() {
            const base = ['Scatz','Tee Grizzley','Sada Baby','Icewear Vezzo','Babyface Ray','Peezy'];
            let items = Array.from({length: 100}, (_, i) => {
                const n = base[i % base.length] + (i >= base.length ? ` ${Math.floor(i/base.length)}` : '');
                const views = Math.floor(5_000_000 - i * 45_000 + Math.random()*40_000);
                return { name: n, avatar: `https://i.pravatar.cc/200?u=artist_${i}`, views: Math.max(views, 1000) };
            }).sort((a,b)=>b.views-a.views);
            renderChipRow('topArtistsRow', items, (a, rank) => createAvatarChip(a.avatar, a.name, `${(a.views/1000).toFixed(1)}K total views`, rank), (a) => openArtistDetail(a));
        }

        function loadTopFilmmakers() {
            const base = ['A. Rivers','N. Carter','M. Sloan','J. Patel','R. Alvarez','S. Kim'];
            let items = Array.from({length:100}, (_, i) => {
                const n = base[i % base.length] + (i >= base.length ? ` ${Math.floor(i/base.length)}` : '');
                const films = Math.max(3, 15 - Math.floor(i/10));
                return { name: n, films, avatar: `https://i.pravatar.cc/200?u=indie_${i}` };
            }).sort((a,b)=>b.films-a.films);
            renderChipRow('topFilmmakersRow', items, (f, rank) => createAvatarChip(f.avatar, f.name, `${f.films} films`, rank), (f) => openFilmmakerDetail(f));
        }

        function loadTopChannels() {
            const base = ['COD Highlights','MyChannel Music','Movie Hub','Sports Zone','Tech Insider'];
            let items = Array.from({length:100}, (_, i) => {
                const n = base[i % base.length] + (i >= base.length ? ` ${Math.floor(i/base.length)}` : '');
                const subs = Math.floor(600_000 - i*4_000 + Math.random()*3_000);
                return { name: n, subs: Math.max(subs, 5_000), avatar: `https://i.pravatar.cc/200?u=chn_${i}` };
            }).sort((a,b)=>b.subs-a.subs);
            renderChipRow('topChannelsRow', items, (c, rank) => createAvatarChip(c.avatar, c.name, `${(c.subs/1000).toFixed(1)}K subs`, rank), (c) => openChannelDetail(c));
        }

        // Minimal modals for details
        function createSheet(contentHTML) {
            const modal = document.createElement('div');
            modal.className = 'upload-modal-backdrop';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="upload-modal" style="display:flex; max-width:720px;">
                    <div class="upload-card" style="width:100%;">
                        <div class="upload-header">
                            <h3 style="margin:0; font-weight:600; color:var(--text-primary);">Details</h3>
                            <button class="upload-close" onclick="this.closest('.upload-modal-backdrop').remove()">&times;</button>
                        </div>
                        <div class="upload-body">${contentHTML}</div>
                    </div>
                </div>`;
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
            document.body.appendChild(modal);
        }

        function openArtistDetail(a) {
            createSheet(`
                <div style="display:flex; gap:16px; align-items:center; margin-bottom:12px;">
                    <img src="${a.avatar}" alt="${a.name}" style="width:64px;height:64px;border-radius:50%;object-fit:cover;">
                    <div>
                        <div style="font-weight:700; font-size:18px; color:var(--text-primary);">${a.name}</div>
                        <div style="color:var(--text-secondary); font-size:13px;">${(a.views/1000).toFixed(1)}K total views</div>
                    </div>
                </div>
                <p style="color:var(--text-secondary); margin:0;">Artist detail page coming soon.</p>
            `);
        }
        function openFilmmakerDetail(f) {
            createSheet(`
                <div style="display:flex; gap:16px; align-items:center; margin-bottom:12px;">
                    <img src="${f.avatar}" alt="${f.name}" style="width:64px;height:64px;border-radius:50%;object-fit:cover;">
                    <div>
                        <div style="font-weight:700; font-size:18px; color:var(--text-primary);">${f.name}</div>
                        <div style="color:var(--text-secondary); font-size:13px;">${f.films} films</div>
                    </div>
                </div>
                <p style="color:var(--text-secondary); margin:0;">Filmmaker detail page coming soon.</p>
            `);
        }
        function openChannelDetail(c) {
            createSheet(`
                <div style="display:flex; gap:16px; align-items:center; margin-bottom:12px;">
                    <img src="${c.avatar}" alt="${c.name}" style="width:64px;height:64px;border-radius:50%;object-fit:cover;">
                    <div>
                        <div style="font-weight:700; font-size:18px; color:var(--text-primary);">${c.name}</div>
                        <div style="color:var(--text-secondary); font-size:13px;">${(c.subs/1000).toFixed(1)}K subs</div>
                    </div>
                </div>
                <p style="color:var(--text-secondary); margin:0;">Channel detail page coming soon.</p>
            `);
        }
        // Enhanced Video Upload System
        let selectedVideoFile = null;
        let uploadProgress = {
            startTime: null,
            bytesUploaded: 0,
            totalBytes: 0
        };
        function initializeUploadSystem() {
            const uploadZone = document.getElementById('uploadZone');
            const videoFileInput = document.getElementById('videoFileInput');
            const titleInput = document.getElementById('umTitle');
            const descInput = document.getElementById('umDesc');
            
            // Drag and drop functionality
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.background = 'var(--accent)';
                uploadZone.style.transform = 'scale(1.02)';
            });
            
            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.style.background = '';
                uploadZone.style.transform = '';
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.style.background = '';
                uploadZone.style.transform = '';
                
                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('video/'));
                if (files.length > 0) {
                    handleVideoFileSelection(files[0]);
                }
            });
            
            // File input change
            videoFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleVideoFileSelection(e.target.files[0]);
                }
            });
            
            // Character counters
            titleInput.addEventListener('input', (e) => {
                document.getElementById('titleCount').textContent = e.target.value.length;
            });
            
            descInput.addEventListener('input', (e) => {
                document.getElementById('descCount').textContent = e.target.value.length;
            });
            
            // Upload buttons
            document.getElementById('umPublish').addEventListener('click', handleVideoUpload);
            document.getElementById('umSaveDraft').addEventListener('click', () => handleVideoUpload(true));
        }
        
        function handleVideoFileSelection(file) {
            selectedVideoFile = file;
            
            // Validate file
            if (file.size > 2 * 1024 * 1024 * 1024) { // 2GB limit
                alert('File size must be under 2GB');
                return;
            }
            
            // Show preview section
            const previewSection = document.getElementById('videoPreviewSection');
            const videoPreview = document.getElementById('videoPreview');
            const fileName = document.getElementById('videoFileName');
            const fileInfo = document.getElementById('videoFileInfo');
            const analysis = document.getElementById('videoAnalysis');
            
            previewSection.style.display = 'block';
            fileName.textContent = file.name;
            fileInfo.textContent = `${formatFileSize(file.size)} ‚Ä¢ ${file.type}`;
            
            // Create video preview
            const url = URL.createObjectURL(file);
            videoPreview.src = url;
            
            // Analyze video
            videoPreview.addEventListener('loadedmetadata', () => {
                const duration = formatDuration(videoPreview.duration);
                const resolution = `${videoPreview.videoWidth}x${videoPreview.videoHeight}`;
                const aspectRatio = (videoPreview.videoWidth / videoPreview.videoHeight).toFixed(2);
                
                analysis.innerHTML = `
                    <span>üìè ${resolution}</span>
                    <span>‚è±Ô∏è ${duration}</span>
                    <span>üìê ${aspectRatio}:1</span>
                    <span>üé¨ ${file.type.split('/')[1].toUpperCase()}</span>
                `;
                
                // Auto-generate title if empty
                const titleInput = document.getElementById('umTitle');
                if (!titleInput.value) {
                    titleInput.value = file.name.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ');
                    document.getElementById('titleCount').textContent = titleInput.value.length;
                }
                
                // Generate thumbnails
                generateThumbnails();
            });
        }
        
        function removeVideoFile() {
            selectedVideoFile = null;
            document.getElementById('videoPreviewSection').style.display = 'none';
            document.getElementById('videoFileInput').value = '';
            document.getElementById('thumbnailOptions').innerHTML = '';
        }
        
        function generateThumbnails() {
            if (!selectedVideoFile) return;
            
            const video = document.getElementById('videoPreview');
            const container = document.getElementById('thumbnailOptions');
            container.innerHTML = '';
            
            // Generate 4 thumbnails at different timestamps
            const timestamps = [0.1, 0.3, 0.5, 0.7];
            
            timestamps.forEach((percent, index) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 120;
                canvas.height = 68;
                
                const thumbnailDiv = document.createElement('div');
                thumbnailDiv.style.cssText = 'position:relative; cursor:pointer; border-radius:6px; overflow:hidden; border:2px solid transparent; transition:border-color 0.2s;';
                
                video.currentTime = video.duration * percent;
                
                video.addEventListener('seeked', function drawThumbnail() {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    thumbnailDiv.appendChild(canvas);
                    
                    const overlay = document.createElement('div');
                    overlay.style.cssText = 'position:absolute; inset:0; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; color:#fff; font-size:10px; opacity:0; transition:opacity 0.2s;';
                    overlay.textContent = 'Select';
                    thumbnailDiv.appendChild(overlay);
                    
                    thumbnailDiv.addEventListener('mouseenter', () => overlay.style.opacity = '1');
                    thumbnailDiv.addEventListener('mouseleave', () => overlay.style.opacity = '0');
                    
                    thumbnailDiv.addEventListener('click', () => {
                        document.querySelectorAll('#thumbnailOptions > div').forEach(d => d.style.borderColor = 'transparent');
                        thumbnailDiv.style.borderColor = 'var(--primary)';
                    });
                    
                    if (index === 1) { // Select second thumbnail by default
                        thumbnailDiv.style.borderColor = 'var(--primary)';
                    }
                    
                    video.removeEventListener('seeked', drawThumbnail);
                }, { once: true });
                
                container.appendChild(thumbnailDiv);
            });
        }
        async function handleVideoUpload(isDraft = false) {
            if (!selectedVideoFile) {
                alert('Please select a video file first');
                return;
            }
            
            const title = document.getElementById('umTitle').value.trim();
            if (!title) {
                alert('Please enter a video title');
                return;
            }
            
            // Initialize Firebase
            await initFirebase();
            const user = auth.currentUser;
            if (!user || user.isAnonymous) {
                document.getElementById('umSignIn').style.display = 'block';
                document.getElementById('umPublish').style.display = 'none';
                return;
            }
            // Show progress
            const progressSection = document.getElementById('umProgress');
            progressSection.style.display = 'block';
            
            uploadProgress.startTime = Date.now();
            uploadProgress.totalBytes = selectedVideoFile.size;
            uploadProgress.bytesUploaded = 0;
            
            updateUploadStep('step1', 'In Progress', 'var(--warning)');
            
            try {
                // Step 1: File validation
                await new Promise(resolve => setTimeout(resolve, 500));
                updateUploadStep('step1', 'Complete', 'var(--success)');
                updateUploadStep('step2', 'In Progress', 'var(--warning)');
                
                // Step 2: Request signed URL (placeholder service) and upload directly
                const signed = await fetch(UPLOAD_SIGNED_URL_ENDPOINT, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: `${Date.now()}_${selectedVideoFile.name}`, contentType: selectedVideoFile.type })
                }).then(r => r.json()).catch(() => null);

                if (!signed || !signed.url) throw new Error('Failed to get signed URL');

                const uploadResp = await fetch(signed.url, { method: 'PUT', headers: { 'Content-Type': selectedVideoFile.type, ...(signed.headers||{}) }, body: selectedVideoFile });
                if (!uploadResp.ok) throw new Error('Direct upload failed');
                
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        updateUploadProgress(progress, snapshot.bytesTransferred);
                    },
                    (error) => {
                        console.error('Upload error:', error);
                        alert('Upload failed: ' + error.message);
                        progressSection.style.display = 'none';
                    },
                    async () => {
                        updateUploadStep('step2', 'Complete', 'var(--success)');
                        updateUploadStep('step3', 'In Progress', 'var(--warning)');
                        
                        // Step 3: Compose public URL placeholder (real flow will notify content service)
                        const downloadURL = signed.url.split('?')[0];
                        
                        const videoData = {
                            title: title,
                            description: document.getElementById('umDesc').value.trim(),
                            category: document.getElementById('umCategory').value,
                            visibility: document.getElementById('umVisibility').value,
                            videoUrl: downloadURL,
                            thumbnailUrl: '', // TODO: Upload selected thumbnail
                            ownerId: user.uid,
                            ownerName: user.displayName || 'Anonymous',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            views: 0,
                            likes: 0,
                            dislikes: 0,
                            comments: 0,
                            duration: document.getElementById('videoPreview').duration,
                            fileSize: selectedVideoFile.size,
                            status: isDraft ? 'draft' : 'published',
                            settings: {
                                allowComments: document.getElementById('enableComments').checked,
                                showLikes: document.getElementById('enableLikes').checked,
                                notifySubscribers: document.getElementById('enableNotifications').checked
                            }
                        };
                        
                        await db.collection('videos').add(videoData);
                        
                        updateUploadStep('step3', 'Complete', 'var(--success)');
                        updateUploadStep('step4', 'Complete', 'var(--success)');
                        
                        // Success!
                        setTimeout(() => {
                            alert(isDraft ? 'Video saved as draft!' : 'Video published successfully!');
                            closeUploadModal();
                            resetUploadForm();
                        }, 1000);
                    }
                );
                
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
                progressSection.style.display = 'none';
            }
        }
        
        function updateUploadProgress(percentage, bytesUploaded) {
            document.getElementById('umFill').style.width = percentage + '%';
            document.getElementById('umPct').textContent = Math.round(percentage) + '%';
            
            uploadProgress.bytesUploaded = bytesUploaded;
            
            // Calculate speed and time remaining
            const elapsed = (Date.now() - uploadProgress.startTime) / 1000;
            const speed = bytesUploaded / elapsed; // bytes per second
            const remaining = (uploadProgress.totalBytes - bytesUploaded) / speed;
            
            document.getElementById('uploadSpeed').textContent = formatFileSize(speed) + '/s';
            document.getElementById('timeRemaining').textContent = formatDuration(remaining);
            document.getElementById('uploadStatus').textContent = `Uploading ${formatFileSize(bytesUploaded)} of ${formatFileSize(uploadProgress.totalBytes)}`;
        }
        
        function updateUploadStep(stepId, status, color) {
            const step = document.getElementById(stepId);
            const statusSpan = step.querySelector('span');
            statusSpan.textContent = status;
            statusSpan.style.color = color;
        }
        
        function resetUploadForm() {
            selectedVideoFile = null;
            document.getElementById('videoPreviewSection').style.display = 'none';
            document.getElementById('videoFileInput').value = '';
            document.getElementById('umTitle').value = '';
            document.getElementById('umDesc').value = '';
            document.getElementById('titleCount').textContent = '0';
            document.getElementById('descCount').textContent = '0';
            document.getElementById('thumbnailOptions').innerHTML = '';
            document.getElementById('umProgress').style.display = 'none';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        function formatDuration(seconds) {
            if (isNaN(seconds) || seconds < 0) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }

        // Live Streaming System
        let mediaStream = null;
        let isStreaming = false;
        let streamStartTime = null;
        let streamTimer = null;
        let cameraEnabled = false;
        let micEnabled = false;
        
        function openLiveStreamModal() {
            document.getElementById('liveStreamModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            initializeLiveStreamSystem();
        }
        
        function closeLiveStreamModal() {
            document.getElementById('liveStreamModal').classList.remove('active');
            document.body.style.overflow = '';
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            resetStreamInterface();
        }
        
        function initializeLiveStreamSystem() {
            const streamTitle = document.getElementById('streamTitle');
            const streamDesc = document.getElementById('streamDesc');
            const startStreamBtn = document.getElementById('startStreamBtn');
            
            // Character counters
            streamTitle.addEventListener('input', (e) => {
                document.getElementById('streamTitleCount').textContent = e.target.value.length;
            });
            
            streamDesc.addEventListener('input', (e) => {
                document.getElementById('streamDescCount').textContent = e.target.value.length;
            });
            
            // Start stream button
            startStreamBtn.addEventListener('click', handleStartStream);
        }
        async function toggleCamera() {
            try {
                if (!cameraEnabled) {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { width: 1280, height: 720 }, 
                        audio: false 
                    });
                    
                    const videoPreview = document.getElementById('cameraPreview');
                    videoPreview.srcObject = stream;
                    
                    if (!mediaStream) {
                        mediaStream = stream;
                    } else {
                        // Add video track to existing stream
                        stream.getVideoTracks().forEach(track => {
                            mediaStream.addTrack(track);
                        });
                    }
                    
                    cameraEnabled = true;
                    document.getElementById('cameraStatus').textContent = 'üì∑ Camera On';
                    document.getElementById('toggleCamera').style.background = 'rgba(76, 175, 80, 0.8)';
                } else {
                    // Stop camera
                    if (mediaStream) {
                        mediaStream.getVideoTracks().forEach(track => {
                            track.stop();
                            mediaStream.removeTrack(track);
                        });
                    }
                    
                    const videoPreview = document.getElementById('cameraPreview');
                    videoPreview.srcObject = null;
                    
                    cameraEnabled = false;
                    document.getElementById('cameraStatus').textContent = 'üì∑ Camera Off';
                    document.getElementById('toggleCamera').style.background = 'rgba(255,255,255,0.2)';
                }
            } catch (error) {
                console.error('Camera error:', error);
                alert('Could not access camera: ' + error.message);
            }
        }
        
        async function toggleMic() {
            try {
                if (!micEnabled) {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: false, 
                        audio: true 
                    });
                    
                    if (!mediaStream) {
                        mediaStream = stream;
                    } else {
                        // Add audio track to existing stream
                        stream.getAudioTracks().forEach(track => {
                            mediaStream.addTrack(track);
                        });
                    }
                    
                    micEnabled = true;
                    document.getElementById('toggleMic').style.background = 'rgba(76, 175, 80, 0.8)';
                } else {
                    // Stop microphone
                    if (mediaStream) {
                        mediaStream.getAudioTracks().forEach(track => {
                            track.stop();
                            mediaStream.removeTrack(track);
                        });
                    }
                    
                    micEnabled = false;
                    document.getElementById('toggleMic').style.background = 'rgba(255,255,255,0.2)';
                }
            } catch (error) {
                console.error('Microphone error:', error);
                alert('Could not access microphone: ' + error.message);
            }
        }
        
        async function handleStartStream() {
            const title = document.getElementById('streamTitle').value.trim();
            if (!title) {
                alert('Please enter a stream title');
                return;
            }
            
            // Initialize Firebase
            await initFirebase();
            const user = auth.currentUser;
            if (!user || user.isAnonymous) {
                document.getElementById('streamSignIn').style.display = 'block';
                document.getElementById('startStreamBtn').style.display = 'none';
                return;
            }
            
            if (!cameraEnabled && !micEnabled) {
                alert('Please enable camera or microphone to start streaming');
                return;
            }
            
            try {
                // Create stream document in Firestore
                const streamData = {
                    title: title,
                    description: document.getElementById('streamDesc').value.trim(),
                    category: document.getElementById('streamCategory').value,
                    quality: document.getElementById('streamQuality').value,
                    streamerId: user.uid,
                    streamerName: user.displayName || 'Anonymous',
                    startTime: firebase.firestore.FieldValue.serverTimestamp(),
                    isLive: true,
                    viewerCount: 0,
                    chatEnabled: document.getElementById('enableChat').checked,
                    recordingEnabled: document.getElementById('recordStream').checked,
                    settings: {
                        notifyFollowers: document.getElementById('notifyFollowers').checked
                    }
                };
                
                const streamDoc = await db.collection('liveStreams').add(streamData);
                
                // Switch to live interface
                document.getElementById('streamSetup').style.display = 'none';
                document.getElementById('liveStreamInterface').style.display = 'block';
                
                isStreaming = true;
                streamStartTime = Date.now();
                
                // Start stream timer
                startStreamTimer();
                
                // Simulate viewer updates
                simulateStreamStats(streamDoc.id);
                
                // Initialize live chat
                initializeLiveChat(streamDoc.id);
                
            } catch (error) {
                console.error('Stream start error:', error);
                alert('Failed to start stream: ' + error.message);
            }
        }
        function startStreamTimer() {
            streamTimer = setInterval(() => {
                if (streamStartTime) {
                    const elapsed = Math.floor((Date.now() - streamStartTime) / 1000);
                    const hours = Math.floor(elapsed / 3600);
                    const minutes = Math.floor((elapsed % 3600) / 60);
                    const seconds = elapsed % 60;
                    
                    const timeStr = hours > 0 
                        ? `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
                        : `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    document.getElementById('streamDuration').textContent = timeStr;
                }
            }, 1000);
        }
        function simulateStreamStats(streamId) {
            // Simulate realistic viewer growth
            let viewers = 0;
            let messages = 0;
            
            const updateStats = () => {
                if (!isStreaming) return;
                
                // Gradual viewer increase with some randomness
                const change = Math.random() > 0.5 ? Math.floor(Math.random() * 3) : -Math.floor(Math.random() * 2);
                viewers = Math.max(0, viewers + change);
                
                // Occasional message
                if (Math.random() > 0.7) {
                    messages++;
                    addSimulatedChatMessage();
                }
                
                document.getElementById('viewerCount').textContent = viewers;
                document.getElementById('chatMessages').textContent = messages;
                
                setTimeout(updateStats, 2000 + Math.random() * 3000);
            };
            
            setTimeout(updateStats, 1000);
        }
        
        function addSimulatedChatMessage() {
            const chatPreview = document.getElementById('liveChatPreview');
            const messages = [
                'Great stream! üëç',
                'Hello from viewer!',
                'Love the content üî•',
                'Keep it up!',
                'Amazing quality!',
                'First time watching üòä',
                'This is awesome!'
            ];
            
            const usernames = ['StreamFan123', 'VideoLover', 'ContentKing', 'ViewerPro', 'ChatMaster'];
            
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'margin-bottom:8px; font-size:12px; padding:4px 8px; background:rgba(var(--primary-rgb), 0.1); border-radius:4px;';
            messageDiv.innerHTML = `
                <span style="font-weight:600; color:var(--primary);">${usernames[Math.floor(Math.random() * usernames.length)]}</span>
                <span style="color:var(--text-primary); margin-left:8px;">${messages[Math.floor(Math.random() * messages.length)]}</span>
            `;
            
            chatPreview.appendChild(messageDiv);
            chatPreview.scrollTop = chatPreview.scrollHeight;
            
            // Remove old messages to prevent overflow
            while (chatPreview.children.length > 10) {
                chatPreview.removeChild(chatPreview.firstChild);
            }
        }
        
        function initializeLiveChat(streamId) {
            const chatPreview = document.getElementById('liveChatPreview');
            chatPreview.innerHTML = '<div style="font-size:12px; color:var(--text-secondary); text-align:center; padding:8px;">Live chat is active! üí¨</div>';
        }
        
        function toggleStreamCamera() {
            toggleCamera();
        }
        
        function toggleStreamMic() {
            toggleMic();
        }
        
        async function endStream() {
            if (!confirm('Are you sure you want to end the stream?')) return;
            
            isStreaming = false;
            
            if (streamTimer) {
                clearInterval(streamTimer);
                streamTimer = null;
            }
            
            // Stop all media tracks
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            // Update stream status in Firestore
            try {
                // In a real implementation, you'd update the specific stream document
                console.log('Stream ended, updating database...');
            } catch (error) {
                console.error('Error ending stream:', error);
            }
            
            alert('Stream ended successfully!');
            closeLiveStreamModal();
        }
        
        function resetStreamInterface() {
            document.getElementById('streamSetup').style.display = 'block';
            document.getElementById('liveStreamInterface').style.display = 'none';
            
            // Reset form
            document.getElementById('streamTitle').value = '';
            document.getElementById('streamDesc').value = '';
            document.getElementById('streamTitleCount').textContent = '0';
            document.getElementById('streamDescCount').textContent = '0';
            
            // Reset camera/mic states
            cameraEnabled = false;
            micEnabled = false;
            document.getElementById('cameraStatus').textContent = 'üì∑ Camera Off';
            document.getElementById('toggleCamera').style.background = 'rgba(255,255,255,0.2)';
            document.getElementById('toggleMic').style.background = 'rgba(255,255,255,0.2)';
            
            // Reset stats
            document.getElementById('viewerCount').textContent = '0';
            document.getElementById('streamDuration').textContent = '00:00';
            document.getElementById('chatMessages').textContent = '0';
            
            isStreaming = false;
            streamStartTime = null;
        }

        // Advanced Notifications System
        let notifications = [];
        let notificationSettings = {
            push: {
                likes: true,
                comments: true,
                follows: true,
                live: true,
                uploads: true
            },
            email: {
                weekly: true,
                monthly: true,
                updates: false
            },
            quietHours: {
                start: '22:00',
                end: '08:00'
            },
            appearance: {
                darkMode: false,
                autoplayPreviews: true
            }
        };
        function toggleNotificationsPanel() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                loadNotifications();
                // Mark notifications as read after viewing
                setTimeout(() => {
                    markVisibleNotificationsAsRead();
                }, 1000);
            }
        }
        
        function loadNotifications() {
            // Simulate loading notifications
            if (notifications.length === 0) {
                generateSampleNotifications();
            }
            renderNotifications();
        }
        function generateSampleNotifications() {
            const sampleNotifications = [
                {
                    id: '1',
                    type: 'likes',
                    title: 'New likes on your video',
                    message: 'Your video "Amazing Sunset Timelapse" received 15 new likes',
                    avatar: '‚ù§Ô∏è',
                    timestamp: Date.now() - 300000, // 5 minutes ago
                    read: false,
                    actionUrl: '#'
                },
                {
                    id: '2',
                    type: 'comments',
                    title: 'New comment',
                    message: 'StreamFan123 commented: "This is incredible! How did you capture this?"',
                    avatar: 'üí¨',
                    timestamp: Date.now() - 900000, // 15 minutes ago
                    read: false,
                    actionUrl: '#'
                },
                {
                    id: '3',
                    type: 'follows',
                    title: 'New follower',
                    message: 'VideoLover started following you',
                    avatar: 'üë•',
                    timestamp: Date.now() - 1800000, // 30 minutes ago
                    read: true,
                    actionUrl: '#'
                },
                {
                    id: '4',
                    type: 'uploads',
                    title: 'New upload from ContentKing',
                    message: 'ContentKing uploaded "Epic Gaming Montage #5"',
                    avatar: 'üìπ',
                    timestamp: Date.now() - 3600000, // 1 hour ago
                    read: true,
                    actionUrl: '#'
                },
                {
                    id: '5',
                    type: 'live',
                    title: 'ViewerPro is now live',
                    message: 'ViewerPro started streaming "Just Chatting with Viewers"',
                    avatar: 'üî¥',
                    timestamp: Date.now() - 7200000, // 2 hours ago
                    read: true,
                    actionUrl: '#'
                }
            ];
            
            notifications = sampleNotifications;
        }
        
        function renderNotifications(filter = 'all') {
            const container = document.getElementById('notificationsList');
            const filteredNotifications = filter === 'all' 
                ? notifications 
                : notifications.filter(n => n.type === filter);
            
            if (filteredNotifications.length === 0) {
                container.innerHTML = `
                    <div class="notifications-empty">
                        <div style="text-align:center; padding:40px 20px; color:var(--text-secondary);">
                            <div style="font-size:48px; margin-bottom:12px;">üîî</div>
                            <div style="font-size:16px; margin-bottom:8px;">No ${filter === 'all' ? '' : filter + ' '}notifications</div>
                            <div style="font-size:12px;">We'll notify you when something happens!</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredNotifications.map(notification => `
                <div class="notification-item ${notification.read ? '' : 'unread'}" onclick="handleNotificationClick('${notification.id}')">
                    <div style="display:flex; align-items:flex-start; gap:12px;">
                        <div class="notification-avatar">${notification.avatar}</div>
                        <div class="notification-content">
                            <div class="notification-text">
                                <strong>${notification.title}</strong><br>
                                ${notification.message}
                            </div>
                            <div class="notification-time">${formatNotificationTime(notification.timestamp)}</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            updateNotificationCount();
        }
        
        function formatNotificationTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return new Date(timestamp).toLocaleDateString();
        }
        
        function handleNotificationClick(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                renderNotifications();
                
                // Navigate to the relevant content
                if (notification.actionUrl && notification.actionUrl !== '#') {
                    window.location.href = notification.actionUrl;
                }
            }
        }
        
        function markAllNotificationsRead() {
            notifications.forEach(n => n.read = true);
            renderNotifications();
        }
        function markVisibleNotificationsAsRead() {
            notifications.forEach(n => {
                if (!n.read) {
                    n.read = true;
                }
            });
            updateNotificationCount();
        }
        
        function updateNotificationCount() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notificationCount');
            const navBadge = document.getElementById('navNotificationBadge');
            
            badge.textContent = unreadCount;
            badge.style.display = unreadCount > 0 ? 'inline' : 'none';
            
            if (navBadge) {
                navBadge.textContent = unreadCount;
                navBadge.style.display = unreadCount > 0 ? 'inline' : 'none';
            }
        }
        
        function openNotificationSettings() {
            document.getElementById('notificationSettingsModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            loadNotificationSettings();
        }
        
        function closeNotificationSettings() {
            document.getElementById('notificationSettingsModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        function loadNotificationSettings() {
            // Load current settings into form
            Object.keys(notificationSettings.push).forEach(type => {
                const checkbox = document.querySelector(`.notification-toggle[data-type="${type}"]`);
                if (checkbox) checkbox.checked = notificationSettings.push[type];
            });
            
            Object.keys(notificationSettings.email).forEach(type => {
                const checkbox = document.querySelector(`.email-toggle[data-type="${type}"]`);
                if (checkbox) checkbox.checked = notificationSettings.email[type];
            });
            
            document.getElementById('quietStart').value = notificationSettings.quietHours.start;
            document.getElementById('quietEnd').value = notificationSettings.quietHours.end;

            // Appearance
            const darkToggle = document.getElementById('enableDarkMode');
            if (darkToggle) {
                darkToggle.checked = !!notificationSettings.appearance.darkMode;
            }
        }
        function saveNotificationSettings() {
            // Save push notification settings
            document.querySelectorAll('.notification-toggle').forEach(checkbox => {
                const type = checkbox.dataset.type;
                notificationSettings.push[type] = checkbox.checked;
            });
            
            // Save email notification settings
            document.querySelectorAll('.email-toggle').forEach(checkbox => {
                const type = checkbox.dataset.type;
                notificationSettings.email[type] = checkbox.checked;
            });
            
            // Save quiet hours
            notificationSettings.quietHours.start = document.getElementById('quietStart').value;
            notificationSettings.quietHours.end = document.getElementById('quietEnd').value;

            // Save appearance
            const darkToggle = document.getElementById('enableDarkMode');
            notificationSettings.appearance.darkMode = !!(darkToggle && darkToggle.checked);
            applyThemeFromSettings();
            
            // Save to localStorage or Firebase
            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
            
            showNotificationToast('Settings saved successfully!', '‚öôÔ∏è');
            closeNotificationSettings();
        }

        function applyThemeFromSettings() {
            try {
                const root = document.documentElement;
                if (notificationSettings.appearance.darkMode) {
                    root.setAttribute('data-theme', 'dark');
                    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0f0f0f');
                } else {
                    root.removeAttribute('data-theme');
                    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ff3b30');
                }
            } catch (e) {}
        }

        // Load settings from localStorage at startup and apply theme
        (function initSettings() {
            try {
                const saved = localStorage.getItem('notificationSettings');
                if (saved) {
                    const obj = JSON.parse(saved);
                    // Deep merge minimal
                    notificationSettings = Object.assign({}, notificationSettings, obj);
                    if (obj.push) notificationSettings.push = Object.assign({}, notificationSettings.push, obj.push);
                    if (obj.email) notificationSettings.email = Object.assign({}, notificationSettings.email, obj.email);
                    if (obj.quietHours) notificationSettings.quietHours = Object.assign({}, notificationSettings.quietHours, obj.quietHours);
                    if (obj.appearance) notificationSettings.appearance = Object.assign({}, notificationSettings.appearance, obj.appearance);
                }
            } catch (e) {}
            applyThemeFromSettings();
        })();

        function openProfileSettings() {
            try {
                const modal = document.getElementById('profileSettingsModal');
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                // sync toggles
                const dark = document.getElementById('psEnableDarkMode');
                const auto = document.getElementById('psAutoplayPreviews');
                if (dark) dark.checked = !!notificationSettings.appearance.darkMode;
                if (auto) auto.checked = !!notificationSettings.appearance.autoplayPreviews;
            } catch {}
        }
        function closeProfileSettings() {
            try {
                const modal = document.getElementById('profileSettingsModal');
                modal.classList.remove('active');
                document.body.style.overflow = '';
            } catch {}
        }
        function saveProfileSettings() {
            try {
                const dark = document.getElementById('psEnableDarkMode');
                const auto = document.getElementById('psAutoplayPreviews');
                notificationSettings.appearance.darkMode = !!(dark && dark.checked);
                notificationSettings.appearance.autoplayPreviews = !!(auto && auto.checked);
                localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
                applyThemeFromSettings();
                closeProfileSettings();
                showNotificationToast('Profile settings saved', '‚öôÔ∏è');
            } catch {}
        }
        
        function showNotificationToast(message, icon = 'üîî') {
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.innerHTML = `
                <div class="notification-toast-header">
                    <span style="font-size:16px;">${icon}</span>
                    <span class="notification-toast-title">MyChannel</span>
                </div>
                <div class="notification-toast-body">${message}</div>
            `;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function addNotification(type, title, message, actionUrl = '#') {
            const notification = {
                id: Date.now().toString(),
                type: type,
                title: title,
                message: message,
                avatar: getNotificationIcon(type),
                timestamp: Date.now(),
                read: false,
                actionUrl: actionUrl
            };
            
            notifications.unshift(notification);
            updateNotificationCount();
            
            // Show toast if notifications are enabled
            if (notificationSettings.push[type] && !isInQuietHours()) {
                showNotificationToast(`${title}: ${message}`, notification.avatar);
            }
            
            // Request permission for browser notifications
            if (Notification.permission === 'granted' && notificationSettings.push[type]) {
                new Notification(title, {
                    body: message,
                    icon: '/favicon.ico',
                    badge: '/favicon.ico'
                });
            }
        }
        
        function getNotificationIcon(type) {
            const icons = {
                likes: '‚ù§Ô∏è',
                comments: 'üí¨',
                follows: 'üë•',
                uploads: 'üìπ',
                live: 'üî¥'
            };
            return icons[type] || 'üîî';
        }
        
        function isInQuietHours() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const [startHour, startMin] = notificationSettings.quietHours.start.split(':').map(Number);
            const [endHour, endMin] = notificationSettings.quietHours.end.split(':').map(Number);
            
            const startTime = startHour * 60 + startMin;
            const endTime = endHour * 60 + endMin;
            
            if (startTime < endTime) {
                return currentTime >= startTime && currentTime <= endTime;
            } else {
                return currentTime >= startTime || currentTime <= endTime;
            }
        }
        
        function initializeNotificationSystem() {
            // Load saved settings
            const savedSettings = localStorage.getItem('notificationSettings');
            if (savedSettings) {
                notificationSettings = { ...notificationSettings, ...JSON.parse(savedSettings) };
            }
            
            // Request notification permission
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Set up notification filters
            document.querySelectorAll('.notification-filter').forEach(filter => {
                filter.addEventListener('click', (e) => {
                    document.querySelectorAll('.notification-filter').forEach(f => f.classList.remove('active'));
                    e.target.classList.add('active');
                    renderNotifications(e.target.dataset.filter);
                });
            });
            
            // Simulate periodic notifications for demo
            setTimeout(() => {
                addNotification('likes', 'New likes!', 'Your video got 5 new likes');
            }, 10000);
            
            setTimeout(() => {
                addNotification('comments', 'New comment!', 'Someone commented on your video');
            }, 20000);
        }
        // Add Flicks button to navigation
        document.addEventListener('DOMContentLoaded', () => {
            const appleBtn = document.querySelector('button[onclick="signInWithApple()"]');
            if (appleBtn && !APPLE_SIGNIN_ENABLED) {
                appleBtn.style.display = 'none';
            }
            
            // Initialize upload system
            initializeUploadSystem();
            
            // Load initial content - remove duplicate calls
            // loadFreeMovies() and loadTrending() are already called in the first DOMContentLoaded listener
            
            // Provider filter change handler
            const providerFilter = document.getElementById('providerFilter');
            if (providerFilter) {
                providerFilter.addEventListener('change', (e) => {
                    loadFreeMovies(e.target.value);
                });
            }
            
            // Removed global .video-card -> Flicks redirect to allow movie cards to open detail view
            
            // Add live stream button to navigation
            const nav = document.querySelector('nav[role="navigation"] > div');
            if (nav && !document.getElementById('liveStreamBtn')) {
                const liveBtn = document.createElement('button');
                liveBtn.id = 'liveStreamBtn';
                liveBtn.onclick = openLiveStreamModal;
                liveBtn.className = 'btn-enhanced';
                liveBtn.style.cssText = 'background:var(--error); margin-left:8px; font-weight:600;';
                liveBtn.innerHTML = 'üî¥ Go Live';
                nav.appendChild(liveBtn);
            }
            
            // Add notifications button to navigation
            if (nav && !document.getElementById('notificationsBtn')) {
                const notifBtn = document.createElement('button');
                notifBtn.id = 'notificationsBtn';
                notifBtn.onclick = toggleNotificationsPanel;
                notifBtn.className = 'btn-enhanced';
                notifBtn.style.cssText = 'background:var(--bg-secondary); color:var(--text-primary); border:1px solid var(--border); margin-left:8px; position:relative;';
                notifBtn.innerHTML = 'üîî <span id="navNotificationBadge" class="notification-badge" style="position:absolute; top:-4px; right:-4px; display:none;">0</span>';
                nav.appendChild(notifBtn);
            }
            
            // Initialize notification system
            initializeNotificationSystem();
            
            // Load initial notifications
            setTimeout(() => {
                loadNotifications();
            }, 2000);
        });

        async function signInWithApple() {
            if (!APPLE_SIGNIN_ENABLED) {
                alert('Sign in with Apple will be available soon.');
                return;
            }
            await initFirebase();
            try {
                const provider = new firebase.auth.OAuthProvider('apple.com');
                provider.addScope('email');
                provider.addScope('name');
                const isIOSSafari = /iP(hone|ad|od)/.test(navigator.userAgent) && /Safari/.test(navigator.userAgent) && !/CriOS|FxiOS/.test(navigator.userAgent);
                if (isIOSSafari) {
                    await auth.signInWithRedirect(provider);
                    return;
                }
                    await auth.signInWithPopup(provider);
                closeAuthModal();
                refreshAccountMenu();
                clearOverlays();
                } catch (e) {
                alert(e?.message || 'Apple sign-in failed');
            }
        }
    </script>
</body>
</html>