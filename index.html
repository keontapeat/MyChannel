<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>MyChannel Pro - Next-Gen Video Platform</title>
    <meta name="title" content="MyChannel - The Future of Video">
    <meta name="description" content="Experience the next generation video platform. Watch, share, and discover amazing content from creators worldwide. Stories, videos, and live streaming - all in one place.">
    <meta name="keywords" content="video platform, streaming, content creators, videos, stories, MyChannel, social media, entertainment">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <meta name="author" content="MyChannel">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mychannel.live/">
    <meta property="og:title" content="MyChannel - The Future of Video">
    <meta property="og:description" content="Experience the next generation video platform. Watch, share, and discover amazing content from creators worldwide.">
    <meta property="og:image" content="https://mychannel.live/assets/MyChannel-og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="MyChannel">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://mychannel.live/">
    <meta property="twitter:title" content="MyChannel - The Future of Video">
    <meta property="twitter:description" content="Experience the next generation video platform. Watch, share, and discover amazing content from creators worldwide.">
    <meta property="twitter:image" content="https://mychannel.live/assets/MyChannel-og-image.png">
    <meta property="twitter:creator" content="@mychannel">
    <meta property="twitter:site" content="@mychannel">
    
    <!-- App Icons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Mobile App -->
    <meta name="theme-color" content="#ff4444">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MyChannel">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://apis.google.com https://www.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: blob:; media-src 'self' https: blob:; connect-src 'self' https: wss:; font-src 'self' data:; frame-src 'self' https://accounts.google.com https://*.google.com https://*.gstatic.com https://mychannel-ca26d.firebaseapp.com https://mychannel-ca26d.web.app; object-src 'none'; base-uri 'self';">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://mychannel.live/">
    
    <!-- Preconnect to External Domains -->
    <link rel="preconnect" href="https://images.unsplash.com">
    <link rel="preconnect" href="https://commondatastorage.googleapis.com">
    <link rel="preconnect" href="https://www.gstatic.com">
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "MyChannel",
      "description": "The future of video - watch, share, and discover amazing content from creators worldwide",
      "url": "https://mychannel.live",
      "applicationCategory": "MultimediaApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "1250"
      }
    }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* CSS Variables - Light Theme Only */
        :root {
            --primary: #FF4444;
            --accent: #00FFE1;
            --light: #ffffff;
            --gray: #888888;
            --light-gray: #f0f0f0;
            --dark: #212529;
            --darker: #6c757d;
            
            /* Main Theme Variables */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --card-bg: rgba(0, 0, 0, 0.05);
            --glass-bg: rgba(0, 0, 0, 0.1);
            --shadow: rgba(0, 0, 0, 0.1);
            --border: #dee2e6;
            --hover: #f8f9fa;
            
            /* Additional Variables */
            --success: #00FF88;
            --warning: #FFB800;
            --error: #FF4444;
            --gradient: linear-gradient(135deg, #FF4444 0%, #FF6B6B 100%);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        /* Completely disable iOS Safari video overlays */
        video {
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            -khtml-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            outline: none !important;
            border: none !important;
        }
        
        .video-player-container {
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            user-select: none !important;
            overflow: hidden !important;
        }
        
        /* Block any iOS Safari video interaction overlays */
        video::-webkit-media-controls-overlay {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        /* Enhanced Animations */
        @keyframes heartFloat {
            0% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
            50% {
                transform: scale(1.5) translateY(-20px);
                opacity: 0.8;
            }
            100% {
                transform: scale(2) translateY(-40px);
                opacity: 0;
            }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-30px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        /* Enhanced Button Styles */
        .theme-toggle:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }

        .pip-btn, .speed-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            margin: 0 4px;
        }

        .pip-btn:hover, .speed-btn:hover {
            background: var(--hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        /* Enhanced Video Grid with Staggered Animation */
        .video-grid .video-item {
            animation: slideInUp 0.6s ease-out forwards;
            animation-delay: calc(var(--item-index, 0) * 0.1s);
        }

        /* Enhanced Story Items */
        .story-item {
            animation: slideInLeft 0.5s ease-out forwards;
            animation-delay: calc(var(--story-index, 0) * 0.1s);
        }

        .story-item:hover {
            animation: pulse 0.3s ease-in-out;
        }

        /* Enhanced Notifications */
        .notification {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: var(--glass-bg);
            border: 1px solid var(--border);
        }

        /* Full-Screen Flicks Viewer */
        .flicks-viewer {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 10000;
            display: none;
            flex-direction: column;
            touch-action: pan-y;
        }

        .flicks-viewer.active {
            display: flex;
        }

        .flicks-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
        }

        .flick-item {
            width: 100vw;
            height: 100vh;
            position: relative;
            scroll-snap-align: start;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flick-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        .flick-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(transparent 60%, rgba(0,0,0,0.4));
            pointer-events: none;
        }

        .flick-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 80px;
            color: white;
            pointer-events: auto;
        }

        .flick-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .flick-creator {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 12px;
        }

        .flick-actions {
            position: absolute;
            right: 20px;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .flick-action {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .flick-action:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .flick-action.liked {
            background: #ff4444;
            color: white;
        }

        .flick-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .flick-progress {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255,255,255,0.3);
        }

        .flick-progress-fill {
            height: 100%;
            background: #ff4444;
            width: 0%;
            transition: width 0.1s linear;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: var(--transition);
            line-height: 1.6;
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 1000;
            padding-top: env(safe-area-inset-top);
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        /* Keep header light and text dark at all times */
        .header .logo { color: var(--text-primary); }
        .header:hover { background: rgba(255, 255, 255, 0.95); border-bottom-color: var(--border); }
        .header:hover .logo { color: var(--text-primary); }

        

        .header:hover {
            background: rgba(0, 0, 0, 0.98);
            border-bottom-color: var(--primary);
        }
        .header .logo { color: var(--text-primary); }
        .header:hover .logo { color: #fff; }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
        }

        /* Keep logo readable on hover when header turns dark */
        .header:hover .logo { color: #fff; }
        
        .logo img {
            width: 32px;
            height: 32px;
            border-radius: 6px;
        }
        
        .main-content {
            margin-top: 60px;
            padding: 20px 16px 70px;
            background: var(--bg-primary);
        }
        
        .stories-section {
            margin-bottom: 24px;
        }

        /* Minimal promo banner */
        .promo-banner { padding: 10px 12px; margin: 8px 0 12px 0; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.08); background:#fff; color:#111; border:1px solid rgba(0,0,0,0.06); }
        .promo-row { gap: 8px; }
        .promo-title { font-size: 16px; font-weight: 800; letter-spacing: .2px; margin: 0 0 2px 0; color:#111; text-shadow:none; }
        .promo-desc { font-size: 12px; opacity: 0.9; margin-top: 0; color:#333; }
        .promo-actions { gap: 10px; }
        .promo-close { top: 6px; right: 6px; width: 20px; height: 20px; font-size: 12px; }
        .promo-banner::after{ display:none; }

        
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #ff4444;
        }
        
        .stories-container {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
            scroll-snap-type: x mandatory;
            background: transparent;
        }
        
        .story-item {
            flex-shrink: 0;
            text-align: center;
            scroll-snap-align: start;
        }
        
        .story-ring {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff4444, #ff6b6b);
            padding: 3px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .story-ring:hover {
            transform: scale(1.05);
        }
        
        .story-ring img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #0f0f0f;
        }
        
        .add-story {
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-story-plus {
            color: white;
            font-size: 28px;
            font-weight: 300;
        }
        
        .active-story {
            background: linear-gradient(45deg, #ff4444, #ff6b6b);
        }
        
        .story-item span {
            font-size: 12px;
            color: #aaa;
            display: block;
            max-width: 64px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .video-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 480px) {
            .video-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (min-width: 900px) {
            .video-grid { grid-template-columns: repeat(3, 1fr); }
        }
        
        .video-card {
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .video-card:hover {
            transform: translateY(-2px);
        }
        
        .video-thumbnail {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #272727;
        }
        
        .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-duration {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .play-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            color: #000;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .video-card:hover .play-overlay {
            opacity: 1;
        }
        
        .video-info {
            padding: 12px;
            display: flex;
            gap: 12px;
        }
        
        .channel-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .video-details { background: rgba(0,0,0,0.85); padding:10px 12px; border-radius:12px; margin-top:8px; }
        .video-details h3 { color:#fff; font-size:16px; font-weight:700; margin:0 0 4px 0; }
        .video-meta { color:#ddd; font-size:12px; margin:0; }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 52px;
            background: var(--bg-primary);
            border-top: 1px solid #272727;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 1000;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 4px 8px;
            color: #aaa;
            text-decoration: none;
            transition: color 0.2s ease;
            cursor: pointer;
            flex: 1;
            max-width: 72px;
        }
        
        .nav-item.active {
            color: #fff;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 1px;
        }
        
        .nav-item small {
            font-size: 10px;
            font-weight: 400;
            letter-spacing: 0.2px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 16px 12px 100px;
            }
            
            .header {
                padding: 0 16px;
                height: 56px;
            }
        }

        /* Enhanced Video Player Styles */
        .enhanced-video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-container:hover .enhanced-video-controls {
            opacity: 1;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            margin-bottom: 12px;
            cursor: pointer;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.1s ease;
        }

        .video-control-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .video-control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Floating Upload Button removed */

        /* Upload Modal */
        .upload-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10002; display: none; }
        .upload-modal { position: fixed; inset: 0; display: none; z-index: 10003; align-items: center; justify-content: center; }
        .upload-card { width: min(720px, 94vw); max-height: 92vh; overflow: auto; background: var(--bg-primary); border-radius: 16px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .upload-header { display:flex; align-items:center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; background: var(--bg-primary); z-index: 1; }
        .upload-body { padding: 16px; }
        .upload-close { background: transparent; border: 0; color: var(--text-secondary); font-size: 22px; cursor: pointer; }
        .upload-zone { border: 2px dashed var(--border-color); border-radius: 12px; padding: 28px; text-align: center; margin-bottom: 16px; }
        .upload-input { display:none; }
        .upload-row { margin-bottom: 12px; }
        .upload-input-text, .upload-textarea, .upload-select { width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); }

            /* Enhanced Stories Section */
            .upload-select option {
                padding: 8px;
                background: var(--bg-primary);
                color: var(--text-primary);
            }
            
            /* Advanced Notifications Styles */
            .notifications-panel {
                position: fixed;
                top: 0;
                right: -400px;
                width: 400px;
                height: 100vh;
                background: var(--bg-primary);
                border-left: 1px solid var(--border);
                z-index: 10000;
                transition: right 0.3s ease;
                display: flex;
                flex-direction: column;
                box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            }
            .notifications-panel.active {
                right: 0;
            }
            .notifications-header {
                padding: 16px;
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: var(--bg-secondary);
            }
            .notification-badge {
                background: var(--error);
                color: #fff;
                border-radius: 50%;
                padding: 2px 6px;
                font-size: 10px;
                font-weight: 600;
                min-width: 16px;
                text-align: center;
            }
            .notifications-filters {
                display: flex;
                padding: 12px 16px;
                gap: 8px;
                border-bottom: 1px solid var(--border);
                overflow-x: auto;
            }
            .notification-filter {
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 16px;
                padding: 6px 12px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
                white-space: nowrap;
                color: var(--text-secondary);
            }
            .notification-filter.active {
                background: var(--primary);
                color: #fff;
                border-color: var(--primary);
            }
            .notifications-list {
                flex: 1;
                overflow-y: auto;
                padding: 8px 0;
            }
            .notification-item {
                padding: 12px 16px;
                border-bottom: 1px solid var(--border);
                cursor: pointer;
                transition: background 0.2s ease;
                position: relative;
            }
            .notification-item:hover {
                background: var(--bg-secondary);
            }
            .notification-item.unread {
                background: rgba(var(--primary-rgb), 0.05);
            }
            .notification-item.unread::before {
                content: '';
                position: absolute;
                left: 8px;
                top: 50%;
                transform: translateY(-50%);
                width: 4px;
                height: 4px;
                background: var(--primary);
                border-radius: 50%;
            }
            .notification-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: var(--bg-secondary);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                margin-right: 12px;
                flex-shrink: 0;
            }
            .notification-content {
                flex: 1;
            }
            .notification-text {
                font-size: 14px;
                color: var(--text-primary);
                margin-bottom: 4px;
                line-height: 1.3;
            }
            .notification-time {
                font-size: 11px;
                color: var(--text-secondary);
            }
            .notifications-empty {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100%;
            }
            .notifications-settings {
                border-top: 1px solid var(--border);
            }
            
            /* Notification Toast */
            .notification-toast {
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--bg-primary);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 12px 16px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                z-index: 10001;
                max-width: 300px;
                transform: translateX(400px);
                transition: transform 0.3s ease;
            }
            .notification-toast.show {
                transform: translateX(0);
            }
            .notification-toast-header {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 8px;
            }
            .notification-toast-title {
                font-weight: 600;
                font-size: 14px;
                color: var(--text-primary);
            }
            .notification-toast-body {
                font-size: 12px;
                color: var(--text-secondary);
                line-height: 1.3;
            }
            
            @media (max-width: 768px) {
                .notifications-panel {
                    width: 100vw;
                    right: -100vw;
                }
            }

        /* Stories Section */
        .stories-section {
            margin-bottom: 24px;
        }

        .story-item {
            position: relative;
            transition: var(--transition);
        }

        .story-item:hover {
            transform: scale(1.05);
        }

        /* Enhanced Buttons */
        .btn-enhanced {
            background: var(--gradient);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .btn-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 68, 68, 0.3);
        }

        /* Enhanced Notifications */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-primary);
            color: var(--light);
            padding: 16px 20px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary);
            box-shadow: var(--shadow);
            z-index: 10000;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .bottom-nav .nav-item { -webkit-tap-highlight-color: transparent; }
        .bottom-nav .nav-item:focus, .bottom-nav .nav-item:focus-visible { outline: none; }
        .bottom-nav .nav-item.active small { color: #fff; }
        .bottom-nav .nav-item.active .nav-icon { color: #fff; }

        /* Bottom nav focus/active fixes */
        .bottom-nav .nav-item { -webkit-tap-highlight-color: transparent; box-shadow: none !important; }
        .bottom-nav .nav-item:focus, .bottom-nav .nav-item:focus-visible { outline: none !important; box-shadow: none !important; }
        .bottom-nav .nav-item small { color: #aaa; }
        .bottom-nav .nav-item.active small, .bottom-nav .nav-item.active { color: #fff !important; }

        /* Ensure active tab text/icon visible on white bar */
        .bottom-nav .nav-item.active, .bottom-nav .nav-item.active small, .bottom-nav .nav-item.active .nav-icon { color: #111 !important; }
        .bottom-nav .nav-item.active { border-bottom: 2px solid var(--primary); }

        /* Promo Banner visual polish */
        .promo-banner { border: 1px solid rgba(255,255,255,0.2); }
        .promo-title { text-shadow: 0 1px 0 rgba(0,0,0,0.25); }
        .promo-btn { box-shadow: 0 6px 14px rgba(0,0,0,0.18); }

        /* Rounded, stylish video thumbnails */
        .video-grid .video-item { background: var(--card-bg); border: 1px solid var(--border); padding: 10px; border-radius: 14px; overflow: hidden; }
        .video-thumbnail { border-radius: 12px; overflow: hidden; position: relative; }
        .video-thumbnail::after { content: ''; position:absolute; inset:0; background: linear-gradient(to top, rgba(0,0,0,0.25), rgba(0,0,0,0)); pointer-events:none; }
        .video-thumbnail img { border-radius: 12px; display:block; width:100%; height:100%; object-fit:cover; }

        /* Promo Banner for guests */
        .promo-banner {
            display: block;
            background: linear-gradient(135deg, #ff4d4d, #ff7a7a);
            color: #fff;
            border-radius: 12px;
            padding: 10px 12px;
            margin: 8px 0 12px 0;
            box-shadow: 0 6px 16px rgba(255, 68, 68, 0.18);
        }
        .promo-banner.hidden { display: none !important; }
        .promo-banner.red { border: 1px solid rgba(255,255,255,0.2); }

        body .promo-banner { background:#fff !important; color:#111 !important; border:1px solid rgba(0,0,0,0.06) !important; box-shadow: 0 10px 24px rgba(0,0,0,0.08) !important; }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div id="authModal" style="display:none; position: fixed; inset:0; background: rgba(0,0,0,0.5); z-index: 20000; align-items:center; justify-content:center;">
        <div style="width: 92vw; max-width: 420px; background: #fff; border-radius: 16px; overflow:hidden; box-shadow: 0 18px 48px rgba(0,0,0,0.25);">
            <div style="padding: 16px 20px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
                <div id="authTitle" style="font-weight:700; font-size:18px;">Sign in</div>
                <button onclick="closeAuthModal()" style="border:none; background:none; font-size:20px; cursor:pointer;">×</button>
            </div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                <input id="authName" placeholder="Full name" style="display:none; padding:12px 14px; border-radius:10px; border:1px solid #e9ecef;">
                <input id="authEmail" placeholder="Email" type="email" style="padding:12px 14px; border-radius:10px; border:1px solid #e9ecef;">
                <input id="authPassword" placeholder="Password" type="password" style="padding:12px 14px; border-radius:10px; border:1px solid #e9ecef;">
                <button id="authSubmit" onclick="submitAuth()" style="margin-top:8px; padding:12px 16px; border:none; background:#ff4444; color:#fff; border-radius:10px; font-weight:600; cursor:pointer;">Continue</button>
                <div style="display:flex; align-items:center; gap:8px; margin:8px 0;">
                    <div style="height:1px; background:#e9ecef; flex:1;"></div>
                    <div style="font-size:12px; color:#6c757d;">or</div>
                    <div style="height:1px; background:#e9ecef; flex:1;"></div>
                </div>
                <button id="googleAuthBtn" onclick="signInWithGoogle()" style="padding:12px 16px; border:none; background:#1a73e8; color:#fff; border-radius:10px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>Continue with Google</span>
                </button>
                <button id="appleAuthBtn" onclick="signInWithApple()" style="padding:12px 16px; border:none; background:#000; color:#fff; border-radius:10px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>Continue with Apple</span>
                </button>
                <div id="authHelper" style="font-size:12px; color:#6c757d; text-align:center; margin-top:8px;"></div>
            </div>
        </div>
    </div>

    <!-- Full-Screen Flicks Viewer -->
    <div id="flicksViewer" class="flicks-viewer">
        <button class="flick-close" onclick="closeFlicks()">×</button>
        <div class="flicks-container" id="flicksContainer">
            <!-- Flick items will be injected here -->
        </div>
    </div>

    <!-- MyChannel Studio Modal -->
    <div id="studioModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.5); z-index:20000; align-items:center; justify-content:center;">
        <div style="width:96vw; max-width:720px; background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 18px 48px rgba(0,0,0,0.25);">
            <div style="padding:16px 20px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
                <div style="font-weight:700; font-size:18px;">MyChannel Studio</div>
                <button onclick="closeStudio()" style="border:none; background:none; font-size:20px; cursor:pointer;">×</button>
            </div>
            <div style="padding:20px; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:16px;">
                <div style="border:1px solid #eef2f4; border-radius:12px; padding:16px;">
                    <div style="font-size:12px; color:#6c757d;">Active users (est.)</div>
                    <div id="studioActiveUsers" style="font-size:28px; font-weight:700;">-</div>
                </div>
                <div style="border:1px solid #eef2f4; border-radius:12px; padding:16px;">
                    <div style="font-size:12px; color:#6c757d;">Stories (24h)</div>
                    <div id="studioStories" style="font-size:28px; font-weight:700;">-</div>
                </div>
                <div style="border:1px solid #eef2f4; border-radius:12px; padding:16px;">
                    <div style="font-size:12px; color:#6c757d;">Comments (24h)</div>
                    <div id="studioComments" style="font-size:28px; font-weight:700;">-</div>
                </div>
                <div style="border:1px solid #eef2f4; border-radius:12px; padding:16px;">
                    <div style="font-size:12px; color:#6c757d;">Likes (24h)</div>
                    <div id="studioLikes" style="font-size:28px; font-weight:700;">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.5); z-index:20000; align-items:center; justify-content:center;">
        <div style="width:94vw; max-width:520px; background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 18px 48px rgba(0,0,0,0.25);">
            <div style="padding:16px 20px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
                <div style="font-weight:700; font-size:18px;">Edit Profile</div>
                <button onclick="closeEditProfile()" style="border:none; background:none; font-size:20px; cursor:pointer;">×</button>
            </div>
            <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
                <input id="profileDisplayName" placeholder="Display name" style="padding:12px 14px; border-radius:10px; border:1px solid #e9ecef;">
                <textarea id="profileBio" placeholder="Bio" rows="3" style="padding:12px 14px; border-radius:10px; border:1px solid #e9ecef;"></textarea>
                <label style="font-size:14px; color:#6c757d;">Banner video (mp4)</label>
                <input id="profileBannerVideo" type="file" accept="video/*" />
                <label style="font-size:14px; color:#6c757d;">Avatar</label>
                <input id="profileAvatar" type="file" accept="image/*" />
                <button onclick="saveProfile()" style="margin-top:8px; padding:12px 16px; border:none; background:#ff4444; color:#fff; border-radius:10px; font-weight:600; cursor:pointer;">Save</button>
            </div>
        </div>
    </div>
    <!-- Skip to Content Link for Screen Readers -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <header class="header" role="banner">
        <a href="#" class="logo" aria-label="MyChannel Home">
            <img src="assets/MyChannel.imageset/MyChannelLaunch.PNG" alt="MyChannel Logo" onerror="this.style.display='none'">
            MyChannel
        </a>
        <div style="display: flex; align-items: center; gap: 16px; position: relative;">
            <span id="notifBell" style="position: relative; font-size: 24px; cursor: pointer;">🔔
                <span id="notifBadge" style="display:none; position:absolute; top:-2px; right:-4px; width:8px; height:8px; background:#ff4444; border-radius:50%;"></span>
            </span>
            <div id="notifMenu" style="display:none; position:absolute; top:44px; right:42px; width: 280px; background:#fff; border:1px solid #eee; border-radius:12px; box-shadow:0 12px 24px rgba(0,0,0,0.12); overflow:hidden;">
                <div style="padding:12px 14px; font-weight:600; border-bottom:1px solid #f0f0f0;">Notifications</div>
                <div id="notifList" style="max-height:320px; overflow:auto;"></div>
                <div style="padding:10px; text-align:center; font-size:12px; color:#6c757d; border-top:1px solid #f0f0f0;">You're up to date</div>
            </div>
            <button id="accountButton" style="width: 32px; height: 32px; border-radius: 50%; background: #ff4444; display: flex; align-items: center; justify-content: center; font-weight: 600; color:#fff; border:none; cursor:pointer;">K</button>
            <!-- Account Menu -->
            <div id="accountMenu" style="display:none; position:absolute; top:44px; right:0; width: 260px; background: #fff; border:1px solid #eee; border-radius: 12px; box-shadow: 0 12px 24px rgba(0,0,0,0.12); overflow:hidden;">
                <div style="padding:12px 16px; border-bottom:1px solid #f0f0f0;">
                    <div id="accountName" style="font-weight:600; color:#212529;">Guest</div>
                    <div id="accountEmail" style="font-size:12px; color:#6c757d;">Not signed in</div>
                </div>
                <div id="menuSignedOut">
                    <button onclick="openAuthModal('signin')" style="width:100%; padding:12px 16px; background:#fff; border:none; text-align:left; cursor:pointer;">Sign in</button>
                    <button onclick="openAuthModal('signup')" style="width:100%; padding:12px 16px; background:#fff; border:none; text-align:left; cursor:pointer;">Create account</button>
                </div>
                <div id="menuSignedIn" style="display:none;">
                    <button onclick="switchProfile()" style="width:100%; padding:12px 16px; background:#fff; border:none; text-align:left; cursor:pointer;">Switch profile</button>
                    <button onclick="signOutUser()" style="width:100%; padding:12px 16px; background:#fff; border:none; text-align:left; cursor:pointer; color:#c1121f;">Sign out</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tab Content -->
    <div id="home-content" class="tab-content active" role="tabpanel" aria-labelledby="home-tab">
        <main class="main-content" id="main-content" role="main">
            <section id="promoBanner" class="promo-banner" role="note" aria-live="polite">
                <div class="promo-row">
                    <div>
                        <div class="promo-title">Your Channel. Your Future.</div>
                        <div class="promo-desc">Join MyChannel to post stories and videos.</div>
                    </div>
                    <div class="promo-actions">
                        <button class="promo-btn" onclick="openAuthModal('signup')">Create account</button>
                        <button class="promo-btn secondary" onclick="openAuthModal('signin')">Sign in</button>
                        <button class="promo-close" id="promoCloseBtn" aria-label="Dismiss">×</button>
                    </div>
                </div>
            </section>
            <section class="stories-section">
                <h2 class="section-title">Stories</h2>
                <div class="stories-container">
                    <!-- Add Story -->
                    <div class="story-item" onclick="addStory()">
                        <div class="story-ring add-story">
                            <div class="add-story-plus">+</div>
                        </div>
                        <span>Your Story</span>
                    </div>
                    
                    <!-- Existing Stories -->
                    <div class="story-item" onclick="viewStory('sarah', 0)">
                        <div class="story-ring active-story">
                            <img src="https://images.unsplash.com/photo-1494790108755-2616b612b786?w=100&h=100&fit=crop&crop=face" alt="Story">
                        </div>
                        <span>Sarah</span>
                    </div>
                    <div class="story-item" onclick="viewStory('mike', 1)">
                        <div class="story-ring active-story">
                            <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&h=100&fit=crop&crop=face" alt="Story">
                        </div>
                        <span>Mike</span>
                    </div>
                    <div class="story-item" onclick="viewStory('alex', 2)">
                        <div class="story-ring active-story">
                            <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100&h=100&fit=crop&crop=face" alt="Story">
                        </div>
                        <span>Alex</span>
                    </div>
                    <div class="story-item" onclick="viewStory('emma', 3)">
                        <div class="story-ring active-story">
                            <img src="https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=100&h=100&fit=crop&crop=face" alt="Story">
                        </div>
                        <span>Emma</span>
                    </div>
                </div>
            </section>

            <section id="featured-section" style="margin:12px 0 16px 0;">
                <h2 class="section-title">Featured</h2>
                <div id="heroCarousel" style="position:relative; border-radius:12px; overflow:hidden; background:#000;">
                    <!-- Slides will be injected dynamically -->
                </div>
                <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                    <div id="heroDots" style="display:flex; gap:6px;"></div>
                    <div style="display:flex; gap:8px;">
                        <button id="heroPrev" aria-label="Previous" style="border:1px solid var(--border); background:#fff; border-radius:8px; padding:6px 8px; cursor:pointer;">‹</button>
                        <button id="heroNext" aria-label="Next" style="border:1px solid var(--border); background:#fff; border-radius:8px; padding:6px 8px; cursor:pointer;">›</button>
                    </div>
                </div>
            </section>

            <!-- Enhanced Free Movies with Provider Filters -->
            <section id="free-movies" style="margin: 18px 0 8px 0;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                    <h2 class="section-title" style="margin:0;">Free Movies</h2>
                    <select id="providerFilter" style="padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--bg-primary); color:var(--text-primary); font-size:12px;">
                        <option value="all">All Platforms</option>
                        <option value="tubi">Tubi</option>
                        <option value="pluto">Pluto TV</option>
                        <option value="roku">Roku Channel</option>
                        <option value="freevee">Amazon Freevee</option>
                        <option value="plex">Plex</option>
                        <option value="crackle">Crackle</option>
                    </select>
                </div>
                <div id="freeMoviesRow" style="display:flex; gap:12px; overflow-x:auto; padding: 6px 2px 12px 2px; scroll-snap-type: x mandatory;"></div>
            </section>

            <!-- Trending Section -->
            <section id="trending-section" style="margin: 18px 0 8px 0;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                    <h2 class="section-title" style="margin:0;">Trending</h2>
                    <div style="display:flex; gap:8px;">
                        <button id="trendingMovies" class="trending-filter active" onclick="loadTrending('movie')" style="padding:4px 12px; border-radius:20px; border:1px solid var(--primary); background:var(--primary); color:#fff; font-size:12px; cursor:pointer;">Movies</button>
                        <button id="trendingTV" class="trending-filter" onclick="loadTrending('tv')" style="padding:4px 12px; border-radius:20px; border:1px solid var(--border); background:transparent; color:var(--text-primary); font-size:12px; cursor:pointer;">TV Shows</button>
                    </div>
                </div>
                <div id="trendingRow" style="display:flex; gap:12px; overflow-x:auto; padding: 6px 2px 12px 2px; scroll-snap-type: x mandatory;"></div>
            </section>

            <section>
                <h2 class="section-title">Recommended for you</h2>
                <div class="video-grid" id="videoGrid">
                    <!-- Videos will be loaded dynamically -->
                </div>
            </section>
        </main>
    </div>
    <nav class="bottom-nav" role="tablist" aria-label="Main navigation">
        <a href="#" class="nav-item active" onclick="showTab('home')" role="tab" aria-selected="true" aria-controls="home-content" id="home-tab" tabindex="0">
            <div class="nav-icon" aria-hidden="true">🏠</div>
            <small>Home</small>
            <span class="sr-only">Navigate to home page</span>
        </a>
        <a href="#" class="nav-item" onclick="showTab('flicks')" role="tab" aria-selected="false" aria-controls="flicks-content" id="flicks-tab" tabindex="-1">
            <div class="nav-icon" aria-hidden="true">🎬</div>
            <small>Flicks</small>
            <span class="sr-only">Navigate to flicks page</span>
        </a>
        <a href="#" class="nav-item" onclick="openUploadModal(); return false;" role="button" aria-label="Create" id="create-tab" tabindex="0">
            <div class="nav-icon" aria-hidden="true">➕</div>
            <small>Create</small>
            <span class="sr-only">Open upload</span>
        </a>
        <a href="#" class="nav-item" onclick="showTab('search')" role="tab" aria-selected="false" aria-controls="search-content" id="search-tab" tabindex="-1">
            <div class="nav-icon" aria-hidden="true">🔍</div>
            <small>Search</small>
            <span class="sr-only">Navigate to search page</span>
        </a>
        <a href="#" class="nav-item" onclick="showTab('profile')" role="tab" aria-selected="false" aria-controls="profile-content" id="profile-tab" tabindex="-1">
            <div class="nav-icon" aria-hidden="true">👤</div>
            <small>Profile</small>
            <span class="sr-only">Navigate to profile page</span>
        </a>
    </nav>



    <div id="flicks-content" class="tab-content">
        <section style="padding: 20px 16px;">
            <h2 class="section-title">🎬 Flicks</h2>
            <div id="flicksGrid" class="flicks-grid" style="display: grid; gap: 12px; grid-template-columns: repeat(3, 1fr);"></div>
            <div id="flicksEmpty" style="margin-top:8px; color: var(--text-secondary); font-size: 13px; padding: 12px; border: 1px dashed var(--border-color); border-radius: 8px;">No flicks yet.</div>
        </section>
    </div>

    <div id="search-content" class="tab-content">
        <section style="padding: 20px 16px;">
            <div class="search-bar" style="margin-bottom: 24px;">
                <input type="text" placeholder="Search MyChannel..." style="width: 100%; padding: 12px 16px; background: #1a1a1a; border: 1px solid #333; border-radius: 24px; color: white; font-size: 16px;" oninput="performSearch(this.value)">
            </div>
            
            <div id="search-results">
                <h3 style="color: #666; text-align: center; margin-top: 60px;">Search for videos, channels, and more</h3>
                
                <div class="search-suggestions" style="margin-top: 40px;">
                    <h4 style="color: #ff4444; margin-bottom: 16px;">Trending Searches</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('gaming')">gaming</span>
                        <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('music')">music</span>
                        <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('tutorial')">tutorial</span>
                        <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('comedy')">comedy</span>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="profile-content" class="tab-content" aria-labelledby="profile-tab" role="tabpanel">
        <!-- Profile Header with Background -->
        <div class="profile-header" style="position: relative; height: 300px; background: #000; overflow: hidden;">
            <!-- Video Banner -->
            <video id="profileBannerVideoEl" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); min-width:100%; min-height:100%; object-fit:cover; opacity:0.6;" autoplay muted loop playsinline></video>
            
            <!-- Settings Icon -->
            <div id="profileSettingsBtn" style="position: absolute; top: 20px; right: 20px; color: white; font-size: 24px; cursor: pointer;" onclick="showSettings()" aria-label="Profile settings" title="Profile settings">⚙️</div>
            
            <!-- Profile Info -->
            <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; background: linear-gradient(transparent, rgba(0,0,0,0.7));">
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div id="profileAvatarEl" style="width: 64px; height: 64px; border-radius: 50%; background: #2a2a2a; border: 3px solid white; margin-right: 16px;"></div>
                    <div>
                        <h2 id="profileDisplayNameEl" style="color: white; margin: 0; font-size: 24px; font-weight: 600;">MyChannel User</h2>
                        <p id="profileHandleEl" style="color: #ccc; margin: 4px 0 0 0; font-size: 14px;">@user</p>
                        <p id="profileBioEl" style="color: #ccc; margin: 2px 0 0 0; font-size: 12px;">Welcome to MyChannel</p>
                    </div>
                </div>
                
                <!-- Stats -->
                <div style="display: flex; gap: 24px; margin-bottom: 16px;">
                    <div style="text-align: center;">
                        <div id="profileHeaderCountsSubs" style="color: white; font-size: 18px; font-weight: 600;">0</div>
                        <div style="color: #ccc; font-size: 11px;">Subscribers</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="profileHeaderCountsVids" style="color: white; font-size: 18px; font-weight: 600;">0</div>
                        <div style="color: #ccc; font-size: 11px;">Videos</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="profileHeaderCountsViews" style="color: white; font-size: 18px; font-weight: 600;">0</div>
                        <div style="color: #ccc; font-size: 11px;">Views</div>
                    </div>
                </div>
                
                <!-- Edit Profile Button -->
                <button id="editProfileBtn" onclick="openEditProfile()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: 500; width: 100%; backdrop-filter: blur(10px); cursor:pointer;">Edit Profile</button>
            </div>
        </div>
        
        <!-- Content Tabs -->
        <div class="profile-tabs" style="display: flex; background: var(--bg-primary); border-bottom: 1px solid #333;">
            <div class="profile-tab active" onclick="showProfileTab('videos')" style="flex: 1; padding: 12px; text-align: center; color: #ff4444; border-bottom: 2px solid #ff4444; font-size: 14px; font-weight: 500; cursor: pointer;">
                📹 Videos (<span id="profileVideosCount">0</span>)
            </div>
            <div class="profile-tab" onclick="showProfileTab('flicks')" style="flex: 1; padding: 12px; text-align: center; color: #666; border-bottom: 2px solid transparent; font-size: 14px; font-weight: 500; cursor: pointer;">
                🎬 Flicks (0)
            </div>
            <div class="profile-tab" onclick="showProfileTab('playlists')" style="flex: 1; padding: 12px; text-align: center; color: #666; border-bottom: 2px solid transparent; font-size: 14px; font-weight: 500; cursor: pointer;">
                📋 Playlists (0)
            </div>
            <div class="profile-tab" onclick="showProfileTab('community')" style="flex: 1; padding: 12px; text-align: center; color: #666; border-bottom: 2px solid transparent; font-size: 14px; font-weight: 500; cursor: pointer;">
                💬 Community
            </div>
            <div class="profile-tab" onclick="showProfileTab('about')" style="flex: 1; padding: 12px; text-align: center; color: #666; border-bottom: 2px solid transparent; font-size: 14px; font-weight: 500; cursor: pointer;">
                ℹ️ About
            </div>
        </div>
        
        <!-- Tab Content Areas -->
        <div id="profile-videos-tab" class="profile-tab-content active" style="padding: 16px; background: var(--bg-primary);">
            <div id="profileVideosEmpty" style="display:none;"></div>
            <div id="profileVideosGrid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;"></div>
        </div>

        <div id="profile-flicks-tab" class="profile-tab-content" style="padding: 16px; background: var(--bg-primary); display: none;">
            <div id="profileFlicksGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;"></div>
        </div>

            <div id="profilePlaylistsEmpty" style="display:none;"></div>
        </div>

        <div id="profile-community-tab" class="profile-tab-content" style="padding: 16px; background: var(--bg-primary); display: none;">
            <div id="communityComposer" style="margin-bottom:12px; display:flex; gap:8px;">
                <input id="communityText" placeholder="Share an update..." style="flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:var(--bg-secondary); color:var(--text-primary);" />
                <button id="communityPostBtn" class="btn-enhanced">Post</button>
            </div>
            <div id="communityFeed" style="display:flex; flex-direction:column; gap:8px;"></div>
        </div>

        <div id="profile-about-tab" class="profile-tab-content" style="padding: 16px; background: var(--bg-primary); display: none;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                <div style="background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px;">
                    <div style="font-size:12px; color:#999;">Subscribers</div>
                    <div id="aboutSubs" style="font-weight:700; font-size:18px;">0</div>
                </div>
                <div style="background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px;">
                    <div style="font-size:12px; color:#999;">Videos</div>
                    <div id="aboutVids" style="font-weight:700; font-size:18px;">0</div>
                </div>
                <div style="background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px;">
                    <div style="font-size:12px; color:#999;">Total Views</div>
                    <div id="aboutViews" style="font-weight:700; font-size:18px;">0</div>
                </div>
                <div style="background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px;">
                    <div style="font-size:12px; color:#999;">Joined</div>
                    <div id="aboutJoined" style="font-weight:700; font-size:18px;">—</div>
                </div>
            </div>
        </div>
        
        <!-- Persistent History section (always visible) -->
        <div id="profile-history-persistent" style="display:none; padding:16px; background: var(--bg-primary);">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                <div style="font-weight:600;">History</div>
                <a href="#" style="font-size:12px; color:#666; text-decoration:none;">View all</a>
            </div>
            <div id="historyGrid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px;"></div>
        </div>
    </div>

    <!-- Story Viewer Modal -->
    <div id="storyViewer" class="story-viewer" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-primary); z-index: 10000;">
        <!-- Story Progress Bars -->
        <div class="story-progress" style="position: absolute; top: 20px; left: 20px; right: 20px; display: flex; gap: 4px; z-index: 10001;">
            <div class="progress-bar" style="flex: 1; height: 3px; background: rgba(255,255,255,0.3); border-radius: 2px;">
                <div class="progress-fill" style="height: 100%; background: white; border-radius: 2px; width: 0%; transition: width 0.1s linear;"></div>
            </div>
        </div>
        
        <!-- Story Header -->
        <div class="story-header" style="position: absolute; top: 40px; left: 20px; right: 20px; display: flex; align-items: center; justify-content: space-between; z-index: 10001;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <img id="storyUserAvatar" src="" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                <div>
                    <div id="storyUsername" style="color: white; font-size: 14px; font-weight: 500;"></div>
                    <div id="storyTime" style="color: #ccc; font-size: 12px;">2h ago</div>
                </div>
            </div>
            <div onclick="closeStoryViewer()" style="color: white; font-size: 28px; cursor: pointer; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.5)'" onmouseout="this.style.background='rgba(0,0,0,0.3)'" title="Close story">×</div>
        </div>
        
        <!-- Story Content -->
        <div class="story-content" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
            <img id="storyImage" src="" style="max-width: 100%; max-height: 100%; object-fit: contain;">
            <video id="storyVideo" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;" controls></video>
        </div>
        
        <!-- Navigation Areas -->
        <div class="story-nav-left" onclick="previousStory()" style="position: absolute; left: 0; top: 0; width: 30%; height: 100%; cursor: pointer; z-index: 10001;" title="Previous story"></div>
        <div class="story-nav-right" onclick="nextStory()" style="position: absolute; right: 0; top: 0; width: 30%; height: 100%; cursor: pointer; z-index: 10001;" title="Next story"></div>
        
        <!-- Navigation hint -->
        <div style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.6); font-size: 12px; z-index: 10001; text-align: center; pointer-events: none;">
            Press ESC to close • Click sides or use arrow keys to navigate
        </div>
        
        <!-- Story Comments List -->
        <div id="storyComments" style="position:absolute; left:20px; right:20px; bottom:88px; max-height:160px; overflow-y:auto; z-index:10001; display:flex; flex-direction:column; gap:8px;"></div>
        <!-- Story Actions -->
        <div class="story-actions" style="position: absolute; bottom: 20px; left: 20px; right: 20px; display: flex; gap: 12px; z-index: 10001;">
            <input id="storyCommentInput" type="text" placeholder="Reply to story..." style="flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 10px 16px; color: white; font-size: 14px;">
            <button id="storyLikeBtn" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 10px 14px; color:#fff; cursor:pointer;">Like</button>
            <button id="storySendBtn" style="background: #ff4444; border:none; border-radius: 20px; padding: 10px 14px; color:#fff; cursor:pointer;">Post</button>
        </div>
    </div>

    <!-- Add Story Modal -->
    <div id="addStoryModal" class="add-story-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; backdrop-filter: blur(10px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; border-radius: 16px; padding: 24px; width: 90%; max-width: 400px;">
            <h3 style="color: white; text-align: center; margin: 0 0 20px 0; font-size: 18px;">Add to Your Story</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                <div onclick="openCamera()" style="background: #333; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: background 0.2s ease;">
                    <div style="font-size: 32px; margin-bottom: 8px;">📷</div>
                    <div style="color: white; font-size: 14px;">Camera</div>
                </div>
                <div onclick="openGallery()" style="background: #333; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: background 0.2s ease;">
                    <div style="font-size: 32px; margin-bottom: 8px;">🖼️</div>
                    <div style="color: white; font-size: 14px;">Gallery</div>
                </div>
            </div>
            
            <button onclick="closeAddStoryModal()" style="width: 100%; background: #ff4444; color: white; border: none; border-radius: 8px; padding: 12px; font-size: 16px; font-weight: 500; cursor: pointer;">Cancel</button>
        </div>
    </div>

    <!-- Video Detail View - iOS App Style -->
    <div id="videoDetailView" class="video-detail-view" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-primary); z-index: 10000; overflow-y: auto;">
        <!-- Video Player Container -->
        <div class="video-player-container" style="position: relative; width: 100%; aspect-ratio: 16/9; background: var(--bg-primary); max-height: 56.25vw;">
            <!-- Main Video Player -->
            <video id="detailVideoPlayer" style="width: 100%; height: 100%; object-fit: contain; background: var(--bg-primary); pointer-events: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;" autoplay playsinline webkit-playsinline x5-playsinline controls="false" controlsList="nodownload nofullscreen noremoteplayback noplaybackrate" disablePictureInPicture disableRemotePlayback>
                <source src="" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            
            <!-- iOS-Style Loading Spinner -->
            <div id="videoLoadingSpinner" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 10002;">
                <div style="width: 60px; height: 60px; border-radius: 50%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;">
                    <div style="width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
            </div>
            
            <!-- Sleek Video Controls Overlay -->
            <div id="videoControlsOverlay" class="video-controls-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10001; opacity: 1; transition: opacity 0.3s ease; pointer-events: none;">
                
                <!-- Top Controls Bar -->
                <div class="top-controls" style="position: absolute; top: 0; left: 0; right: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); padding: 20px; display: flex; align-items: center; justify-content: space-between; pointer-events: auto;">
                    <!-- Close Button -->
                    <div onclick="closeVideoDetail()" style="width: 40px; height: 40px; border-radius: 8px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </div>
                    
                    <!-- Video Title -->
                    <div style="flex: 1; margin: 0 16px; text-align: center;">
                        <div id="topBarVideoTitle" style="color: white; font-size: 15px; font-weight: 500; line-height: 1.2; background: rgba(0,0,0,0.4); padding: 6px 16px; border-radius: 8px; max-width: 280px; margin: 0 auto;"></div>
                    </div>
                    
                    <!-- Mini Player Button -->
                    <div onclick="minimizeToMiniPlayer()" style="width: 40px; height: 40px; border-radius: 8px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 4h4v4H6z"></path>
                            <path d="M14 4h4v4h-4z"></path>
                            <path d="M6 14h4v4H6z"></path>
                            <path d="M14 14h4v4h-4z"></path>
                        </svg>
                    </div>
                </div>
                
                <!-- Center Play/Pause Button -->
                <div class="center-controls" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; pointer-events: auto;">
                    <div id="centerPlayButton" onclick="togglePlayPause()" style="width: 80px; height: 80px; border-radius: 16px; background: rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s ease; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                        <svg id="centerPlayIcon" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="none">
                            <polygon points="8,5 19,12 8,19"></polygon>
                        </svg>
                    </div>
                </div>
                
                <!-- Bottom Controls Bar -->
                <div class="bottom-controls" style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 20px; pointer-events: auto;">
                    
                    <!-- Progress Bar -->
                    <div style="margin-bottom: 16px;">
                        <div class="progress-container" style="width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; position: relative; cursor: pointer;" onclick="seekToPosition(event)">
                            <div id="progressBar" style="height: 100%; background: #ff4444; border-radius: 2px; width: 0%; transition: width 0.1s linear;"></div>
                            <div id="progressHandle" style="position: absolute; top: 50%; right: 0; transform: translate(50%, -50%); width: 14px; height: 14px; background: #ff4444; border: 2px solid white; border-radius: 50%; opacity: 0; transition: opacity 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>
                        </div>
                    </div>
                    
                    <!-- Control Buttons Row -->
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <!-- Left Side - Time Display -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="currentTimeDisplay" style="color: white; font-size: 13px; font-weight: 500; font-family: 'SF Mono', Monaco, monospace;">0:00</span>
                            <span style="color: rgba(255,255,255,0.5); font-size: 13px;">/</span>
                            <span id="durationDisplay" style="color: rgba(255,255,255,0.7); font-size: 13px; font-family: 'SF Mono', Monaco, monospace;">0:00</span>
                        </div>
                        
                        <!-- Center - Playback Controls -->
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div onclick="seekBackward()" style="width: 36px; height: 36px; border-radius: 8px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'" title="Seek backward 10s">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="white" stroke="none">
                                    <polygon points="11,19 2,12 11,5"></polygon>
                                    <polygon points="22,19 13,12 22,5"></polygon>
                                </svg>
                            </div>
                            <div onclick="seekForward()" style="width: 36px; height: 36px; border-radius: 8px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'" title="Seek forward 10s">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="white" stroke="none">
                                    <polygon points="13,19 22,12 13,5"></polygon>
                                    <polygon points="2,19 11,12 2,5"></polygon>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Right Side - Settings -->
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div onclick="toggleMute()" style="width: 36px; height: 36px; border-radius: 8px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                                <svg id="volumeIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="11,5 6,9 2,9 2,15 6,15 11,19"></polygon>
                                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                </svg>
                            </div>
                            <div onclick="toggleFullscreen()" style="width: 36px; height: 36px; border-radius: 8px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="white" stroke="none">
                                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Removed intrusive tap areas - users can use the clean buttons instead -->
            </div>
        </div>
        
        <!-- Video Info -->
        <div class="video-detail-info" style="padding: 20px; background: var(--bg-primary);">
            <h1 id="detailVideoTitle" style="color: var(--text-primary); font-size: 20px; font-weight: 600; margin: 0 0 12px 0; line-height: 1.3;"></h1>
            
            <!-- Stats and Actions -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div id="detailVideoStats" style="color: var(--text-secondary); font-size: 14px;"></div>
                <div style="display: flex; gap: 16px;">
                    <button onclick="likeVideo()" style="background: var(--card-bg); border: 1px solid var(--border); color: var(--text-primary); display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 20px; cursor: pointer; transition: var(--transition);" onmouseover="this.style.background='var(--hover)'" onmouseout="this.style.background='var(--card-bg)'">
                        👍 <span id="likeCount">1.2K</span>
                    </button>
                    <button onclick="shareVideo()" style="background: var(--card-bg); border: 1px solid var(--border); color: var(--text-primary); display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 20px; cursor: pointer; transition: var(--transition);" onmouseover="this.style.background='var(--hover)'" onmouseout="this.style.background='var(--card-bg)'">
                        📤 Share
                    </button>
                </div>
            </div>
            
            <!-- Channel Info -->
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding: 16px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px;">
                <img id="detailChannelAvatar" src="" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
                <div style="flex: 1;">
                    <div id="detailChannelName" style="color: var(--text-primary); font-size: 16px; font-weight: 500; margin-bottom: 4px;"></div>
                    <div id="detailChannelSubs" style="color: var(--text-secondary); font-size: 12px;"></div>
                </div>
                <button onclick="subscribeChannel()" style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 500; cursor: pointer; transition: var(--transition);" onmouseover="this.style.background='#ff3333'" onmouseout="this.style.background='#ff4444'">Subscribe</button>
            </div>
            
            <!-- Description -->
            <div style="background: #1a1a1a; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                <div id="detailVideoDescription" style="color: #ccc; font-size: 14px; line-height: 1.6;"></div>
            </div>
            
            <div id="commentsSection" style="background: #111; border-radius: 12px; padding: 16px;">
                <h3 id="commentsHeader" style="color: white; margin: 0 0 16px 0; font-size: 16px;">Comments</h3>
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=40&h=40&fit=crop&crop=face" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                    <input id="commentInput" type="text" placeholder="Add a comment..." style="flex: 1; background: #222; border: 1px solid #333; border-radius: 20px; padding: 10px 16px; color: white;">
                    <button id="commentPostBtn" style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px;">Post</button>
                </div>
                <div id="commentsList"></div>
                </div>
                
            <div id="suggestedContainer" style="margin-top:20px; display:none;">
                <h3 style="color:white;margin:0 0 12px 0;font-size:16px;">Suggested videos</h3>
                <div id="suggestedList" style="display:grid;grid-template-columns:1fr;gap:12px;"></div>
                    </div>
                    
            <!-- Place comments above suggestions -->
            <!-- BEGIN_INLINE_MOVED
            try {
                const infoEl = document.querySelector('.video-detail-info');
                const commentsEl = document.getElementById('commentsSection');
                const suggEl = document.getElementById('suggestedContainer');
                if (infoEl && commentsEl) {
                    infoEl.appendChild(commentsEl);
                }
                if (suggEl) suggEl.style.display = 'block';
            } catch {}
            END_INLINE_MOVED -->

            <!-- BEGIN_INLINE_MOVED: comments and suggested logic
            window.__comments = window.__comments || {};
            const listEl = document.getElementById('commentsList');
            const headerEl = document.getElementById('commentsHeader');
            const postBtn = document.getElementById('commentPostBtn');
            const inputEl = document.getElementById('commentInput');
            if (!window.__comments[video.id]) {
                window.__comments[video.id] = [
                    { user: '@sarah_creates', text: 'This is amazing content! Keep it up! 🔥', ago: '2 hours ago', avatar: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=40&h=40&fit=crop&crop=face' },
                    { user: '@mike_dev', text: 'Really helpful tutorial, thanks for sharing!', ago: '5 hours ago', avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=40&h=40&fit=crop&crop=face' }
                ];
            }
            function renderComments() {
                const arr = window.__comments[video.id] || [];
                if (headerEl) headerEl.textContent = `Comments • ${arr.length}`;
                if (listEl) {
                    listEl.innerHTML = arr.map(c => `
                        <div style=\"display:flex; gap:12px; margin-bottom:16px;\">
                            <img src=\"${c.avatar}\" style=\"width:32px; height:32px; border-radius:50%; object-fit:cover;\">
                        <div>
                                <div style=\"color:white; font-size:13px; font-weight:500;\">${c.user}</div>
                                <div style=\"color:#ccc; font-size:14px; margin:4px 0;\">${c.text}</div>
                                <div style=\"color:#666; font-size:12px;\">${c.ago}</div>
                        </div>
                        </div>`).join('');
                }
            }
            renderComments();
            if (postBtn && inputEl) {
                postBtn.onclick = () => {
                    const text = (inputEl.value || '').trim();
                    if (!text) return;
                    (window.__comments[video.id] || []).unshift({ user: '@you', text, ago: 'just now', avatar: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=40&h=40&fit=crop&crop=face' });
                    inputEl.value = '';
                    renderComments();
                };
            }

            // Render suggested videos
            try {
                const list = document.getElementById('suggestedList');
                if (list) {
                    list.innerHTML = '';
                    let pool = (window.videoLibrary || []).filter(v => v.id !== video.id);
                    if (!pool.length) {
                        try {
                            document.querySelectorAll('#videoGrid .video-item').forEach((card, i) => {
                                if (i < 8) {
                                    const img = card.querySelector('img');
                                    const title = card.querySelector('h3');
                                    pool.push({ id: 'home-' + i, title: (title && title.textContent) || 'Video', thumbnail: (img && img.src) || '', views: 0, channel: { name: 'Creator' } });
                                }
                            });
                        } catch {}
                    }
                    pool.slice(0, 8).forEach(v => {
                        const row = document.createElement('div');
                        row.style.cssText = 'display:flex; gap:12px; cursor:pointer;';
                        row.onclick = () => openVideoDetail(v);
                        const thumb = v.thumbnailUrl || v.thumb || v.thumbnail || v.poster || v.image || 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&h=400&fit=crop';
                        row.innerHTML = `
                            <img src="${thumb}" alt="${v.title||''}" loading="lazy" style="width:160px; height:90px; object-fit:cover; border-radius:8px;" onerror="this.src='https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&h=400&fit=crop'">
                            <div style=\"flex:1; min-width:0;\">
                                <div style=\"color:#fff; font-size:14px; font-weight:600; line-height:1.3;\">${v.title || 'Untitled'}</div>
                                <div style=\"color:#aaa; font-size:12px; margin-top:4px;\">${(v.channel && v.channel.name) || v.creator || 'Creator'}</div>
                                <div style=\"color:#666; font-size:12px; margin-top:2px;\">${v.views || 0} views</div>
                            </div>`;
                        list.appendChild(row);
                    });
                }
            } catch {}
            END_INLINE_MOVED -->
        </div>
    </div>

    <!-- Mini Player (hidden by default) -->
    <div id="miniPlayer" style="display:none; position: fixed; right: 16px; bottom: 92px; width: 320px; max-width: 90vw; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 12px 30px rgba(0,0,0,0.35); z-index: 10050;">
        <video id="miniVideo" style="width: 100%; height: 100%; object-fit: contain; background: #000;" playsinline webkit-playsinline x5-playsinline></video>
        <!-- Mini controls -->
        <div style="position:absolute; left:0; right:0; bottom:0; padding:8px; display:flex; align-items:center; justify-content:space-between; background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);">
            <div style="display:flex; gap:8px;">
                <button id="miniPlayBtn" style="width:32px; height:32px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.1); color:#fff; display:flex; align-items:center; justify-content:center;">▶</button>
                <div id="miniTime" style="color:#fff; font-size:12px; font-family: 'SF Mono', Monaco, monospace; opacity:0.9;">0:00 / 0:00</div>
            </div>
            <div style="display:flex; gap:8px;">
                <button id="miniExpandBtn" style="width:32px; height:32px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.1); color:#fff; display:flex; align-items:center; justify-content:center;">⤢</button>
                <button id="miniCloseBtn" style="width:32px; height:32px; border-radius:8px; border:1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.1); color:#fff; display:flex; align-items:center; justify-content:center;">×</button>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="cameraInput" accept="image/*,video/*" capture="environment" style="display: none;" onchange="handleStoryUpload(this)">
    <input type="file" id="galleryInput" accept="image/*,video/*" style="display: none;" onchange="handleStoryUpload(this)">
    
    <!-- Custom Modal -->
    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <div id="modalIcon" class="modal-icon">ℹ️</div>
            <div id="modalTitle" class="modal-title">Information</div>
            <div id="modalMessage" class="modal-message">This is a custom modal message.</div>
            <button class="modal-button" onclick="closeCustomModal()">Got it!</button>
        </div>
    </div>
    
    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        .tab-content {
            display: none;
            min-height: calc(100vh - 112px);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .profile-item {
            padding: 16px;
            background: #1a1a1a;
            margin-bottom: 1px;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
        }
        
        .profile-item:hover {
            background: #2a2a2a;
        }
        
        .profile-item:first-child {
            border-radius: 12px 12px 0 0;
        }
        
        .profile-item:last-child {
            border-radius: 0 0 12px 12px;
        }
        
        /* Video Player Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .video-controls-overlay:hover .progress-container #progressHandle {
            opacity: 1 !important;
        }
        
        #centerPlayButton:hover {
            background: rgba(255,255,255,0.25) !important;
        }
        
        #centerPlayButton:active {
            background: rgba(255,255,255,0.2) !important;
        }
        
        /* COMPLETELY HIDE ALL NATIVE VIDEO CONTROLS */
        video {
            outline: none !important;
        }
        
        video::-webkit-media-controls {
            display: none !important;
            -webkit-appearance: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }
        
        video::-webkit-media-controls-panel {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-play-button {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-start-playback-button {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-timeline {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-current-time-display {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-time-remaining-display {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-mute-button {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-toggle-closed-captions-button {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-volume-slider {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-fullscreen-button {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-enclosure {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-overlay-play-button {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        video::-webkit-media-controls-overlay-enclosure {
            display: none !important;
            -webkit-appearance: none !important;
        }
        
        /* Firefox Controls */
        video::-moz-media-controls {
            display: none !important;
        }
        
        /* Microsoft Edge */
        video::-ms-media-controls {
            display: none !important;
        }
        
        /* Force hide any controls that might appear */
        #detailVideoPlayer {
            pointer-events: auto !important;
        }
        
        /* Accessibility Focus Indicators */
        *:focus { outline: 2px solid #ff4444; outline-offset: 2px; }
        
        button:focus,
        [onclick]:focus,
        .nav-item:focus,
        .story-item:focus {
            outline: 2px solid #ff4444;
            outline-offset: 2px;
        }
        
        /* Screen Reader Only Text */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Skip to Content Link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #ff4444;
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 100000;
            border-radius: 4px;
        }
        
        .skip-link:focus {
            top: 6px;
        }
        
        /* Custom Modal System */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1a1a;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        
        .modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: white;
        }
        
        .modal-message {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 24px;
            line-height: 1.5;
        }
        
        .modal-button {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .modal-button:hover {
            background: #ff3333;
        }
        
        #detailVideoPlayer::-webkit-media-controls,
        #detailVideoPlayer::-webkit-media-controls-panel,
        #detailVideoPlayer::-webkit-media-controls-play-button,
        #detailVideoPlayer::-webkit-media-controls-start-playback-button,
        #detailVideoPlayer::-webkit-media-controls-timeline,
        #detailVideoPlayer::-webkit-media-controls-current-time-display,
        #detailVideoPlayer::-webkit-media-controls-time-remaining-display,
        #detailVideoPlayer::-webkit-media-controls-mute-button,
        #detailVideoPlayer::-webkit-media-controls-toggle-closed-captions-button,
        #detailVideoPlayer::-webkit-media-controls-volume-slider,
        #detailVideoPlayer::-webkit-media-controls-fullscreen-button,
        #detailVideoPlayer::-webkit-media-controls-enclosure,
        #detailVideoPlayer::-webkit-media-controls-overlay-play-button,
        #detailVideoPlayer::-webkit-media-controls-overlay-enclosure {
            display: none !important;
            -webkit-appearance: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            width: 0 !important;
            height: 0 !important;
        }
    </style>

    <script>
        // Enhanced Movie Integration with Fallback Data - Load immediately
        document.addEventListener('DOMContentLoaded', async () => {
            // Load movies with fallback data
            loadFreeMovies();
            loadTrending('movie');
        });
    </script>
    <script>
        // Firebase configuration - LIVE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBXy89aYxkfImhy6LYiAP-84DoZHY87ITY",
            authDomain: "mychannel-ca26d.firebaseapp.com",
            projectId: "mychannel-ca26d",
            storageBucket: "mychannel-ca26d.firebasestorage.app",
            messagingSenderId: "124515086975",
            appId: "1:124515086975:ios:f3683f5fb93c02d2c3454a"
        };
        
        let auth, db, storage;
        
        async function initFirebase() {
            try {
                if (window.firebase && window.firebase.apps && window.firebase.apps.length) {
                    auth = firebase.auth();
                    db = firebase.firestore();
                    storage = firebase.storage();
                    return;
                }
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                try { await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); } catch {}
                auth = firebase.auth();
                try { await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); } catch {}
                db = firebase.firestore();
                storage = firebase.storage();
                
                // Wait for Firebase to be ready
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Firebase initialized successfully
                try {
                    if (!window.__authListenerBound) {
                        auth.onAuthStateChanged((user) => {
                            logAuth('onAuthStateChanged user=' + (user ? (user.uid || 'yes') : 'null'));
                            loadUserStories();
                            if (user && !user.isAnonymous) {
                                __redirectInProgress = false;
                                try { closeAuthModal(); } catch {}
                                const menu = document.getElementById('accountMenu');
                                if (menu) { menu.style.display = 'none'; }
                                const promo = document.getElementById('promoBanner');
                                if (promo) { promo.classList.add('hidden'); }
                                // Apply avatar immediately on login
                                try { applyAvatarToUI(user.photoURL); refreshStoriesForAvatar(); } catch {}
                            }
                            try { refreshAccountMenu(); } catch {}
                        });
                        window.__authListenerBound = true;
                    }
                } catch {}
            } catch (e) {
                console.error('Firebase init failed:', e?.message || e);
                throw e;
            }
        }

        let __redirectInProgress = false;

        async function ensureAuth() {
            await initFirebase();
            try {
                // Do not auto sign-in anonymously to avoid interfering with OAuth redirects
                return auth.currentUser || null;
            } catch (e) {
                console.warn('ensureAuth error', e);
                return auth.currentUser || null;
            }
        }

        async function loadCommunityPosts() {
            try {
                await initFirebase();
                const u = auth && auth.currentUser;
                const feed = document.getElementById('communityFeed');
                const input = document.getElementById('communityText');
                const btn = document.getElementById('communityPostBtn');
                if (btn && !btn.__bound) {
                    btn.__bound = true;
                    btn.addEventListener('click', async () => {
                        if (!u || u.isAnonymous) { alert('Sign in to post.'); return; }
                        const text = (input && input.value || '').trim();
                        if (!text) return;
                        await db.collection('community').add({ ownerId: u.uid, text, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                        input.value='';
                        loadCommunityPosts();
                    });
                }
                if (!feed) return;
                feed.innerHTML = '';
                if (!u || u.isAnonymous) return;
                const qs = await db.collection('community').where('ownerId','==',u.uid).orderBy('createdAt','desc').limit(50).get();
                qs.docs.forEach(d => {
                    const c = d.data();
                    const row = document.createElement('div');
                    row.style.cssText = 'background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;';
                    const ts = c.createdAt && c.createdAt.seconds ? new Date(c.createdAt.seconds*1000).toLocaleString() : '';
                    row.innerHTML = `<div style=\"font-size:12px;color:#999;\">${ts}</div><div style=\"margin-top:4px;\">${c.text||''}</div>`;
                    feed.appendChild(row);
                });
            } catch (e) { console.error('loadCommunityPosts failed', e); }
        }

        async function loadAboutAndHistory() {
            try {
                await initFirebase();
                const u = auth && auth.currentUser; if (!u || u.isAnonymous) return;
                const userSnap = await db.collection('users').doc(u.uid).get();
                const d = userSnap.exists ? userSnap.data() : {};
                const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = String(val ?? 0); };
                setText('aboutSubs', d.subscribers || 0);
                setText('aboutVids', d.videos || 0);
                setText('aboutViews', d.views || 0);
                const joined = u.metadata && u.metadata.creationTime ? new Date(u.metadata.creationTime).toLocaleDateString() : '—';
                const jEl = document.getElementById('aboutJoined'); if (jEl) jEl.textContent = joined;
                // History moved to persistent section below profile tabs
                const grid = document.getElementById('historyGrid');
                if (grid) {
                    grid.innerHTML='';
                    const qs = await db.collection('history').where('ownerId','==',u.uid).orderBy('ts','desc').limit(9).get();
                    qs.docs.forEach(d => {
                        const h = d.data();
                        const cell = document.createElement('div');
                        cell.style.cssText='background:#1a1a1a;border-radius:8px;overflow:hidden;height:90px;';
                        cell.innerHTML = `<img src=\"${h.thumbnailUrl||'/api/placeholder/160/90'}\" style=\"width:100%;height:100%;object-fit:cover;\">`;
                        grid.appendChild(cell);
                    });
                }
            } catch (e) { console.error('loadAboutAndHistory failed', e); }
        }

        function isSignedInNonAnonymous() {
            try { return !!(auth && auth.currentUser && !auth.currentUser.isAnonymous); } catch { return false; }
        }
        
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-content').classList.add('active');
            
            // Activate corresponding nav item
            event.target.closest('.nav-item').classList.add('active');

            // Toggle profile-only history section
            try {
                const hist = document.getElementById('profile-history-persistent');
                if (hist) hist.style.display = (tabName === 'profile') ? 'block' : 'none';
            } catch {}
        }

        // Account menu toggle
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('accountButton');
            const menu = document.getElementById('accountMenu');
            if (btn && menu) {
                btn.addEventListener('click', async () => {
                    await ensureAuth();
                    refreshAccountMenu();
                    menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
                });
                document.addEventListener('click', (e) => {
                    if (!menu.contains(e.target) && e.target !== btn) menu.style.display = 'none';
                });
            }
        });

        async function refreshAccountMenu() {
            await initFirebase();
            const user = auth.currentUser;
            const nameEl = document.getElementById('accountName');
            const emailEl = document.getElementById('accountEmail');
            const so = document.getElementById('menuSignedOut');
            const si = document.getElementById('menuSignedIn');
            if (user && !user.isAnonymous) {
                nameEl.textContent = user.displayName || 'MyChannel User';
                emailEl.textContent = user.email || '';
                so.style.display = 'none';
                si.style.display = 'block';
                // Update avatar initial
                const btn = document.getElementById('accountButton');
                btn.textContent = (user.displayName || user.email || 'U')[0].toUpperCase();
            } else {
                nameEl.textContent = 'Guest';
                emailEl.textContent = 'Not signed in';
                so.style.display = 'block';
                si.style.display = 'none';
                document.getElementById('accountButton').textContent = 'K';
            }
        }

        function openAuthModal(mode) {
            const modal = document.getElementById('authModal');
            const title = document.getElementById('authTitle');
            const name = document.getElementById('authName');
            const helper = document.getElementById('authHelper');
            modal.style.display = 'flex';
            if (mode === 'signup') {
                title.textContent = 'Create account';
                name.style.display = 'block';
                helper.innerHTML = 'We\'ll email a verification link.';
                modal.dataset.mode = 'signup';
            } else {
                title.textContent = 'Sign in';
                name.style.display = 'none';
                helper.textContent = '';
                modal.dataset.mode = 'signin';
            }
            const appleBtn = document.getElementById('appleAuthBtn');
            if (appleBtn) { appleBtn.style.display = 'flex'; }
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        async function submitAuth() {
            await initFirebase();
            const mode = document.getElementById('authModal').dataset.mode || 'signin';
            const name = document.getElementById('authName').value.trim();
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            try {
                if (mode === 'signup') {
                    const cred = await auth.createUserWithEmailAndPassword(email, password);
                    await cred.user.updateProfile({ displayName: name });
                    await cred.user.sendEmailVerification();
                    await db.collection('users').doc(cred.user.uid).set({
                        displayName: name,
                        email,
                        createdAt: new Date()
                    });
                    closeAuthModal();
                    refreshAccountMenu();
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                    closeAuthModal();
                    refreshAccountMenu();
                }
            } catch (e) {
                alert(e?.message || 'Authentication failed');
            }
        }

        async function signOutUser() {
            await initFirebase();
            await auth.signOut();
            refreshAccountMenu();
        }

        function switchProfile() {
            openAuthModal('signin');
        }

        // Studio
        async function openStudio() {
            await initFirebase();
            document.getElementById('studioModal').style.display = 'flex';
            // Pull quick stats
            try {
                const now = new Date();
                const since = new Date(now.getTime() - 24*60*60*1000);
                const stories24 = await db.collection('stories').where('createdAt','>', since).get();
                document.getElementById('studioStories').textContent = stories24.size.toLocaleString();
                let commentsCount = 0; let likesCount = 0;
                // For each story, aggregate comments and likes sizes (lightweight for demo)
                const promises = stories24.docs.slice(0,50).map(async d => {
                    const c = await db.collection('stories').doc(d.id).collection('comments').where('createdAt','>', since).get();
                    commentsCount += c.size;
                    const likes = d.data().likes || [];
                    likesCount += Array.isArray(likes) ? likes.length : 0;
                });
                await Promise.all(promises);
                document.getElementById('studioComments').textContent = commentsCount.toLocaleString();
                document.getElementById('studioLikes').textContent = likesCount.toLocaleString();
                // Active users (approx): unique userIds in 24h stories + commenters
                const userSet = new Set(stories24.docs.map(d=>d.data().userId));
                document.getElementById('studioActiveUsers').textContent = userSet.size.toLocaleString();
            } catch (e) {
                console.warn('Studio stats error', e);
            }
        }
        function closeStudio(){ document.getElementById('studioModal').style.display='none'; }

        // Edit profile flows
        async function openEditProfile() {
            await ensureAuth();
            const modal = document.getElementById('editProfileModal');
            const user = auth.currentUser;
            document.getElementById('profileDisplayName').value = user?.displayName || '';
            // Load existing profile doc for bio/banner
            try {
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists) {
                    const d = doc.data();
                    document.getElementById('profileBio').value = d.bio || '';
                    if (d.bannerUrl) {
                        document.getElementById('profileBannerVideoEl').src = d.bannerUrl;
                    }
                    if (d.avatarUrl) {
                        document.getElementById('profileAvatarEl').style.background = `url('${d.avatarUrl}') center/cover`;
                        try { applyAvatarToUI(d.avatarUrl); refreshStoriesForAvatar(); } catch {}
                    } else {
                        document.getElementById('profileAvatarEl').style.background = '#2a2a2a';
                    }
                    if (d.displayName) {
                        document.getElementById('profileDisplayNameEl').textContent = d.displayName;
                        const handle = (auth.currentUser?.email || 'user').split('@')[0];
                        document.getElementById('profileHandleEl').textContent = '@' + handle;
                    }
                    if (d.bio) {
                        document.getElementById('profileBioEl').textContent = d.bio;
                    }
                }
            } catch {}
            modal.style.display = 'flex';
        }

        function closeEditProfile() {
            document.getElementById('editProfileModal').style.display = 'none';
        }

        // Gating Profile actions for guests
        async function gateProfileForAuth() {
            try {
                await initFirebase();
                const user = auth.currentUser;
                const isGuest = !user || user.isAnonymous;
                const editBtn = document.getElementById('editProfileBtn');
                const settingsBtn = document.getElementById('profileSettingsBtn');
                if (isGuest) {
                    if (editBtn) { editBtn.textContent = 'Create account to edit'; editBtn.onclick = () => openAuthModal('signup'); }
                    if (settingsBtn) { settingsBtn.style.display = 'none'; }
                }
            } catch {}
        }

        async function saveProfile() {
            await ensureAuth();
            const user = auth.currentUser;
            const name = document.getElementById('profileDisplayName').value.trim();
            const bio = document.getElementById('profileBio').value.trim();
            const bannerFile = document.getElementById('profileBannerVideo').files[0];
            const avatarFile = document.getElementById('profileAvatar').files[0];
            let bannerUrl, avatarUrl;
            try {
                if (name && name !== user.displayName) {
                    await user.updateProfile({ displayName: name });
                }
                if (bannerFile) {
                    const ref = storage.ref().child(`profiles/${user.uid}/banner_${Date.now()}`);
                    await ref.put(bannerFile);
                    bannerUrl = await ref.getDownloadURL();
                    document.getElementById('profileBannerVideoEl').src = bannerUrl;
                }
                if (avatarFile) {
                    const refA = storage.ref().child(`profiles/${user.uid}/avatar_${Date.now()}`);
                    await refA.put(avatarFile);
                    avatarUrl = await refA.getDownloadURL();
                }
                await db.collection('users').doc(user.uid).set({
                    displayName: name || user.displayName || '',
                    bio,
                    bannerUrl: bannerUrl || firebase.firestore.FieldValue.delete(),
                    avatarUrl: avatarUrl || firebase.firestore.FieldValue.delete(),
                    updatedAt: new Date()
                }, { merge: true });
                // Reflect immediately
                if (name) document.getElementById('profileDisplayNameEl').textContent = name;
                if (bio) document.getElementById('profileBioEl').textContent = bio;
                if (avatarUrl) document.getElementById('profileAvatarEl').style.background = `url('${avatarUrl}') center/cover`;
                closeEditProfile();
            } catch (e) {
                alert(e?.message || 'Failed to save profile');
            }
        }
        
        // Custom Modal System
        function showCustomModal(title, message, icon = 'ℹ️') {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalIcon').textContent = icon;
            document.getElementById('customModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeCustomModal() {
            document.getElementById('customModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.id === 'customModal') {
                closeCustomModal();
            }
        });
        
        function showSignIn() {
            showCustomModal('Coming Soon!', 'Sign In feature is being developed and will be available soon!', '🚀');
        }
        
        function showSettings() { openStudio(); }
        
        function showHistory() {
            // History UI is only on Profile tab now
            showProfileTab('about');
        }
        
        function showLiked() {
            showCustomModal('Liked Videos', 'Liked Videos collection is coming soon!', '👍');
        }
        
        function showSignOut() {
            showCustomModal('Sign Out', 'Sign Out functionality is being implemented!', '🚪');
        }
        
        function performSearch(query) {
            const resultsDiv = document.getElementById('search-results');
            if (query.trim() === '') {
                resultsDiv.innerHTML = `
                    <h3 style="color: #666; text-align: center; margin-top: 60px;">Search for videos, channels, and more</h3>
                    <div class="search-suggestions" style="margin-top: 40px;">
                        <h4 style="color: #ff4444; margin-bottom: 16px;">Trending Searches</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('gaming')">gaming</span>
                            <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('music')">music</span>
                            <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('tutorial')">tutorial</span>
                            <span class="search-tag" style="background: #1a1a1a; color: #ccc; padding: 8px 12px; border-radius: 16px; font-size: 14px; cursor: pointer;" onclick="searchFor('comedy')">comedy</span>
                        </div>
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `
                    <h3 style="color: #ff4444; margin-bottom: 16px;">Search Results for "${query}"</h3>
                    <p style="color: #666; text-align: center; margin-top: 40px;">No results found. Try a different search term.</p>
                `;
            }
        }
        
        function searchFor(term) {
            document.querySelector('#search-content input').value = term;
            performSearch(term);
        }
        
        function showProfileTab(tabName) {
            // Hide all profile tab contents
            document.querySelectorAll('.profile-tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.style.color = '#666';
                tab.style.borderBottom = '2px solid transparent';
            });
            
            // Show selected tab content
            document.getElementById('profile-' + tabName + '-tab').style.display = 'block';
            document.getElementById('profile-' + tabName + '-tab').classList.add('active');
            
            // Activate selected tab
            event.target.style.color = '#ff4444';
            event.target.style.borderBottom = '2px solid #ff4444';

            // Lazy-load data for tabs
            if (tabName === 'community') { try { loadCommunityPosts(); } catch {} }
            if (tabName === 'about') { try { loadAboutAndHistory(); } catch {} }
            if (tabName === 'flicks') { try { loadFlicksTab(); } catch {} }

            // Only show history section on profile view
            try {
                const hist = document.getElementById('profile-history-persistent');
                if (hist) hist.style.display = 'block';
            } catch {}
        }
        
        // Story Data
        const stories = [
            {
                username: 'sarah',
                avatar: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=100&h=100&fit=crop&crop=face',
                content: [
                    { type: 'image', url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=600&h=800&fit=crop', time: '2h' },
                    { type: 'image', url: 'https://images.unsplash.com/photo-1519904981063-b0cf448d479e?w=600&h=800&fit=crop', time: '1h' }
                ]
            },
            {
                username: 'mike',
                avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&h=100&fit=crop&crop=face',
                content: [
                    { type: 'image', url: 'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=600&h=800&fit=crop', time: '3h' }
                ]
            },
            {
                username: 'alex',
                avatar: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100&h=100&fit=crop&crop=face',
                content: [
                    { type: 'image', url: 'https://images.unsplash.com/photo-1426604966848-d7adac402bff?w=600&h=800&fit=crop', time: '4h' },
                    { type: 'image', url: 'https://images.unsplash.com/photo-1464822759844-d150baec93c5?w=600&h=800&fit=crop', time: '3h' }
                ]
            },
            {
                username: 'emma',
                avatar: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=100&h=100&fit=crop&crop=face',
                content: [
                    { type: 'image', url: 'https://images.unsplash.com/photo-1611095973362-87fa4ac9b4e1?w=600&h=800&fit=crop', time: '5h' }
                ]
            }
        ];
        
        let currentStoryIndex = 0;
        let currentStoryItemIndex = 0;
        let storyProgressInterval;
        
        // Story Functions
        async function addStory() {
            try { await initFirebase(); } catch {}
            // Remove any prior hidden pickers to avoid iOS sheet reappearing
            document.querySelectorAll('#tempStoryPicker').forEach(el => el.remove());
            if (!isSignedInNonAnonymous()) {
                openAuthModal('signin');
                return;
            }
            // Use native picker for a faster UX
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*';
            input.multiple = true;
            input.id = 'tempStoryPicker';
            input.onchange = async (e) => {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;
                await ensureAuth();
                await uploadStoriesFromFiles(files);
                await loadUserStories();
                input.remove();
            };
            input.click();
        }
        
        function closeAddStoryModal() {}
        
        function openCamera() {}
        
        function openGallery() {}
        
        async function handleStoryUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            try {
                // Show loading
                showStoryUploadProgress();
                
                // Initialize Firebase
                await initFirebase();
                
                // For demo purposes, create a local URL and mock save to database
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        updateStoryUploadProgress(50);
                        
                        // Create story data with local URL for demo
                        const storyData = {
                            userId: 'keonta',
                            username: 'Keonta Peat',
                            avatar: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop&crop=face',
                            mediaUrl: e.target.result, // Local data URL for demo
                            mediaType: file.type.startsWith('video/') ? 'video' : 'image',
                            timestamp: new Date(),
                            expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000),
                            views: 0,
                            likes: []
                        };
                        
                        updateStoryUploadProgress(75);
                        
                        // Add to local stories array for immediate viewing
                        let userStory = firebaseStories.find(s => s.userId === 'keonta');
                        if (!userStory) {
                            userStory = {
                                userId: 'keonta',
                                username: 'Keonta Peat',
                                avatar: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop&crop=face',
                                content: []
                            };
                            firebaseStories.unshift(userStory);
                        }
                        
                        userStory.content.unshift({
                            id: 'story_' + Date.now(),
                            type: storyData.mediaType,
                            url: storyData.mediaUrl,
                            time: 'now',
                            views: 0,
                            likes: []
                        });
                        
                        console.log('Story added to firebaseStories:', firebaseStories);
                        
                        updateStoryUploadProgress(100);
                        
                        // Update UI
                        updateStoriesUI();
                        
                        hideStoryUploadProgress();
                        showSuccessMessage('Story posted! 🔥');
                        
                        // Reset input
                        input.value = '';
                        
                    } catch (error) {
                        console.error('Error processing story:', error);
                        hideStoryUploadProgress();
                        showCustomModal('Upload Error', 'Error uploading story. Please try again.', '❌');
                    }
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('Error uploading story:', error);
                hideStoryUploadProgress();
                showCustomModal('Upload Error', 'Error uploading story. Please try again.', '❌');
            }
        }

        // New: upload multiple files to Storage and create Firestore story
        async function uploadStoriesFromFiles(files) {
            await ensureAuth();
            await initFirebase();
            try {
                showStoryUploadProgress();
                const user = auth.currentUser;
                const uploads = [];
                let completed = 0;
                for (const f of files) {
                    const id = `${user.uid}_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
                    const ref = storage.ref().child(`stories/${user.uid}/${id}`);
                    await ref.put(f);
                    const url = await ref.getDownloadURL();
                    uploads.push({ type: f.type.startsWith('video') ? 'video' : 'image', url });
                    completed += 1;
                    updateStoryUploadProgress((completed/files.length)*80);
                }
                const now = new Date();
                const expiresAt = new Date(now.getTime()+24*60*60*1000);
                await db.collection('stories').add({
                    userId: user.uid,
                    username: user.displayName || 'You',
                    avatar: 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG',
                    items: uploads,
                    createdAt: now,
                    timestamp: now,
                    expiresAt,
                    views: 0,
                    likes: [],
                });
                updateStoryUploadProgress(100);
                hideStoryUploadProgress();
                await loadUserStories();
            } catch (e) {
                console.error('uploadStoriesFromFiles failed', e);
                hideStoryUploadProgress();
            }
        }
        
        function viewStory(username, storyIndex) {
            currentStoryIndex = storyIndex;
            currentStoryItemIndex = 0;
            
            const story = stories[storyIndex];
            if (!story) return;
            
            document.getElementById('storyViewer').style.display = 'block';
            document.getElementById('storyUsername').textContent = story.username;
            document.getElementById('storyUserAvatar').src = story.avatar;
            
            showStoryItem();
            startStoryProgress();
            attachStoryRealtime();
        }
        
        function showStoryItem() {
            const story = stories[currentStoryIndex];
            const item = story.content[currentStoryItemIndex];
            
            document.getElementById('storyTime').textContent = item.time + ' ago';
            
            const image = document.getElementById('storyImage');
            const video = document.getElementById('storyVideo');
            
            if (item.type === 'image') {
                image.src = item.url;
                image.style.display = 'block';
                video.style.display = 'none';
            } else if (item.type === 'video') {
                video.src = item.url;
                video.style.display = 'block';
                image.style.display = 'none';
            }
        }
        
        function startStoryProgress() {
            clearInterval(storyProgressInterval);
            const progressBar = document.querySelector('.progress-fill');
            let progress = 0;
            
            storyProgressInterval = setInterval(() => {
                progress += 0.5;
                progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    nextStory();
                }
            }, 30); // 6 seconds total (100 / 0.5 * 30ms)
        }
        
        function nextStory() {
            const story = stories[currentStoryIndex];
            
            if (currentStoryItemIndex < story.content.length - 1) {
                currentStoryItemIndex++;
                showStoryItem();
                startStoryProgress();
            } else if (currentStoryIndex < stories.length - 1) {
                currentStoryIndex++;
                currentStoryItemIndex = 0;
                viewStory(stories[currentStoryIndex].username, currentStoryIndex);
            } else {
                closeStoryViewer();
            }
        }
        
        function previousStory() {
            if (currentStoryItemIndex > 0) {
                currentStoryItemIndex--;
                showStoryItem();
                startStoryProgress();
            } else if (currentStoryIndex > 0) {
                currentStoryIndex--;
                const prevStory = stories[currentStoryIndex];
                currentStoryItemIndex = prevStory.content.length - 1;
                viewStory(prevStory.username, currentStoryIndex);
            }
        }
        
        function closeStoryViewer() {
            document.getElementById('storyViewer').style.display = 'none';
            clearInterval(storyProgressInterval);
            
            // Reset progress bar
            const progressBar = document.querySelector('.progress-fill');
            if (progressBar) {
                progressBar.style.width = '0%';
            }
            
            // Clear video if playing
            const video = document.getElementById('storyVideo');
            if (video) {
                video.pause();
                video.currentTime = 0;
            }
            
            showNotification('Story closed', 'info');
        }

        // Enhanced keyboard support for stories
        function initStoryKeyboardSupport() {
            document.addEventListener('keydown', (e) => {
                const storyViewer = document.getElementById('storyViewer');
                if (storyViewer.style.display === 'block') {
                    switch (e.key) {
                        case 'Escape':
                            e.preventDefault();
                            closeStoryViewer();
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            previousStory();
                            break;
                        case 'ArrowRight':
                        case ' ':
                            e.preventDefault();
                            nextStory();
                            break;
                    }
                }
            });
        }
        
        // Firebase Integration Functions
        let firebaseStories = [];
        const STORIES_CACHE_KEY = 'mc_stories_cache_v1';
        const STORIES_CACHE_TTL_MS = 15 * 60 * 1000; // 15 minutes

        function getCachedStories() {
            try {
                const raw = localStorage.getItem(STORIES_CACHE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                if (!parsed || !Array.isArray(parsed.data)) return null;
                if (Date.now() - (parsed.ts || 0) > STORIES_CACHE_TTL_MS) return null;
                return parsed.data;
            } catch (e) { return null; }
        }

        function setCachedStories(data) {
            try {
                localStorage.setItem(STORIES_CACHE_KEY, JSON.stringify({ ts: Date.now(), data }));
            } catch (e) { /* ignore quota/private mode errors */ }
        }

        function primeStoriesFromCache() {
            const cached = getCachedStories();
            if (cached && cached.length) {
                firebaseStories = cached;
                try { updateStoriesUI(); } catch (e) { console.log('prime cache render failed', e); }
            }
        }

        function buildMockStoriesFromAssets() {
            return [
                {
                    userId: 'luh_monti45',
                    username: 'luh_monti45',
                    avatar: 'assets/472855250_1416699136402148_2912796090052603733_n.imageset/472855250_1416699136402148_2912796090052603733_n.jpg',
                    content: [ { id: 'm1', type: 'image', url: 'assets/470923123_18158490016332148_6477017450217403765_n.imageset/470923123_18158490016332148_6477017450217403765_n.jpg', time: '2h' } ]
                },
                {
                    userId: 'geefrm2800',
                    username: 'geefrm2800',
                    avatar: 'assets/475835447_675201954830347_1756031358478369730_n.imageset/475835447_675201954830347_1756031358478369730_n.jpg',
                    content: [ { id: 'm2', type: 'image', url: 'assets/466399531_2282738375443632_7939875496433451873_n.imageset/466399531_2282738375443632_7939875496433451873_n.jpg', time: '3h' } ]
                },
                {
                    userId: 'reformedscumbag',
                    username: 'reformedscumbag',
                    avatar: 'assets/481160706_665641712649483_7487614386252000095_n.imageset/481160706_665641712649483_7487614386252000095_n.jpg',
                    content: [ { id: 'm3', type: 'image', url: 'assets/481384467_18341497597158210_3083149182286552212_n.imageset/481384467_18341497597158210_3083149182286552212_n.jpg', time: '4h' } ]
                },
                {
                    userId: 'rmc__mike',
                    username: 'rmc__mike',
                    avatar: 'assets/334320756_533260078924966_5316833915723430997_n.imageset/334320756_533260078924966_5316833915723430997_n.jpg',
                    content: [ { id: 'm4', type: 'image', url: 'assets/472392893_18252867850302322_7284995541774475779_n.imageset/472392893_18252867850302322_7284995541774475779_n.jpg', time: '5h' } ]
                },
                {
                    userId: 'bighornetpro',
                    username: 'bighornetpro',
                    avatar: 'assets/426685704_792648982704647_967197470146596162_n.imageset/426685704_792648982704647_967197470146596162_n.jpg',
                    content: [ { id: 'm5', type: 'image', url: 'assets/129075787_113795503889280_2510749229606017551_n.imageset/129075787_113795503889280_2510749229606017551_n.jpg', time: '6h' } ]
                },
                {
                    userId: '3200tre',
                    username: '3200tre',
                    avatar: 'assets/462248242_560040823136600_3556568014350287952_n.imageset/462248242_560040823136600_3556568014350287952_n.jpg',
                    content: [ { id: 'm6', type: 'image', url: 'assets/475362444_18498481846042375_7590792999184552048_n.imageset/475362444_18498481846042375_7590792999184552048_n.jpg', time: '7h' } ]
                },
                {
                    userId: 'freeemweemseeemleaveem',
                    username: 'freeemweemseeemleaveem',
                    avatar: 'assets/457371595_1235198240853217_1778504049849463165_n.imageset/457371595_1235198240853217_1778504049849463165_n.jpg',
                    content: [ { id: 'm7', type: 'image', url: 'assets/465660700_1797636381041731_4081532569943287856_n.imageset/465660700_1797636381041731_4081532569943287856_n.jpg', time: '8h' } ]
                },
                {
                    userId: 'scatzripky6',
                    username: 'scatzripky6',
                    avatar: 'assets/481403833_944554144430511_4402918744878259452_n.imageset/481403833_944554144430511_4402918744878259452_n.jpg',
                    content: [ { id: 'm8', type: 'image', url: 'assets/469432783_1093903885799534_1724252623959748153_n.imageset/469432783_1093903885799534_1724252623959748153_n.jpg', time: '9h' } ]
                }
            ];
        }
        
        async function loadUserStories() {
            try {
                if (!window.firebase || !window.firebase.apps.length) {
                    await initFirebase();
                }
                const isGuest = !(auth && auth.currentUser) || !!(auth && auth.currentUser && auth.currentUser.isAnonymous);
                if (isGuest) {
                    firebaseStories = buildMockStoriesFromAssets();
                    updateStoriesUI();
                    setCachedStories(firebaseStories);
                    return;
                }
                
                const db = firebase.firestore();
                const now = new Date();
                
                // Get stories from last 24 hours
                const storiesSnapshot = await db.collection('stories')
                    .where('expiresAt', '>', now)
                    .orderBy('expiresAt')
                    .get();
                
                // Group stories by user
                const userStories = {};
                storiesSnapshot.forEach(doc => {
                    const story = { id: doc.id, ...doc.data() };
                    const userId = story.userId;
                    
                    if (!userStories[userId]) {
                        userStories[userId] = {
                            username: story.username,
                            avatar: story.avatar,
                            content: []
                        };
                    }
                    
                    const items = Array.isArray(story.items) && story.items.length ? story.items : [{ type:story.mediaType, url:story.mediaUrl }];
                    items.forEach((it, idx) => {
                    userStories[userId].content.push({
                            id: `${story.id}_${idx}`,
                            type: it.type,
                            url: it.url,
                            time: formatTimeAgo(story.createdAt?.toDate?.() || new Date()),
                        views: story.views || 0,
                        likes: story.likes || []
                        });
                    });
                });
                
                // Update global stories array; seed mocks if none
                const keys = Object.keys(userStories);
                firebaseStories = keys.length > 0 ? keys.map(userId => ({ userId, ...userStories[userId] })) : buildMockStoriesFromAssets();
                
                // Update UI
                updateStoriesUI();
                // Persist cache for fast boot next time
                setCachedStories(firebaseStories);
                
            } catch (error) {
                console.error('Error loading stories:', error);
                // Fallback to mock data
                firebaseStories = stories;
                updateStoriesUI();
            }
        }
        
        async function updateStoriesUI() {
            const storiesContainer = document.querySelector('.stories-container');
            if (!storiesContainer) {
                console.log('Stories container not found');
                return;
            }
            
            console.log('Updating stories UI with:', firebaseStories);
            
            // Clear all stories
            storiesContainer.innerHTML = '';
            
            // Add "Your Story" button - check if user has stories
            const currentUserId = (auth && auth.currentUser && auth.currentUser.uid) || '__guest__';
            const userHasStories = firebaseStories.find(s => s.userId === currentUserId);
            console.log('User has stories:', userHasStories);
            
            const addStoryElement = document.createElement('div');
            addStoryElement.className = 'story-item';
            const handleAddStoryTap = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (!isSignedInNonAnonymous()) {
                    openAuthModal('signin');
                    return false;
                }
                if (userHasStories && userHasStories.content.length > 0) {
                    const userIndex = firebaseStories.findIndex(s => s.userId === currentUserId);
                    viewStory('You', userIndex);
                } else {
                    addStory();
                }
                return false;
            };
            addStoryElement.onclick = handleAddStoryTap;
            addStoryElement.addEventListener('touchstart', handleAddStoryTap, { passive: false });
            
            if (userHasStories) {
                addStoryElement.innerHTML = `
                    <div class="story-ring active-story">
                        <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop&crop=face" alt="Your Story">
                    </div>
                    <span>Your Story</span>
                `;
            } else {
                addStoryElement.innerHTML = `
                    <div class="story-ring add-story">
                        <div class="add-story-plus">+</div>
                    </div>
                    <span>Your Story</span>
                `;
            }
            
            storiesContainer.appendChild(addStoryElement);

            // Ensure your story tile (if exists) shows avatar
            if (auth && auth.currentUser) {
                try {
                    const dbLocal = (typeof firebase !== 'undefined' && firebase.firestore) ? firebase.firestore() : null;
                    if (dbLocal) {
                        const doc = await dbLocal.collection('users').doc(auth.currentUser.uid).get();
                        const avatarUrl = doc.exists && doc.data().avatarUrl;
                        const imgEl = addStoryElement.querySelector('div.story-ring.active-story img');
                        if (avatarUrl && imgEl) {
                            imgEl.src = avatarUrl;
                        }
                    }
                } catch (e) { console.warn('avatar fetch skipped', e?.message); }
            }
            
            // Add other users' stories
            firebaseStories.filter(s => s.userId !== currentUserId).forEach((story, index) => {
                const storyElement = document.createElement('div');
                storyElement.className = 'story-item';
                const actualIndex = firebaseStories.findIndex(s => s.userId === story.userId);
                storyElement.onclick = () => viewStory(story.username, actualIndex);
                
                storyElement.innerHTML = `
                    <div class="story-ring active-story">
                        <img src="${story.avatar}" alt="Story">
                    </div>
                    <span>${story.username}</span>
                `;
                
                storiesContainer.appendChild(storyElement);
            });
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor(diffMs / (1000 * 60));
            
            if (diffHours > 0) return diffHours + 'h';
            if (diffMins > 0) return diffMins + 'm';
            return 'now';
        }
        
        // Updated viewStory to use Firebase stories
        function viewStory(username, storyIndex) {
            console.log('viewStory called:', username, storyIndex, firebaseStories);
            currentStoryIndex = storyIndex;
            currentStoryItemIndex = 0;
            
            const story = firebaseStories[storyIndex] || stories[storyIndex];
            console.log('Selected story:', story);
            
            if (!story || !story.content || story.content.length === 0) {
                console.log('No story content found');
                return;
            }
            
            document.getElementById('storyViewer').style.display = 'block';
            document.getElementById('storyUsername').textContent = story.username;
            document.getElementById('storyUserAvatar').src = story.avatar;
            
            showStoryItem();
            startStoryProgress();
        }
        
        function showStoryItem() {
            const story = firebaseStories[currentStoryIndex] || stories[currentStoryIndex];
            const item = story.content[currentStoryItemIndex];
            
            console.log('showStoryItem:', story, item);
            
            document.getElementById('storyTime').textContent = item.time + ' ago';
            
            const image = document.getElementById('storyImage');
            const video = document.getElementById('storyVideo');
            
            // Reset both elements
            image.style.display = 'none';
            video.style.display = 'none';
            image.src = '';
            video.src = '';
            
            if (item.type === 'image' || (item.type && item.type.startsWith('image/'))) {
                console.log('Showing image:', item.url);
                image.src = item.url;
                image.style.display = 'block';
                image.onload = () => console.log('Image loaded successfully');
                image.onerror = (e) => console.error('Image failed to load:', e);
            } else if (item.type === 'video' || (item.type && item.type.startsWith('video/'))) {
                console.log('Showing video:', item.url);
                video.src = item.url;
                video.style.display = 'block';
                video.onloadeddata = () => console.log('Video loaded successfully');
                video.onerror = (e) => console.error('Video failed to load:', e);
            }
        }

        // Realtime likes/comments for current story
        let commentsUnsub = null;
        async function attachStoryRealtime() {
            if (commentsUnsub) commentsUnsub();
            await initFirebase();
            const storyOwner = firebaseStories[currentStoryIndex];
            const item = storyOwner?.content?.[currentStoryItemIndex];
            if (!storyOwner || !item) return;
            const storyDoc = await db.collection('stories').where('userId','==',storyOwner.userId).limit(1).get();
            if (storyDoc.empty) return;
            const docId = storyDoc.docs[0].id;
            commentsUnsub = db.collection('stories').doc(docId).collection('comments')
                .orderBy('createdAt','desc').limit(25)
                .onSnapshot(snap => {
                    const list = document.getElementById('storyComments');
                    if (!list) return;
                    list.innerHTML='';
                    snap.forEach(d => {
                        const c = d.data();
                        const el = document.createElement('div');
                        el.style.cssText = 'display:flex; gap:8px; align-items:center; color:#fff;';
                        el.innerHTML = `<div style="width:24px;height:24px;border-radius:50%;background:rgba(255,255,255,0.2);"></div>
                                         <div style="font-size:13px;opacity:0.9;">${(c.userName||'User')}: ${c.text}</div>`;
                        list.appendChild(el);
                    });
                });
        }

        // Like + Comment actions
        document.addEventListener('click', async (e) => {
            if (e.target && e.target.id === 'storySendBtn') {
                const input = document.getElementById('storyCommentInput');
                const text = input.value.trim();
                if (!text) return;
                await ensureAuth(); await initFirebase();
                const storyOwner = firebaseStories[currentStoryIndex];
                const q = await db.collection('stories').where('userId','==',storyOwner.userId).limit(1).get();
                if (!q.empty) {
                    await db.collection('stories').doc(q.docs[0].id).collection('comments').add({
                        userId: auth.currentUser.uid,
                        userName: auth.currentUser.displayName || 'User',
                        text,
                        createdAt: new Date()
                    });
                }
                input.value='';
            }
            if (e.target && e.target.id === 'storyLikeBtn') {
                await ensureAuth(); await initFirebase();
                const storyOwner = firebaseStories[currentStoryIndex];
                const q = await db.collection('stories').where('userId','==',storyOwner.userId).limit(1).get();
                if (!q.empty) {
                    const ref = db.collection('stories').doc(q.docs[0].id);
                    await ref.update({ likes: firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid) });
                }
            }
        });
        
        // UI Helper Functions
        function showStoryUploadProgress() { /* overlay disabled for guest-gated flow */ }
        
        function updateStoryUploadProgress(progress) {
            const progressBar = document.getElementById('uploadProgress');
            const percentage = document.getElementById('uploadPercentage');
            if (progressBar) progressBar.style.width = progress + '%';
            if (percentage) percentage.textContent = Math.round(progress) + '%';
        }
        
        function hideStoryUploadProgress() {}
        
        function showSuccessMessage(message) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: #1a1a1a; color: white; padding: 16px 24px; border-radius: 8px;
                z-index: 10003; font-size: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            modal.textContent = message;
            document.body.appendChild(modal);
            
            setTimeout(() => modal.remove(), 3000);
        }
        
        // Video Library - Free videos for new users
        const videoLibrary = [
            {
                id: 'vid1',
                title: 'Amazing Nature Documentary - Wildlife in 4K',
                description: 'Experience the beauty of nature with this stunning 4K wildlife documentary. From majestic mountains to serene oceans, discover the incredible diversity of our planet.',
                thumbnail: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                duration: '9:56',
                views: '2.1M',
                uploadTime: '3 days ago',
                channel: {
                    name: 'Nature Explorer',
                    avatar: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=100&h=100&fit=crop&crop=face',
                    subscribers: '1.2M'
                },
                likes: 45000
            },
            {
                id: 'vid2', 
                title: 'Epic Travel Vlog - Exploring Hidden Gems',
                description: 'Join me on an incredible journey to discover hidden gems around the world. From secret beaches to mountain villages, adventure awaits!',
                thumbnail: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4',
                duration: '12:34',
                views: '1.8M',
                uploadTime: '1 week ago',
                channel: {
                    name: 'Adventure Seeker',
                    avatar: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=100&h=100&fit=crop&crop=face',
                    subscribers: '850K'
                },
                likes: 38000
            },
            {
                id: 'vid3',
                title: 'Ultimate Cooking Masterclass - Professional Techniques',
                description: 'Learn professional cooking techniques from a master chef. Perfect your knife skills, master seasoning, and create restaurant-quality dishes at home.',
                thumbnail: 'https://images.unsplash.com/photo-1556909114-4f6e8407730d?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4',
                duration: '15:22',
                views: '3.2M',
                uploadTime: '5 days ago',
                channel: {
                    name: 'Chef Masters',
                    avatar: 'https://images.unsplash.com/photo-1556909114-4f6e8407730d?w=100&h=100&fit=crop&crop=face',
                    subscribers: '2.1M'
                },
                likes: 67000
            },
            {
                id: 'vid4',
                title: 'Tech Review - Latest Gadgets You Need to See',
                description: 'Comprehensive review of the latest tech gadgets hitting the market. Unboxing, testing, and honest opinions on what\'s worth your money.',
                thumbnail: 'https://images.unsplash.com/photo-1518717758536-85ae29035b6d?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerEscapes.mp4',
                duration: '8:45',
                views: '950K',
                uploadTime: '2 days ago',
                channel: {
                    name: 'Tech Insider',
                    avatar: 'https://images.unsplash.com/photo-1518717758536-85ae29035b6d?w=100&h=100&fit=crop&crop=face',
                    subscribers: '750K'
                },
                likes: 25000
            },
            {
                id: 'vid5',
                title: 'Fitness Transformation - 30 Day Challenge Results',
                description: 'See incredible transformation results from a 30-day fitness challenge. Workout routines, nutrition tips, and motivation to help you reach your goals.',
                thumbnail: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerFun.mp4',
                duration: '11:18',
                views: '1.4M',
                uploadTime: '1 day ago',
                channel: {
                    name: 'Fit Life',
                    avatar: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=100&h=100&fit=crop&crop=face',
                    subscribers: '920K'
                },
                likes: 34000
            },
            {
                id: 'vid6',
                title: 'Music Production Tutorial - Beat Making Basics',
                description: 'Learn the fundamentals of music production and beat making. From basic rhythm patterns to advanced mixing techniques.',
                thumbnail: 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4',
                duration: '14:07',
                views: '780K',
                uploadTime: '4 days ago',
                channel: {
                    name: 'Beat Makers',
                    avatar: 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=100&h=100&fit=crop&crop=face',
                    subscribers: '650K'
                },
                likes: 19000
            },
            {
                id: 'vid7',
                title: 'Sintel - Open Movie',
                description: 'Award-winning animated short film produced by the Blender Institute.',
                thumbnail: 'https://images.unsplash.com/photo-1529101091764-c3526daf38fe?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4',
                duration: '14:48',
                views: '5.4M',
                uploadTime: '2 weeks ago',
                channel: {
                    name: 'Blender Studio',
                    avatar: 'https://images.unsplash.com/photo-1511367461989-f85a21fda167?w=100&h=100&fit=crop&crop=face',
                    subscribers: '1.1M'
                },
                likes: 120000
            },
            {
                id: 'vid8',
                title: 'Tears of Steel - Sci-Fi Short',
                description: 'A high-quality sci-fi short with epic VFX and a dramatic storyline.',
                thumbnail: 'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4',
                duration: '12:14',
                views: '3.8M',
                uploadTime: '1 month ago',
                channel: {
                    name: 'Open Movies',
                    avatar: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=100&h=100&fit=crop&crop=face',
                    subscribers: '890K'
                },
                likes: 86000
            },
            {
                id: 'vid9',
                title: 'Offroad Drive - Subaru Outback',
                description: 'A cinematic drive through street and dirt to test the limits of the Outback.',
                thumbnail: 'https://images.unsplash.com/photo-1502877338535-766e1452684a?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/SubaruOutbackOnStreetAndDirt.mp4',
                duration: '2:12',
                views: '1.2M',
                uploadTime: '6 days ago',
                channel: {
                    name: 'Auto Motion',
                    avatar: 'https://images.unsplash.com/photo-1519340333755-5063a2421801?w=100&h=100&fit=crop&crop=face',
                    subscribers: '410K'
                },
                likes: 22000
            },
            {
                id: 'vid10',
                title: 'For Bigger Meltdowns - Comedy Short',
                description: 'A quick, funny short that shows what happens when things heat up.',
                thumbnail: 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&h=400&fit=crop',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerMeltdowns.mp4',
                duration: '1:00',
                views: '640K',
                uploadTime: '5 days ago',
                channel: {
                    name: 'Shorts Central',
                    avatar: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop&crop=face',
                    subscribers: '300K'
                },
                likes: 14000
            }
        ];
        
        // Load videos into the grid
        function loadVideos() {
            const videoGrid = document.getElementById('videoGrid');
            if (!videoGrid) return;
            videoGrid.innerHTML = '';
            videoLibrary.forEach(video => {
                const videoCard = document.createElement('div');
                videoCard.className = 'video-item';
                const thumb = video.thumbnailUrl || video.thumbnail || video.thumb || video.poster || video.image || 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&h=400&fit=crop';
                videoCard.innerHTML = `
                    <div class="video-thumbnail">
                        <img src="${thumb}" alt="${video.title}" loading="lazy" onerror="this.src='https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&h=400&fit=crop'">
                    </div>
                        <div class="video-details">
                            <h3>${video.title}</h3>
                        <p class="video-meta">${(video.views||0)} views • ${video.uploadTime}</p>
                    </div>
                `;
                videoCard.onclick = () => openVideoDetail(video);
                videoGrid.appendChild(videoCard);
            });
        }
        
        // Global video player state
        let currentVideo = null;
        let controlsTimeout = null;
        let isVideoPlaying = false;
        
        // Video Detail Functions
        function openVideoDetail(video) {
            // Opening video detail view
            currentVideo = video;
            
            // Set video data
            const videoPlayer = document.getElementById('detailVideoPlayer');
            document.getElementById('detailVideoTitle').textContent = video.title;
            document.getElementById('topBarVideoTitle').textContent = video.title;
            document.getElementById('detailVideoStats').textContent = `${video.views} views • ${video.uploadTime}`;
            document.getElementById('detailChannelAvatar').src = video.channel.avatar;
            document.getElementById('detailChannelName').textContent = video.channel.name;
            document.getElementById('detailChannelSubs').textContent = `${video.channel.subscribers} subscribers`;
            document.getElementById('detailVideoDescription').textContent = video.description;
            // Move comments section under info and wire comments logic
            try {
                const infoEl = document.querySelector('.video-detail-info');
                const commentsEl = document.getElementById('commentsSection');
                const suggEl = document.getElementById('suggestedContainer');
                if (infoEl && commentsEl && commentsEl.parentElement !== infoEl) {
                    infoEl.appendChild(commentsEl);
                }
                if (suggEl) suggEl.style.display = 'block';
            } catch (e) {}

            // Comments logic (previously inline)
            try {
                window.__comments = window.__comments || {};
                const listEl = document.getElementById('commentsList');
                const headerEl = document.getElementById('commentsHeader');
                const postBtn = document.getElementById('commentPostBtn');
                const inputEl = document.getElementById('commentInput');
                if (!window.__comments[video.id]) {
                    window.__comments[video.id] = [
                        { user: '@sarah_creates', text: 'This is amazing content! Keep it up! 🔥', ago: '2 hours ago', avatar: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=40&h=40&fit=crop&crop=face' },
                        { user: '@mike_dev', text: 'Really helpful tutorial, thanks for sharing!', ago: '5 hours ago', avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=40&h=40&fit=crop&crop=face' }
                    ];
                }
                function renderComments() {
                    const arr = window.__comments[video.id] || [];
                    if (headerEl) headerEl.textContent = `Comments • ${arr.length}`;
                    if (listEl) {
                        listEl.innerHTML = arr.map(c => `
                            <div style=\"display:flex; gap:12px; margin-bottom:16px;\">
                                <img src=\"${c.avatar}\" style=\"width:32px; height:32px; border-radius:50%; object-fit:cover;\">
                                <div>
                                    <div style=\"color:white; font-size:13px; font-weight:500;\">${c.user}</div>
                                    <div style=\"color:#ccc; font-size:14px; margin:4px 0;\">${c.text}</div>
                                    <div style=\"color:#666; font-size:12px;\">${c.ago}</div>
                                </div>
                            </div>`).join('');
                    }
                }
                renderComments();
                if (postBtn && inputEl) {
                    postBtn.onclick = () => {
                        const text = (inputEl.value || '').trim();
                        if (!text) return;
                        (window.__comments[video.id] || []).unshift({ user: '@you', text, ago: 'just now', avatar: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=40&h=40&fit=crop&crop=face' });
                        inputEl.value = '';
                        renderComments();
                    };
                }
            } catch (e) {}
            // Render suggested videos
            try {
                let container = document.getElementById('suggestedContainer');
                if (!container) {
                    const info = document.querySelector('.video-detail-info');
                    if (info) {
                        container = document.createElement('div');
                        container.id = 'suggestedContainer';
                        container.style.marginTop = '20px';
                        container.innerHTML = '<h3 style="color:white;margin:0 0 12px 0;font-size:16px;">Suggested videos</h3><div id="suggestedList" style="display:grid;grid-template-columns:1fr;gap:12px;"></div>';
                        info.insertBefore(container, info.querySelector('.comments-list') || null);
                    }
                }
                const list = document.getElementById('suggestedList');
                if (list) {
                    list.innerHTML = '';
                    let pool = (window.videoLibrary || []).filter(v => v.id !== video.id);
                    if (!pool.length) {
                        // Fallback: scrape current home grid thumbnails/titles
                        try {
                            document.querySelectorAll('#videoGrid .video-item').forEach((card, i) => {
                                if (i < 8) {
                                    const img = card.querySelector('img');
                                    const title = card.querySelector('h3');
                                    pool.push({
                                        id: 'home-' + i,
                                        title: (title && title.textContent) || 'Video',
                                        thumbnail: (img && img.src) || '',
                                        views: 0,
                                        channel: { name: 'Creator' }
                                    });
                                }
                            });
                        } catch {}
                    }
                    pool.slice(0, 8).forEach(v => {
                        const row = document.createElement('div');
                        row.style.cssText = 'display:flex; gap:12px; cursor:pointer;';
                        row.onclick = () => openVideoDetail(v);
                        const thumb = v.thumbnailUrl || v.thumb || v.thumbnail || v.poster || v.image || 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&h=400&fit=crop';
                        row.innerHTML = `
                            <img src="${thumb}" alt="${v.title||''}" loading="lazy" style="width:160px; height:90px; object-fit:cover; border-radius:8px;" onerror="this.src='https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=600&h=400&fit=crop'">
                            <div style=\"flex:1; min-width:0;\">
                                <div style=\"color:#fff; font-size:14px; font-weight:600; line-height:1.3;\">${v.title || 'Untitled'}</div>
                                <div style=\"color:#aaa; font-size:12px; margin-top:4px;\">${(v.channel && v.channel.name) || v.creator || 'Creator'}</div>
                                <div style=\"color:#666; font-size:12px; margin-top:2px;\">${v.views || 0} views</div>
                            </div>`;
                        list.appendChild(row);
                    });
                }
            } catch {}
            
            // Show loading spinner
            showVideoLoading();
            
            // Load video
            videoPlayer.src = video.videoUrl;
            videoPlayer.load();
            
            // Set up video event listeners
            setupVideoEventListeners();
            
            // Show the detail view
            document.getElementById('videoDetailView').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Show controls initially, then auto-hide
            showVideoControls();
            startControlsAutoHide();
        }
        
        function closeVideoDetail() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            videoPlayer.pause();
            videoPlayer.src = '';
            
            // Clear timeouts
            if (controlsTimeout) {
                clearTimeout(controlsTimeout);
                controlsTimeout = null;
            }
            
            document.getElementById('videoDetailView').style.display = 'none';
            document.body.style.overflow = 'auto';
            
            currentVideo = null;
            isVideoPlaying = false;
        }
        
        function setupVideoEventListeners() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            
            // AGGRESSIVELY remove all native controls
            videoPlayer.controls = false;
            videoPlayer.removeAttribute('controls');
            videoPlayer.setAttribute('controlsList', 'nodownload nofullscreen noremoteplayback noplaybackrate');
            videoPlayer.setAttribute('disablePictureInPicture', 'true');
            videoPlayer.setAttribute('disableRemotePlayback', 'true');
            videoPlayer.setAttribute('playsinline', 'true');
            videoPlayer.setAttribute('webkit-playsinline', 'true');
            videoPlayer.setAttribute('x5-playsinline', 'true');
            
            // Force hide controls continuously
            setInterval(() => {
                if (videoPlayer.controls) {
                    videoPlayer.controls = false;
                    videoPlayer.removeAttribute('controls');
                }
            }, 100);
            
            videoPlayer.onloadstart = () => {
                showVideoLoading();
                // Force remove controls again on load
                videoPlayer.controls = false;
                videoPlayer.removeAttribute('controls');
            };
            videoPlayer.oncanplay = () => {
                hideVideoLoading();
                // Force remove controls when ready
                videoPlayer.controls = false;
                videoPlayer.removeAttribute('controls');
            };
            videoPlayer.onplay = () => {
                isVideoPlaying = true;
                updatePlayButtons('pause');
                // Force remove controls on play
                videoPlayer.controls = false;
                videoPlayer.removeAttribute('controls');
            };
            videoPlayer.onpause = () => {
                isVideoPlaying = false;
                updatePlayButtons('play');
            };
            videoPlayer.ontimeupdate = () => updateProgress();
            videoPlayer.onloadedmetadata = () => {
                updateDuration();
                // Force remove controls when metadata loads
                videoPlayer.controls = false;
                videoPlayer.removeAttribute('controls');
            };
            videoPlayer.onerror = () => {
                hideVideoLoading();
                console.error('Video failed to load');
            };
            
            // Prevent context menu on video
            videoPlayer.oncontextmenu = (e) => {
                e.preventDefault();
                return false;
            };
            
            // Prevent double-click fullscreen
            videoPlayer.ondblclick = (e) => {
                e.preventDefault();
                return false;
            };
            
            // Block any attempt to show controls
            videoPlayer.addEventListener('controlschange', () => {
                videoPlayer.controls = false;
            });
        }
        
        function showVideoLoading() {
            document.getElementById('videoLoadingSpinner').style.display = 'block';
        }
        
        function hideVideoLoading() {
            document.getElementById('videoLoadingSpinner').style.display = 'none';
        }
        
        function togglePlayPause() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            
            if (videoPlayer.paused) {
                videoPlayer.play();
            } else {
                videoPlayer.pause();
            }
            
            // Show controls when interacting
            showVideoControls();
            startControlsAutoHide();
        }
        
        function updatePlayButtons(state) {
            const centerIcon = document.getElementById('centerPlayIcon');
            
            if (state === 'play') {
                // Play icon - properly centered
                centerIcon.innerHTML = '<polygon points="8,5 19,12 8,19" fill="white"></polygon>';
            } else {
                // Pause icon - perfectly centered with consistent spacing
                centerIcon.innerHTML = '<rect x="9" y="5" width="2.5" height="14" fill="white"></rect><rect x="12.5" y="5" width="2.5" height="14" fill="white"></rect>';
            }
        }
        
        function seekBackward() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 10);
            showVideoControls();
            startControlsAutoHide();
        }
        
        function seekForward() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 10);
            showVideoControls();
            startControlsAutoHide();
        }
        
        function seekToPosition(event) {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            const progressContainer = event.currentTarget;
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = clickX / rect.width;
            
            videoPlayer.currentTime = percentage * videoPlayer.duration;
            showVideoControls();
            startControlsAutoHide();
        }
        
        function updateProgress() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            const progressBar = document.getElementById('progressBar');
            const currentTimeDisplay = document.getElementById('currentTimeDisplay');
            
            if (videoPlayer.duration > 0) {
                const percentage = (videoPlayer.currentTime / videoPlayer.duration) * 100;
                progressBar.style.width = percentage + '%';
                currentTimeDisplay.textContent = formatVideoTime(videoPlayer.currentTime);
            }
        }
        
        function updateDuration() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            const durationDisplay = document.getElementById('durationDisplay');
            durationDisplay.textContent = formatVideoTime(videoPlayer.duration);
        }
        
        function formatVideoTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }
        
        function toggleMute() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            const volumeIcon = document.getElementById('volumeIcon');
            
            videoPlayer.muted = !videoPlayer.muted;
            
            if (videoPlayer.muted) {
                // Muted icon
                volumeIcon.innerHTML = '<polygon points="11,5 6,9 2,9 2,15 6,15 11,19"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line>';
            } else {
                // Volume icon
                volumeIcon.innerHTML = '<polygon points="11,5 6,9 2,9 2,15 6,15 11,19"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>';
            }
            
            showVideoControls();
            startControlsAutoHide();
        }
        
        function toggleFullscreen() {
            const videoDetailView = document.getElementById('videoDetailView');
            
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                videoDetailView.requestFullscreen();
            }
            
            showVideoControls();
            startControlsAutoHide();
        }
        
        // Mini Player state
        let miniPlayerActive = false;
        
        function minimizeToMiniPlayer() {
            const fullVideo = document.getElementById('detailVideoPlayer');
            const miniPlayer = document.getElementById('miniPlayer');
            const miniVideo = document.getElementById('miniVideo');

            // Show mini player
            miniPlayer.style.display = 'block';
            miniPlayerActive = true;

            // Mirror source and current time
            miniVideo.src = fullVideo.currentSrc || fullVideo.src;
            miniVideo.currentTime = fullVideo.currentTime;
            miniVideo.muted = fullVideo.muted;
            miniVideo.playbackRate = fullVideo.playbackRate;

            // Start playing in mini
            miniVideo.play().catch(() => {});

            // Close full view
            closeVideoDetail();

            // Wire controls
            wireMiniPlayerControls();
        }

        function restoreFromMiniPlayer() {
            const miniVideo = document.getElementById('miniVideo');
            const src = miniVideo.currentSrc || miniVideo.src;
            const time = miniVideo.currentTime;
            const muted = miniVideo.muted;
            const rate = miniVideo.playbackRate;

            // Reopen full player and continue playback
            openVideoDetail({
                title: document.getElementById('detailVideoTitle')?.textContent || 'Video',
                url: src,
                autoplay: true
            }, true);

            const fullVideo = document.getElementById('detailVideoPlayer');
            fullVideo.src = src;
            fullVideo.currentTime = time;
            fullVideo.muted = muted;
            fullVideo.playbackRate = rate;
            fullVideo.play().catch(() => {});

            // Hide mini
            destroyMiniPlayer();
        }

        function destroyMiniPlayer() {
            const miniPlayer = document.getElementById('miniPlayer');
            const miniVideo = document.getElementById('miniVideo');
            miniVideo.pause();
            miniVideo.removeAttribute('src');
            miniVideo.load();
            miniPlayer.style.display = 'none';
            miniPlayerActive = false;
        }

        function wireMiniPlayerControls() {
            const miniVideo = document.getElementById('miniVideo');
            const playBtn = document.getElementById('miniPlayBtn');
            const expandBtn = document.getElementById('miniExpandBtn');
            const closeBtn = document.getElementById('miniCloseBtn');
            const timeLabel = document.getElementById('miniTime');

            playBtn.onclick = () => {
                if (miniVideo.paused) {
                    miniVideo.play();
                    playBtn.textContent = '❚❚';
                } else {
                    miniVideo.pause();
                    playBtn.textContent = '▶';
                }
            };

            expandBtn.onclick = restoreFromMiniPlayer;
            closeBtn.onclick = destroyMiniPlayer;

            miniVideo.ontimeupdate = () => {
                timeLabel.textContent = `${formatTime(miniVideo.currentTime)} / ${formatTime(miniVideo.duration || 0)}`;
            };

            // Make mini draggable
            makeMiniPlayerDraggable();
        }

        function makeMiniPlayerDraggable() {
            const el = document.getElementById('miniPlayer');
            let startX = 0, startY = 0, initialLeft = 0, initialTop = 0;

            const onTouchStart = (e) => {
                const t = e.touches[0];
                startX = t.clientX; startY = t.clientY;
                const rect = el.getBoundingClientRect();
                initialLeft = rect.left; initialTop = rect.top;
                document.addEventListener('touchmove', onTouchMove, { passive: false });
                document.addEventListener('touchend', onTouchEnd);
            };

            const onTouchMove = (e) => {
                e.preventDefault();
                const t = e.touches[0];
                const dx = t.clientX - startX;
                const dy = t.clientY - startY;
                el.style.left = initialLeft + dx + 'px';
                el.style.top = initialTop + dy + 'px';
                el.style.right = 'auto';
                el.style.bottom = 'auto';
            };

            const onTouchEnd = () => {
                document.removeEventListener('touchmove', onTouchMove);
                document.removeEventListener('touchend', onTouchEnd);
            };

            el.addEventListener('touchstart', onTouchStart);
        }
        
        function showVideoControls() {
            const overlay = document.getElementById('videoControlsOverlay');
            overlay.style.opacity = '1';
        }
        
        function hideVideoControls() {
            const overlay = document.getElementById('videoControlsOverlay');
            overlay.style.opacity = '0';
        }
        
        function startControlsAutoHide() {
            if (controlsTimeout) {
                clearTimeout(controlsTimeout);
            }
            
            controlsTimeout = setTimeout(() => {
                if (isVideoPlaying) {
                    hideVideoControls();
                }
            }, 4000); // Hide after 4 seconds like iOS
        }
        
        // Add click handler to show/hide controls
        document.addEventListener('DOMContentLoaded', function() {
            const videoDetailView = document.getElementById('videoDetailView');
            if (videoDetailView) {
                videoDetailView.addEventListener('click', function(e) {
                    // Only toggle controls if clicking on the video area, not buttons
                    if (e.target.closest('.video-controls-overlay') && !e.target.closest('[onclick]')) {
                        const overlay = document.getElementById('videoControlsOverlay');
                        if (overlay.style.opacity === '0') {
                            showVideoControls();
                            startControlsAutoHide();
                        } else {
                            hideVideoControls();
                        }
                    }
                });
            }
        });
        
        function likeVideo() {
            const likeBtn = document.querySelector('[onclick="likeVideo()"]');
            const currentLikes = parseInt(document.getElementById('likeCount').textContent.replace('K', '').replace('.', '')) * 1000;
            const newLikes = currentLikes + 1;
            document.getElementById('likeCount').textContent = formatNumber(newLikes);
            
            likeBtn.style.background = '#ff4444';
            likeBtn.innerHTML = '❤️ <span id="likeCount">' + formatNumber(newLikes) + '</span>';
            
            showSuccessMessage('Liked! ❤️');
        }
        
        function shareVideo() {
            if (navigator.share) {
                navigator.share({
                    title: document.getElementById('detailVideoTitle').textContent,
                    url: window.location.href
                });
            } else {
                // Fallback
                navigator.clipboard.writeText(window.location.href);
                showSuccessMessage('Link copied to clipboard! 📋');
            }
        }
        
        function subscribeChannel() {
            const subBtn = document.querySelector('[onclick="subscribeChannel()"]');
            subBtn.textContent = 'Subscribed ✓';
            subBtn.style.background = '#333';
            showSuccessMessage('Subscribed! 🔔');
        }
        
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
        
        // Enhanced Features and Utilities
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Enhanced Video Player Controls
        function createEnhancedVideoPlayer(videoElement) {
            const container = videoElement.parentElement;
            
            // Add enhanced controls overlay
            const controlsOverlay = document.createElement('div');
            controlsOverlay.className = 'enhanced-video-controls';
            controlsOverlay.innerHTML = `
                <div class="progress-bar" onclick="seekVideo(event, this)">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="video-controls-row">
                    <div class="video-controls-left">
                        <button class="video-control-btn play-pause-btn" onclick="togglePlayPause()">⏸️</button>
                        <button class="video-control-btn" onclick="adjustVolume(-0.1)">🔉</button>
                        <button class="video-control-btn" onclick="adjustVolume(0.1)">🔊</button>
                        <span class="time-display">0:00 / 0:00</span>
                    </div>
                    <div class="video-controls-right">
                        <button class="video-control-btn" onclick="toggleFullscreen()">⛶</button>
                    </div>
                </div>
            `;
            
            container.appendChild(controlsOverlay);
            
            // Update progress bar
            videoElement.addEventListener('timeupdate', updateProgressBar);
            videoElement.addEventListener('loadedmetadata', updateTimeDisplay);
        }

        function updateProgressBar() {
            const video = document.getElementById('detailVideoPlayer');
            const progressFill = document.querySelector('.progress-fill');
            const timeDisplay = document.querySelector('.time-display');
            
            if (video && progressFill) {
                const progress = (video.currentTime / video.duration) * 100;
                progressFill.style.width = progress + '%';
                
                if (timeDisplay) {
                    const current = formatTime(video.currentTime);
                    const total = formatTime(video.duration);
                    timeDisplay.textContent = `${current} / ${total}`;
                }
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function seekVideo(event, progressBar) {
            const video = document.getElementById('detailVideoPlayer');
            const rect = progressBar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            video.currentTime = percent * video.duration;
        }

        function togglePlayPause() {
            const video = document.getElementById('detailVideoPlayer');
            const btn = document.querySelector('.play-pause-btn');
            
            if (video.paused) {
                video.play();
                btn.textContent = '⏸️';
            } else {
                video.pause();
                btn.textContent = '▶️';
            }
        }

        function adjustVolume(change) {
            const video = document.getElementById('detailVideoPlayer');
            video.volume = Math.max(0, Math.min(1, video.volume + change));
            showNotification(`Volume: ${Math.round(video.volume * 100)}%`, 'info');
        }

        function toggleFullscreen() {
            const videoContainer = document.getElementById('videoDetailView');
            
            if (!document.fullscreenElement) {
                videoContainer.requestFullscreen().catch(err => {
                    showNotification('Fullscreen not supported', 'error');
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Enhanced Story Features
        function enhanceStoryExperience() {
            const stories = document.querySelectorAll('.story-item');
            stories.forEach(story => {
                story.addEventListener('click', function() {
                    const storyTitle = this.querySelector('.story-name')?.textContent || 'Story';
                    showNotification(`Opening ${storyTitle}...`, 'info');
                });
            });
        }

        // Advanced Performance Optimization
        function lazyLoadImages() {
            const images = document.querySelectorAll('img[data-src]');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        imageObserver.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px 0px', // Start loading 50px before image comes into view
                threshold: 0.1
            });

            images.forEach(img => imageObserver.observe(img));
        }

        // Virtual Scrolling for Video Grid (Performance Boost)
        class VirtualScrollManager {
            constructor(container, itemHeight = 200) {
                this.container = container;
                this.itemHeight = itemHeight;
                this.visibleItems = Math.ceil(window.innerHeight / itemHeight) + 2;
                this.scrollTop = 0;
                this.totalItems = 0;
                
                this.init();
            }
            
            init() {
                this.container.addEventListener('scroll', this.handleScroll.bind(this));
                window.addEventListener('resize', this.handleResize.bind(this));
            }
            
            handleScroll() {
                this.scrollTop = this.container.scrollTop;
                this.updateVisibleItems();
            }
            
            handleResize() {
                this.visibleItems = Math.ceil(window.innerHeight / this.itemHeight) + 2;
                this.updateVisibleItems();
            }
            
            updateVisibleItems() {
                const startIndex = Math.floor(this.scrollTop / this.itemHeight);
                const endIndex = Math.min(startIndex + this.visibleItems, this.totalItems);
                
                // This would integrate with your video loading logic
                this.renderVisibleItems(startIndex, endIndex);
            }
            
            renderVisibleItems(start, end) {
                // Implementation would depend on your video data structure
                console.log(`Rendering items ${start} to ${end}`);
            }
        }

        // Advanced Caching System
        class AdvancedCache {
            constructor(maxSize = 50) {
                this.cache = new Map();
                this.maxSize = maxSize;
            }
            
            set(key, value, ttl = 300000) { // 5 minutes default TTL
                if (this.cache.size >= this.maxSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                
                this.cache.set(key, {
                    value,
                    timestamp: Date.now(),
                    ttl
                });
            }
            
            get(key) {
                const item = this.cache.get(key);
                if (!item) return null;
                
                if (Date.now() - item.timestamp > item.ttl) {
                    this.cache.delete(key);
                    return null;
                }
                
                return item.value;
            }
            
            clear() {
                this.cache.clear();
            }
        }

        // Initialize advanced performance features
        const videoCache = new AdvancedCache(100);
        let virtualScroll = null;

        // Theme removed - using light theme only

        // Enhanced Video Player with Advanced Controls
        function enhanceVideoPlayer() {
            const videoPlayer = document.getElementById('detailVideoPlayer');
            if (!videoPlayer) return;

            // Add picture-in-picture support
            if (document.pictureInPictureEnabled) {
                const pipButton = document.createElement('button');
                pipButton.innerHTML = '📱';
                pipButton.className = 'pip-btn';
                pipButton.onclick = togglePictureInPicture;
                pipButton.title = 'Picture in Picture';
                
                const controlsContainer = videoPlayer.parentElement.querySelector('.video-controls');
                if (controlsContainer) {
                    controlsContainer.appendChild(pipButton);
                }
            }

            // Add playback speed control
            const speedButton = document.createElement('button');
            speedButton.innerHTML = '1x';
            speedButton.className = 'speed-btn';
            speedButton.onclick = cyclePlaybackSpeed;
            speedButton.title = 'Playback Speed';
            
            const controlsContainer = videoPlayer.parentElement.querySelector('.video-controls');
            if (controlsContainer) {
                controlsContainer.appendChild(speedButton);
            }
        }

        function togglePictureInPicture() {
            const video = document.getElementById('detailVideoPlayer');
            
            if (document.pictureInPictureElement) {
                document.exitPictureInPicture();
            } else {
                video.requestPictureInPicture().catch(err => {
                    showNotification('Picture-in-picture not available', 'error');
                });
            }
        }

        const playbackSpeeds = [0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2];
        let currentSpeedIndex = 3; // 1x

        function cyclePlaybackSpeed() {
            const video = document.getElementById('detailVideoPlayer');
            const speedBtn = document.querySelector('.speed-btn');
            
            currentSpeedIndex = (currentSpeedIndex + 1) % playbackSpeeds.length;
            const newSpeed = playbackSpeeds[currentSpeedIndex];
            
            video.playbackRate = newSpeed;
            speedBtn.innerHTML = `${newSpeed}x`;
            showNotification(`Speed: ${newSpeed}x`, 'info');
        }

        // Enhanced Mobile Gestures
        function initMobileGestures() {
            let touchStartX = 0;
            let touchStartY = 0;
            let touchStartTime = 0;

            document.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
            });

            document.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const touchEndTime = Date.now();
                
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const deltaTime = touchEndTime - touchStartTime;
                
                // Quick swipe detection
                if (deltaTime < 300 && Math.abs(deltaX) > 50) {
                    if (deltaX > 0) {
                        // Swipe right - go back or previous video
                        handleSwipeRight();
                    } else {
                        // Swipe left - next video or forward
                        handleSwipeLeft();
                    }
                }
                
                // Double tap like disabled (removed per design requirements)
            });
        }

        function handleSwipeRight() {}

        function handleSwipeLeft() {}

        // handleDoubleTap removed (no hearts / simplified UI)

        // Enhanced Accessibility Features
        function initAccessibilityFeatures() {
            // Keyboard navigation for video grid
            const videoItems = document.querySelectorAll('.video-item');
            videoItems.forEach((item, index) => {
                item.setAttribute('tabindex', '0');
                item.setAttribute('role', 'button');
                item.setAttribute('aria-label', `Video ${index + 1}`);
                
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        item.click();
                    }
                });
            });

            // Keyboard navigation for stories
            const storyItems = document.querySelectorAll('.story-item');
            storyItems.forEach((item, index) => {
                item.setAttribute('tabindex', '0');
                item.setAttribute('role', 'button');
                item.setAttribute('aria-label', `Story ${index + 1}`);
                
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        item.click();
                    }
                });
            });

            // Enhanced focus indicators
            const focusableElements = document.querySelectorAll('button, [tabindex="0"], a, input, select, textarea');
            focusableElements.forEach(element => {
                element.addEventListener('focus', () => {
                    element.style.outline = '2px solid var(--accent)';
                    element.style.outlineOffset = '2px';
                });
                
                element.addEventListener('blur', () => {
                    element.style.outline = '';
                    element.style.outlineOffset = '';
                });
            });

            // Skip links functionality
            const skipLink = document.querySelector('.skip-link');
            if (skipLink) {
                skipLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    const target = document.querySelector(skipLink.getAttribute('href'));
                    if (target) {
                        target.focus();
                        target.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            }

            // Announce theme changes to screen readers
            const themeButton = document.querySelector('.theme-toggle');
            if (themeButton) {
                themeButton.setAttribute('aria-live', 'polite');
                themeButton.setAttribute('aria-atomic', 'true');
            }
        }

        // Enhanced Keyboard Shortcuts
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Only handle shortcuts when not in input fields
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                switch (e.key) {
                    case 'k':
                    case 'K':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            const searchInput = document.querySelector('input[type="search"]');
                            if (searchInput) {
                                searchInput.focus();
                                showNotification('🔍 Search activated', 'info');
                            }
                        }
                        break;
                    
                    // Theme toggle removed
                    
                    case ' ':
                        if (document.activeElement.classList.contains('video-item')) {
                            e.preventDefault();
                            document.activeElement.click();
                        }
                        break;
                    
                    case 'Escape':
                        // Close any open modals
                        const modal = document.querySelector('.modal.show');
                        if (modal) {
                            closeCustomModal();
                        }
                        break;
                    
                    case 'h':
                    case 'H':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            showKeyboardShortcuts();
                        }
                        break;
                }
            });
        }

        function showKeyboardShortcuts() {
            const shortcuts = [
                '⌘/Ctrl + K: Focus search',
                '⌘/Ctrl + H: Show shortcuts',
                'Space: Activate focused item',
                'Escape: Close modals',
                'Tab: Navigate elements'
            ];
            
            showCustomModal('⌨️ Keyboard Shortcuts', shortcuts.join('<br>'));
        }

        // Reduced Motion Support
        function initReducedMotionSupport() {
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)');
            
            function handleReducedMotion() {
                if (prefersReducedMotion.matches) {
                    document.body.style.setProperty('--transition', 'none');
                    document.querySelectorAll('*').forEach(el => {
                        el.style.animationDuration = '0.01ms !important';
                        el.style.animationIterationCount = '1 !important';
                        el.style.transitionDuration = '0.01ms !important';
                    });
                    showNotification('🎯 Reduced motion enabled', 'info');
                } else {
                    document.body.style.setProperty('--transition', 'all 0.3s ease');
                }
            }
            
            prefersReducedMotion.addListener(handleReducedMotion);
            handleReducedMotion();
        }

        // Enhanced Search Functionality
        function initEnhancedSearch() {
            // Add search suggestions
            const searchSuggestions = [
                '🎵 Music Videos', '🎮 Gaming', '📚 Education', '🍳 Cooking',
                '💪 Fitness', '🎨 Art', '💻 Tech', '🎬 Movies'
            ];
            
            // This would integrate with your existing search functionality
            console.log('Enhanced search initialized with suggestions:', searchSuggestions);
        }

        // Enhanced Analytics Integration
        function trackUserEngagement(action, data = {}) {
            // Enhanced analytics tracking with more context
            const enhancedData = {
                ...data,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                screenResolution: `${screen.width}x${screen.height}`,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                theme: 'light',
                connectionType: navigator.connection?.effectiveType || 'unknown'
            };
            
            console.log('📊 User Engagement:', action, enhancedData);
            
            // Firebase Analytics integration
            if (typeof gtag !== 'undefined') {
                gtag('event', action, enhancedData);
            }
            
            // Store in local cache for offline analysis
            const analyticsCache = JSON.parse(localStorage.getItem('analytics_cache') || '[]');
            analyticsCache.push({ action, data: enhancedData });
            
            // Keep only last 100 events
            if (analyticsCache.length > 100) {
                analyticsCache.shift();
            }
            
            localStorage.setItem('analytics_cache', JSON.stringify(analyticsCache));
        }

        // Performance Monitoring
        function initPerformanceMonitoring() {
            // Monitor page load performance
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    if (perfData) {
                        trackUserEngagement('performance_metrics', {
                            loadTime: Math.round(perfData.loadEventEnd - perfData.fetchStart),
                            domContentLoaded: Math.round(perfData.domContentLoadedEventEnd - perfData.fetchStart),
                            firstPaint: Math.round(performance.getEntriesByName('first-paint')[0]?.startTime || 0),
                            firstContentfulPaint: Math.round(performance.getEntriesByName('first-contentful-paint')[0]?.startTime || 0)
                        });
                    }
                }, 1000);
            });

            // Monitor user interactions
            ['click', 'scroll', 'keydown'].forEach(eventType => {
                document.addEventListener(eventType, () => {
                    trackUserEngagement('user_interaction', { type: eventType });
                }, { once: true, passive: true });
            });

            // Monitor video engagement
            document.addEventListener('play', (e) => {
                if (e.target.tagName === 'VIDEO') {
                    trackUserEngagement('video_play', { videoId: e.target.id || 'unknown' });
                }
            });

            document.addEventListener('pause', (e) => {
                if (e.target.tagName === 'VIDEO') {
                    trackUserEngagement('video_pause', { 
                        videoId: e.target.id || 'unknown',
                        currentTime: e.target.currentTime,
                        duration: e.target.duration
                    });
                }
            });
        }

        // Load stories and videos when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Revert force-close overlays to avoid hiding required UI
            // Initialize performance monitoring
            initPerformanceMonitoring();
            
            // Prime stories from cache for instant UI
            try { primeStoriesFromCache(); } catch {}

            // Load videos immediately with a safeguard re-try
            loadVideos();
            setTimeout(() => {
                try {
                    const grid = document.getElementById('videoGrid');
                    if (grid && grid.children.length === 0) {
                        loadVideos();
                    }
                } catch (e) { /* no-op */ }
            }, 600);
            
            // Load stories after a short delay to let the page render
            setTimeout(loadUserStories, 1000);

            // Hero carousel disabled for production for now

            // Show promo for guests (hide if signed in or dismissed)
            try {
                const promo = document.getElementById('promoBanner');
                const closeBtn = document.getElementById('promoCloseBtn');
                let dismissedUntil = 0;
                try { dismissedUntil = parseInt(localStorage.getItem('mc_promo_dismissed_until')||'0', 10) || 0; } catch {}
                const now = Date.now();
                const notDismissed = now > dismissedUntil;
                let shownThisSession = false;
                try { shownThisSession = sessionStorage.getItem('mc_promo_shown') === '1'; } catch {}
                if (promo && notDismissed && !shownThisSession) {
                    promo.classList.remove('hidden');
                    try { sessionStorage.setItem('mc_promo_shown','1'); } catch {}
                }
                await initFirebase();
                const isSignedIn = auth && auth.currentUser && !auth.currentUser.isAnonymous;
                if (promo) {
                    if (!isSignedIn && notDismissed) {
                        promo.classList.remove('hidden');
                    }
                    if (closeBtn) closeBtn.onclick = () => {
                        promo.classList.add('hidden');
                        try { localStorage.setItem('mc_promo_dismissed_until', String(Date.now() + 7*24*60*60*1000)); } catch {}
                    };
                }
            } catch {
                // If anything failed, show promo as a last resort (guest default)
                const promo = document.getElementById('promoBanner');
                if (promo) promo.style.display = 'block';
            }

            // Initialize enhanced features
            setTimeout(() => {
                initEnhancedSearch();
                enhanceStoryExperience();
                lazyLoadImages();
                enhanceVideoPlayer();
                initMobileGestures();
                initAccessibilityFeatures();
                initKeyboardShortcuts();
                initReducedMotionSupport();
                initStoryKeyboardSupport();
                
                // Initialize virtual scrolling if container exists
                const videoGrid = document.getElementById('videoGrid');
                if (videoGrid) {
                    virtualScroll = new VirtualScrollManager(videoGrid);
                }
                
                // Add staggered animations to existing items
                document.querySelectorAll('.video-item').forEach((item, index) => {
                    item.style.setProperty('--item-index', index);
                });
                
                document.querySelectorAll('.story-item').forEach((item, index) => {
                    item.style.setProperty('--story-index', index);
                });
                
                // Welcome toast disabled for cleaner first impression
                
                // Track page load with enhanced metrics
                // Suppressed page_load analytics to avoid any overlays/console noise on first render
                gateProfileForAuth();
            }, 1500);
        });

        function initHeroCarousel() {
            const slides = Array.from(document.querySelectorAll('#heroCarousel .hero-slide'));
            const dots = Array.from(document.querySelectorAll('#heroDots .hero-dot'));
            const prev = document.getElementById('heroPrev');
            const next = document.getElementById('heroNext');
            if (slides.length === 0) return;
            let i = 0; let timer = null;
            const show = (idx) => {
                i = (idx + slides.length) % slides.length;
                slides.forEach((s, si) => s.classList.toggle('active', si === i));
                dots.forEach((d, di) => d.classList.toggle('active', di === i));
            };
            const play = () => { stop(); timer = setInterval(() => show(i + 1), 5000); };
            const stop = () => { if (timer) { clearInterval(timer); timer = null; } };
            prev.addEventListener('click', () => { show(i - 1); play(); });
            next.addEventListener('click', () => { show(i + 1); play(); });
            slides.forEach((s, si) => s.addEventListener('click', () => {
                try { if (Array.isArray(window.videoLibrary) && window.videoLibrary[si]) { openVideoDetail(window.videoLibrary[si]); } } catch (e) {}
            }));
            play();
        }

        function forceCloseOverlays() {}

        // OAuth sign-in with Google
        async function signInWithGoogle() {
            await initFirebase();
            try {
                __redirectInProgress = false;
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({ prompt: 'select_account' });
                await auth.signInWithPopup(provider);
                try { sessionStorage.removeItem('oauthRedirect'); } catch {}
                closeAuthModal();
                refreshAccountMenu();
                clearOverlays();
                startAuthWatchdog();
            } catch (e) {
                const msg = (e && e.code) ? e.code : (e && e.message) ? e.message : String(e);
                if (/popup/.test(msg)) {
                    alert('Please allow popups, then tap Continue with Google again. If you are inside another app\'s browser, tap the ••• menu and choose Open in Safari/Chrome.');
                } else {
                    alert('Google sign-in failed: ' + msg);
                }
            }
        }

        // OAuth sign-in with Apple
        async function signInWithApple() {
            if (!APPLE_SIGNIN_ENABLED) {
                alert('Sign in with Apple will be available soon.');
                return;
            }
            await initFirebase();
            try {
                const provider = new firebase.auth.OAuthProvider('apple.com');
                provider.addScope('email');
                provider.addScope('name');
                const isIOSSafari = /iP(hone|ad|od)/.test(navigator.userAgent) && /Safari/.test(navigator.userAgent) && !/CriOS|FxiOS/.test(navigator.userAgent);
                if (isIOSSafari) {
                    await auth.signInWithRedirect(provider);
                    return;
                }
                await auth.signInWithPopup(provider);
                closeAuthModal();
                refreshAccountMenu();
                clearOverlays();
            } catch (e) {
                alert(e?.message || 'Apple sign-in failed');
            }
        }

        // Handle redirect result (iOS Safari)
        window.addEventListener('load', async () => {
            try {
                await initFirebase();
                const result = await auth.getRedirectResult();
                logAuth('getRedirectResult user=' + (result && result.user ? (result.user.uid || 'yes') : 'null'));
                const hadRedirectFlag = (typeof sessionStorage !== 'undefined' && sessionStorage.getItem('oauthRedirect') === '1');
                try { sessionStorage.removeItem('oauthRedirect'); } catch {}
                if (result && result.user) {
                    __redirectInProgress = false;
                    try {
                        if (result.additionalUserInfo && result.additionalUserInfo.isNewUser) {
                            await db.collection('users').doc(result.user.uid).set({
                                displayName: result.user.displayName || 'MyChannel User',
                                email: result.user.email || '',
                                createdAt: new Date()
                            }, { merge: true });
                        }
                    } catch {}
                    closeAuthModal();
                    refreshAccountMenu();
                    clearOverlays();
                    try {
                        if (hadRedirectFlag) {
                            setTimeout(() => { window.location.replace('/'); }, 50);
                        }
                    } catch {}
                    startAuthWatchdog();
                }
            } catch { __redirectInProgress = false; }
        });

        const APPLE_SIGNIN_ENABLED = false;

        // Defensive: ensure no overlay is blocking taps after auth
        function clearOverlays() {
            try {
                const modal = document.getElementById('authModal');
                const backdrop = document.getElementById('uploadBackdrop');
                if (modal) modal.style.display = (auth && auth.currentUser && !auth.currentUser.isAnonymous) ? 'none' : modal.style.display;
                if (backdrop) backdrop.style.display = 'none';
                document.body.style.overflow = '';
            } catch {}
        }

        function isInAppBrowser() {
            try {
                const ua = navigator.userAgent || '';
                return /(FBAN|FBAV|Instagram|Line|Twitter|TikTok|MicroMessenger|Snapchat|Pinterest)/i.test(ua);
            } catch { return false; }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try { await initFirebase(); } catch {}
            try { refreshAccountMenu(); } catch {}
            // Build Featured carousel from Firestore or fallback
            try {
                await initFirebase();
                const wrap = document.getElementById('heroCarousel');
                const dotsWrap = document.getElementById('heroDots');
                if (wrap && dotsWrap) {
                    let items = [];
                    try {
                        const snap = await db.collection('featured').orderBy('order','asc').limit(5).get();
                        items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    } catch {}
                    if (items.length === 0) {
                        // Hard fallback to ensure autoplay demo
                        items = [
                            { id: 'feat-demo-1', title: 'Featured', views: 5200, thumbnailUrl: 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=1200&h=675&fit=crop', videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4' }
                        ];
                    }
                    const fmt = (n) => { try { if (!n) return '0'; const abs=Math.abs(n); if (abs>=1e9) return (n/1e9).toFixed(1)+'B'; if (abs>=1e6) return (n/1e6).toFixed(1)+'M'; if (abs>=1e3) return (n/1e3).toFixed(1)+'K'; return String(n);} catch { return String(n||0);} };
                    wrap.innerHTML = items.map((it, i) => {
                        const viewsText = (typeof it.views === 'number') ? `${fmt(it.views)} views` : '';
                        return `
                        <div class=\"hero-slide${i===0?' active':''}\" style=\"position:relative; width:100%; height:200px;\">
                            <video ${i===0?'autoplay':''} muted playsinline loop src=\"${it.videoUrl||''}\" poster=\"${it.thumbnailUrl||''}\" style=\"width:100%;height:100%;object-fit:cover;\"></video>
                            <div style=\"position:absolute;left:0;right:0;bottom:0;padding:12px;background:linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0) 60%);display:flex;align-items:flex-end;justify-content:space-between;gap:12px;\">
                                <div style=\"color:#fff;max-width:70%;\">
                                    <div style=\"font-weight:700;font-size:16px;line-height:1.2;text-shadow:0 2px 8px rgba(0,0,0,.6);\">${it.title||'Featured'}</div>
                                    <div style=\"opacity:.9;font-size:12px;margin-top:4px;\">${viewsText}</div>
                                </div>
                                <button data-idx=\"${i}\" class=\"heroPlayBtn\" style=\"border:0;background:rgba(0,0,0,.55);color:#fff;border-radius:999px;padding:8px 12px;backdrop-filter:blur(4px);\">Play</button>
                            </div>
                        </div>`;
                    }).join('');
                    dotsWrap.innerHTML = items.map((_, i) => `<div class=\"hero-dot${i===0?' active':''}\" style=\"width:8px;height:8px;border-radius:50%;background:${i===0?'#ff4444':'#ddd'};\"></div>`).join('');
                    document.querySelectorAll('.heroPlayBtn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const idx = Number(e.currentTarget.getAttribute('data-idx'))||0;
                            const it = items[idx];
                            if (it && it.videoUrl) {
                                openVideoDetail({ id: it.id||('feat-'+idx), title: it.title||'Featured', description: '', thumbnail: it.thumbnailUrl, videoUrl: it.videoUrl, duration: '', views: 0, uploadTime: '', channel: { name: 'Featured', avatar: 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG', subscribers: 0 } });
                            }
                        });
                    });
                    initHeroCarousel();
                }
            } catch (e) { console.warn('Featured carousel init failed', e); }
        });

        function logAuth(msg) {
            try {
                if (location.search.includes('authdebug=1')) {
                    let box = document.getElementById('authDebugBox');
                    if (!box) {
                        box = document.createElement('div');
                        box.id = 'authDebugBox';
                        box.style.cssText = 'position:fixed;bottom:8px;left:8px;right:8px;max-height:40vh;overflow:auto;background:rgba(0,0,0,.7);color:#0f0;padding:8px;border-radius:8px;font:12px/1.4 monospace;z-index:99999;';
                        document.body.appendChild(box);
                    }
                    const line = document.createElement('div');
                    line.textContent = new Date().toISOString() + ' ' + msg;
                    box.appendChild(line);
                }
            } catch {}
        }

        function startAuthWatchdog() {
            let tries = 0;
            const t = setInterval(() => {
                tries++;
                const u = (auth && auth.currentUser) || null;
                logAuth('watchdog tick user=' + (u ? (u.uid || 'yes') : 'null'));
                if (u && !u.isAnonymous) {
                    try { refreshAccountMenu(); closeAuthModal(); clearOverlays(); } catch {}
                    clearInterval(t);
                }
                if (tries > 10) clearInterval(t);
            }, 500);
        }

        function openUploadModal() {
            const backdrop = document.getElementById('uploadBackdrop');
            const modal = document.getElementById('uploadModal');
            if (backdrop) backdrop.style.display = 'block';
            if (modal) modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        function closeUploadModal() {
            const backdrop = document.getElementById('uploadBackdrop');
            const modal = document.getElementById('uploadModal');
            if (backdrop) backdrop.style.display = 'none';
            if (modal) modal.style.display = 'none';
            document.body.style.overflow = '';
        }
        document.addEventListener('DOMContentLoaded', () => {
            const closeBtn = document.getElementById('closeUpload');
            if (closeBtn) closeBtn.addEventListener('click', closeUploadModal);
            const backdrop = document.getElementById('uploadBackdrop');
            if (backdrop) backdrop.addEventListener('click', closeUploadModal);
            // Wire upload flow
            const fileInput = document.getElementById('umFile');
            const publishBtn = document.getElementById('umPublish');
            const titleEl = document.getElementById('umTitle');
            const descEl = document.getElementById('umDesc');
            const catEl = document.getElementById('umCat');
            const prog = document.getElementById('umProgress');
            const fill = document.getElementById('umFill');
            const pct = document.getElementById('umPct');
            const preview = document.getElementById('umPreview');
            const zone = document.getElementById('umZone');
            if (zone && fileInput) {
                zone.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', () => {
                    const f = fileInput.files && fileInput.files[0];
                    if (preview) preview.style.display = f ? 'block' : 'none';
                    if (preview && f) preview.textContent = `${f.name} • ${(f.size/1024/1024).toFixed(2)} MB`;
                });
            }
            if (publishBtn) publishBtn.addEventListener('click', async () => {
                try {
                    await initFirebase();
                    const u = auth && auth.currentUser;
                    if (!u || u.isAnonymous) {
                        alert('Please sign in to upload.');
                        return;
                    }
                    const f = fileInput && fileInput.files && fileInput.files[0];
                    const title = (titleEl && titleEl.value || '').trim();
                    const description = (descEl && descEl.value || '').trim();
                    const category = (catEl && catEl.value) || '';
                    if (!f || !title) {
                        alert('Title and video file are required.');
                        return;
                    }
                    if (prog) prog.style.display = 'block';
                    if (fill) fill.style.width = '0%'; if (pct) pct.textContent = '0%';
                    const ref = storage.ref().child(`videos/${u.uid}/${Date.now()}_${f.name}`);
                    const task = ref.put(f, { contentType: f.type });
                    await new Promise((resolve, reject) => {
                        task.on('state_changed', (snap) => {
                            const p = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
                            if (fill) fill.style.width = p + '%'; if (pct) pct.textContent = p + '%';
                        }, reject, resolve);
                    });
                    const videoUrl = await ref.getDownloadURL();
                    // Optional: thumbnail extraction can be added later
                    const docRef = await db.collection('videos').add({
                        ownerId: u.uid,
                        title,
                        description,
                        category,
                        videoUrl,
                        thumbnailUrl: '',
                        duration: '',
                        views: 0,
                        likes: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    // Increment user's video count
                    const userRef = db.collection('users').doc(u.uid);
                    await userRef.set({ videos: firebase.firestore.FieldValue.increment(1) }, { merge: true });
                    if (prog) prog.style.display = 'none';
                    closeUploadModal();
                    pushNotification('Upload Complete', 'Your video has been published.');
                    // Refresh profile header and videos
                    try { loadProfileHeader(); } catch {}
                    try { loadProfileVideos(); } catch {}
                } catch (e) {
                    console.error('Upload failed', e);
                    alert(e?.message || 'Upload failed');
                }
            });
            // Show FAB for signed-in users
            const fab = document.getElementById('openUploadFab');
            if (fab) {
                fab.addEventListener('click', openUploadModal);
                setTimeout(async () => {
                    try { await initFirebase(); if (auth.currentUser && !auth.currentUser.isAnonymous) fab.style.display = 'flex'; } catch {}
                }, 800);
            }
        });

        // Notifications
        const notifState = { items: [] };
        function pushNotification(title, body) {
            notifState.items.unshift({ id: Date.now(), title, body, ts: new Date() });
            renderNotifications();
        }
        function renderNotifications() {
            const list = document.getElementById('notifList');
            const badge = document.getElementById('notifBadge');
            if (!list || !badge) return;
            list.innerHTML = notifState.items.map(n => `
                <div style=\"padding:10px 12px; border-bottom:1px solid #f5f5f5;\">
                    <div style=\"font-weight:600; font-size:13px;\">${n.title}</div>
                    <div style=\"font-size:12px; color:#6c757d;\">${n.body}</div>
                </div>`).join('');
            badge.style.display = notifState.items.length ? 'block' : 'none';
        }
        document.addEventListener('DOMContentLoaded', () => {
            const bell = document.getElementById('notifBell');
            const menu = document.getElementById('notifMenu');
            if (bell && menu) {
                bell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
                });
                document.addEventListener('click', () => { menu.style.display = 'none'; });
            }
        });

        // After auth sign-in, send welcome notification once per user/device
        async function maybeSendWelcomeNotification() {
            try {
                await initFirebase();
                const u = auth && auth.currentUser;
                if (!u || u.isAnonymous) return;
                const key = 'mc_welcome_notif_' + u.uid;
                const sent = localStorage.getItem(key) === '1';
                if (!sent) {
                    pushNotification('Welcome to MyChannel 🎉', 'Thanks for joining! Tap Create to upload your first video.');
                    localStorage.setItem(key, '1');
                }
            } catch {}
        }
        // Hook into auth listener
        (function(){
            const _orig = window.__authListenerBound;
            setTimeout(maybeSendWelcomeNotification, 1200);
        })();

        // Avatar helpers
        function applyAvatarToUI(avatarUrl) {
            try {
                if (!avatarUrl) return;
                const profileAvatarEl = document.getElementById('profileAvatarEl');
                if (profileAvatarEl) profileAvatarEl.style.background = `url('${avatarUrl}') center/cover`;
                const accountBtn = document.getElementById('accountButton');
                if (accountBtn) {
                    accountBtn.style.background = `url('${avatarUrl}') center/cover`;
                    accountBtn.textContent = '';
                }
            } catch {}
        }
        function refreshStoriesForAvatar() {
            try { if (typeof updateStoriesUI === 'function') updateStoriesUI(); } catch {}
        }

        async function loadProfileHeader() {
            try {
                await initFirebase();
                const u = auth && auth.currentUser;
                const subsEl = document.querySelector('#profileHeaderCountsSubs');
                const vidsEl = document.querySelector('#profileHeaderCountsVids');
                const viewsEl = document.querySelector('#profileHeaderCountsViews');
                const nameEl = document.getElementById('profileDisplayNameEl');
                const handleEl = document.getElementById('profileHandleEl');
                if (!u || u.isAnonymous) {
                    if (subsEl) subsEl.textContent = '0';
                    if (vidsEl) vidsEl.textContent = '0';
                    if (viewsEl) viewsEl.textContent = '0';
                    return;
                }
                handleEl.textContent = '@' + (u.email ? u.email.split('@')[0] : 'user');
                nameEl.textContent = u.displayName || 'MyChannel User';
                const snap = await db.collection('users').doc(u.uid).get();
                const d = snap.exists ? snap.data() : {};
                if (subsEl) subsEl.textContent = String(d.subscribers || 0);
                if (vidsEl) vidsEl.textContent = String(d.videos || 0);
                if (viewsEl) viewsEl.textContent = String(d.views || 0);
            } catch {}
        }
        document.addEventListener('DOMContentLoaded', loadProfileHeader);

        async function loadProfileVideos() {
            try {
                await initFirebase();
                const u = auth && auth.currentUser;
                const grid = document.getElementById('profileVideosGrid');
                const empty = document.getElementById('profileVideosEmpty');
                const countEl = document.getElementById('profileVideosCount');
                if (!grid || !empty) return;
                grid.innerHTML = '';
                if (!u || u.isAnonymous) {
                    empty.style.display = 'block';
                    if (countEl) countEl.textContent = '0';
                    return;
                }
                const qs = await db.collection('videos').where('ownerId','==', u.uid).orderBy('createdAt','desc').limit(50).get();
                const docs = qs.docs.map(d => ({ id: d.id, ...d.data() }));
                if (countEl) countEl.textContent = String(docs.length);
                if (!docs.length) {
                    empty.style.display = 'block';
                    return;
                }
                empty.style.display = 'none';
                docs.forEach(v => {
                    const card = document.createElement('div');
                    card.style.background = '#1a1a1a';
                    card.style.borderRadius = '8px';
                    card.style.overflow = 'hidden';
                    card.innerHTML = `
                        <div style="position: relative;">
                            <img src="${v.thumbnailUrl || '/api/placeholder/320/180'}" style="width: 100%; aspect-ratio: 16/9; object-fit: cover;">
                            <div style="position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.8); color: white; padding: 1px 4px; border-radius: 3px; font-size: 10px;">${v.duration || ''}</div>
                        </div>
                        <div style="padding: 8px;">
                            <h4 style="color: white; font-size: 12px; font-weight: 500; margin: 0; line-height: 1.2;">${v.title || 'Untitled'}</h4>
                            <p style="color: #666; font-size: 10px; margin: 2px 0 0 0;">${(v.views || 0)} views</p>
                        </div>`;
                    card.onclick = () => openVideoDetail({
                        id: v.id,
                        title: v.title || 'Untitled',
                        description: v.description || '',
                        thumbnail: v.thumbnailUrl,
                        videoUrl: v.videoUrl,
                        duration: v.duration || '',
                        views: v.views || 0,
                        uploadTime: v.createdAt ? new Date(v.createdAt.seconds*1000).toLocaleDateString() : '',
                        channel: { name: (auth.currentUser?.displayName || 'You'), avatar: auth.currentUser?.photoURL || 'assets/UserProfileAvatar.imageset/UserProfileAvatar.PNG', subscribers: 0 }
                    });
                    grid.appendChild(card);
                });
            } catch (e) {
                console.error('loadProfileVideos failed', e);
            }
        }
        document.addEventListener('DOMContentLoaded', () => setTimeout(loadProfileVideos, 1200));

        // Load user's Flicks (shorts) grid if/when implemented; default empty
        async function loadFlicksTab() {
            try {
                await initFirebase();
                const u = auth && auth.currentUser;
                const grid = document.getElementById('flicksGrid');
                const empty = document.getElementById('flicksEmpty');
                if (!grid || !empty) return;
                grid.innerHTML = '';
                if (!u || u.isAnonymous) { empty.style.display = 'block'; return; }
                const qs = await db.collection('flicks').where('ownerId','==',u.uid).orderBy('createdAt','desc').limit(60).get();
                const docs = qs.docs.map(d => ({ id:d.id, ...d.data() }));
                if (docs.length === 0) { empty.style.display = 'block'; return; }
                empty.style.display = 'none';
                docs.forEach(f => {
                    const cell = document.createElement('div');
                    cell.className = 'flick-item';
                    cell.style.cssText = 'aspect-ratio:9/16;background:#1a1a1a;border-radius:12px;overflow:hidden;position:relative;';
                    cell.innerHTML = `
                        <img src="${f.thumbnailUrl||'/api/placeholder/180/320'}" alt="Flick" style="width:100%;height:100%;object-fit:cover;">
                        <div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.8);color:white;padding:2px 6px;border-radius:4px;font-size:10px;">${f.duration||''}</div>
                    `;
                    grid.appendChild(cell);
                });
            } catch (e) { console.error('loadFlicksTab failed', e); }
        }

        async function fetchFollowedStories() {
            try {
                await initFirebase();
                const u = auth && auth.currentUser;
                if (!u || u.isAnonymous) return;
                const doc = await db.collection('users').doc(u.uid).get();
                const following = (doc.exists && Array.isArray(doc.data().following)) ? doc.data().following : [];
                // Filter firebaseStories by following list + own story
                const currentId = u.uid;
                firebaseStories = firebaseStories.filter(s => s.userId === currentId || following.includes(s.userId));
                updateStoriesUI();
            } catch {}
        }
        document.addEventListener('DOMContentLoaded', () => setTimeout(fetchFollowedStories, 1500));
    </script>

    <!-- Advanced Notifications Panel -->
    <div id="notificationsPanel" class="notifications-panel">
        <div class="notifications-header">
            <h3 style="margin:0; font-weight:600; color:var(--text-primary); display:flex; align-items:center; gap:8px;">
                🔔 Notifications
                <span id="notificationCount" class="notification-badge">0</span>
            </h3>
            <div style="display:flex; gap:8px; align-items:center;">
                <button onclick="markAllNotificationsRead()" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:12px;">Mark all read</button>
                <button onclick="toggleNotificationsPanel()" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:18px;">&times;</button>
            </div>
        </div>
        
        <div class="notifications-filters">
            <button class="notification-filter active" data-filter="all">All</button>
            <button class="notification-filter" data-filter="likes">❤️ Likes</button>
            <button class="notification-filter" data-filter="comments">💬 Comments</button>
            <button class="notification-filter" data-filter="follows">👥 Follows</button>
            <button class="notification-filter" data-filter="uploads">📹 Uploads</button>
            <button class="notification-filter" data-filter="live">🔴 Live</button>
        </div>
        
        <div id="notificationsList" class="notifications-list">
            <div class="notifications-empty">
                <div style="text-align:center; padding:40px 20px; color:var(--text-secondary);">
                    <div style="font-size:48px; margin-bottom:12px;">🔔</div>
                    <div style="font-size:16px; margin-bottom:8px;">No notifications yet</div>
                    <div style="font-size:12px;">We'll notify you when something happens!</div>
                </div>
            </div>
        </div>
        
        <div class="notifications-settings">
            <div style="padding:16px; border-top:1px solid var(--border); background:var(--bg-secondary);">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                    <span style="font-size:14px; font-weight:600; color:var(--text-primary);">Notification Settings</span>
                    <button onclick="openNotificationSettings()" style="background:var(--primary); color:#fff; border:none; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">⚙️ Settings</button>
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:8px; font-size:11px;">
                    <label style="display:flex; align-items:center; gap:4px; color:var(--text-secondary);">
                        <input type="checkbox" id="pushNotifications" checked>
                        Push notifications
                    </label>
                    <label style="display:flex; align-items:center; gap:4px; color:var(--text-secondary);">
                        <input type="checkbox" id="emailNotifications" checked>
                        Email notifications
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Settings Modal -->
    <div id="notificationSettingsModal" class="upload-modal-backdrop">
        <div class="upload-modal">
            <div class="upload-card">
                <div class="upload-header">
                    <h3 style="margin:0; font-weight:600; color:var(--text-primary);">🔔 Notification Settings</h3>
                    <button class="upload-close" onclick="closeNotificationSettings()">&times;</button>
                </div>
                <div class="upload-body">
                    <div class="upload-row">
                        <h4 style="margin:0 0 12px 0; color:var(--text-primary);">Push Notifications</h4>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>New likes on your videos</span>
                                <input type="checkbox" class="notification-toggle" data-type="likes" checked>
                            </label>
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>New comments on your videos</span>
                                <input type="checkbox" class="notification-toggle" data-type="comments" checked>
                            </label>
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>New followers</span>
                                <input type="checkbox" class="notification-toggle" data-type="follows" checked>
                            </label>
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>Someone you follow goes live</span>
                                <input type="checkbox" class="notification-toggle" data-type="live" checked>
                            </label>
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>Someone you follow uploads</span>
                                <input type="checkbox" class="notification-toggle" data-type="uploads" checked>
                            </label>
                        </div>
                    </div>
                    
                    <div class="upload-row">
                        <h4 style="margin:0 0 12px 0; color:var(--text-primary);">Email Notifications</h4>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>Weekly activity summary</span>
                                <input type="checkbox" class="email-toggle" data-type="weekly" checked>
                            </label>
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>Monthly analytics report</span>
                                <input type="checkbox" class="email-toggle" data-type="monthly" checked>
                            </label>
                            <label style="display:flex; align-items:center; justify-content:space-between; padding:8px 0;">
                                <span>Product updates and news</span>
                                <input type="checkbox" class="email-toggle" data-type="updates">
                            </label>
                        </div>
                    </div>
                    
                    <div class="upload-row">
                        <h4 style="margin:0 0 12px 0; color:var(--text-primary);">Quiet Hours</h4>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">Start Time</label>
                                <input type="time" id="quietStart" value="22:00" class="upload-input-text">
                            </div>
                            <div>
                                <label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">End Time</label>
                                <input type="time" id="quietEnd" value="08:00" class="upload-input-text">
                            </div>
                        </div>
                        <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">No notifications will be sent during these hours</div>
                    </div>
                    
                    <div class="upload-row">
                        <button onclick="saveNotificationSettings()" class="btn-enhanced" style="width:100%;">💾 Save Settings</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Streaming Modal -->
    <div id="liveStreamModal" class="upload-modal-backdrop">
        <div class="upload-modal">
            <div class="upload-card">
                <div class="upload-header">
                    <h3 style="margin:0; font-weight:600; color:var(--text-primary);">🔴 Go Live</h3>
                    <button class="upload-close" onclick="closeLiveStreamModal()">&times;</button>
                </div>
                <div class="upload-body">
                    <!-- Stream Setup -->
                    <div id="streamSetup">
                        <div class="upload-row">
                            <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Stream Title *</label>
                            <input type="text" id="streamTitle" class="upload-input-text" placeholder="What's your stream about?" maxlength="100">
                            <div style="text-align:right; font-size:11px; color:var(--text-secondary); margin-top:2px;"><span id="streamTitleCount">0</span>/100</div>
                        </div>
                        
                        <div class="upload-row">
                            <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Description</label>
                            <textarea id="streamDesc" class="upload-textarea" rows="2" placeholder="Tell viewers what to expect" maxlength="300"></textarea>
                            <div style="text-align:right; font-size:11px; color:var(--text-secondary); margin-top:2px;"><span id="streamDescCount">0</span>/300</div>
                        </div>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;" class="upload-row">
                            <div>
                                <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Category</label>
                                <select id="streamCategory" class="upload-select">
                                    <option value="gaming">🎮 Gaming</option>
                                    <option value="music">🎵 Music</option>
                                    <option value="talk">💬 Just Chatting</option>
                                    <option value="education">📚 Education</option>
                                    <option value="art">🎨 Art & Creative</option>
                                    <option value="cooking">👨‍🍳 Cooking</option>
                                    <option value="fitness">💪 Fitness</option>
                                    <option value="tech">💻 Tech</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Quality</label>
                                <select id="streamQuality" class="upload-select">
                                    <option value="720p">HD 720p</option>
                                    <option value="1080p">Full HD 1080p</option>
                                    <option value="480p">SD 480p</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Camera Preview -->
                        <div class="upload-row">
                            <label style="display:block; font-weight:600; margin-bottom:8px; color:var(--text-primary);">Camera Preview</label>
                            <div style="position:relative; background:#000; border-radius:8px; overflow:hidden; aspect-ratio:16/9;">
                                <video id="cameraPreview" style="width:100%; height:100%; object-fit:cover;" muted autoplay playsinline></video>
                                <div id="cameraStatus" style="position:absolute; top:12px; left:12px; background:rgba(0,0,0,0.7); color:#fff; padding:4px 8px; border-radius:4px; font-size:12px;">📷 Camera Off</div>
                                <div style="position:absolute; bottom:12px; right:12px; display:flex; gap:8px;">
                                    <button id="toggleCamera" onclick="toggleCamera()" style="background:rgba(255,255,255,0.2); border:none; border-radius:50%; width:40px; height:40px; color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center;">📷</button>
                                    <button id="toggleMic" onclick="toggleMic()" style="background:rgba(255,255,255,0.2); border:none; border-radius:50%; width:40px; height:40px; color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center;">🎤</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stream Settings -->
                        <div class="upload-row">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                                <input type="checkbox" id="enableChat" checked>
                                <label for="enableChat" style="font-size:14px; color:var(--text-primary);">Enable live chat</label>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                                <input type="checkbox" id="recordStream" checked>
                                <label for="recordStream" style="font-size:14px; color:var(--text-primary);">Save stream recording</label>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <input type="checkbox" id="notifyFollowers" checked>
                                <label for="notifyFollowers" style="font-size:14px; color:var(--text-primary);">Notify followers</label>
                            </div>
                        </div>
                        
                        <!-- Stream Actions -->
                        <div class="upload-row">
                            <button id="startStreamBtn" class="btn-enhanced" style="width:100%; background:var(--error); font-size:16px; font-weight:600;">🔴 Start Streaming</button>
                            <button id="streamSignIn" class="btn-enhanced" style="width:100%; margin-top:8px; display:none; background:#1a73e8;">Sign in with Google to Stream</button>
                        </div>
                    </div>
                    
                    <!-- Live Stream Interface -->
                    <div id="liveStreamInterface" style="display:none;">
                        <div style="text-align:center; margin-bottom:16px;">
                            <div style="display:inline-flex; align-items:center; gap:8px; background:var(--error); color:#fff; padding:8px 16px; border-radius:20px; font-weight:600;">
                                <div style="width:8px; height:8px; background:#fff; border-radius:50%; animation:pulse 2s infinite;"></div>
                                LIVE
                            </div>
                        </div>
                        
                        <!-- Stream Stats -->
                        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-bottom:16px;">
                            <div style="text-align:center; padding:12px; background:var(--bg-secondary); border-radius:8px;">
                                <div style="font-size:20px; font-weight:600; color:var(--text-primary);" id="viewerCount">0</div>
                                <div style="font-size:12px; color:var(--text-secondary);">Viewers</div>
                            </div>
                            <div style="text-align:center; padding:12px; background:var(--bg-secondary); border-radius:8px;">
                                <div style="font-size:20px; font-weight:600; color:var(--text-primary);" id="streamDuration">00:00</div>
                                <div style="font-size:12px; color:var(--text-secondary);">Duration</div>
                            </div>
                            <div style="text-align:center; padding:12px; background:var(--bg-secondary); border-radius:8px;">
                                <div style="font-size:20px; font-weight:600; color:var(--text-primary);" id="chatMessages">0</div>
                                <div style="font-size:12px; color:var(--text-secondary);">Messages</div>
                            </div>
                        </div>
                        
                        <!-- Live Chat Preview -->
                        <div style="background:var(--bg-secondary); border-radius:8px; padding:12px; margin-bottom:16px; height:120px; overflow-y:auto;" id="liveChatPreview">
                            <div style="font-size:12px; color:var(--text-secondary); text-align:center; padding:20px;">Live chat will appear here...</div>
                        </div>
                        
                        <!-- Stream Controls -->
                        <div style="display:flex; gap:8px;">
                            <button onclick="toggleStreamCamera()" class="btn-enhanced" style="flex:1; background:var(--bg-secondary); color:var(--text-primary); border:1px solid var(--border);">📷 Camera</button>
                            <button onclick="toggleStreamMic()" class="btn-enhanced" style="flex:1; background:var(--bg-secondary); color:var(--text-primary); border:1px solid var(--border);">🎤 Mic</button>
                            <button onclick="endStream()" class="btn-enhanced" style="flex:2; background:var(--error);">⏹️ End Stream</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Upload Modal with Advanced Features -->
    <div id="uploadModal" class="upload-modal-backdrop">
        <div class="upload-modal">
            <div class="upload-card">
                <div class="upload-header">
                    <h3 style="margin:0; font-weight:600; color:var(--text-primary);">Upload Video</h3>
                    <button class="upload-close" onclick="closeUploadModal()">&times;</button>
                </div>
                <div class="upload-body">
                    <!-- Enhanced Upload Zone with Drag & Drop -->
                    <div id="uploadZone" class="upload-zone enhanced-upload-zone" onclick="document.getElementById('videoFileInput').click()">
                        <div id="uploadZoneContent">
                            <div style="font-size:48px; margin-bottom:12px; color:var(--text-secondary);">📹</div>
                            <div style="font-size:16px; font-weight:600; margin-bottom:8px; color:var(--text-primary);">Choose video to upload</div>
                            <div style="font-size:12px; color:var(--text-secondary); margin-bottom:12px;">MP4, MOV, AVI up to 2GB • Drag and drop supported</div>
                            <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
                                <span style="background:var(--primary); color:#fff; padding:4px 8px; border-radius:12px; font-size:10px;">HD Quality</span>
                                <span style="background:var(--success); color:#fff; padding:4px 8px; border-radius:12px; font-size:10px;">Auto Compression</span>
                                <span style="background:var(--accent); color:#000; padding:4px 8px; border-radius:12px; font-size:10px;">Fast Upload</span>
                            </div>
                        </div>
                        <input type="file" id="videoFileInput" class="upload-input" accept="video/*" multiple>
                    </div>
                    
                    <!-- Video Preview Section -->
                    <div id="videoPreviewSection" style="display:none; margin-bottom:16px;">
                        <div style="background:var(--bg-secondary); border-radius:8px; padding:12px;">
                            <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                                <video id="videoPreview" style="width:80px; height:45px; border-radius:4px; object-fit:cover;" muted></video>
                                <div style="flex:1;">
                                    <div id="videoFileName" style="font-weight:600; font-size:14px; color:var(--text-primary);"></div>
                                    <div id="videoFileInfo" style="font-size:12px; color:var(--text-secondary);"></div>
                                </div>
                                <button onclick="removeVideoFile()" style="background:var(--error); color:#fff; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer; font-size:12px;">&times;</button>
                            </div>
                            <div id="videoAnalysis" style="font-size:11px; color:var(--text-secondary); display:flex; gap:12px; flex-wrap:wrap;"></div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Form Fields -->
                    <div class="upload-row">
                        <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Title *</label>
                        <input type="text" id="umTitle" class="upload-input-text" placeholder="Enter video title" maxlength="100">
                        <div style="text-align:right; font-size:11px; color:var(--text-secondary); margin-top:2px;"><span id="titleCount">0</span>/100</div>
                    </div>
                    
                    <div class="upload-row">
                        <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Description</label>
                        <textarea id="umDesc" class="upload-textarea" rows="3" placeholder="Tell viewers about your video" maxlength="500"></textarea>
                        <div style="text-align:right; font-size:11px; color:var(--text-secondary); margin-top:2px;"><span id="descCount">0</span>/500</div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;" class="upload-row">
                        <div>
                            <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Category</label>
                            <select id="umCategory" class="upload-select">
                                <option value="entertainment">🎭 Entertainment</option>
                                <option value="music">🎵 Music</option>
                                <option value="gaming">🎮 Gaming</option>
                                <option value="education">📚 Education</option>
                                <option value="news">📰 News</option>
                                <option value="sports">⚽ Sports</option>
                                <option value="tech">💻 Tech</option>
                                <option value="lifestyle">✨ Lifestyle</option>
                                <option value="comedy">😂 Comedy</option>
                                <option value="travel">✈️ Travel</option>
                            </select>
                        </div>
                        <div>
                            <label style="display:block; font-weight:600; margin-bottom:4px; color:var(--text-primary);">Visibility</label>
                            <select id="umVisibility" class="upload-select">
                                <option value="public">🌍 Public</option>
                                <option value="unlisted">🔗 Unlisted</option>
                                <option value="private">🔒 Private</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Thumbnail Options -->
                    <div class="upload-row">
                        <label style="display:block; font-weight:600; margin-bottom:8px; color:var(--text-primary);">Thumbnail</label>
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(80px, 1fr)); gap:8px; margin-bottom:8px;" id="thumbnailOptions">
                            <!-- Auto-generated thumbnails will appear here -->
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="file" id="umThumb" accept="image/*" style="display:none;">
                            <button onclick="document.getElementById('umThumb').click()" style="flex:1; padding:8px 12px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary); cursor:pointer; font-size:12px;">📁 Upload Custom</button>
                            <button onclick="generateThumbnails()" style="flex:1; padding:8px 12px; background:var(--accent); border:none; border-radius:6px; color:#000; cursor:pointer; font-size:12px; font-weight:600;">✨ Auto Generate</button>
                        </div>
                    </div>
                    
                    <!-- Advanced Options -->
                    <div class="upload-row">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                            <input type="checkbox" id="enableComments" checked>
                            <label for="enableComments" style="font-size:14px; color:var(--text-primary);">Allow comments</label>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                            <input type="checkbox" id="enableLikes" checked>
                            <label for="enableLikes" style="font-size:14px; color:var(--text-primary);">Show like/dislike counts</label>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <input type="checkbox" id="enableNotifications" checked>
                            <label for="enableNotifications" style="font-size:14px; color:var(--text-primary);">Notify subscribers</label>
                        </div>
                    </div>
                    
                    <!-- Upload Actions -->
                    <div class="upload-row">
                        <div style="display:flex; gap:8px;">
                            <button id="umSaveDraft" class="btn-enhanced" style="flex:1; background:var(--bg-secondary); color:var(--text-primary); border:1px solid var(--border);">💾 Save Draft</button>
                            <button id="umPublish" class="btn-enhanced" style="flex:2;">🚀 Publish Video</button>
                        </div>
                        <button id="umSignIn" class="btn-enhanced" style="width:100%; margin-top:8px; display:none; background:#1a73e8;">Sign in with Google to Upload</button>
                    </div>

                    <!-- Enhanced Progress Section -->
                    <div class="upload-progress" id="umProgress">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                            <div style="font-weight:600; color:var(--text-primary);">Uploading...</div>
                            <div style="font-size:12px; color:var(--text-secondary);">
                                <span id="uploadSpeed">0 MB/s</span> • <span id="timeRemaining">Calculating...</span>
                            </div>
                        </div>
                        <div class="upload-progress-bar">
                            <div class="upload-progress-fill" id="umFill"></div>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--text-secondary); margin-top:6px;">
                            <span id="uploadStatus">Preparing upload...</span>
                            <span id="umPct">0%</span>
                        </div>
                        <div id="uploadSteps" style="margin-top:12px; font-size:11px; color:var(--text-secondary);">
                            <div id="step1" style="margin-bottom:4px;">📁 File validation: <span style="color:var(--warning);">Pending</span></div>
                            <div id="step2" style="margin-bottom:4px;">📤 Upload: <span style="color:var(--text-secondary);">Waiting</span></div>
                            <div id="step3" style="margin-bottom:4px;">🎬 Processing: <span style="color:var(--text-secondary);">Waiting</span></div>
                            <div id="step4">✅ Publishing: <span style="color:var(--text-secondary);">Waiting</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="site-footer" role="contentinfo" style="margin-top:64px; padding:32px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border); color: var(--text-secondary);">
        <div style="max-width:1200px; margin:0 auto; display:flex; flex-wrap:wrap; gap:16px; align-items:center; justify-content:space-between;">
            <div style="font-size:14px;">&copy; 2025 MyChannel. All rights reserved.</div>
            <nav aria-label="Footer" style="display:flex; gap:16px; font-size:14px; flex-wrap:wrap;">
                <a href="/privacy.html" style="color:var(--text-primary); text-decoration:none;">Privacy</a>
                <a href="/terms.html" style="color:var(--text-primary); text-decoration:none;">Terms</a>
                <a href="/contact.html" style="color:var(--text-primary); text-decoration:none;">Contact</a>
                <a href="/sitemap.xml" style="color:var(--text-primary); text-decoration:none;">Sitemap</a>
            </nav>
        </div>
    </footer>

    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js?v=104').catch(function(e){
                    console.error('SW registration failed', e);
                });
            });
        }
    </script>

    <script>
        // Flicks Viewer Implementation
        let currentFlickIndex = 0;
        let flicksData = [];
        let flicksSwipeStartY = 0;
        let flicksSwipeEndY = 0;

        // Sample flicks data - replace with real data from your backend
        const sampleFlicks = [
            {
                id: '1',
                title: 'Amazing Sunset Timelapse',
                creator: 'NatureFilms',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                likes: 1234,
                comments: 89,
                shares: 45
            },
            {
                id: '2', 
                title: 'City Life in 60 Seconds',
                creator: 'UrbanExplorer',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4',
                likes: 2156,
                comments: 134,
                shares: 78
            },
            {
                id: '3',
                title: 'Quick Recipe: Pasta Magic',
                creator: 'ChefMike',
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4',
                likes: 3421,
                comments: 267,
                shares: 156
            }
        ];

        function openFlicks(startIndex = 0) {
            flicksData = sampleFlicks;
            currentFlickIndex = startIndex;
            const viewer = document.getElementById('flicksViewer');
            viewer.classList.add('active');
            document.body.style.overflow = 'hidden';
            renderFlicks();
            setupFlicksGestures();
        }

        function closeFlicks() {
            const viewer = document.getElementById('flicksViewer');
            viewer.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Enhanced Movie Integration with Fallback Data
        const fallbackMovies = [
            {
                id: 1,
                title: "The Shawshank Redemption",
                overview: "Two imprisoned men bond over a number of years, finding solace and eventual redemption through acts of common decency.",
                poster: "https://image.tmdb.org/t/p/w780/q6y0Go1tsGEsmtFryDOJo3dEmqu.jpg",
                vote_average: 9.3,
                release_date: "1994-09-23"
            },
            {
                id: 2,
                title: "The Godfather",
                overview: "The aging patriarch of an organized crime dynasty transfers control of his clandestine empire to his reluctant son.",
                poster: "https://image.tmdb.org/t/p/w780/3bhkrj58Vtu7enYsRolD1fZdja1.jpg",
                vote_average: 9.2,
                release_date: "1972-03-14"
            },
            {
                id: 3,
                title: "The Dark Knight",
                overview: "When the menace known as the Joker wreaks havoc and chaos on the people of Gotham, Batman must accept one of the greatest psychological and physical tests.",
                poster: "https://image.tmdb.org/t/p/w780/qJ2tW6WMUDux911r6m7haRef0WH.jpg",
                vote_average: 9.0,
                release_date: "2008-07-18"
            },
            {
                id: 4,
                title: "Pulp Fiction",
                overview: "The lives of two mob hitmen, a boxer, a gangster and his wife, and a pair of diner bandits intertwine in four tales of violence and redemption.",
                poster: "https://image.tmdb.org/t/p/w780/d5iIlFn5s0ImszYzBPb8JPIfbXD.jpg",
                vote_average: 8.9,
                release_date: "1994-10-14"
            },
            {
                id: 5,
                title: "Forrest Gump",
                overview: "The presidencies of Kennedy and Johnson, the Vietnam War, the Watergate scandal and other historical events unfold from the perspective of an Alabama man.",
                poster: "https://image.tmdb.org/t/p/w780/arw2vcBveWOVZr6pxd9XTd1TdQa.jpg",
                vote_average: 8.8,
                release_date: "1994-06-23"
            },
            {
                id: 6,
                title: "Inception",
                overview: "A thief who steals corporate secrets through the use of dream-sharing technology is given the inverse task of planting an idea into the mind of a C.E.O.",
                poster: "https://image.tmdb.org/t/p/w780/9gk7adHYeDvHkCSEqAvQNLV5Uge.jpg",
                vote_average: 8.8,
                release_date: "2010-07-15"
            },
            {
                id: 7,
                title: "The Matrix",
                overview: "A computer programmer is led to fight an underground war against powerful computers who have constructed his entire reality with a system called the Matrix.",
                poster: "https://image.tmdb.org/t/p/w780/f89U3ADr1oiB1s9GkdPOEpXUk5H.jpg",
                vote_average: 8.7,
                release_date: "1999-03-30"
            },
            {
                id: 8,
                title: "Goodfellas",
                overview: "The story of Henry Hill and his life in the mob, covering his relationship with his wife Karen Hill and his mob partners.",
                poster: "https://image.tmdb.org/t/p/w780/aKuFiU82s5ISJpGZp7YkIr3kCUd.jpg",
                vote_average: 8.7,
                release_date: "1990-09-12"
            }
        ];
        
        async function loadFreeMovies(provider = 'all') {
            try {
                const response = await fetch(`/api/tmdb_free_ads?provider=${provider}&region=US`);
                if (!response.ok) throw new Error('API not available');
                const data = await response.json();
                renderMovies(data.items);
            } catch (error) {
                console.log('Using fallback movie data');
                renderMovies(fallbackMovies);
            }
        }
        
        function renderMovies(movies) {
            const container = document.getElementById('freeMoviesRow');
            if (!container) return;
            
            const fragment = document.createDocumentFragment();
            movies.forEach(movie => {
                const movieCard = document.createElement('div');
                movieCard.className = 'video-card';
                movieCard.style.cssText = 'min-width:180px; flex-shrink:0; cursor:pointer; scroll-snap-align:start;';
                movieCard.onclick = () => openMovieModal(movie.id, 'movie');
                
                movieCard.innerHTML = `
                    <div class="video-thumbnail">
                        <img src="${movie.poster}" alt="${movie.title}" loading="lazy" style="width:100%; height:100%; object-fit:cover; border-radius:8px;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjI3MCIgdmlld0JveD0iMCAwIDE4MCAyNzAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMjcwIiBmaWxsPSIjMzMzIi8+Cjx0ZXh0IHg9IjkwIiB5PSIxMzUiIGZpbGw9IiM2NjYiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+TW92aWUgUG9zdGVyPC90ZXh0Pgo8L3N2Zz4K'">
                        <div class="video-duration">Movie</div>
                    </div>
                    <div class="video-info">
                        <h3 class="video-title">${movie.title}</h3>
                        <p class="video-description">${movie.overview.substring(0, 80)}${movie.overview.length > 80 ? '...' : ''}</p>
                        <div class="video-stats">
                            <span>⭐ ${movie.vote_average.toFixed(1)}</span>
                            <span>${movie.release_date.split('-')[0] || 'N/A'}</span>
                        </div>
                    </div>
                `;
                fragment.appendChild(movieCard);
            });
            container.innerHTML = '';
            container.appendChild(fragment);
        }
        
        // Fallback trending data
        const fallbackTrending = [
            {
                id: 101,
                title: "Spider-Man: No Way Home",
                overview: "Peter Parker is unmasked and no longer able to separate his normal life from the high-stakes of being a super-hero.",
                poster: "https://image.tmdb.org/t/p/w780/1g0dhYtq4irTY1GPXvft6k4YLjm.jpg",
                vote_average: 8.4,
                release_date: "2021-12-15"
            },
            {
                id: 102,
                title: "Top Gun: Maverick",
                overview: "After more than thirty years of service as one of the Navy's top aviators, Pete Mitchell is where he belongs, pushing the envelope as a courageous test pilot.",
                poster: "https://image.tmdb.org/t/p/w780/62HCnUTziyWcpDaBO2i1DX17ljH.jpg",
                vote_average: 8.3,
                release_date: "2022-05-24"
            }
        ];
        
        async function loadTrending(mediaType = 'movie') {
            try {
                const response = await fetch(`/api/tmdb_trending?media_type=${mediaType}&time_window=week`);
                if (!response.ok) throw new Error('API not available');
                const data = await response.json();
                renderTrendingMovies(data.items);
            } catch (error) {
                console.log('Using fallback trending data');
                renderTrendingMovies(fallbackTrending);
            }
        }
        
        function renderTrendingMovies(movies) {
            const container = document.getElementById('trendingRow');
            if (!container) return;
            
            const fragment = document.createDocumentFragment();
            movies.forEach(movie => {
                const movieCard = document.createElement('div');
                movieCard.className = 'video-card';
                movieCard.style.cssText = 'min-width:180px; flex-shrink:0; cursor:pointer; scroll-snap-align:start;';
                movieCard.onclick = () => openMovieModal(movie.id, 'movie');
                
                movieCard.innerHTML = `
                    <div class="video-thumbnail">
                        <img src="${movie.poster}" alt="${movie.title}" loading="lazy" style="width:100%; height:100%; object-fit:cover; border-radius:8px;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjI3MCIgdmlld0JveD0iMCAwIDE4MCAyNzAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMjcwIiBmaWxsPSIjMzMzIi8+Cjx0ZXh0IHg9IjkwIiB5PSIxMzUiIGZpbGw9IiM2NjYiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+TW92aWUgUG9zdGVyPC90ZXh0Pgo8L3N2Zz4K'">
                        <div class="video-duration">Trending</div>
                    </div>
                    <div class="video-info">
                        <h3 class="video-title">${movie.title}</h3>
                        <p class="video-description">${movie.overview.substring(0, 80)}${movie.overview.length > 80 ? '...' : ''}</p>
                        <div class="video-stats">
                            <span>⭐ ${movie.vote_average.toFixed(1)}</span>
                            <span>${movie.release_date.split('-')[0] || 'N/A'}</span>
                        </div>
                    </div>
                `;
                fragment.appendChild(movieCard);
            });
            container.innerHTML = '';
            container.appendChild(fragment);
        }
        
        async function openMovieModal(movieId, mediaType = 'movie') {
            try {
                let movie;
                try {
                    const response = await fetch(`/api/tmdb_details?id=${movieId}&media_type=${mediaType}`);
                    if (!response.ok) throw new Error('API not available');
                    movie = await response.json();
                } catch (error) {
                    // Use fallback data
                    const allMovies = [...fallbackMovies, ...fallbackTrending];
                    movie = allMovies.find(m => m.id === movieId) || {
                        id: movieId,
                        title: "Sample Movie",
                        overview: "This is a sample movie description. The actual movie data will be available once the API is connected.",
                        poster: "https://image.tmdb.org/t/p/w780/sample.jpg",
                        vote_average: 8.0,
                        release_date: "2023-01-01",
                        runtime: 120,
                        genres: ["Action", "Drama"],
                        watch_providers: { free: [] }
                    };
                }
                
                // Create modal with movie data
                const modal = createMovieModal(movie);
                document.body.appendChild(modal);
                
                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                
            } catch (error) {
                console.error('Error loading movie details:', error);
            }
        }
        
        function createMovieModal(movie) {
{{ ... }}
                    // Create modal
                const modal = document.createElement('div');
                modal.className = 'upload-modal-backdrop';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="upload-modal" style="display:flex;">
                        <div class="upload-card" style="max-width:800px;">
                            <div class="upload-header">
                                <h3 style="margin:0; font-weight:600; color:var(--text-primary);">${movie.title}</h3>
                                <button class="upload-close" onclick="this.closest('.upload-modal-backdrop').remove()">&times;</button>
                            </div>
                            <div class="upload-body">
                                <div style="display:grid; grid-template-columns:300px 1fr; gap:20px; margin-bottom:16px;">
                                    <img src="${movie.poster}" alt="${movie.title}" style="width:100%; border-radius:8px;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiBmaWxsPSIjMzMzIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjI1IiBmaWxsPSIjNjY2IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiPk1vdmllIFBvc3RlcjwvdGV4dD4KPHN2Zz4K'">
                                    <div>
                                        <div style="margin-bottom:12px;">
                                            <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                                                <span style="background:var(--primary); color:#fff; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600;">⭐ ${movie.vote_average.toFixed(1)}</span>
                                                <span style="color:var(--text-secondary);">${movie.release_date.split('-')[0]} • ${movie.runtime || 'N/A'} min</span>
                                            </div>
                                            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
                                                ${(movie.genres || []).map(genre => `<span style="background:var(--bg-secondary); padding:4px 8px; border-radius:12px; font-size:12px; color:var(--text-primary);">${genre}</span>`).join('')}
                                            </div>
                                        </div>
                                        <p style="color:var(--text-secondary); line-height:1.5; margin-bottom:16px;">${movie.overview}</p>
                                        
                                        ${movie.watch_providers && movie.watch_providers.free && movie.watch_providers.free.length > 0 ? `
                                            <div style="margin-bottom:16px;">
                                                <h4 style="margin:0 0 8px 0; color:var(--text-primary);">Watch Free</h4>
                                                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                                    ${movie.watch_providers.free.map(provider => `
                                                        <div style="display:flex; align-items:center; gap:8px; background:var(--bg-secondary); padding:8px 12px; border-radius:8px;">
                                                            <img src="${provider.logo_path}" alt="${provider.provider_name}" style="width:24px; height:24px; border-radius:4px;">
                                                            <span style="font-size:12px; color:var(--text-primary);">${provider.provider_name}</span>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : '<div style="color:var(--text-secondary); font-size:14px; margin-bottom:16px;">No free streaming options available</div>'}
                                        
                                        <div style="display:flex; gap:8px;">
                                            <button class="btn-enhanced" style="flex:1;">Watch Now</button>
                                            <button onclick="shareMovie('${movie.title}')" style="background:var(--bg-secondary); color:var(--text-primary); border:1px solid var(--border); padding:8px 16px; border-radius:6px; cursor:pointer;">Share</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                return modal;
        }
        
        function shareMovie(title) {
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: `Check out ${title} on MyChannel`,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(`Check out ${title} on MyChannel: ${window.location.href}`);
                alert('Link copied to clipboard!');
            }
        }

        // Enhanced Video Upload System
        let selectedVideoFile = null;
        let uploadProgress = {
            startTime: null,
            bytesUploaded: 0,
            totalBytes: 0
        };

        function initializeUploadSystem() {
            const uploadZone = document.getElementById('uploadZone');
            const videoFileInput = document.getElementById('videoFileInput');
            const titleInput = document.getElementById('umTitle');
            const descInput = document.getElementById('umDesc');
            
            // Drag and drop functionality
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.background = 'var(--accent)';
                uploadZone.style.transform = 'scale(1.02)';
            });
            
            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.style.background = '';
                uploadZone.style.transform = '';
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.style.background = '';
                uploadZone.style.transform = '';
                
                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('video/'));
                if (files.length > 0) {
                    handleVideoFileSelection(files[0]);
                }
            });
            
            // File input change
            videoFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleVideoFileSelection(e.target.files[0]);
                }
            });
            
            // Character counters
            titleInput.addEventListener('input', (e) => {
                document.getElementById('titleCount').textContent = e.target.value.length;
            });
            
            descInput.addEventListener('input', (e) => {
                document.getElementById('descCount').textContent = e.target.value.length;
            });
            
            // Upload buttons
            document.getElementById('umPublish').addEventListener('click', handleVideoUpload);
            document.getElementById('umSaveDraft').addEventListener('click', () => handleVideoUpload(true));
        }
        
        function handleVideoFileSelection(file) {
            selectedVideoFile = file;
            
            // Validate file
            if (file.size > 2 * 1024 * 1024 * 1024) { // 2GB limit
                alert('File size must be under 2GB');
                return;
            }
            
            // Show preview section
            const previewSection = document.getElementById('videoPreviewSection');
            const videoPreview = document.getElementById('videoPreview');
            const fileName = document.getElementById('videoFileName');
            const fileInfo = document.getElementById('videoFileInfo');
            const analysis = document.getElementById('videoAnalysis');
            
            previewSection.style.display = 'block';
            fileName.textContent = file.name;
            fileInfo.textContent = `${formatFileSize(file.size)} • ${file.type}`;
            
            // Create video preview
            const url = URL.createObjectURL(file);
            videoPreview.src = url;
            
            // Analyze video
            videoPreview.addEventListener('loadedmetadata', () => {
                const duration = formatDuration(videoPreview.duration);
                const resolution = `${videoPreview.videoWidth}x${videoPreview.videoHeight}`;
                const aspectRatio = (videoPreview.videoWidth / videoPreview.videoHeight).toFixed(2);
                
                analysis.innerHTML = `
                    <span>📏 ${resolution}</span>
                    <span>⏱️ ${duration}</span>
                    <span>📐 ${aspectRatio}:1</span>
                    <span>🎬 ${file.type.split('/')[1].toUpperCase()}</span>
                `;
                
                // Auto-generate title if empty
                const titleInput = document.getElementById('umTitle');
                if (!titleInput.value) {
                    titleInput.value = file.name.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ');
                    document.getElementById('titleCount').textContent = titleInput.value.length;
                }
                
                // Generate thumbnails
                generateThumbnails();
            });
        }
        
        function removeVideoFile() {
            selectedVideoFile = null;
            document.getElementById('videoPreviewSection').style.display = 'none';
            document.getElementById('videoFileInput').value = '';
            document.getElementById('thumbnailOptions').innerHTML = '';
        }
        
        function generateThumbnails() {
            if (!selectedVideoFile) return;
            
            const video = document.getElementById('videoPreview');
            const container = document.getElementById('thumbnailOptions');
            container.innerHTML = '';
            
            // Generate 4 thumbnails at different timestamps
            const timestamps = [0.1, 0.3, 0.5, 0.7];
            
            timestamps.forEach((percent, index) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 120;
                canvas.height = 68;
                
                const thumbnailDiv = document.createElement('div');
                thumbnailDiv.style.cssText = 'position:relative; cursor:pointer; border-radius:6px; overflow:hidden; border:2px solid transparent; transition:border-color 0.2s;';
                
                video.currentTime = video.duration * percent;
                
                video.addEventListener('seeked', function drawThumbnail() {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    thumbnailDiv.appendChild(canvas);
                    
                    const overlay = document.createElement('div');
                    overlay.style.cssText = 'position:absolute; inset:0; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; color:#fff; font-size:10px; opacity:0; transition:opacity 0.2s;';
                    overlay.textContent = 'Select';
                    thumbnailDiv.appendChild(overlay);
                    
                    thumbnailDiv.addEventListener('mouseenter', () => overlay.style.opacity = '1');
                    thumbnailDiv.addEventListener('mouseleave', () => overlay.style.opacity = '0');
                    
                    thumbnailDiv.addEventListener('click', () => {
                        document.querySelectorAll('#thumbnailOptions > div').forEach(d => d.style.borderColor = 'transparent');
                        thumbnailDiv.style.borderColor = 'var(--primary)';
                    });
                    
                    if (index === 1) { // Select second thumbnail by default
                        thumbnailDiv.style.borderColor = 'var(--primary)';
                    }
                    
                    video.removeEventListener('seeked', drawThumbnail);
                }, { once: true });
                
                container.appendChild(thumbnailDiv);
            });
        }
        
        async function handleVideoUpload(isDraft = false) {
            if (!selectedVideoFile) {
                alert('Please select a video file first');
                return;
            }
            
            const title = document.getElementById('umTitle').value.trim();
            if (!title) {
                alert('Please enter a video title');
                return;
            }
            
            // Initialize Firebase
            await initFirebase();
            const user = auth.currentUser;
            if (!user || user.isAnonymous) {
                document.getElementById('umSignIn').style.display = 'block';
                document.getElementById('umPublish').style.display = 'none';
                return;
            }
            
            // Show progress
            const progressSection = document.getElementById('umProgress');
            progressSection.style.display = 'block';
            
            uploadProgress.startTime = Date.now();
            uploadProgress.totalBytes = selectedVideoFile.size;
            uploadProgress.bytesUploaded = 0;
            
            updateUploadStep('step1', 'In Progress', 'var(--warning)');
            
            try {
                // Step 1: File validation
                await new Promise(resolve => setTimeout(resolve, 500));
                updateUploadStep('step1', 'Complete', 'var(--success)');
                updateUploadStep('step2', 'In Progress', 'var(--warning)');
                
                // Step 2: Upload to Firebase Storage
                const videoRef = storage.ref(`videos/${user.uid}/${Date.now()}_${selectedVideoFile.name}`);
                const uploadTask = videoRef.put(selectedVideoFile);
                
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        updateUploadProgress(progress, snapshot.bytesTransferred);
                    },
                    (error) => {
                        console.error('Upload error:', error);
                        alert('Upload failed: ' + error.message);
                        progressSection.style.display = 'none';
                    },
                    async () => {
                        updateUploadStep('step2', 'Complete', 'var(--success)');
                        updateUploadStep('step3', 'In Progress', 'var(--warning)');
                        
                        // Step 3: Get download URL and save metadata
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        
                        const videoData = {
                            title: title,
                            description: document.getElementById('umDesc').value.trim(),
                            category: document.getElementById('umCategory').value,
                            visibility: document.getElementById('umVisibility').value,
                            videoUrl: downloadURL,
                            thumbnailUrl: '', // TODO: Upload selected thumbnail
                            ownerId: user.uid,
                            ownerName: user.displayName || 'Anonymous',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            views: 0,
                            likes: 0,
                            dislikes: 0,
                            comments: 0,
                            duration: document.getElementById('videoPreview').duration,
                            fileSize: selectedVideoFile.size,
                            status: isDraft ? 'draft' : 'published',
                            settings: {
                                allowComments: document.getElementById('enableComments').checked,
                                showLikes: document.getElementById('enableLikes').checked,
                                notifySubscribers: document.getElementById('enableNotifications').checked
                            }
                        };
                        
                        await db.collection('videos').add(videoData);
                        
                        updateUploadStep('step3', 'Complete', 'var(--success)');
                        updateUploadStep('step4', 'Complete', 'var(--success)');
                        
                        // Success!
                        setTimeout(() => {
                            alert(isDraft ? 'Video saved as draft!' : 'Video published successfully!');
                            closeUploadModal();
                            resetUploadForm();
                        }, 1000);
                    }
                );
                
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
                progressSection.style.display = 'none';
            }
        }
        
        function updateUploadProgress(percentage, bytesUploaded) {
            document.getElementById('umFill').style.width = percentage + '%';
            document.getElementById('umPct').textContent = Math.round(percentage) + '%';
            
            uploadProgress.bytesUploaded = bytesUploaded;
            
            // Calculate speed and time remaining
            const elapsed = (Date.now() - uploadProgress.startTime) / 1000;
            const speed = bytesUploaded / elapsed; // bytes per second
            const remaining = (uploadProgress.totalBytes - bytesUploaded) / speed;
            
            document.getElementById('uploadSpeed').textContent = formatFileSize(speed) + '/s';
            document.getElementById('timeRemaining').textContent = formatDuration(remaining);
            document.getElementById('uploadStatus').textContent = `Uploading ${formatFileSize(bytesUploaded)} of ${formatFileSize(uploadProgress.totalBytes)}`;
        }
        
        function updateUploadStep(stepId, status, color) {
            const step = document.getElementById(stepId);
            const statusSpan = step.querySelector('span');
            statusSpan.textContent = status;
            statusSpan.style.color = color;
        }
        
        function resetUploadForm() {
            selectedVideoFile = null;
            document.getElementById('videoPreviewSection').style.display = 'none';
            document.getElementById('videoFileInput').value = '';
            document.getElementById('umTitle').value = '';
            document.getElementById('umDesc').value = '';
            document.getElementById('titleCount').textContent = '0';
            document.getElementById('descCount').textContent = '0';
            document.getElementById('thumbnailOptions').innerHTML = '';
            document.getElementById('umProgress').style.display = 'none';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        function formatDuration(seconds) {
            if (isNaN(seconds) || seconds < 0) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }

        // Live Streaming System
        let mediaStream = null;
        let isStreaming = false;
        let streamStartTime = null;
        let streamTimer = null;
        let cameraEnabled = false;
        let micEnabled = false;
        
        function openLiveStreamModal() {
            document.getElementById('liveStreamModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            initializeLiveStreamSystem();
        }
        
        function closeLiveStreamModal() {
            document.getElementById('liveStreamModal').classList.remove('active');
            document.body.style.overflow = '';
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            resetStreamInterface();
        }
        
        function initializeLiveStreamSystem() {
            const streamTitle = document.getElementById('streamTitle');
            const streamDesc = document.getElementById('streamDesc');
            const startStreamBtn = document.getElementById('startStreamBtn');
            
            // Character counters
            streamTitle.addEventListener('input', (e) => {
                document.getElementById('streamTitleCount').textContent = e.target.value.length;
            });
            
            streamDesc.addEventListener('input', (e) => {
                document.getElementById('streamDescCount').textContent = e.target.value.length;
            });
            
            // Start stream button
            startStreamBtn.addEventListener('click', handleStartStream);
        }
        
        async function toggleCamera() {
            try {
                if (!cameraEnabled) {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { width: 1280, height: 720 }, 
                        audio: false 
                    });
                    
                    const videoPreview = document.getElementById('cameraPreview');
                    videoPreview.srcObject = stream;
                    
                    if (!mediaStream) {
                        mediaStream = stream;
                    } else {
                        // Add video track to existing stream
                        stream.getVideoTracks().forEach(track => {
                            mediaStream.addTrack(track);
                        });
                    }
                    
                    cameraEnabled = true;
                    document.getElementById('cameraStatus').textContent = '📷 Camera On';
                    document.getElementById('toggleCamera').style.background = 'rgba(76, 175, 80, 0.8)';
                } else {
                    // Stop camera
                    if (mediaStream) {
                        mediaStream.getVideoTracks().forEach(track => {
                            track.stop();
                            mediaStream.removeTrack(track);
                        });
                    }
                    
                    const videoPreview = document.getElementById('cameraPreview');
                    videoPreview.srcObject = null;
                    
                    cameraEnabled = false;
                    document.getElementById('cameraStatus').textContent = '📷 Camera Off';
                    document.getElementById('toggleCamera').style.background = 'rgba(255,255,255,0.2)';
                }
            } catch (error) {
                console.error('Camera error:', error);
                alert('Could not access camera: ' + error.message);
            }
        }
        
        async function toggleMic() {
            try {
                if (!micEnabled) {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: false, 
                        audio: true 
                    });
                    
                    if (!mediaStream) {
                        mediaStream = stream;
                    } else {
                        // Add audio track to existing stream
                        stream.getAudioTracks().forEach(track => {
                            mediaStream.addTrack(track);
                        });
                    }
                    
                    micEnabled = true;
                    document.getElementById('toggleMic').style.background = 'rgba(76, 175, 80, 0.8)';
                } else {
                    // Stop microphone
                    if (mediaStream) {
                        mediaStream.getAudioTracks().forEach(track => {
                            track.stop();
                            mediaStream.removeTrack(track);
                        });
                    }
                    
                    micEnabled = false;
                    document.getElementById('toggleMic').style.background = 'rgba(255,255,255,0.2)';
                }
            } catch (error) {
                console.error('Microphone error:', error);
                alert('Could not access microphone: ' + error.message);
            }
        }
        
        async function handleStartStream() {
            const title = document.getElementById('streamTitle').value.trim();
            if (!title) {
                alert('Please enter a stream title');
                return;
            }
            
            // Initialize Firebase
            await initFirebase();
            const user = auth.currentUser;
            if (!user || user.isAnonymous) {
                document.getElementById('streamSignIn').style.display = 'block';
                document.getElementById('startStreamBtn').style.display = 'none';
                return;
            }
            
            if (!cameraEnabled && !micEnabled) {
                alert('Please enable camera or microphone to start streaming');
                return;
            }
            
            try {
                // Create stream document in Firestore
                const streamData = {
                    title: title,
                    description: document.getElementById('streamDesc').value.trim(),
                    category: document.getElementById('streamCategory').value,
                    quality: document.getElementById('streamQuality').value,
                    streamerId: user.uid,
                    streamerName: user.displayName || 'Anonymous',
                    startTime: firebase.firestore.FieldValue.serverTimestamp(),
                    isLive: true,
                    viewerCount: 0,
                    chatEnabled: document.getElementById('enableChat').checked,
                    recordingEnabled: document.getElementById('recordStream').checked,
                    settings: {
                        notifyFollowers: document.getElementById('notifyFollowers').checked
                    }
                };
                
                const streamDoc = await db.collection('liveStreams').add(streamData);
                
                // Switch to live interface
                document.getElementById('streamSetup').style.display = 'none';
                document.getElementById('liveStreamInterface').style.display = 'block';
                
                isStreaming = true;
                streamStartTime = Date.now();
                
                // Start stream timer
                startStreamTimer();
                
                // Simulate viewer updates
                simulateStreamStats(streamDoc.id);
                
                // Initialize live chat
                initializeLiveChat(streamDoc.id);
                
            } catch (error) {
                console.error('Stream start error:', error);
                alert('Failed to start stream: ' + error.message);
            }
        }
        
        function startStreamTimer() {
            streamTimer = setInterval(() => {
                if (streamStartTime) {
                    const elapsed = Math.floor((Date.now() - streamStartTime) / 1000);
                    const hours = Math.floor(elapsed / 3600);
                    const minutes = Math.floor((elapsed % 3600) / 60);
                    const seconds = elapsed % 60;
                    
                    const timeStr = hours > 0 
                        ? `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
                        : `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    document.getElementById('streamDuration').textContent = timeStr;
                }
            }, 1000);
        }
        
        function simulateStreamStats(streamId) {
            // Simulate realistic viewer growth
            let viewers = 0;
            let messages = 0;
            
            const updateStats = () => {
                if (!isStreaming) return;
                
                // Gradual viewer increase with some randomness
                const change = Math.random() > 0.5 ? Math.floor(Math.random() * 3) : -Math.floor(Math.random() * 2);
                viewers = Math.max(0, viewers + change);
                
                // Occasional message
                if (Math.random() > 0.7) {
                    messages++;
                    addSimulatedChatMessage();
                }
                
                document.getElementById('viewerCount').textContent = viewers;
                document.getElementById('chatMessages').textContent = messages;
                
                setTimeout(updateStats, 2000 + Math.random() * 3000);
            };
            
            setTimeout(updateStats, 1000);
        }
        
        function addSimulatedChatMessage() {
            const chatPreview = document.getElementById('liveChatPreview');
            const messages = [
                'Great stream! 👍',
                'Hello from viewer!',
                'Love the content 🔥',
                'Keep it up!',
                'Amazing quality!',
                'First time watching 😊',
                'This is awesome!'
            ];
            
            const usernames = ['StreamFan123', 'VideoLover', 'ContentKing', 'ViewerPro', 'ChatMaster'];
            
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'margin-bottom:8px; font-size:12px; padding:4px 8px; background:rgba(var(--primary-rgb), 0.1); border-radius:4px;';
            messageDiv.innerHTML = `
                <span style="font-weight:600; color:var(--primary);">${usernames[Math.floor(Math.random() * usernames.length)]}</span>
                <span style="color:var(--text-primary); margin-left:8px;">${messages[Math.floor(Math.random() * messages.length)]}</span>
            `;
            
            chatPreview.appendChild(messageDiv);
            chatPreview.scrollTop = chatPreview.scrollHeight;
            
            // Remove old messages to prevent overflow
            while (chatPreview.children.length > 10) {
                chatPreview.removeChild(chatPreview.firstChild);
            }
        }
        
        function initializeLiveChat(streamId) {
            const chatPreview = document.getElementById('liveChatPreview');
            chatPreview.innerHTML = '<div style="font-size:12px; color:var(--text-secondary); text-align:center; padding:8px;">Live chat is active! 💬</div>';
        }
        
        function toggleStreamCamera() {
            toggleCamera();
        }
        
        function toggleStreamMic() {
            toggleMic();
        }
        
        async function endStream() {
            if (!confirm('Are you sure you want to end the stream?')) return;
            
            isStreaming = false;
            
            if (streamTimer) {
                clearInterval(streamTimer);
                streamTimer = null;
            }
            
            // Stop all media tracks
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            // Update stream status in Firestore
            try {
                // In a real implementation, you'd update the specific stream document
                console.log('Stream ended, updating database...');
            } catch (error) {
                console.error('Error ending stream:', error);
            }
            
            alert('Stream ended successfully!');
            closeLiveStreamModal();
        }
        
        function resetStreamInterface() {
            document.getElementById('streamSetup').style.display = 'block';
            document.getElementById('liveStreamInterface').style.display = 'none';
            
            // Reset form
            document.getElementById('streamTitle').value = '';
            document.getElementById('streamDesc').value = '';
            document.getElementById('streamTitleCount').textContent = '0';
            document.getElementById('streamDescCount').textContent = '0';
            
            // Reset camera/mic states
            cameraEnabled = false;
            micEnabled = false;
            document.getElementById('cameraStatus').textContent = '📷 Camera Off';
            document.getElementById('toggleCamera').style.background = 'rgba(255,255,255,0.2)';
            document.getElementById('toggleMic').style.background = 'rgba(255,255,255,0.2)';
            
            // Reset stats
            document.getElementById('viewerCount').textContent = '0';
            document.getElementById('streamDuration').textContent = '00:00';
            document.getElementById('chatMessages').textContent = '0';
            
            isStreaming = false;
            streamStartTime = null;
        }

        // Advanced Notifications System
        let notifications = [];
        let notificationSettings = {
            push: {
                likes: true,
                comments: true,
                follows: true,
                live: true,
                uploads: true
            },
            email: {
                weekly: true,
                monthly: true,
                updates: false
            },
            quietHours: {
                start: '22:00',
                end: '08:00'
            }
        };
        
        function toggleNotificationsPanel() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                loadNotifications();
                // Mark notifications as read after viewing
                setTimeout(() => {
                    markVisibleNotificationsAsRead();
                }, 1000);
            }
        }
        
        function loadNotifications() {
            // Simulate loading notifications
            if (notifications.length === 0) {
                generateSampleNotifications();
            }
            renderNotifications();
        }
        
        function generateSampleNotifications() {
            const sampleNotifications = [
                {
                    id: '1',
                    type: 'likes',
                    title: 'New likes on your video',
                    message: 'Your video "Amazing Sunset Timelapse" received 15 new likes',
                    avatar: '❤️',
                    timestamp: Date.now() - 300000, // 5 minutes ago
                    read: false,
                    actionUrl: '#'
                },
                {
                    id: '2',
                    type: 'comments',
                    title: 'New comment',
                    message: 'StreamFan123 commented: "This is incredible! How did you capture this?"',
                    avatar: '💬',
                    timestamp: Date.now() - 900000, // 15 minutes ago
                    read: false,
                    actionUrl: '#'
                },
                {
                    id: '3',
                    type: 'follows',
                    title: 'New follower',
                    message: 'VideoLover started following you',
                    avatar: '👥',
                    timestamp: Date.now() - 1800000, // 30 minutes ago
                    read: true,
                    actionUrl: '#'
                },
                {
                    id: '4',
                    type: 'uploads',
                    title: 'New upload from ContentKing',
                    message: 'ContentKing uploaded "Epic Gaming Montage #5"',
                    avatar: '📹',
                    timestamp: Date.now() - 3600000, // 1 hour ago
                    read: true,
                    actionUrl: '#'
                },
                {
                    id: '5',
                    type: 'live',
                    title: 'ViewerPro is now live',
                    message: 'ViewerPro started streaming "Just Chatting with Viewers"',
                    avatar: '🔴',
                    timestamp: Date.now() - 7200000, // 2 hours ago
                    read: true,
                    actionUrl: '#'
                }
            ];
            
            notifications = sampleNotifications;
        }
        
        function renderNotifications(filter = 'all') {
            const container = document.getElementById('notificationsList');
            const filteredNotifications = filter === 'all' 
                ? notifications 
                : notifications.filter(n => n.type === filter);
            
            if (filteredNotifications.length === 0) {
                container.innerHTML = `
                    <div class="notifications-empty">
                        <div style="text-align:center; padding:40px 20px; color:var(--text-secondary);">
                            <div style="font-size:48px; margin-bottom:12px;">🔔</div>
                            <div style="font-size:16px; margin-bottom:8px;">No ${filter === 'all' ? '' : filter + ' '}notifications</div>
                            <div style="font-size:12px;">We'll notify you when something happens!</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredNotifications.map(notification => `
                <div class="notification-item ${notification.read ? '' : 'unread'}" onclick="handleNotificationClick('${notification.id}')">
                    <div style="display:flex; align-items:flex-start; gap:12px;">
                        <div class="notification-avatar">${notification.avatar}</div>
                        <div class="notification-content">
                            <div class="notification-text">
                                <strong>${notification.title}</strong><br>
                                ${notification.message}
                            </div>
                            <div class="notification-time">${formatNotificationTime(notification.timestamp)}</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            updateNotificationCount();
        }
        
        function formatNotificationTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return new Date(timestamp).toLocaleDateString();
        }
        
        function handleNotificationClick(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                renderNotifications();
                
                // Navigate to the relevant content
                if (notification.actionUrl && notification.actionUrl !== '#') {
                    window.location.href = notification.actionUrl;
                }
            }
        }
        
        function markAllNotificationsRead() {
            notifications.forEach(n => n.read = true);
            renderNotifications();
        }
        
        function markVisibleNotificationsAsRead() {
            notifications.forEach(n => {
                if (!n.read) {
                    n.read = true;
                }
            });
            updateNotificationCount();
        }
        
        function updateNotificationCount() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notificationCount');
            const navBadge = document.getElementById('navNotificationBadge');
            
            badge.textContent = unreadCount;
            badge.style.display = unreadCount > 0 ? 'inline' : 'none';
            
            if (navBadge) {
                navBadge.textContent = unreadCount;
                navBadge.style.display = unreadCount > 0 ? 'inline' : 'none';
            }
        }
        
        function openNotificationSettings() {
            document.getElementById('notificationSettingsModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            loadNotificationSettings();
        }
        
        function closeNotificationSettings() {
            document.getElementById('notificationSettingsModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        function loadNotificationSettings() {
            // Load current settings into form
            Object.keys(notificationSettings.push).forEach(type => {
                const checkbox = document.querySelector(`.notification-toggle[data-type="${type}"]`);
                if (checkbox) checkbox.checked = notificationSettings.push[type];
            });
            
            Object.keys(notificationSettings.email).forEach(type => {
                const checkbox = document.querySelector(`.email-toggle[data-type="${type}"]`);
                if (checkbox) checkbox.checked = notificationSettings.email[type];
            });
            
            document.getElementById('quietStart').value = notificationSettings.quietHours.start;
            document.getElementById('quietEnd').value = notificationSettings.quietHours.end;
        }
        
        function saveNotificationSettings() {
            // Save push notification settings
            document.querySelectorAll('.notification-toggle').forEach(checkbox => {
                const type = checkbox.dataset.type;
                notificationSettings.push[type] = checkbox.checked;
            });
            
            // Save email notification settings
            document.querySelectorAll('.email-toggle').forEach(checkbox => {
                const type = checkbox.dataset.type;
                notificationSettings.email[type] = checkbox.checked;
            });
            
            // Save quiet hours
            notificationSettings.quietHours.start = document.getElementById('quietStart').value;
            notificationSettings.quietHours.end = document.getElementById('quietEnd').value;
            
            // Save to localStorage or Firebase
            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
            
            showNotificationToast('Settings saved successfully!', '⚙️');
            closeNotificationSettings();
        }
        
        function showNotificationToast(message, icon = '🔔') {
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.innerHTML = `
                <div class="notification-toast-header">
                    <span style="font-size:16px;">${icon}</span>
                    <span class="notification-toast-title">MyChannel</span>
                </div>
                <div class="notification-toast-body">${message}</div>
            `;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function addNotification(type, title, message, actionUrl = '#') {
            const notification = {
                id: Date.now().toString(),
                type: type,
                title: title,
                message: message,
                avatar: getNotificationIcon(type),
                timestamp: Date.now(),
                read: false,
                actionUrl: actionUrl
            };
            
            notifications.unshift(notification);
            updateNotificationCount();
            
            // Show toast if notifications are enabled
            if (notificationSettings.push[type] && !isInQuietHours()) {
                showNotificationToast(`${title}: ${message}`, notification.avatar);
            }
            
            // Request permission for browser notifications
            if (Notification.permission === 'granted' && notificationSettings.push[type]) {
                new Notification(title, {
                    body: message,
                    icon: '/favicon.ico',
                    badge: '/favicon.ico'
                });
            }
        }
        
        function getNotificationIcon(type) {
            const icons = {
                likes: '❤️',
                comments: '💬',
                follows: '👥',
                uploads: '📹',
                live: '🔴'
            };
            return icons[type] || '🔔';
        }
        
        function isInQuietHours() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const [startHour, startMin] = notificationSettings.quietHours.start.split(':').map(Number);
            const [endHour, endMin] = notificationSettings.quietHours.end.split(':').map(Number);
            
            const startTime = startHour * 60 + startMin;
            const endTime = endHour * 60 + endMin;
            
            if (startTime < endTime) {
                return currentTime >= startTime && currentTime <= endTime;
            } else {
                return currentTime >= startTime || currentTime <= endTime;
            }
        }
        
        function initializeNotificationSystem() {
            // Load saved settings
            const savedSettings = localStorage.getItem('notificationSettings');
            if (savedSettings) {
                notificationSettings = { ...notificationSettings, ...JSON.parse(savedSettings) };
            }
            
            // Request notification permission
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Set up notification filters
            document.querySelectorAll('.notification-filter').forEach(filter => {
                filter.addEventListener('click', (e) => {
                    document.querySelectorAll('.notification-filter').forEach(f => f.classList.remove('active'));
                    e.target.classList.add('active');
                    renderNotifications(e.target.dataset.filter);
                });
            });
            
            // Simulate periodic notifications for demo
            setTimeout(() => {
                addNotification('likes', 'New likes!', 'Your video got 5 new likes');
            }, 10000);
            
            setTimeout(() => {
                addNotification('comments', 'New comment!', 'Someone commented on your video');
            }, 20000);
        }

        // Add Flicks button to navigation
        document.addEventListener('DOMContentLoaded', () => {
            const appleBtn = document.querySelector('button[onclick="signInWithApple()"]');
            if (appleBtn && !APPLE_SIGNIN_ENABLED) {
                appleBtn.style.display = 'none';
            }
            
            // Initialize upload system
            initializeUploadSystem();
            
            // Load initial content - remove duplicate calls
            // loadFreeMovies() and loadTrending() are already called in the first DOMContentLoaded listener
            
            // Provider filter change handler
            const providerFilter = document.getElementById('providerFilter');
            if (providerFilter) {
                providerFilter.addEventListener('change', (e) => {
                    loadFreeMovies(e.target.value);
                });
            }
            
            // Add click handler to video cards to open in Flicks viewer
            document.addEventListener('click', (e) => {
                const videoCard = e.target.closest('.video-card');
                if (videoCard) {
                    e.preventDefault();
                    openFlicks(0); // Start from first flick
                }
            });
            
            // Add live stream button to navigation
            const nav = document.querySelector('nav[role="navigation"] > div');
            if (nav && !document.getElementById('liveStreamBtn')) {
                const liveBtn = document.createElement('button');
                liveBtn.id = 'liveStreamBtn';
                liveBtn.onclick = openLiveStreamModal;
                liveBtn.className = 'btn-enhanced';
                liveBtn.style.cssText = 'background:var(--error); margin-left:8px; font-weight:600;';
                liveBtn.innerHTML = '🔴 Go Live';
                nav.appendChild(liveBtn);
            }
            
            // Add notifications button to navigation
            if (nav && !document.getElementById('notificationsBtn')) {
                const notifBtn = document.createElement('button');
                notifBtn.id = 'notificationsBtn';
                notifBtn.onclick = toggleNotificationsPanel;
                notifBtn.className = 'btn-enhanced';
                notifBtn.style.cssText = 'background:var(--bg-secondary); color:var(--text-primary); border:1px solid var(--border); margin-left:8px; position:relative;';
                notifBtn.innerHTML = '🔔 <span id="navNotificationBadge" class="notification-badge" style="position:absolute; top:-4px; right:-4px; display:none;">0</span>';
                nav.appendChild(notifBtn);
            }
            
            // Initialize notification system
            initializeNotificationSystem();
            
            // Load initial notifications
            setTimeout(() => {
                loadNotifications();
            }, 2000);
        });

        async function signInWithApple() {
            if (!APPLE_SIGNIN_ENABLED) {
                alert('Sign in with Apple will be available soon.');
                return;
            }
            await initFirebase();
            try {
                const provider = new firebase.auth.OAuthProvider('apple.com');
                provider.addScope('email');
                provider.addScope('name');
                const isIOSSafari = /iP(hone|ad|od)/.test(navigator.userAgent) && /Safari/.test(navigator.userAgent) && !/CriOS|FxiOS/.test(navigator.userAgent);
                if (isIOSSafari) {
                    await auth.signInWithRedirect(provider);
                    return;
                }
                    await auth.signInWithPopup(provider);
                closeAuthModal();
                refreshAccountMenu();
                clearOverlays();
                } catch (e) {
                alert(e?.message || 'Apple sign-in failed');
            }
        }
    </script>
</body>
</html>
