name: iOS Build (MyChannel)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16
        run: |
          XCODE="/Applications/Xcode_16.0.app"
          if [ -d "$XCODE" ]; then
            sudo xcode-select -s "$XCODE"
          else
            xcodebuild -version
          fi

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: ${{ runner.os }}-spm-

      - name: Resolve dependencies
        run: |
          xcodebuild -resolvePackageDependencies -project MyChannel.xcodeproj

      - name: Build (Debug, iPhone 15)
        run: |
          set -o pipefail
          xcodebuild \
            -project MyChannel.xcodeproj \
            -scheme MyChannel \
            -configuration Debug \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            build | xcpretty
        env:
          NSUnbufferedIO: YES

      - name: ğŸ‰ Build Success Notification
        if: success()
        run: |
          echo "ğŸ”¥ BUILD SUCCEEDED! ğŸ”¥"
          echo "âœ… MyChannel iOS app built successfully on commit ${{ github.sha }}"
          echo "ğŸš€ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Pushed by: ${{ github.actor }}"
          echo "ğŸ“± Platform: iOS Simulator (iPhone 15)"
          echo "â° Build completed at: $(date)"

      - name: ğŸ“§ Send Success Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸ”¥ BUILD SUCCESS: MyChannel iOS App (${{ github.ref_name }})"
          to: ${{ secrets.EMAIL_TO }}
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
          html_body: |
            <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; text-align: center; margin-bottom: 20px;">
                <h1 style="margin: 0; font-size: 28px;">ğŸ”¥ BUILD SUCCESS! ğŸ”¥</h1>
                <p style="margin: 10px 0 0 0; font-size: 18px; opacity: 0.9;">MyChannel iOS App</p>
              </div>
              
              <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h2 style="color: #28a745; margin-top: 0;">âœ… Build Details</h2>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold;">Repository:</td>
                    <td style="padding: 8px 0;">keontapeat/MyChannel</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold;">Branch:</td>
                    <td style="padding: 8px 0;">${{ github.ref_name }}</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold;">Commit:</td>
                    <td style="padding: 8px 0;"><code>${{ github.sha }}</code></td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold;">Pushed by:</td>
                    <td style="padding: 8px 0;">${{ github.actor }}</td>
                  </tr>
                  <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px 0; font-weight: bold;">Platform:</td>
                    <td style="padding: 8px 0;">ğŸ“± iOS Simulator (iPhone 15)</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; font-weight: bold;">Configuration:</td>
                    <td style="padding: 8px 0;">Debug</td>
                  </tr>
                </table>
              </div>
              
              <div style="text-align: center; padding: 20px;">
                <a href="https://github.com/keontapeat/MyChannel/actions" style="display: inline-block; background: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold;">View Build Details</a>
              </div>
              
              <div style="text-align: center; color: #6c757d; font-size: 14px; border-top: 1px solid #dee2e6; padding-top: 20px;">
                <p>ğŸš€ Your iOS app is ready to rock! Keep building awesome features! ğŸ˜¤ğŸ”¥</p>
                <p>Sent by GitHub Actions â€¢ <a href="https://github.com/keontapeat/MyChannel">MyChannel Repository</a></p>
              </div>
            </div>

      - name: ğŸ’¥ Build Failure Notification
        if: failure()
        run: |
          echo "âŒ BUILD FAILED!"
          echo "ğŸ’” MyChannel iOS app build failed on commit ${{ github.sha }}"
          echo "ğŸš¨ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Pushed by: ${{ github.actor }}"
          echo "â° Build failed at: $(date)"
